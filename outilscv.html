<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Générateur de CV IA (A4 PDF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librairie pour générer le PDF depuis le HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style pour le conteneur du CV au format A4 */
        #cv-preview {
            width: 210mm;
            min-height: 297mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.15);
            margin: 2rem auto;
            transition: opacity 0.5s ease-in-out;
            /* Préserver les sauts de ligne et les espaces */
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
        /* Masquer les éléments initialement */
        .hidden-initially {
            display: none;
            opacity: 0;
        }
        /* Animation pour le chargement */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start px-4 py-8">

    <!-- Section de contrôle -->
    <div class="w-full max-w-3xl bg-white shadow-xl rounded-xl p-8 mb-8">
        <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">Générateur de CV IA</h1>
        <p class="text-center text-gray-500 mb-6">Créez un CV professionnel au format PDF en quelques secondes.</p>
        
        <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">
            Décrivez le CV que vous souhaitez :
        </label>
        <textarea id="prompt" placeholder="Exemple : Écris un CV pour un ingénieur VRD diplômé de l’INSA"
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 mb-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>

        <button id="generate-btn"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
            Générer le CV
        </button>

        <!-- Zone de notification -->
        <div id="notification" class="mt-4 text-center text-sm"></div>
    </div>

    <!-- Bouton de téléchargement (initialement masqué) -->
    <div id="download-container" class="w-full max-w-3xl text-center mb-8 hidden-initially">
         <button id="download-btn"
                class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center justify-center gap-2 mx-auto">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
             Télécharger en PDF
         </button>
    </div>

    <!-- Prévisualisation du CV (initialement masqué) -->
    <div id="cv-container" class="hidden-initially">
        <div id="cv-preview" class="bg-white p-12 text-gray-800">
            <!-- Le contenu du CV sera injecté ici -->
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const downloadContainer = document.getElementById('download-container');
        const promptInput = document.getElementById('prompt');
        const notificationDiv = document.getElementById('notification');
        const cvContainer = document.getElementById('cv-container');
        const cvPreview = document.getElementById('cv-preview');
        
        let cvFileName = 'cv.pdf';

        /**
         * Affiche une notification à l'utilisateur.
         */
        function notify(message, type = 'info') {
            notificationDiv.innerHTML = ''; // Clear previous
            const p = document.createElement('p');
            p.innerHTML = message;
            if (type === 'error') p.className = 'text-red-500 font-medium';
            else if (type === 'success') p.className = 'text-green-500 font-medium';
            else p.className = 'text-gray-500';
            notificationDiv.appendChild(p);
        }

        /**
         * Gère l'état de chargement de l'interface.
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="loader"></div><span class="ml-2">Génération en cours...</span>';
                cvContainer.style.display = 'none';
                cvContainer.style.opacity = 0;
                downloadContainer.style.display = 'none';
                downloadContainer.style.opacity = 0;
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>Générer le CV';
            }
        }

        /**
         * Appelle l'API pour générer le contenu du CV.
         */
        async function generateCV() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                notify("Veuillez décrire le CV que vous souhaitez générer.", 'error');
                return;
            }

            setLoadingState(true);
            notify("L'IA rédige votre CV, veuillez patienter...");

            try {
                const response = await fetch("https://simulateur-ltd.onrender.com/api/gemini", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt })
                });
                
                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (data.response) {
                    renderCV(data.response);
                    notify("CV généré avec succès !", 'success');
                } else {
                    throw new Error(data.error || "La réponse de l'API est vide.");
                }

            } catch (err) {
                console.error("Erreur lors de la génération :", err);
                notify(`Une erreur est survenue. (${err.message})`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * Affiche le texte du CV dans le template HTML.
         * @param {string} textContent - Le contenu textuel du CV.
         */
        function renderCV(textContent) {
            // Utilise le début du prompt pour un nom de fichier plus pertinent
            cvFileName = `CV_${promptInput.value.trim().substring(0, 20).replace(/\s+/g, '_') || 'genere'}.pdf`;
            
            cvPreview.textContent = textContent; // Utiliser textContent pour éviter l'injection de HTML

            cvContainer.style.display = 'block';
            downloadContainer.style.display = 'block';
            // Utiliser un timeout pour l'animation d'apparition
            setTimeout(() => {
                cvContainer.style.opacity = 1;
                downloadContainer.style.opacity = 1;
            }, 10);
        }

        /**
         * Génère et télécharge le PDF à partir de l'élément cv-preview.
         */
        function downloadPDF() {
            const element = document.getElementById('cv-preview');
            const opt = {
              margin:       [15, 15, 15, 15], // marges en mm (haut, gauche, bas, droite)
              filename:     cvFileName,
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 3, letterRendering: true, useCORS: true },
              jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // Utiliser html2pdf pour générer le PDF
            html2pdf().from(element).set(opt).save();
        }

        // Ajout des écouteurs d'événements
        generateBtn.addEventListener('click', generateCV);
        downloadBtn.addEventListener('click', downloadPDF);

    </script>
</body>
</html>
