<!--
Pour utiliser le modèle nakamoto-yama/t5-resume-generation de Hugging Face en pur front,
on ne fait QU'UN fetch POST vers l'API Space Gradio /run/predict, sans instruction spéciale.
-->

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de CV IA - LTD Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; }
        .cv-preview-container { width: 21cm; min-height: 29.7cm; background: white; color: #22223b; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: auto; }
        .error-message { background: #ef4444; color: white; padding: 0.8rem; border-radius: 0.5rem; margin-top: 1rem;}
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useRef } = React;
const { jsPDF } = window.jspdf;

function CvTool() {
    const [inputText, setInputText] = useState('');
    const [cvText, setCvText] = useState('');
    const [isGenerating, setIsGenerating] = useState(false);
    const [error, setError] = useState(null);
    const cvPreviewRef = useRef(null);

    // Handler: Appel API Hugging Face
    const handleApiCall = async () => {
        if (!inputText.trim()) {
            setError("Veuillez coller un texte de profil ou de parcours.");
            return;
        }
        setIsGenerating(true);
        setError(null);
        setCvText("");
        try {
            const response = await fetch(
                "https://nakamoto-yama-t5-resume-generation.hf.space/run/predict",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ data: [inputText] })
                }
            );
            const resultText = await response.text();

            let result;
            try {
                result = JSON.parse(resultText);
            } catch (e) {
                setError(
                    resultText.startsWith('<')
                        ? "L'IA Hugging Face est en veille ou saturée. Réessayez dans 1-2 minutes."
                        : "Erreur API Hugging Face : " + e.message
                );
                setIsGenerating(false);
                return;
            }

            // result.data[0] = résumé généré (souvent au format texte)
            setCvText(result.data?.[0] || "Aucune donnée générée.");
        } catch (err) {
            setError("Erreur API Hugging Face : " + err.message);
        } finally {
            setIsGenerating(false);
        }
    };

    // Génération PDF
    const handleDownloadPdf = () => {
        const input = cvPreviewRef.current;
        if (!input) return;
        html2canvas(input, { scale: 3, useCORS: true }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
            pdf.save('cv-ia.pdf');
        });
    };

    return (
        <div className="flex flex-col items-center min-h-screen py-10 px-2">
            <h1 className="text-3xl font-bold mb-3 text-center">Générateur de CV IA</h1>
            <div className="w-full max-w-xl bg-[#1e293b] p-6 rounded-xl shadow mb-8">
                <textarea
                    value={inputText}
                    onChange={e => setInputText(e.target.value)}
                    placeholder="Collez ici un texte de parcours, profil, expériences..."
                    className="w-full h-32 p-3 mb-3 rounded bg-[#0f172a] border border-[#334155] text-white resize-none"
                />
                <button
                    onClick={handleApiCall}
                    disabled={isGenerating}
                    className="w-full py-2 rounded bg-[#6366f1] hover:bg-[#4f46e5] font-semibold text-lg text-white transition"
                >
                    {isGenerating ? "Génération en cours..." : "Générer le CV"}
                </button>
                {error && <div className="error-message mt-3">{error}</div>}
            </div>
            <div className="w-full max-w-3xl">
                <div ref={cvPreviewRef} className="cv-preview-container p-10 mb-6 min-h-[400px]">
                    {cvText ? (
                        <pre className="whitespace-pre-line text-lg">{cvText}</pre>
                    ) : (
                        <div className="text-gray-400 text-center py-8">
                            L'aperçu du CV généré s'affichera ici.
                        </div>
                    )}
                </div>
                <button
                    onClick={handleDownloadPdf}
                    disabled={!cvText}
                    className="w-full py-2 rounded bg-[#10b981] hover:bg-[#059669] font-semibold text-white transition"
                >
                    Télécharger en PDF
                </button>
            </div>
            <div className="mt-8 opacity-70 text-xs text-center">
                Propulsé par <a className="underline" href="https://huggingface.co/spaces/nakamoto-yama/t5-resume-generation" target="_blank" rel="noopener noreferrer">nakamoto-yama/t5-resume-generation</a> (Hugging Face Spaces)
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<CvTool />);
</script>
</body>
</html>
