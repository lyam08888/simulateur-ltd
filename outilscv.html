<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Générateur de CV Professionnel IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        #cv-preview-wrapper {
            width: 210mm;
            min-height: 297mm;
            background-color: white;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            margin: 2rem auto;
            transition: opacity 0.5s ease-in-out;
        }
        #cv-preview {
            padding: 18mm 15mm;
        }
        .hidden-initially {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styles pour le template du CV */
        .cv-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e40af; /* blue-800 */
            border-bottom: 2px solid #93c5fd; /* blue-300 */
            padding-bottom: 0.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .cv-icon {
            width: 1.2rem;
            height: 1.2rem;
            stroke-width: 2;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start px-4 py-10">

    <!-- Section de contrôle -->
    <div class="w-full max-w-3xl bg-white shadow-lg rounded-xl p-8 mb-8">
        <div class="flex items-center justify-center gap-3 mb-2">
             <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v5"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M4.268 12.157a2.5 2.5 0 0 0-2.45 2.691 2.5 2.5 0 0 0 2.45 2.691h.084a2.5 2.5 0 0 1 2.45 2.691 2.5 2.5 0 0 1-2.45 2.691h-.084a2.5 2.5 0 0 0-2.45 2.691 2.5 2.5 0 0 0 2.45 2.691"/><path d="m10 15-2 2 2 2"/><path d="m7 17h3"/></svg>
            <h1 class="text-3xl font-bold text-center text-gray-800">Générateur de CV Professionnel</h1>
        </div>
        <p class="text-center text-gray-500 mb-8">Créez un CV élégant et structuré, prêt à être téléchargé en PDF.</p>
        
        <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">
            Décrivez le CV que vous souhaitez :
        </label>
        <textarea id="prompt" placeholder="Exemple : Crée un CV pour un chef de projet marketing avec 5 ans d'expérience, spécialisé en SEO et campagnes digitales."
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 mb-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>

        <button id="generate-btn"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm hover:shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
            Générer le CV
        </button>

        <div id="notification" class="mt-4 text-center text-sm min-h-[20px]"></div>
    </div>

    <!-- Boutons d'action (initialement masqués) -->
    <div id="action-buttons" class="w-full max-w-3xl text-center mb-8 hidden-initially">
         <div class="flex justify-center gap-4 flex-wrap">
            <button id="copy-btn" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition-all duration-300 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copier Texte Original
            </button>
            <button id="download-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center justify-center gap-2">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                 Télécharger en PDF
            </button>
        </div>
    </div>

    <!-- Prévisualisation du CV -->
    <div id="cv-container" class="hidden-initially">
        <div id="cv-preview-wrapper">
            <div id="cv-preview">
                <!-- Le contenu du CV structuré sera injecté ici -->
            </div>
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const copyBtn = document.getElementById('copy-btn');
        const actionButtons = document.getElementById('action-buttons');
        const promptInput = document.getElementById('prompt');
        const notificationDiv = document.getElementById('notification');
        const cvContainer = document.getElementById('cv-container');
        const cvPreview = document.getElementById('cv-preview');
        
        let cvFileName = 'cv.pdf';
        let originalRawText = ''; // Pour stocker le texte brut de l'API utilisateur

        function notify(message, type = 'info') {
            notificationDiv.innerHTML = '';
            const p = document.createElement('p');
            p.innerHTML = message;
            const colors = { error: 'text-red-500', success: 'text-green-600', info: 'text-gray-500' };
            p.className = `${colors[type]} font-medium transition-opacity duration-300`;
            notificationDiv.appendChild(p);
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="loader"></div><span class="ml-2">Génération en cours...</span>';
                cvContainer.style.display = 'none';
                actionButtons.style.display = 'none';
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>Générer le CV';
            }
        }

        async function handleGenerateCV() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                notify("Veuillez décrire le CV que vous souhaitez générer.", 'error');
                return;
            }

            setLoadingState(true);
            
            try {
                // --- Étape 1: Obtenir le texte brut de l'API de l'utilisateur ---
                notify("Étape 1/2 : Récupération du contenu du CV...", 'info');
                const rawTextResponse = await fetch("https://simulateur-ltd.onrender.com/api/gemini", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: userPrompt })
                });
                if (!rawTextResponse.ok) throw new Error(`Erreur de l'API source: ${rawTextResponse.statusText}`);
                const rawData = await rawTextResponse.json();
                if (!rawData.response) throw new Error(rawData.error || "L'API source n'a pas retourné de contenu.");
                originalRawText = rawData.response;

                // --- Étape 2: Structurer le texte brut avec l'API Gemini ---
                notify("Étape 2/2 : Mise en page professionnelle du CV...", 'info');
                const structuringPrompt = `Analyse le texte de CV suivant et transforme-le en un objet JSON valide. Le JSON doit avoir cette structure exacte : {"name": "string", "title": "string", "contact": {"email": "string", "phone": "string", "address": "string", "linkedin": "string (URL complète si présente)"}, "summary": "string", "experience": [{"title": "string", "company": "string", "dates": "string", "description": "string (conserve les sauts de ligne)"}], "education": [{"degree": "string", "school": "string", "dates": "string"}], "skills": ["string"]}. Ne renvoie rien d'autre que l'objet JSON. Voici le texte du CV : \n\n${originalRawText}`;
                
                const chatHistory = [{ role: "user", parts: [{ text: structuringPrompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; // Géré par l'environnement
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const structuredResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!structuredResponse.ok) throw new Error(`Erreur de l'API de structuration: ${structuredResponse.statusText}`);
                
                const result = await structuredResponse.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    let jsonString = result.candidates[0].content.parts[0].text;
                    jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();
                    const cvData = JSON.parse(jsonString);
                    renderProfessionalCV(cvData);
                    notify("CV professionnel généré avec succès !", 'success');
                } else {
                    throw new Error("La réponse de l'API de structuration est malformée.");
                }

            } catch (err) {
                console.error("Erreur lors de la génération du CV:", err);
                notify(`Une erreur est survenue: ${err.message}`, 'error');
                // En cas d'erreur, afficher le texte brut pour ne pas bloquer l'utilisateur
                if(originalRawText) renderCVAsFallback(originalRawText);
            } finally {
                setLoadingState(false);
            }
        }

        function renderProfessionalCV(data) {
            cvFileName = `CV_${(data.name || 'Candidat').replace(/\s+/g, '_')}.pdf`;
            const { name, title, contact, summary, experience, education, skills } = data;

            const contactHTML = `
                <div class="flex flex-col items-center text-center text-sm text-gray-600 space-y-1">
                    ${contact.phone ? `<div>${contact.phone}</div>` : ''}
                    ${contact.email ? `<div>${contact.email}</div>` : ''}
                    ${contact.address ? `<div>${contact.address}</div>` : ''}
                    ${contact.linkedin ? `<div><a href="${contact.linkedin}" class="text-blue-600 hover:underline">Profil LinkedIn</a></div>` : ''}
                </div>`;

            const summaryHTML = summary ? `
                <section class="mb-6">
                    <h2 class="cv-section-title">
                        <svg class="cv-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        Profil
                    </h2>
                    <p class="text-sm text-gray-700 leading-relaxed">${summary}</p>
                </section>` : '';

            const experienceHTML = experience?.length ? `
                <section class="mb-6">
                    <h2 class="cv-section-title">
                        <svg class="cv-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L8.6 3.3a2 2 0 0 0-1.7-1H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"></path></svg>
                        Expérience Professionnelle
                    </h2>
                    <div class="space-y-4">
                        ${experience.map(exp => `
                            <div class="text-sm">
                                <h3 class="font-bold text-gray-800">${exp.title}</h3>
                                <p class="font-semibold text-gray-600">${exp.company} | <span class="font-normal">${exp.dates}</span></p>
                                <div class="mt-1 text-gray-700 whitespace-pre-wrap">${exp.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </section>` : '';

            const educationHTML = education?.length ? `
                <section class="mb-6">
                    <h2 class="cv-section-title">
                        <svg class="cv-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="m4 6 8-4 8 4-8 4-8-4Z"></path><path d="m12 14 8 4-8 4-8-4Z"></path><path d="M4 14v-4c0 1.5.4 2.9 1.2 4"></path><path d="M20 14v-4c0 1.5-.4 2.9-1.2 4"></path></svg>
                        Formation
                    </h2>
                    <div class="space-y-3">
                        ${education.map(edu => `
                             <div class="text-sm">
                                <h3 class="font-bold text-gray-800">${edu.degree}</h3>
                                <p class="font-semibold text-gray-600">${edu.school} | <span class="font-normal">${edu.dates}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </section>` : '';
            
            const skillsHTML = skills?.length ? `
                <section>
                    <h2 class="cv-section-title">
                       <svg class="cv-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                        Compétences
                    </h2>
                    <div class="flex flex-wrap gap-2">
                        ${skills.map(skill => `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">${skill}</span>`).join('')}
                    </div>
                </section>` : '';

            cvPreview.innerHTML = `
                <header class="text-center mb-6">
                    <h1 class="text-4xl font-bold text-gray-900 tracking-tight">${name || 'Nom du Candidat'}</h1>
                    <p class="text-xl font-medium text-blue-700 mt-1">${title || 'Titre du Poste'}</p>
                    <div class="mt-3">${contactHTML}</div>
                </header>
                <main>
                    ${summaryHTML}
                    ${experienceHTML}
                    ${educationHTML}
                    ${skillsHTML}
                </main>
            `;
            showCvContainer();
        }
        
        // Fonction de secours si la structuration échoue
        function renderCVAsFallback(textContent) {
            cvPreview.innerHTML = `<div class="p-12 text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">${textContent}</div>`;
            showCvContainer();
        }
        
        function showCvContainer() {
            cvContainer.style.display = 'block';
            actionButtons.style.display = 'block';
            setTimeout(() => {
                cvContainer.style.opacity = 1;
                actionButtons.style.opacity = 1;
            }, 10);
        }

        function handleDownloadPDF() {
            notify('Préparation du PDF...', 'info');
            const element = document.getElementById('cv-preview-wrapper');
            const opt = {
              margin: 0,
              filename: cvFileName,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 4, letterRendering: true, useCORS: true },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().from(element).set(opt).save().then(() => {
                notify('PDF téléchargé avec succès !', 'success');
            }).catch(err => notify('Erreur lors du téléchargement.', 'error'));
        }

        function handleCopyText() {
            if (!originalRawText) {
                notify('Rien à copier.', 'error');
                return;
            }
            const textArea = document.createElement('textarea');
            textArea.value = originalRawText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                notify('Texte original copié dans le presse-papiers !', 'success');
            } catch (err) {
                notify('La copie a échoué.', 'error');
            }
            document.body.removeChild(textArea);
        }

        generateBtn.addEventListener('click', handleGenerateCV);
        downloadBtn.addEventListener('click', handleDownloadPDF);
        copyBtn.addEventListener('click', handleCopyText);

    </script>
</body>
</html>
