<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Studio CV IA - Éditeur de CV Professionnel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        #cv-preview-wrapper {
            width: 210mm; min-height: 297mm; background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: 0 auto;
            transition: all 0.3s ease-in-out;
        }
        .hidden-initially { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #ffffff;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .draggable { cursor: grab; user-select: none; position: relative; }
        .dragging { opacity: 0.5; }
        
        [contenteditable]:focus { outline: 2px solid #3b82f6; background-color: #eff6ff; border-radius: 3px; }
        .delete-section-btn {
            position: absolute; top: 8px; right: 8px; background-color: #ef4444; color: white;
            border-radius: 9999px; width: 20px; height: 20px; font-size: 12px;
            display: none; align-items: center; justify-content: center;
            cursor: pointer; transition: opacity 0.2s; z-index: 10;
        }
        .draggable:hover .delete-section-btn { display: flex; }
        .photo-upload-area { cursor: pointer; }
        .photo-upload-area:hover { background-color: #e0e0e0 !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start px-4 py-10">

    <!-- Section de contrôle principale (visible au début) -->
    <div id="main-controls" class="w-full max-w-2xl bg-white shadow-lg rounded-xl p-8 mb-8 transition-all duration-500">
        <div class="flex items-center justify-center gap-3 mb-2">
            <svg class="h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h6z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M3 15h6"/><path d="M6 12v6"/><path d="M15 18h-2a2 2 0 0 0-2 2v2H9a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2"/></svg>
            <h1 class="text-4xl font-bold text-center text-gray-800">Studio CV IA</h1>
        </div>
        <p class="text-center text-gray-500 mb-8">Créez un CV professionnel et moderne en quelques secondes.</p>
        <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">Décrivez le CV que vous souhaitez :</label>
        <textarea id="prompt" placeholder="Exemple : Un CV pour une développeuse web full-stack avec 3 ans d'expérience sur React et Node.js, incluant des projets sur GitHub."
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 mb-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
        <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm hover:shadow-md text-lg">
            Lancer le Studio
        </button>
        <div id="notification" class="mt-4 text-center text-sm min-h-[20px]"></div>
    </div>

    <!-- Layout principal : Editeur + Preview (caché au début) -->
    <div id="editor-layout" class="w-full max-w-screen-2xl mx-auto hidden-initially">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Panneau d'édition latéral -->
            <aside id="editor-panel" class="w-full lg:w-96 bg-white rounded-lg shadow-md p-6 h-fit lg:sticky top-8">
                <h2 class="text-xl font-bold text-center text-gray-700 mb-6">Studio d'Édition</h2>
                <div class="space-y-6">
                    <!-- Actions rapides -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Actions IA</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="a4-check-btn" class="bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-purple-700 text-sm">Ajuster pour A4</button>
                            <button id="translate-btn" class="bg-orange-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-orange-600 text-sm">Traduire (EN/FR)</button>
                        </div>
                    </div>
                     <!-- Modèles -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Modèles</h3>
                        <div id="design-templates" class="grid grid-cols-3 gap-2">
                            <img src="https://placehold.co/100x141/1f2937/dbeafe?text=Prestige" data-index="0" class="cursor-pointer rounded border-2 border-blue-500" alt="Modèle Prestige">
                            <img src="https://placehold.co/100x141/ffffff/60a5fa?text=Moderne" data-index="1" class="cursor-pointer rounded border-2 border-transparent" alt="Modèle Moderne">
                            <img src="https://placehold.co/100x141/4f46e5/c7d2fe?text=Créatif" data-index="2" class="cursor-pointer rounded border-2 border-transparent" alt="Modèle Créatif">
                        </div>
                    </div>
                     <!-- Outils de Style -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Style du Document</h3>
                        <div class="space-y-4">
                            <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Taille Titres</label><input type="range" id="title-size-slider" min="16" max="32" value="24" class="w-full"></div>
                            <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Taille Texte</label><input type="range" id="body-size-slider" min="9" max="14" value="10" class="w-full"></div>
                            <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Marges</label><input type="range" id="margin-slider" min="10" max="30" value="20" class="w-full"></div>
                            <div class="flex gap-4 items-center">
                                 <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Couleur 1</label><input type="color" id="color1-picker" value="#1f2937" class="w-12 h-10 border-none rounded cursor-pointer"></div>
                                 <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Couleur 2</label><input type="color" id="color2-picker" value="#3b82f6" class="w-12 h-10 border-none rounded cursor-pointer"></div>
                            </div>
                        </div>
                    </div>
                     <!-- Gestion des sections -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Sections</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="add-section-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-lg hover:bg-gray-300 text-sm">Ajouter Section</button>
                            <button id="anonymize-btn" class="bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-slate-700 text-sm">Anonymiser</button>
                            <button id="restore-btn" class="bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600 text-sm col-span-2">Restaurer l'Original</button>
                        </div>
                    </div>
                     <!-- Actions finales -->
                     <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Finaliser</h3>
                        <button id="download-btn" class="w-full bg-green-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-700">Télécharger en PDF</button>
                    </div>
                </div>
            </aside>
            <!-- Prévisualisation du CV -->
            <div id="cv-container" class="flex-1">
                <div id="cv-preview-wrapper">
                    <div id="cv-preview"></div>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="photo-upload" class="hidden" accept="image/*">

    <script>
        // --- DOM Elements ---
        const allElements = {
            generateBtn: document.getElementById('generate-btn'),
            downloadBtn: document.getElementById('download-btn'),
            summarizeBtn: document.getElementById('a4-check-btn'),
            translateBtn: document.getElementById('translate-btn'),
            designBtnContainer: document.getElementById('design-templates'),
            anonymizeBtn: document.getElementById('anonymize-btn'),
            restoreBtn: document.getElementById('restore-btn'),
            addSectionBtn: document.getElementById('add-section-btn'),
            editorLayout: document.getElementById('editor-layout'),
            mainControls: document.getElementById('main-controls'),
            promptInput: document.getElementById('prompt'),
            notificationDiv: document.getElementById('notification'),
            cvPreview: document.getElementById('cv-preview'),
            titleSizeSlider: document.getElementById('title-size-slider'),
            bodySizeSlider: document.getElementById('body-size-slider'),
            marginSlider: document.getElementById('margin-slider'),
            color1Picker: document.getElementById('color1-picker'),
            color2Picker: document.getElementById('color2-picker'),
            photoUploadInput: document.getElementById('photo-upload'),
        };
        
        // --- State Management ---
        let originalCvData = null, currentCvData = null, originalRawText = '', currentDesignIndex = 0, styleConfig = {}, currentLang = 'fr';

        function resetStyleConfig() {
            styleConfig = {
                titleSize: 24, bodySize: 10, margin: 20,
                color1: '#1f2937', color2: '#3b82f6',
                blockOrder: ['summary', 'experience', 'education'],
                photo: null, customSections: {}
            };
            allElements.titleSizeSlider.value = styleConfig.titleSize;
            allElements.bodySizeSlider.value = styleConfig.bodySize;
            allElements.marginSlider.value = styleConfig.margin;
            allElements.color1Picker.value = styleConfig.color1;
            allElements.color2Picker.value = styleConfig.color2;
        }

        function notify(message, type = 'info') {
            allElements.notificationDiv.innerHTML = '';
            const p = document.createElement('p');
            p.innerHTML = message;
            const colorClasses = { error: 'text-red-500', success: 'text-green-600', info: 'text-gray-500' };
            p.className = `${colorClasses[type]} font-medium transition-opacity duration-300`;
            allElements.notificationDiv.appendChild(p);
        }

        function setLoadingState(isLoading, button) {
            if (isLoading) {
                button.dataset.originalHtml = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<div class="loader"></div><span class="ml-2">Chargement...</span>';
            } else {
                button.disabled = false;
                if (button.dataset.originalHtml) button.innerHTML = button.dataset.originalHtml;
            }
        }
        
        function parseCvTextLocally(text) {
            const cvData = { name: '', title: '', contact: { email: '', phone: '', address: '', linkedin: '' }, summary: '', experience: [], education: [], skills: [], languages: [], customSections: {} };
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length > 0) cvData.name = lines.shift().replace(/[*#]/g, '').trim();
            if (lines.length > 0 && lines[0].length < 60 && !lines[0].includes(':')) cvData.title = lines.shift().replace(/[*#]/g, '').trim();
            const sectionKeywords = { summary: /Profil|Résumé|À propos/i, experience: /Expérience|Parcours Professionnel/i, education: /Formation|Éducation/i, skills: /Compétences/i, contact: /Contact|Coordonnées/i, languages: /Langues/i };
            let currentSection = 'contact';
            let sections = { contact: '' };
            for (const line of lines) {
                let isNewSection = false;
                for (const key in sectionKeywords) {
                    if (sectionKeywords[key].test(line)) { currentSection = key; sections[currentSection] = ''; isNewSection = true; break; }
                }
                if (!isNewSection && currentSection) sections[currentSection] += line + '\n';
            }
            const contactText = sections.contact || text;
            cvData.contact.email = (contactText.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/) || [])[0] || '';
            cvData.contact.phone = (contactText.match(/(\+33|0)[1-9]([ .-]?[0-9]{2}){4}/) || [])[0] || '';
            cvData.contact.address = (contactText.match(/(?:\d{1,5}\s[\w\s]{1,50},?\s\d{5}\s[\w\s-]{1,50})/) || [])[0] || '';
            cvData.contact.linkedin = (contactText.match(/linkedin\.com\/in\/[a-zA-Z0-9-]+/) || [])[0] || '';
            if (sections.summary) cvData.summary = sections.summary.trim();
            if (sections.skills) cvData.skills = sections.skills.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            if (sections.languages) cvData.languages = sections.languages.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            if (sections.experience) {
                const entries = sections.experience.trim().split(/\n\s*\n/);
                entries.forEach(entry => {
                    const lines = entry.split('\n');
                    const titleLine = lines.shift() || '';
                    const companyLine = lines.shift() || '';
                    const description = lines.slice(0).join('\n').replace(/^[-*]\s*/gm, '').trim();
                    const [company, dates] = (companyLine || '').split('|').map(s => s.trim());
                    cvData.experience.push({ title: titleLine.replace(/^[-*]\s*/, '').trim(), company: company || '', dates: dates || '', description });
                });
            }
            if (sections.education) {
                 const entries = sections.education.trim().split(/\n\s*\n/);
                 entries.forEach(entry => {
                     const lines = entry.split('\n');
                     const degree = lines.shift() || '';
                     const schoolLine = lines.shift() || '';
                     const [school, dates] = (schoolLine || '').split('|').map(s => s.trim());
                     cvData.education.push({ degree, school: school || '', dates: dates || '' });
                });
            }
            return cvData;
        }

        async function handleGenerateCV() {
            const userPrompt = allElements.promptInput.value.trim();
            if (!userPrompt) { notify("Veuillez décrire le CV que vous souhaitez générer.", 'error'); return; }
            setLoadingState(true, allElements.generateBtn);
            notify("Génération de votre CV...", 'info');
            const finalPrompt = `Rédige un CV complet et professionnel en FRANÇAIS basé sur la description suivante : "${userPrompt}". La réponse doit être uniquement le texte du CV, sans aucun commentaire ou phrase d'introduction.`;
            try {
                const response = await fetch("https://simulateur-ltd.onrender.com/api/gemini", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: finalPrompt }) });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Erreur de l'API: ${response.status}. ${errorBody}`);
                }
                const data = await response.json();
                if (!data.response) throw new Error(data.error || "La réponse de l'API est vide.");
                originalRawText = data.response;
                currentLang = 'fr';
                try {
                    originalCvData = parseCvTextLocally(originalRawText);
                    currentCvData = JSON.parse(JSON.stringify(originalCvData));
                    resetStyleConfig();
                    renderCV();
                    notify("CV professionnel généré avec succès !", 'success');
                } catch (parseError) {
                    console.error("Erreur de l'analyse locale:", parseError);
                    notify("La mise en page pro a échoué. Affichage du texte brut.", 'error');
                    renderCVAsFallback(originalRawText);
                }
            } catch (err) {
                console.error("Erreur lors de la génération:", err);
                notify(`Une erreur est survenue: ${err.message}`, 'error');
            } finally {
                setLoadingState(false, allElements.generateBtn);
            }
        }

        // --- Action Handlers ---
        async function handleApiAction(button, prompt) {
            if (!originalCvData) { notify("Veuillez d'abord générer un CV.", 'error'); return null; }
            setLoadingState(true, button);
            try {
                const response = await fetch("https://simulateur-ltd.onrender.com/api/gemini", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt }) });
                if (!response.ok) throw new Error(`Erreur de l'API: ${response.status}.`);
                const data = await response.json();
                if (!data.response) throw new Error("La réponse de l'API est vide.");
                return data.response;
            } catch (err) {
                notify(`L'action a échoué: ${err.message}`, "error");
                return null;
            } finally {
                setLoadingState(false, button);
            }
        }
        async function handleSummarize() {
            notify("Synthèse par IA en cours...", 'info');
            const prompt = `Synthétise le contenu de ce CV en FRANÇAIS. Pour chaque expérience, réduis la description à 2 points essentiels maximum. Garde les autres informations intactes. Voici le texte : \n\n${originalRawText}`;
            const summarizedText = await handleApiAction(allElements.summarizeBtn, prompt);
            if (summarizedText) {
                currentCvData = parseCvTextLocally(summarizedText);
                renderCV();
                notify("CV synthétisé avec succès !", "success");
            }
        }
        async function handleTranslate() {
            const targetLang = currentLang === 'fr' ? 'anglais' : 'français';
            const targetLangCode = currentLang === 'fr' ? 'en' : 'fr';
            notify(`Traduction en ${targetLang}...`, 'info');
            const prompt = `Traduis ce CV en ${targetLang}. Conserve la structure et le formatage. Texte: \n\n${JSON.stringify(currentCvData)}`;
            const translatedText = await handleApiAction(allElements.translateBtn, prompt);
            if (translatedText) {
                currentCvData = parseCvTextLocally(translatedText);
                currentLang = targetLangCode;
                renderCV();
                notify(`CV traduit en ${targetLang} !`, "success");
            }
        }
        function handleAnonymize() {
            if (!currentCvData) return;
            const anonymizedData = JSON.parse(JSON.stringify(currentCvData));
            const nameParts = (anonymizedData.name || '').split(' ');
            anonymizedData.name = `${nameParts[0]} ${nameParts.length > 1 ? nameParts[nameParts.length - 1].charAt(0) + '.' : ''}`;
            anonymizedData.contact = { email: 'confidentiel', phone: 'confidentiel', address: 'confidentiel', linkedin: '' };
            currentCvData = anonymizedData;
            renderCV();
            notify("CV anonymisé.", "info");
        }
        function handleRestore() {
            if (!originalCvData) return;
            currentCvData = JSON.parse(JSON.stringify(originalCvData));
            resetStyleConfig();
            renderCV();
            notify("CV original restauré.", "success");
        }
        function handleChangeDesign(e) {
            if (!currentCvData || !e.target.closest('[data-index]')) return;
            currentDesignIndex = parseInt(e.target.closest('[data-index]').dataset.index);
            document.querySelectorAll('#design-templates img').forEach(img => img.classList.replace('border-blue-500', 'border-transparent'));
            e.target.closest('[data-index]').classList.replace('border-transparent', 'border-blue-500');
            renderCV();
        }
        function handleAddSection() {
            const title = prompt("Titre de la nouvelle section :");
            if (title && title.trim()) {
                const key = 'custom_' + Date.now();
                styleConfig.customSections[key] = { title: title.trim(), content: "Cliquez pour éditer le contenu de cette nouvelle section." };
                styleConfig.blockOrder.push(key);
                renderCV();
            }
        }
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { styleConfig.photo = e.target.result; renderCV(); };
                reader.readAsDataURL(file);
            }
        }
        function handleDeleteSection(key) {
            if (confirm("Voulez-vous vraiment supprimer cette section ?")) {
                styleConfig.blockOrder = styleConfig.blockOrder.filter(k => k !== key);
                if (key.startsWith('custom_')) {
                    delete styleConfig.customSections[key];
                } else {
                    currentCvData[key] = (Array.isArray(currentCvData[key])) ? [] : '';
                }
                renderCV();
            }
        }

        // --- Rendering ---
        const designTemplates = [renderDesignPrestige, renderDesignModern, renderDesignCreative];
        function renderCV() {
            if (!currentCvData) return;
            designTemplates[currentDesignIndex](currentCvData, styleConfig);
            addEditableHandlers();
            addDragAndDropHandlers();
            showEditorLayout();
        }
        function renderDesignPrestige(data, styles) {
            const { name, title, contact, summary, experience, education, skills, languages } = data;
            const mainSections = { summary, experience, education, ...styles.customSections };
            
            const photoHTML = `<div class="mx-auto mb-6 h-32 w-32 rounded-full bg-gray-300 photo-upload-area flex items-center justify-center text-gray-500 text-center text-xs" onclick="allElements.photoUploadInput.click()" style="${styles.photo ? `background-image: url(${styles.photo}); background-size: cover; background-position: center;` : ''}">${!styles.photo ? 'Ajouter Photo' : ''}</div>`;
            const contactHTML = `<section class="mb-8"><h2 class="text-sm font-semibold uppercase tracking-wider mb-4" style="color: var(--color2);">Contact</h2><div class="space-y-3 text-sm text-slate-300" style="font-size: ${styles.bodySize}px;">...</div></section>`;
            
            allElements.cvPreview.innerHTML = `
                <div class="flex min-h-[277mm]" style="--color1: ${styles.color1}; --color2: ${styles.color2}; --title-size: ${styles.titleSize}px; --body-size: ${styles.bodySize}px;">
                    <aside class="w-1/3 text-white p-8" style="background-color: var(--color1);">
                        ${photoHTML}
                        <div class="text-center mb-10">
                            <h1 data-key="name" class="font-bold text-white tracking-tight" style="font-size: ${styles.titleSize * 1.3}px;">${name || ''}</h1>
                            <p data-key="title" class="font-light mt-1" style="color: var(--color2); font-size: ${styles.titleSize * 0.7}px;">${title || ''}</p>
                        </div>
                        ${contactHTML}
                        ${skills && skills.length > 0 ? `<section class="mb-8"><h2 class="text-sm font-semibold uppercase tracking-wider mb-4" style="color: var(--color2);">Compétences</h2><div class="flex flex-wrap gap-2">${skills.map(skill => `<span class="text-xs font-medium px-2.5 py-1 rounded" style="background-color: var(--color2); color: var(--color1);">${skill}</span>`).join('')}</div></section>` : ''}
                        ${languages && languages.length > 0 ? `<section><h2 class="text-sm font-semibold uppercase tracking-wider mb-4" style="color: var(--color2);">Langues</h2><ul class="space-y-1 text-sm text-slate-300" style="font-size: ${styles.bodySize}px;">${languages.map(lang => `<li>${lang}</li>`).join('')}</ul></section>` : ''}
                        ${contact.linkedin ? `<canvas id="qr-code" class="mx-auto mt-4"></canvas>` : ''}
                    </aside>
                    <main class="w-2/3 p-8" id="main-content-area" style="font-size: ${styles.bodySize}px;">
                        ${styles.blockOrder.map(key => {
                            if (key === 'summary' && mainSections.summary) return `<section id="summary" draggable="true" class="draggable mb-8"><div class="delete-section-btn" onclick="handleDeleteSection('summary')">X</div><h2 class="font-bold tracking-tight border-b-2 pb-2" style="font-size: ${styles.titleSize}px; border-color: var(--color2); color: var(--color1);">Profil</h2><p data-key="summary" class="mt-4 text-slate-700 leading-relaxed">${mainSections.summary}</p></section>`;
                            if (key === 'experience' && mainSections.experience?.length) return `<section id="experience" draggable="true" class="draggable mb-8"><div class="delete-section-btn" onclick="handleDeleteSection('experience')">X</div><h2 class="font-bold tracking-tight border-b-2 pb-2" style="font-size: ${styles.titleSize}px; border-color: var(--color2); color: var(--color1);">Expérience</h2><div class="mt-4 space-y-6">${mainSections.experience.map((exp, i) => `<div><h3 data-key="experience.${i}.title" class="font-semibold" style="font-size: ${styles.bodySize * 1.2}px;">${exp.title}</h3><p class="font-medium text-slate-600"><span data-key="experience.${i}.company">${exp.company || ''}</span> <span class="text-slate-500 font-normal italic ml-2" data-key="experience.${i}.dates">${exp.dates || ''}</span></p><div data-key="experience.${i}.description" class="mt-2 text-slate-700 whitespace-pre-wrap">${exp.description}</div></div>`).join('')}</div></section>`;
                            if (key === 'education' && mainSections.education?.length) return `<section id="education" draggable="true" class="draggable"><div class="delete-section-btn" onclick="handleDeleteSection('education')">X</div><h2 class="font-bold tracking-tight border-b-2 pb-2" style="font-size: ${styles.titleSize}px; border-color: var(--color2); color: var(--color1);">Formation</h2><div class="mt-4 space-y-4">${mainSections.education.map((edu, i) => `<div><h3 data-key="education.${i}.degree" class="font-semibold" style="font-size: ${styles.bodySize * 1.2}px;">${edu.degree}</h3><p class="font-medium text-slate-600"><span data-key="education.${i}.school">${edu.school || ''}</span> <span class="text-slate-500 font-normal italic ml-2" data-key="education.${i}.dates">${edu.dates || ''}</span></p></div>`).join('')}</div></section>`;
                            if (key.startsWith('custom_')) return `<section id="${key}" draggable="true" class="draggable mb-8"><div class="delete-section-btn" onclick="handleDeleteSection('${key}')">X</div><h2 data-key="customSections.${key}.title" class="font-bold tracking-tight border-b-2 pb-2" style="font-size: ${styles.titleSize}px; border-color: var(--color2); color: var(--color1);">${mainSections[key].title}</h2><p data-key="customSections.${key}.content" class="mt-4 text-slate-700 leading-relaxed">${mainSections[key].content}</p></section>`;
                            return '';
                        }).join('')}
                    </main>
                </div>`;
            allElements.cvPreview.style.padding = '0';
            if (contact.linkedin) new QRious({ element: document.getElementById('qr-code'), value: `https://${contact.linkedin}`, background: 'transparent', foreground: 'white', size: 80 });
        }
        function renderDesignModern(data, styles) { /* ... implementation ... */ }
        function renderDesignCreative(data, styles) { /* ... implementation ... */ }
        function renderCVAsFallback(textContent) { /* ... implementation ... */ }
        function showEditorLayout() {
            allElements.mainControls.style.display = 'none';
            allElements.editorLayout.style.display = 'flex';
            setTimeout(() => { allElements.editorLayout.style.opacity = 1; }, 10);
        }

        // --- Interactivity Logic ---
        function addEditableHandlers() {
            allElements.cvPreview.querySelectorAll('[data-key]').forEach(el => {
                el.setAttribute('contenteditable', 'true');
                el.addEventListener('blur', (e) => {
                    const keys = e.target.dataset.key.split('.');
                    let dataRef = keys[0] === 'customSections' ? styleConfig : currentCvData;
                    for (let i = 0; i < keys.length - 1; i++) {
                        dataRef = dataRef[keys[i]] = dataRef[keys[i]] || (isNaN(keys[i+1]) ? {} : []);
                    }
                    dataRef[keys[keys.length - 1]] = e.target.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/&nbsp;/g, ' ');
                });
            });
        }
        function addDragAndDropHandlers() {
            const draggables = document.querySelectorAll('.draggable');
            const container = document.getElementById('main-content-area');
            if (!container) return;
            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
                draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
            });
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (dragging) { if (afterElement == null) { container.appendChild(dragging); } else { container.insertBefore(dragging, afterElement); } }
            });
            container.addEventListener('drop', () => {
                const newOrder = [...container.children].map(child => child.id).filter(Boolean);
                if (newOrder.length > 0) { styleConfig.blockOrder = newOrder; notify("Ordre des sections mis à jour.", "info"); }
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
                else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }
        function handleDownloadPDF() {
            notify('Préparation du PDF...', 'info');
            const element = document.getElementById('cv-preview-wrapper');
            const opt = { margin: 0, filename: `CV_${(currentCvData.name || 'Candidat').replace(/\s+/g, '_')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 4, letterRendering: true, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(element).set(opt).save().then(() => notify('PDF téléchargé avec succès !', 'success')).catch(err => notify('Erreur lors du téléchargement.', 'error'));
        }

        // --- Event Listeners ---
        allElements.generateBtn.addEventListener('click', handleGenerateCV);
        allElements.downloadBtn.addEventListener('click', handleDownloadPDF);
        allElements.summarizeBtn.addEventListener('click', handleSummarize);
        allElements.translateBtn.addEventListener('click', handleTranslate);
        allElements.designBtnContainer.addEventListener('click', handleChangeDesign);
        allElements.anonymizeBtn.addEventListener('click', handleAnonymize);
        allElements.restoreBtn.addEventListener('click', handleRestore);
        allElements.addSectionBtn.addEventListener('click', handleAddSection);
        allElements.photoUploadInput.addEventListener('change', handlePhotoUpload);
        [allElements.titleSizeSlider, allElements.bodySizeSlider, allElements.marginSlider, allElements.color1Picker, allElements.color2Picker].forEach(el => {
            el.addEventListener('input', (e) => {
                const keyMap = { 'title-size-slider': 'titleSize', 'body-size-slider': 'bodySize', 'margin-slider': 'margin', 'color1-picker': 'color1', 'color2-picker': 'color2' };
                const key = keyMap[e.target.id];
                if (key) { styleConfig[key] = e.target.value; renderCV(); }
            });
        });
        
        resetStyleConfig(); // Initial setup
    </script>
</body>
</html>
