<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Studio CV IA - Éditeur de CV Professionnel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        #cv-preview-wrapper {
            width: 210mm; min-height: 297mm; background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: 0 auto;
            transition: all 0.3s ease-in-out;
        }
        .hidden-initially { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #ffffff;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .draggable { cursor: grab; user-select: none; position: relative; }
        .dragging { opacity: 0.5; }
        .drag-over { border-top: 2px dashed #3b82f6; }
        
        [contenteditable]:focus { outline: 1px dashed #3b82f6; background-color: #eff6ff; }
        .delete-section-btn {
            position: absolute; top: 0; right: 0; background-color: #ef4444; color: white;
            border-radius: 9999px; width: 20px; height: 20px; font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
        }
        .draggable:hover .delete-section-btn { opacity: 1; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start px-4 py-10">

    <!-- Section de contrôle principale (visible au début) -->
    <div id="main-controls" class="w-full max-w-2xl bg-white shadow-lg rounded-xl p-8 mb-8 transition-all duration-500">
        <div class="flex items-center justify-center gap-3 mb-2">
            <svg class="h-10 w-10 text-blue-600" xmlns="http://www.w.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h6z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M3 15h6"/><path d="M6 12v6"/><path d="M15 18h-2a2 2 0 0 0-2 2v2H9a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2"/></svg>
            <h1 class="text-4xl font-bold text-center text-gray-800">Studio CV IA</h1>
        </div>
        <p class="text-center text-gray-500 mb-8">Créez un CV professionnel et moderne en quelques secondes.</p>
        <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">Décrivez le CV que vous souhaitez :</label>
        <textarea id="prompt" placeholder="Exemple : Un CV pour une développeuse web full-stack avec 3 ans d'expérience sur React et Node.js, incluant des projets sur GitHub."
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 mb-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
        <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm hover:shadow-md text-lg">
            Générer mon CV
        </button>
        <div id="notification" class="mt-4 text-center text-sm min-h-[20px]"></div>
    </div>

    <!-- Layout principal : Editeur + Preview (caché au début) -->
    <div id="editor-layout" class="w-full max-w-screen-2xl mx-auto hidden-initially">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Panneau d'édition latéral -->
            <aside id="editor-panel" class="w-full lg:w-96 bg-white rounded-lg shadow-md p-6 h-fit lg:sticky top-8">
                <h2 class="text-xl font-bold text-center text-gray-700 mb-6">Studio d'Édition</h2>
                <div class="space-y-6">
                    <!-- Actions rapides -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Actions Rapides</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="a4-check-btn" class="bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-purple-700 text-sm">Ajuster pour A4</button>
                            <button id="translate-btn" class="bg-orange-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-orange-600 text-sm">Traduire (EN/FR)</button>
                            <button id="anonymize-btn" class="bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-slate-700 text-sm">Anonymiser</button>
                            <button id="restore-btn" class="bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600 text-sm">Restaurer</button>
                        </div>
                    </div>
                     <!-- Modèles -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Modèles</h3>
                        <div id="design-templates" class="grid grid-cols-2 gap-3">
                            <img src="https://placehold.co/150x212/1f2937/dbeafe?text=Prestige" data-index="0" class="cursor-pointer rounded border-2 border-blue-500" alt="Modèle Prestige">
                            <img src="https://placehold.co/150x212/ffffff/60a5fa?text=Moderne" data-index="1" class="cursor-pointer rounded border-2 border-transparent" alt="Modèle Moderne">
                        </div>
                    </div>
                     <!-- Outils de Style -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Style du Document</h3>
                        <div class="space-y-4">
                            <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Taille Titres</label><input type="range" id="title-size-slider" min="16" max="32" value="24" class="w-full"></div>
                            <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Taille Texte</label><input type="range" id="body-size-slider" min="9" max="14" value="10" class="w-full"></div>
                            <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Marges</label><input type="range" id="margin-slider" min="10" max="30" value="20" class="w-full"></div>
                            <div class="flex gap-4 items-center">
                                 <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Couleur 1</label><input type="color" id="color1-picker" value="#1f2937" class="w-12 h-10 border-none rounded cursor-pointer"></div>
                                 <div class="space-y-1"><label class="block text-sm font-medium text-gray-600">Couleur 2</label><input type="color" id="color2-picker" value="#3b82f6" class="w-12 h-10 border-none rounded cursor-pointer"></div>
                            </div>
                        </div>
                    </div>
                     <!-- Gestion des sections -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Sections</h3>
                        <button id="add-section-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-3 rounded-lg hover:bg-gray-300 text-sm">Ajouter une section</button>
                    </div>
                     <!-- Actions finales -->
                     <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Finaliser</h3>
                        <button id="download-btn" class="w-full bg-green-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-700">Télécharger en PDF</button>
                    </div>
                </div>
            </aside>
            <!-- Prévisualisation du CV -->
            <div id="cv-container" class="flex-1">
                <div id="cv-preview-wrapper">
                    <div id="cv-preview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const allElements = {
            generateBtn: document.getElementById('generate-btn'),
            downloadBtn: document.getElementById('download-btn'),
            summarizeBtn: document.getElementById('a4-check-btn'),
            translateBtn: document.getElementById('translate-btn'),
            designBtnContainer: document.getElementById('design-templates'),
            anonymizeBtn: document.getElementById('anonymize-btn'),
            restoreBtn: document.getElementById('restore-btn'),
            addSectionBtn: document.getElementById('add-section-btn'),
            editorLayout: document.getElementById('editor-layout'),
            mainControls: document.getElementById('main-controls'),
            promptInput: document.getElementById('prompt'),
            notificationDiv: document.getElementById('notification'),
            cvPreview: document.getElementById('cv-preview'),
            titleSizeSlider: document.getElementById('title-size-slider'),
            bodySizeSlider: document.getElementById('body-size-slider'),
            marginSlider: document.getElementById('margin-slider'),
            color1Picker: document.getElementById('color1-picker'),
            color2Picker: document.getElementById('color2-picker'),
        };
        
        // --- State Management ---
        let originalCvData = null;
        let currentCvData = null;
        let originalRawText = '';
        let currentDesignIndex = 0;
        let styleConfig = {};

        function resetStyleConfig() {
            styleConfig = {
                titleSize: 24, bodySize: 10, margin: 20,
                color1: '#1f2937', color2: '#3b82f6',
                blockOrder: ['summary', 'experience', 'education'],
                photo: null,
                customSections: {}
            };
            allElements.titleSizeSlider.value = styleConfig.titleSize;
            allElements.bodySizeSlider.value = styleConfig.bodySize;
            allElements.marginSlider.value = styleConfig.margin;
            allElements.color1Picker.value = styleConfig.color1;
            allElements.color2Picker.value = styleConfig.color2;
        }

        function notify(message, type = 'info') {
            allElements.notificationDiv.innerHTML = '';
            const p = document.createElement('p');
            p.innerHTML = message;
            const colorClasses = { error: 'text-red-500', success: 'text-green-600', info: 'text-gray-500' };
            p.className = `${colorClasses[type]} font-medium transition-opacity duration-300`;
            allElements.notificationDiv.appendChild(p);
        }

        function setLoadingState(isLoading, button) {
            if (isLoading) {
                button.dataset.originalHtml = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<div class="loader"></div><span class="ml-2">Chargement...</span>';
            } else {
                button.disabled = false;
                if (button.dataset.originalHtml) {
                    button.innerHTML = button.dataset.originalHtml;
                }
            }
        }
        
        function parseCvTextLocally(text) {
            const cvData = { name: '', title: '', contact: { email: '', phone: '', address: '', linkedin: '' }, summary: '', experience: [], education: [], skills: [], languages: [] };
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length > 0) cvData.name = lines.shift().replace(/[*#]/g, '').trim();
            if (lines.length > 0 && lines[0].length < 60 && !lines[0].includes(':')) cvData.title = lines.shift().replace(/[*#]/g, '').trim();
            const sectionKeywords = { summary: /Profil|Résumé|À propos/i, experience: /Expérience|Parcours Professionnel/i, education: /Formation|Éducation/i, skills: /Compétences/i, contact: /Contact|Coordonnées/i, languages: /Langues/i };
            let currentSection = 'contact';
            let sections = { contact: '' };
            for (const line of lines) {
                let isNewSection = false;
                for (const key in sectionKeywords) {
                    if (sectionKeywords[key].test(line)) { currentSection = key; sections[currentSection] = ''; isNewSection = true; break; }
                }
                if (!isNewSection && currentSection) sections[currentSection] += line + '\n';
            }
            const contactText = sections.contact || text;
            cvData.contact.email = (contactText.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/) || [])[0] || '';
            cvData.contact.phone = (contactText.match(/(\+33|0)[1-9]([ .-]?[0-9]{2}){4}/) || [])[0] || '';
            cvData.contact.address = (contactText.match(/(?:\d{1,5}\s[\w\s]{1,50},?\s\d{5}\s[\w\s-]{1,50})/) || [])[0] || '';
            cvData.contact.linkedin = (contactText.match(/linkedin\.com\/in\/[a-zA-Z0-9-]+/) || [])[0] || '';
            if (sections.summary) cvData.summary = sections.summary.trim();
            if (sections.skills) cvData.skills = sections.skills.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            if (sections.languages) cvData.languages = sections.languages.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            if (sections.experience) {
                const entries = sections.experience.trim().split(/\n\s*\n/);
                entries.forEach(entry => {
                    const lines = entry.split('\n');
                    const titleLine = lines.shift() || '';
                    const companyLine = lines.shift() || '';
                    const description = lines.slice(0).join('\n').replace(/^[-*]\s*/gm, '').trim();
                    const [company, dates] = (companyLine || '').split('|').map(s => s.trim());
                    cvData.experience.push({ title: titleLine.replace(/^[-*]\s*/, '').trim(), company: company || '', dates: dates || '', description });
                });
            }
            if (sections.education) {
                 const entries = sections.education.trim().split(/\n\s*\n/);
                 entries.forEach(entry => {
                     const lines = entry.split('\n');
                     const degree = lines.shift() || '';
                     const schoolLine = lines.shift() || '';
                     const [school, dates] = (schoolLine || '').split('|').map(s => s.trim());
                     cvData.education.push({ degree, school: school || '', dates: dates || '' });
                });
            }
            return cvData;
        }

        async function handleGenerateCV() {
            const userPrompt = allElements.promptInput.value.trim();
            if (!userPrompt) { notify("Veuillez décrire le CV que vous souhaitez générer.", 'error'); return; }
            setLoadingState(true, allElements.generateBtn);
            notify("Génération de votre CV...", 'info');
            const finalPrompt = `Rédige un CV complet et professionnel en FRANÇAIS basé sur la description suivante : "${userPrompt}". La réponse doit être uniquement le texte du CV, sans aucun commentaire ou phrase d'introduction.`;
            try {
                const response = await fetch("https://simulateur-ltd.onrender.com/api/gemini", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: finalPrompt }) });
                if (!response.ok) throw new Error(`Erreur de l'API: ${response.status}.`);
                const data = await response.json();
                if (!data.response) throw new Error(data.error || "La réponse de l'API est vide.");
                originalRawText = data.response;
                try {
                    originalCvData = parseCvTextLocally(originalRawText);
                    currentCvData = JSON.parse(JSON.stringify(originalCvData));
                    resetStyleConfig();
                    renderCV();
                    notify("CV professionnel généré avec succès !", 'success');
                } catch (parseError) {
                    console.error("Erreur de l'analyse locale:", parseError);
                    notify("La mise en page pro a échoué. Affichage du texte brut.", 'error');
                    renderCVAsFallback(originalRawText);
                }
            } catch (err) {
                console.error("Erreur lors de la génération:", err);
                notify(`Une erreur est survenue: ${err.message}`, 'error');
            } finally {
                setLoadingState(false, allElements.generateBtn);
            }
        }

        // --- Action Handlers ---
        async function handleSummarize() { /* ... same as before ... */ }
        function handleAnonymize() { /* ... same as before ... */ }
        function handleRestore() { /* ... same as before ... */ }
        function handleChangeDesign(e) {
            if (!currentCvData || !e.target.closest('[data-index]')) return;
            currentDesignIndex = parseInt(e.target.closest('[data-index]').dataset.index);
            document.querySelectorAll('#design-templates img').forEach(img => img.classList.replace('border-blue-500', 'border-transparent'));
            e.target.closest('[data-index]').classList.replace('border-transparent', 'border-blue-500');
            renderCV();
        }
        async function handleTranslate() { /* ... new implementation needed ... */ }
        function handleAddSection() { /* ... new implementation needed ... */ }
        function handlePhotoUpload(event) { /* ... new implementation needed ... */ }

        // --- Rendering ---
        const designTemplates = [renderDesignPrestige, renderDesignModern];
        function renderCV() {
            if (!currentCvData) return;
            designTemplates[currentDesignIndex](currentCvData, styleConfig);
            addEditableHandlers();
            addDragAndDropHandlers();
            showEditorLayout();
        }
        function renderDesignPrestige(data, styles) { /* ... same as before, but with contenteditable="true" on text elements ... */ }
        function renderDesignModern(data, styles) { /* ... same as before, but with contenteditable="true" on text elements ... */ }
        function renderCVAsFallback(textContent) {
            allElements.cvPreview.innerHTML = `<div class="p-12 text-slate-800 text-sm leading-relaxed whitespace-pre-wrap">${textContent}</div>`;
            showEditorLayout();
        }
        function showEditorLayout() {
            allElements.mainControls.style.display = 'none';
            allElements.editorLayout.style.display = 'block';
            setTimeout(() => { allElements.editorLayout.style.opacity = 1; }, 10);
        }

        // --- Interactivity Logic ---
        function addEditableHandlers() { /* ... new implementation for contenteditable ... */ }
        function addDragAndDropHandlers() { /* ... same as before ... */ }
        function getDragAfterElement(container, y) { /* ... same as before ... */ }
        function handleDownloadPDF() { /* ... same as before ... */ }

        // --- Event Listeners ---
        allElements.generateBtn.addEventListener('click', handleGenerateCV);
        allElements.downloadBtn.addEventListener('click', handleDownloadPDF);
        allElements.summarizeBtn.addEventListener('click', handleSummarize);
        allElements.designBtnContainer.addEventListener('click', handleChangeDesign);
        allElements.anonymizeBtn.addEventListener('click', handleAnonymize);
        allElements.restoreBtn.addEventListener('click', handleRestore);
        // ... more listeners for new features
        
        resetStyleConfig(); // Initial setup
    </script>
</body>
</html>
