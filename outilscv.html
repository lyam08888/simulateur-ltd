<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Studio CV IA - Générateur de CV Professionnel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        #cv-preview-wrapper {
            width: 210mm;
            min-height: 297mm;
            background-color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin: 2rem auto;
            transition: all 0.3s ease-in-out;
        }
        .hidden-initially { display: none; opacity: 0; transition: opacity 0.5s ease; }
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .draggable { cursor: grab; user-select: none; }
        .dragging { opacity: 0.5; }
        .drag-over { border-top: 2px dashed #3b82f6; }

        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext {
            visibility: hidden; width: 160px; background-color: #555;
            color: #fff; text-align: center; border-radius: 6px;
            padding: 5px 0; position: absolute; z-index: 1;
            bottom: 125%; left: 50%; margin-left: -80px;
            opacity: 0; transition: opacity 0.3s; font-size: 12px;
        }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start px-4 py-10">

    <!-- Section de contrôle principale -->
    <div id="main-controls" class="w-full max-w-2xl bg-white shadow-lg rounded-xl p-8 mb-8 transition-all duration-500">
        <div class="flex items-center justify-center gap-3 mb-2">
            <svg class="h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2h6z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M3 15h6"/><path d="M6 12v6"/><path d="M15 18h-2a2 2 0 0 0-2 2v2H9a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2h2"/></svg>
            <h1 class="text-4xl font-bold text-center text-gray-800">Studio CV IA</h1>
        </div>
        <p class="text-center text-gray-500 mb-8">Créez un CV professionnel et moderne en quelques secondes.</p>
        <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">Décrivez le CV que vous souhaitez :</label>
        <textarea id="prompt" placeholder="Exemple : Un CV pour une développeuse web full-stack avec 3 ans d'expérience sur React et Node.js, incluant des projets sur GitHub."
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 mb-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>
        <button id="generate-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm hover:shadow-md text-lg">
            Générer mon CV
        </button>
        <div id="notification" class="mt-4 text-center text-sm min-h-[20px]"></div>
    </div>

    <!-- Layout principal : Editeur + Preview -->
    <div id="editor-layout" class="w-full max-w-7xl mx-auto hidden-initially">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Panneau d'édition latéral -->
            <aside id="editor-panel" class="w-full lg:w-1/3 bg-white rounded-lg shadow-md p-6 h-fit lg:sticky top-8">
                <h2 class="text-xl font-bold text-center text-gray-700 mb-6">Personnaliser</h2>
                <div class="space-y-6">
                    <!-- Actions rapides -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Actions Rapides</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="summarize-btn" class="bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-purple-700 text-sm">Synthétiser</button>
                            <button id="design-btn" class="bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-teal-700 text-sm">Changer Design</button>
                            <button id="anonymize-btn" class="bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-slate-700 text-sm">Anonymiser</button>
                            <button id="restore-btn" class="bg-gray-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-gray-600 text-sm">Restaurer</button>
                        </div>
                    </div>
                     <!-- Outils de Style -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Style du Document</h3>
                        <div class="space-y-4">
                            <div class="space-y-1">
                                <label class="block text-sm font-medium text-gray-600">Taille Titres</label>
                                <input type="range" id="title-size-slider" min="16" max="32" value="24" class="w-full">
                            </div>
                            <div class="space-y-1">
                                <label class="block text-sm font-medium text-gray-600">Taille Texte</label>
                                <input type="range" id="body-size-slider" min="9" max="14" value="10" class="w-full">
                            </div>
                            <div class="space-y-1">
                                <label class="block text-sm font-medium text-gray-600">Marges</label>
                                <input type="range" id="margin-slider" min="10" max="30" value="20" class="w-full">
                            </div>
                            <div class="flex gap-4 items-center">
                                 <div class="space-y-1">
                                    <label class="block text-sm font-medium text-gray-600">Couleur 1</label>
                                    <input type="color" id="color1-picker" value="#1f2937" class="w-12 h-10 border-none rounded cursor-pointer">
                                </div>
                                 <div class="space-y-1">
                                    <label class="block text-sm font-medium text-gray-600">Couleur 2</label>
                                    <input type="color" id="color2-picker" value="#3b82f6" class="w-12 h-10 border-none rounded cursor-pointer">
                                </div>
                                <div class="tooltip">
                                    <button id="a4-check-btn" class="bg-blue-100 text-blue-700 rounded-full h-8 w-8 flex items-center justify-center font-bold text-lg">?</button>
                                    <span class="tooltiptext">Ce bouton synthétise le texte via IA pour aider le CV à tenir sur une page A4.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                     <!-- Actions finales -->
                     <div>
                        <h3 class="text-md font-semibold text-gray-600 mb-3">Finaliser</h3>
                        <div class="flex flex-col space-y-3">
                            <button id="download-btn" class="bg-green-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-700">Télécharger en PDF</button>
                        </div>
                    </div>
                </div>
                <div class="text-center text-xs text-gray-500 mt-6">Glissez-déposez les sections dans le CV pour les réorganiser.</div>
            </aside>
            <!-- Prévisualisation du CV -->
            <div id="cv-container" class="w-full lg:w-2/3">
                <div id="cv-preview-wrapper">
                    <div id="cv-preview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const summarizeBtn = document.getElementById('summarize-btn');
        const designBtn = document.getElementById('design-btn');
        const anonymizeBtn = document.getElementById('anonymize-btn');
        const restoreBtn = document.getElementById('restore-btn');
        const editorLayout = document.getElementById('editor-layout');
        const promptInput = document.getElementById('prompt');
        const notificationDiv = document.getElementById('notification');
        const cvPreview = document.getElementById('cv-preview');
        const titleSizeSlider = document.getElementById('title-size-slider');
        const bodySizeSlider = document.getElementById('body-size-slider');
        const marginSlider = document.getElementById('margin-slider');
        const color1Picker = document.getElementById('color1-picker');
        const color2Picker = document.getElementById('color2-picker');
        
        // --- State Management ---
        let originalCvData = null;
        let currentCvData = null;
        let originalRawText = '';
        let currentDesignIndex = 0;
        let styleConfig = {};

        function resetStyleConfig() {
            styleConfig = {
                titleSize: 24, bodySize: 10, margin: 20,
                color1: '#1f2937', color2: '#3b82f6',
                blockOrder: ['summary', 'experience', 'education']
            };
            titleSizeSlider.value = styleConfig.titleSize;
            bodySizeSlider.value = styleConfig.bodySize;
            marginSlider.value = styleConfig.margin;
            color1Picker.value = styleConfig.color1;
            color2Picker.value = styleConfig.color2;
        }

        function notify(message, type = 'info') {
            notificationDiv.innerHTML = '';
            const p = document.createElement('p');
            p.innerHTML = message;
            const colorClasses = { error: 'text-red-500', success: 'text-green-600', info: 'text-gray-500' };
            p.className = `${colorClasses[type]} font-medium transition-opacity duration-300`;
            notificationDiv.appendChild(p);
        }

        function setLoadingState(isLoading, button) {
            if (isLoading) {
                button.dataset.originalHtml = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<div class="loader"></div><span class="ml-2">Chargement...</span>';
            } else {
                button.disabled = false;
                if (button.dataset.originalHtml) {
                    button.innerHTML = button.dataset.originalHtml;
                }
            }
        }
        
        function parseCvTextLocally(text) {
            const cvData = { name: '', title: '', contact: { email: '', phone: '', address: '', linkedin: '' }, summary: '', experience: [], education: [], skills: [], languages: [] };
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length > 0) cvData.name = lines.shift().replace(/[*#]/g, '').trim();
            if (lines.length > 0 && lines[0].length < 60 && !lines[0].includes(':')) cvData.title = lines.shift().replace(/[*#]/g, '').trim();
            const sectionKeywords = { summary: /Profil|Résumé|À propos/i, experience: /Expérience|Parcours Professionnel/i, education: /Formation|Éducation/i, skills: /Compétences/i, contact: /Contact|Coordonnées/i, languages: /Langues/i };
            let currentSection = 'contact';
            let sections = { contact: '' };
            for (const line of lines) {
                let isNewSection = false;
                for (const key in sectionKeywords) {
                    if (sectionKeywords[key].test(line)) { currentSection = key; sections[currentSection] = ''; isNewSection = true; break; }
                }
                if (!isNewSection && currentSection) sections[currentSection] += line + '\n';
            }
            const contactText = sections.contact || text;
            cvData.contact.email = (contactText.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/) || [])[0] || '';
            cvData.contact.phone = (contactText.match(/(\+33|0)[1-9]([ .-]?[0-9]{2}){4}/) || [])[0] || '';
            cvData.contact.address = (contactText.match(/(?:\d{1,5}\s[\w\s]{1,50},?\s\d{5}\s[\w\s-]{1,50})/) || [])[0] || '';
            cvData.contact.linkedin = (contactText.match(/linkedin\.com\/in\/[a-zA-Z0-9-]+/) || [])[0] || '';
            if (sections.summary) cvData.summary = sections.summary.trim();
            if (sections.skills) cvData.skills = sections.skills.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            if (sections.languages) cvData.languages = sections.languages.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            if (sections.experience) {
                const entries = sections.experience.trim().split(/\n\s*\n/);
                entries.forEach(entry => {
                    const lines = entry.split('\n');
                    const titleLine = lines.shift() || '';
                    const companyLine = lines.shift() || '';
                    const description = lines.slice(0).join('\n').replace(/^[-*]\s*/gm, '').trim();
                    const [company, dates] = (companyLine || '').split('|').map(s => s.trim());
                    cvData.experience.push({ title: titleLine.replace(/^[-*]\s*/, '').trim(), company: company || '', dates: dates || '', description });
                });
            }
            if (sections.education) {
                 const entries = sections.education.trim().split(/\n\s*\n/);
                 entries.forEach(entry => {
                     const lines = entry.split('\n');
                     const degree = lines.shift() || '';
                     const schoolLine = lines.shift() || '';
                     const [school, dates] = (schoolLine || '').split('|').map(s => s.trim());
                     cvData.education.push({ degree, school: school || '', dates: dates || '' });
                });
            }
            return cvData;
        }

        async function handleGenerateCV() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) { notify("Veuillez décrire le CV que vous souhaitez générer.", 'error'); return; }
            setLoadingState(true, generateBtn);
            notify("Génération de votre CV...", 'info');
            const finalPrompt = `Rédige un CV complet et professionnel en FRANÇAIS basé sur la description suivante : "${userPrompt}". La réponse doit être uniquement le texte du CV, sans aucun commentaire ou phrase d'introduction.`;
            try {
                const response = await fetch("https://simulateur-ltd.onrender.com/api/gemini", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: finalPrompt }) });
                if (!response.ok) throw new Error(`Erreur de l'API: ${response.status}.`);
                const data = await response.json();
                if (!data.response) throw new Error(data.error || "La réponse de l'API est vide.");
                originalRawText = data.response;
                try {
                    originalCvData = parseCvTextLocally(originalRawText);
                    currentCvData = JSON.parse(JSON.stringify(originalCvData));
                    resetStyleConfig();
                    renderCV();
                    notify("CV professionnel généré avec succès !", 'success');
                } catch (parseError) {
                    console.error("Erreur de l'analyse locale:", parseError);
                    notify("La mise en page pro a échoué. Affichage du texte brut.", 'error');
                    renderCVAsFallback(originalRawText);
                }
            } catch (err) {
                console.error("Erreur lors de la génération:", err);
                notify(`Une erreur est survenue: ${err.message}`, 'error');
            } finally {
                setLoadingState(false, generateBtn);
            }
        }

        // --- Action Handlers ---
        async function handleSummarize() {
            if (!originalCvData) { notify("Veuillez d'abord générer un CV.", 'error'); return; }
            setLoadingState(true, summarizeBtn);
            notify("Synthèse par IA en cours...", 'info');
            const summarizationPrompt = `Synthétise le contenu de ce CV en FRANÇAIS. Pour chaque expérience, réduis la description à 2 points essentiels maximum. Garde les autres informations intactes. Voici le texte : \n\n${originalRawText}`;
            try {
                const response = await fetch("https://simulateur-ltd.onrender.com/api/gemini", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ prompt: summarizationPrompt }) });
                if (!response.ok) throw new Error(`Erreur de l'API: ${response.status}.`);
                const data = await response.json();
                if (!data.response) throw new Error("La réponse de l'API de synthèse est vide.");
                currentCvData = parseCvTextLocally(data.response);
                renderCV();
                notify("CV synthétisé avec succès !", "success");
            } catch (err) {
                notify(`La synthèse a échoué: ${err.message}`, "error");
            } finally {
                 setLoadingState(false, summarizeBtn);
            }
        }
        function handleAnonymize() {
            if (!currentCvData) return;
            const anonymizedData = JSON.parse(JSON.stringify(currentCvData));
            const nameParts = (anonymizedData.name || '').split(' ');
            anonymizedData.name = `${nameParts[0]} ${nameParts.length > 1 ? nameParts[nameParts.length - 1].charAt(0) + '.' : ''}`;
            anonymizedData.contact = { email: 'confidentiel', phone: 'confidentiel', address: 'confidentiel', linkedin: '' };
            currentCvData = anonymizedData;
            renderCV();
            notify("CV anonymisé.", "info");
        }
        function handleRestore() {
            if (!originalCvData) return;
            currentCvData = JSON.parse(JSON.stringify(originalCvData));
            resetStyleConfig();
            renderCV();
            notify("CV original restauré.", "success");
        }
        function handleChangeDesign() {
            if (!currentCvData) return;
            currentDesignIndex = (currentDesignIndex + 1) % designTemplates.length;
            renderCV();
        }

        // --- Rendering ---
        const designTemplates = [renderDesignPrestige, renderDesignModern];
        function renderCV() {
            if (!currentCvData) return;
            designTemplates[currentDesignIndex](currentCvData, styleConfig);
            addDragAndDropHandlers();
            showEditorLayout();
        }
        function renderDesignPrestige(data, styles) {
            const { name, title, contact, summary, experience, education, skills, languages } = data;
            const mainSections = { summary, experience, education };
            
            const contactHTML = `<section class="mb-8"><h2 class="text-sm font-semibold uppercase tracking-wider mb-4" style="color: var(--color2);">Contact</h2><div class="space-y-3 text-sm text-slate-300" style="font-size: ${styles.bodySize}px;">${contact.email ? `<div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><span class="break-all">${contact.email}</span></div>` : ''}${contact.phone ? `<div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg><span>${contact.phone}</span></div>` : ''}${contact.address ? `<div class="flex items-start gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mt-1 flex-shrink-0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><span>${contact.address}</span></div>` : ''}${contact.linkedin ? `<div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg><a href="https://www.${contact.linkedin}" class="hover:underline">linkedin.com/in/...</a></div>` : ''}</div></section>`;
            cvPreview.innerHTML = `<div class="flex min-h-[277mm]" style="--color1: ${styles.color1}; --color2: ${styles.color2}; --title-size: ${styles.titleSize}px; --body-size: ${styles.bodySize}px;"><aside class="w-1/3 text-white p-8" style="background-color: var(--color1);"><div class="text-center mb-10"><h1 class="font-bold text-white tracking-tight" style="font-size: ${styles.titleSize * 1.3}px;">${name || ''}</h1><p class="font-light mt-1" style="color: var(--color2); font-size: ${styles.titleSize * 0.7}px;">${title || ''}</p></div>${contactHTML}${skills && skills.length > 0 ? `<section class="mb-8"><h2 class="text-sm font-semibold uppercase tracking-wider mb-4" style="color: var(--color2);">Compétences</h2><div class="flex flex-wrap gap-2">${skills.map(skill => `<span class="text-xs font-medium px-2.5 py-1 rounded" style="background-color: var(--color2); color: var(--color1);">${skill}</span>`).join('')}</div></section>` : ''}${languages && languages.length > 0 ? `<section><h2 class="text-sm font-semibold uppercase tracking-wider mb-4" style="color: var(--color2);">Langues</h2><ul class="space-y-1 text-sm text-slate-300" style="font-size: ${styles.bodySize}px;">${languages.map(lang => `<li>${lang}</li>`).join('')}</ul></section>` : ''}</aside><main class="w-2/3 p-8" id="main-content-area" style="font-size: ${styles.bodySize}px;">${styles.blockOrder.map(key => {if (key === 'summary' && mainSections.summary) return `<section id="summary" draggable="true" class="draggable mb-8"><h2 class="font-bold tracking-tight border-b-2 pb-2" style="font-size: ${styles.titleSize}px; border-color: var(--color2); color: var(--color1);">Profil</h2><p class="mt-4 text-slate-700 leading-relaxed">${mainSections.summary}</p></section>`;if (key === 'experience' && mainSections.experience?.length) return `<section id="experience" draggable="true" class="draggable mb-8"><h2 class="font-bold tracking-tight border-b-2 pb-2" style="font-size: ${styles.titleSize}px; border-color: var(--color2); color: var(--color1);">Expérience</h2><div class="mt-4 space-y-6">${mainSections.experience.map(exp => `<div><h3 class="font-semibold" style="font-size: ${styles.bodySize * 1.2}px;">${exp.title}</h3><p class="font-medium text-slate-600">${exp.company || ''} <span class="text-slate-500 font-normal italic ml-2">${exp.dates || ''}</span></p><div class="mt-2 text-slate-700 whitespace-pre-wrap">${exp.description}</div></div>`).join('')}</div></section>`;if (key === 'education' && mainSections.education?.length) return `<section id="education" draggable="true" class="draggable"><h2 class="font-bold tracking-tight border-b-2 pb-2" style="font-size: ${styles.titleSize}px; border-color: var(--color2); color: var(--color1);">Formation</h2><div class="mt-4 space-y-4">${mainSections.education.map(edu => `<div><h3 class="font-semibold" style="font-size: ${styles.bodySize * 1.2}px;">${edu.degree}</h3><p class="font-medium text-slate-600">${edu.school || ''} <span class="text-slate-500 font-normal italic ml-2">${edu.dates || ''}</span></p></div>`).join('')}</div></section>`;return '';}).join('')}</main></div>`;
            cvPreview.style.padding = '0';
        }
        function renderDesignModern(data, styles) {
             const { name, title, contact, summary, experience, education, skills, languages } = data;
             const mainSections = { summary, experience, education };
             const mainSectionTitle = "text-lg font-semibold uppercase tracking-wider mb-3 border-b-2 pb-2";
             cvPreview.innerHTML = `<div style="--color1: ${styles.color1}; --color2: ${styles.color2}; --title-size: ${styles.titleSize}px; --body-size: ${styles.bodySize}px; font-size: ${styles.bodySize}px;"><header class="text-center mb-10"><h1 class="font-bold text-slate-800 tracking-tight" style="font-size: ${styles.titleSize * 1.4}px; color: var(--color1);">${name || ''}</h1><p class="font-medium text-slate-600 mt-1" style="font-size: ${styles.titleSize * 0.8}px; color: var(--color2);">${title || ''}</p><div class="flex justify-center gap-6 mt-4 text-sm text-slate-500">${contact.email ? `<span>${contact.email}</span>` : ''}${contact.phone ? `<span>${contact.phone}</span>` : ''}${contact.address ? `<span>${contact.address}</span>` : ''}</div></header><main id="main-content-area">${styles.blockOrder.map(key => {if (key === 'summary' && mainSections.summary) return `<section id="summary" draggable="true" class="draggable mb-6"><h2 class="${mainSectionTitle}" style="border-color: var(--color2); color: var(--color1); font-size: ${styles.titleSize * 0.8}px;">Profil</h2><p class="mt-3 text-slate-700 leading-relaxed">${mainSections.summary}</p></section>`;if (key === 'experience' && mainSections.experience?.length) return `<section id="experience" draggable="true" class="draggable mb-6"><h2 class="${mainSectionTitle}" style="border-color: var(--color2); color: var(--color1); font-size: ${styles.titleSize * 0.8}px;">Expérience</h2><div class="space-y-5">${mainSections.experience.map(exp => `<div class="text-sm"><h3 class="font-bold text-slate-800" style="font-size: ${styles.bodySize * 1.1}px;">${exp.title}</h3><p class="font-semibold text-slate-600">${exp.company || ''} <span class="font-normal italic ml-2">${exp.dates || ''}</span></p><div class="mt-1 text-slate-700 whitespace-pre-wrap">${exp.description}</div></div>`).join('')}</div></section>`;if (key === 'education' && mainSections.education?.length) return `<section id="education" draggable="true" class="draggable mb-6"><h2 class="${mainSectionTitle}" style="border-color: var(--color2); color: var(--color1); font-size: ${styles.titleSize * 0.8}px;">Formation</h2><div class="space-y-3">${mainSections.education.map(edu => `<div class="text-sm"><h3 class="font-bold text-slate-800" style="font-size: ${styles.bodySize * 1.1}px;">${edu.degree}</h3><p class="text-slate-600">${edu.school || ''} <span class="italic ml-2">${edu.dates || ''}</span></p></div>`).join('')}</div></section>`;return '';}).join('')}<div class="grid grid-cols-2 gap-8">${skills && skills.length > 0 ? `<section><h2 class="${mainSectionTitle}" style="border-color: var(--color2); color: var(--color1); font-size: ${styles.titleSize * 0.8}px;">Compétences</h2><div class="flex flex-wrap gap-2 mt-3">${skills.map(skill => `<span class="bg-slate-200 text-slate-800 text-xs font-medium px-2.5 py-1 rounded-full">${skill}</span>`).join('')}</div></section>` : ''}${languages && languages.length > 0 ? `<section><h2 class="${mainSectionTitle}" style="border-color: var(--color2); color: var(--color1); font-size: ${styles.titleSize * 0.8}px;">Langues</h2><ul class="space-y-1 text-slate-700 list-disc list-inside mt-3">${languages.map(lang => `<li>${lang}</li>`).join('')}</ul></section>` : ''}</div></main></div>`;
            cvPreview.style.padding = `${styles.margin}mm`;
        }
        function renderCVAsFallback(textContent) { cvPreview.innerHTML = `<div class="p-12 text-slate-800 text-sm leading-relaxed whitespace-pre-wrap">${textContent}</div>`; showEditorLayout(); }
        function showEditorLayout() {
            editorLayout.style.display = 'block';
            setTimeout(() => { editorLayout.style.opacity = 1; }, 10);
        }

        // --- Drag & Drop Logic ---
        function addDragAndDropHandlers() {
            const draggables = document.querySelectorAll('.draggable');
            const container = document.getElementById('main-content-area');
            if (!container) return;
            draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
                draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
            });
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (dragging) { if (afterElement == null) { container.appendChild(dragging); } else { container.insertBefore(dragging, afterElement); } }
            });
            container.addEventListener('drop', () => {
                const newOrder = [...container.children].map(child => child.id).filter(Boolean);
                if (newOrder.length > 0) { styleConfig.blockOrder = newOrder; notify("Ordre des sections mis à jour.", "info"); }
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } 
                else { return closest; }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function handleDownloadPDF() {
            notify('Préparation du PDF...', 'info');
            const element = document.getElementById('cv-preview-wrapper');
            const opt = { margin: 0, filename: `CV_${(currentCvData.name || 'Candidat').replace(/\s+/g, '_')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 4, letterRendering: true, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(element).set(opt).save().then(() => notify('PDF téléchargé avec succès !', 'success')).catch(err => notify('Erreur lors du téléchargement.', 'error'));
        }

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGenerateCV);
        downloadBtn.addEventListener('click', handleDownloadPDF);
        summarizeBtn.addEventListener('click', handleSummarize);
        document.getElementById('a4-check-btn').addEventListener('click', handleSummarize);
        designBtn.addEventListener('click', handleChangeDesign);
        anonymizeBtn.addEventListener('click', handleAnonymize);
        restoreBtn.addEventListener('click', handleRestore);
        [titleSizeSlider, bodySizeSlider, marginSlider, color1Picker, color2Picker].forEach(el => {
            el.addEventListener('input', (e) => {
                const keyMap = { 'title-size-slider': 'titleSize', 'body-size-slider': 'bodySize', 'margin-slider': 'margin', 'color1-picker': 'color1', 'color2-picker': 'color2' };
                const key = keyMap[e.target.id];
                if (key) { styleConfig[key] = e.target.value; renderCV(); }
            });
        });
        
        resetStyleConfig(); // Initial setup
    </script>
</body>
</html>
