<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de CV Pro Avancé</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PDF & QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .cv-section, .cv-item, .cv-header {
            page-break-inside: avoid;
        }
        .dragging {
            opacity: 0.5;
            background-color: #eef2ff;
        }
        .drop-zone.drag-over {
            border-style: solid;
            border-color: #4f46e5;
            background-color: #f4f4f5;
        }
        /* Simple transition for accordion */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
            opacity: 0;
        }
        .accordion-content.open {
            max-height: 4000px; /* Increased max-height */
            opacity: 1;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: max-content;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 50;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            pointer-events: none;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #4f46e5;
            cursor: pointer;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="min-h-screen p-2 md:p-6"></div>

    <script type="module">
        // --- INITIAL DATA ---
        const initialCvData = {
            personal: {
                firstName: 'Alexandre',
                lastName: 'Dubois',
                title: 'Chef de Projet Digital',
                email: 'alex.dubois@email.com',
                phone: '+33 6 98 76 54 32',
                address: 'Lyon, France',
                summary: 'Chef de projet digital créatif et rigoureux, avec 8 ans d\'expérience dans la gestion de projets web et mobiles, de la conception à la mise en production. Passionné par l\'innovation et l\'optimisation de l\'expérience utilisateur.',
                onlineProfileUrl: ''
            },
            experiences: [
                { id: 1, company: 'Web Agency "La Crème"', position: 'Chef de Projet Senior', startDate: '2019', endDate: 'Présent', description: 'Pilotage de projets d\'envergure pour des clients grands comptes. Gestion des équipes de développement et de design. Responsable du respect des délais et des budgets.' }
            ],
            projects: [
                { id: 1, name: 'Refonte E-commerce', url: 'exemple.com', description: 'Direction de la refonte complète d\'une plateforme e-commerce, résultant en une augmentation de 25% des conversions.' }
            ],
            education: [
                { id: 1, institution: 'INSEEC Lyon', degree: 'Master en Management Digital', startDate: '2015', endDate: '2017', description: 'Spécialisation en stratégie digitale et gestion de projet.' }
            ],
            skills: [
                { id: 1, name: 'Gestion de Projet Agile', level: 5 },
                { id: 2, name: 'Scrum & Kanban', level: 5 },
                { id: 3, name: 'UX/UI Design', level: 4 },
                { id: 4, name: 'SEO/SEA', level: 4 },
            ],
            awards: [
                { id: 1, name: 'Trophée de l\'Innovation Digitale', issuer: 'Web Summit', date: '2021', description: 'Récompense pour un projet innovant de réalité augmentée en e-commerce.'}
            ],
            languages: [
                { id: 1, name: 'Français', level: 'Natif' },
                { id: 2, name: 'Anglais', level: 'Courant (C1)' }
            ],
            hobbies: [
                { id: 1, name: 'Photographie Urbaine', icon: 'camera' },
                { id: 2, name: 'Veille Technologique', icon: 'code' },
                { id: 3, name: 'Randonnée', icon: 'dumbbell' }
            ]
        };

        // --- CONFIGURATIONS ---
        const templates = { modern: { name: 'Moderne' }, classic: { name: 'Classique' }, creative: { name: 'Créatif' }, minimalist: { name: 'Minimaliste' }, tech: { name: 'Tech' } };
        const layouts = { single: { name: 'Une colonne' }, two: { name: 'Deux colonnes' } };
        const fonts = {
            sans: { name: 'Inter (Sans)', family: "'Inter', sans-serif" },
            serif: { name: 'Lora (Serif)', family: "'Lora', serif" },
            mono: { name: 'JetBrains Mono', family: "'JetBrains Mono', monospace" },
        };
        const colors = {
            indigo: { primary: '#4f46e5', secondary: '#eef2ff', accent: '#3730a3', textOnPrimary: '#ffffff' },
            blue: { primary: '#2563eb', secondary: '#eff6ff', accent: '#1d4ed8', textOnPrimary: '#ffffff' },
            green: { primary: '#059669', secondary: '#f0fdf4', accent: '#047857', textOnPrimary: '#ffffff' },
            purple: { primary: '#7c3aed', secondary: '#faf5ff', accent: '#6d28d9', textOnPrimary: '#ffffff' },
            red: { primary: '#dc2626', secondary: '#fef2f2', accent: '#b91c1c', textOnPrimary: '#ffffff' },
            gray: { primary: '#4b5563', secondary: '#f9fafb', accent: '#1f2937', textOnPrimary: '#ffffff' }
        };
        const hobbyIcons = ['code', 'book-open', 'camera', 'music', 'plane', 'dumbbell', 'paintbrush', 'heart', 'star', 'lightbulb'];

        // --- STATE MANAGEMENT ---
        let state = {};

        function setState(newState, render = true) {
            state = { ...state, ...newState };
            
            // Save to localStorage
            try {
                const stateToSave = { ...state };
                delete stateToSave.photo; // Don't save blob url
                localStorage.setItem('cvState_v3', JSON.stringify(stateToSave));
            } catch (error) {
                console.error("Could not save data:", error);
            }
            
            if(render) {
                renderApp();
            }
        }

        // --- RENDER FUNCTIONS ---
        
        function renderApp() {
            const appContainer = document.getElementById('app');
            appContainer.innerHTML = `
                <div class="max-w-screen-2xl mx-auto">
                    ${renderHeaderControls()}
                    <div id="main-content" class="grid ${state.previewMode ? 'grid-cols-1' : 'grid-cols-1 xl:grid-cols-[minmax(400px,1fr)_1.5fr]'} gap-8 items-start">
                        ${!state.previewMode ? `<div id="editor-panel" class="space-y-6 bg-white p-4 rounded-lg shadow-sm">${renderEditor()}</div>` : ''}
                        <div id="preview-panel" class="flex flex-col items-center sticky top-24">
                            ${renderPreviewControls()}
                            <div id="cv-outer-container" class="origin-top shadow-2xl transition-transform duration-300" style="transform: scale(${state.previewScale})">
                                ${renderCV()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            attachEventListeners();
            lucide.createIcons();
            generateVCardQR();
        }

        function renderHeaderControls() {
            return `
                <header class="bg-white rounded-xl shadow-md p-4 mb-6 flex flex-wrap justify-between items-center gap-4 sticky top-4 z-30">
                    <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="file-text" class="text-indigo-600"></i>Créateur de CV Pro</h1>
                    <div class="flex items-center flex-wrap gap-2">
                         <div class="tooltip">
                            <button id="randomize-design" class="p-2 rounded-lg transition-colors bg-purple-100 text-purple-700 hover:bg-purple-200">
                                <i data-lucide="sparkles" class="w-4 h-4"></i>
                            </button>
                            <span class="tooltip-text">Design Aléatoire (IA)</span>
                        </div>
                        <div class="tooltip">
                            <button id="toggle-anonymize" class="p-2 rounded-lg transition-colors ${state.isAnonymized ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'}">
                                <i data-lucide="shield-check" class="w-4 h-4"></i>
                            </button>
                            <span class="tooltip-text">${state.isAnonymized ? "Désanonymiser" : "Anonymiser"}</span>
                        </div>
                        <button id="toggle-preview-mode" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2 transition-colors">
                            <i data-lucide="eye" class="w-4 h-4"></i> <span class="hidden sm:inline">${state.previewMode ? 'Éditer' : 'Plein écran'}</span>
                        </button>
                        <button id="generate-pdf" ${state.isDownloadingPdf ? 'disabled' : ''} class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 transition-colors disabled:bg-indigo-300 w-[180px]">
                            ${state.isDownloadingPdf 
                                ? `<i data-lucide="loader-circle" class="animate-spin w-4 h-4"></i> Téléchargement...` 
                                : `<i data-lucide="download" class="w-4 h-4"></i> Télécharger PDF`
                            }
                        </button>
                    </div>
                </header>
            `;
        }

        function renderPreviewControls() {
            return `
                <div class="w-full flex justify-center items-center gap-2 mb-4 bg-white p-2 rounded-lg shadow-sm">
                    <div class="tooltip">
                        <button id="zoom-out" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                        <span class="tooltip-text">Zoom arrière</span>
                    </div>
                    <input type="range" id="zoom-slider" min="0.3" max="1.5" step="0.01" value="${state.previewScale}" class="w-32">
                    <div class="tooltip">
                        <button id="zoom-in" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
                        <span class="tooltip-text">Zoom avant</span>
                    </div>
                    <div class="tooltip">
                        <button id="zoom-reset" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="rotate-cw" class="w-4 h-4"></i></button>
                        <span class="tooltip-text">Réinitialiser</span>
                    </div>
                    <span class="text-sm font-mono text-gray-500">${Math.round(state.previewScale * 100)}%</span>
                </div>
            `;
        }

        // --- CV Rendering ---

        function renderCV() {
            const { cvData, activeTemplate, activeFont, backgroundColor, pagePadding, baseFontSize, lineHeight } = state;
            const personalDataForRender = state.isAnonymized
                ? { ...cvData.personal, lastName: `${cvData.personal.lastName.charAt(0)}.`, email: '', phone: '', address: '' }
                : cvData.personal;

            const getBlockComponent = (blockId) => {
                 switch(blockId) {
                    case 'personal': return renderCvHeader(personalDataForRender);
                    case 'experiences': return cvData.experiences?.length > 0 && visibilityCheck(blockId) ? renderExperiences() : '';
                    case 'projects': return cvData.projects?.length > 0 && visibilityCheck(blockId) ? renderProjects() : '';
                    case 'education': return cvData.education?.length > 0 && visibilityCheck(blockId) ? renderEducation() : '';
                    case 'awards': return cvData.awards?.length > 0 && visibilityCheck(blockId) ? renderAwards() : '';
                    case 'skills': return cvData.skills?.length > 0 && visibilityCheck(blockId) ? renderSkills() : '';
                    case 'languages': return cvData.languages?.length > 0 && visibilityCheck(blockId) ? renderLanguages() : '';
                    case 'hobbies': return cvData.hobbies?.length > 0 && visibilityCheck(blockId) ? renderHobbies() : '';
                    default: return '';
                }
            };

            const { left: leftColClass, right: rightColClass } = {
                'large-right': { left: 'w-1/3', right: 'w-2/3' },
                'equal': { left: 'w-1/2', right: 'w-1/2' },
                'large-left': { left: 'w-2/3', right: 'w-1/3' },
            }[state.columnRatio];

            let cvContent;
            if (state.activeLayout === 'two') {
                cvContent = `
                    <div class="flex h-full" style="gap: ${pagePadding}rem">
                        <div class="${leftColClass} flex flex-col">
                            ${state.columnAssignment.left.map(blockId => getBlockComponent(blockId)).join('')}
                        </div>
                        <div class="${rightColClass} flex flex-col">
                            ${state.columnAssignment.right.map(blockId => getBlockComponent(blockId)).join('')}
                        </div>
                    </div>
                `;
            } else {
                cvContent = `
                    ${getBlockComponent('personal')}
                    <div class="flex flex-col">
                        ${state.blockOrder.map(blockId => getBlockComponent(blockId)).join('')}
                    </div>
                `;
            }

            return `
                <div id="cv-preview-container" class="bg-white" style="width: 210mm; min-height: 297mm; box-sizing: border-box; overflow: hidden;">
                    <div id="cv-preview" class="text-gray-800 template-${activeTemplate}" style="font-family: ${fonts[activeFont].family}; background-color: ${backgroundColor}; box-sizing: border-box; width: 100%; height: 100%;">
                        <div class="h-full w-full flex flex-col relative" style="font-size: ${baseFontSize}pt; line-height: ${lineHeight}; padding: ${pagePadding}rem;">
                            <div class="flex-grow">${cvContent}</div>
                            ${state.showVCardQR && !state.isAnonymized ? '<div id="vcard-qr-code" class="absolute bottom-4 right-4 bg-white p-2 rounded-md shadow-lg"></div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderCvHeader(personalData) {
            const { sectionSpacing, photo, photoShape, nameFontSize, activeColor } = state;
            return `
                <div class="cv-header flex flex-col items-center text-center" style="margin-bottom: ${sectionSpacing}rem;">
                    ${photo && !state.isAnonymized ? `
                        <img src="${photo}" alt="User" class="mb-4 w-32 h-32 object-cover shadow-lg" style="border-radius: ${photoShape === 'round' ? '50%' : '0.75rem'};">
                    ` : ''}
                    <h1 class="font-bold mb-1 text-gray-900" style="font-size: ${nameFontSize}pt;">
                        ${personalData.firstName} ${personalData.lastName}
                    </h1>
                    <h2 class="text-xl mb-3 font-medium" style="color: ${colors[activeColor].primary};">
                        ${personalData.title}
                    </h2>
                    ${!state.isAnonymized ? `
                        <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-gray-600 mb-4 text-sm">
                            <div class="flex items-center gap-2"><i data-lucide="mail" class="w-3.5 h-3.5"></i>${personalData.email}</div>
                            <div class="flex items-center gap-2"><i data-lucide="phone" class="w-3.5 h-3.5"></i>${personalData.phone}</div>
                            <div class="flex items-center gap-2"><i data-lucide="map-pin" class="w-3.5 h-3.5"></i>${personalData.address}</div>
                        </div>
                    ` : ''}
                    <p class="text-gray-700 leading-relaxed max-w-3xl mx-auto">
                        ${personalData.summary}
                    </p>
                </div>
            `;
        }

        function renderSection(title, content) {
            const { sectionTitleStyle, activeColor, sectionTitleFontSize, sectionSpacing } = state;
            const titleStyles = {
                border: `border-b-2 pb-1`,
                background: `p-2 rounded-md`,
                simple: ``,
            };
            const titleColor = sectionTitleStyle === 'background' ? colors[activeColor].textOnPrimary : colors[activeColor].primary;
            const titleBg = sectionTitleStyle === 'background' ? colors[activeColor].primary : 'transparent';

            return `
                <div class="cv-section" style="margin-bottom: ${sectionSpacing}rem;">
                    <h3 class="font-bold mb-3 uppercase tracking-wider ${titleStyles[sectionTitleStyle]}" style="color: ${titleColor}; background-color: ${titleBg}; border-color: ${colors[activeColor].primary}; font-size: ${sectionTitleFontSize}pt;">
                        ${title}
                    </h3>
                    ${content}
                </div>
            `;
        }

        function renderExperiences() {
            const { cvData, itemSpacing, activeColor, visibility } = state;
            const content = `
                <div style="display: flex; flex-direction: column; gap: ${itemSpacing}rem;">
                    ${cvData.experiences.filter(exp => visibility.experiences[exp.id]).map(exp => `
                        <div class="cv-item">
                            <div class="flex justify-between items-start mb-1">
                                <div>
                                    <h4 class="font-semibold text-base">${exp.position}</h4>
                                    <p class="font-medium" style="color: ${colors[activeColor].accent};">${exp.company}</p>
                                </div>
                                <span class="font-mono whitespace-nowrap pl-4 text-sm text-gray-600">${exp.startDate} - ${exp.endDate}</span>
                            </div>
                            <p class="text-gray-600">${exp.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            return renderSection('Expérience Professionnelle', content);
        }
        
        function renderProjects() {
            const { cvData, itemSpacing, activeColor, visibility } = state;
            const content = `
                <div style="display: flex; flex-direction: column; gap: ${itemSpacing}rem;">
                    ${(cvData.projects || []).filter(p => visibility.projects[p.id]).map(p => `
                        <div class="cv-item">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="font-semibold text-base">${p.name}</h4>
                                ${p.url ? `<a href="${p.url}" target="_blank" rel="noopener noreferrer" class="font-mono text-sm" style="color: ${colors[activeColor].primary};">Voir le projet</a>` : ''}
                            </div>
                            <p class="text-gray-600">${p.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            return renderSection('Projets', content);
        }

        function renderEducation() {
            const { cvData, itemSpacing, activeColor, visibility } = state;
            const content = `
                <div style="display: flex; flex-direction: column; gap: ${itemSpacing}rem;">
                    ${cvData.education.filter(edu => visibility.education[edu.id]).map(edu => `
                        <div class="cv-item">
                            <div class="flex justify-between items-start mb-1">
                                <div>
                                    <h4 class="font-semibold text-base">${edu.degree}</h4>
                                    <p class="font-medium" style="color: ${colors[activeColor].accent};">${edu.institution}</p>
                                </div>
                                <span class="font-mono whitespace-nowrap pl-4 text-sm text-gray-600">${edu.startDate} - ${edu.endDate}</span>
                            </div>
                            <p class="text-gray-600">${edu.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            return renderSection('Formation', content);
        }

        function renderAwards() {
            const { cvData, itemSpacing, activeColor, visibility } = state;
            const content = `
                <div style="display: flex; flex-direction: column; gap: ${itemSpacing}rem;">
                    ${(cvData.awards || []).filter(a => visibility.awards[a.id]).map(award => `
                        <div class="cv-item">
                            <div class="flex justify-between items-start mb-1">
                                <div>
                                    <h4 class="font-semibold text-base">${award.name}</h4>
                                    <p class="font-medium" style="color: ${colors[activeColor].accent};">${award.issuer}</p>
                                </div>
                                <span class="font-mono whitespace-nowrap pl-4 text-sm text-gray-600">${award.date}</span>
                            </div>
                            <p class="text-gray-600">${award.description}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            return renderSection('Récompenses', content);
        }

        function renderSkills() {
            const { cvData, itemSpacing, skillDisplayStyle, activeColor } = state;
            const content = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6" style="gap-y: ${itemSpacing/2}rem;">
                    ${cvData.skills.map(skill => `
                        <div>
                            <span class="font-medium">${skill.name}</span>
                            ${skillDisplayStyle === 'stars' ? `
                                <div class="flex items-center mt-1">
                                    ${[...Array(5)].map((_, i) => `
                                        <i data-lucide="star" class="w-4 h-4 ${i < skill.level ? 'fill-current' : ''}" style="color: ${i < skill.level ? colors[activeColor].primary : '#e0e0e0'};"></i>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                    <div class="h-2 rounded-full" style="width: ${skill.level * 20}%; background-color: ${colors[activeColor].primary};"></div>
                                </div>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
            return renderSection('Compétences', content);
        }

        function renderLanguages() {
            const { cvData, itemSpacing } = state;
            const content = `
                <div style="display: flex; flex-direction: column; gap: ${itemSpacing / 4}rem;">
                    ${cvData.languages.map(lang => `
                        <div class="flex justify-between py-1">
                            <span class="font-medium">${lang.name}</span>
                            <span class="text-gray-600">${lang.level}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            return renderSection('Langues', content);
        }

        function renderHobbies() {
            const { cvData, itemSpacing, activeColor } = state;
            const content = `
                <div class="flex flex-wrap" style="gap: ${itemSpacing/2}rem;">
                    ${cvData.hobbies.map(hobby => `
                        <div class="flex items-center p-2 bg-gray-100 rounded-lg">
                            <i data-lucide="${hobby.icon}" class="w-3.5 h-3.5 mr-2" style="color: ${colors[activeColor].primary};"></i>
                            <span>${hobby.name}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            return renderSection('Centres d\'intérêt', content);
        }
        
        // --- Editor Rendering ---

        function renderAccordion(title, icon, content, defaultOpen = false, id) {
            const isOpen = state.openAccordions[id];
            return `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <button data-accordion-id="${id}" class="accordion-toggle w-full flex justify-between items-center p-4 font-bold text-gray-800 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center">
                            <i data-lucide="${icon}" class="mr-3 text-indigo-600 w-5 h-5"></i>
                            <span class="text-md">${title}</span>
                        </div>
                        <i data-lucide="chevron-down" class="transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''} w-5 h-5"></i>
                    </button>
                    <div class="accordion-content ${isOpen ? 'open' : ''} border-t border-gray-200">
                        <div class="p-5">${content}</div>
                    </div>
                </div>
            `;
        }

        function renderInputField(label, value, dataPath, placeholder, icon, type = 'text') {
            return `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-1 flex items-center">
                        ${icon ? `<i data-lucide="${icon}" class="w-3.5 h-3.5 mr-2"></i>` : ''}
                        ${label}
                    </label>
                    <input
                        type="${type}"
                        value="${value || ''}"
                        data-path="${dataPath}"
                        placeholder="${placeholder || label}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                    />
                </div>
            `;
        }

        function renderTextareaField(label, value, dataPath, placeholder, icon, rows = 3) {
            return `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-1 flex items-center">
                         ${icon ? `<i data-lucide="${icon}" class="w-3.5 h-3.5 mr-2"></i>` : ''}
                        ${label}
                    </label>
                    <textarea
                        data-path="${dataPath}"
                        placeholder="${placeholder || label}"
                        rows="${rows}"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                    >${value || ''}</textarea>
                </div>
            `;
        }
        
        function renderSlider(label, value, dataPath, min, max, step) {
            return `
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">${label}: <span class="font-mono text-indigo-600">${value}</span></label>
                    <input type="range" min="${min}" max="${max}" step="${step}" value="${value}" data-path="${dataPath}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            `;
        }

        function renderEditor() {
            return `
                ${renderAccordion('Contenu du CV', 'edit-3', `
                    ${renderAccordion('Informations Personnelles', 'user', `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${renderInputField('Prénom', state.cvData.personal.firstName, 'cvData.personal.firstName')}
                            ${renderInputField('Nom', state.cvData.personal.lastName, 'cvData.personal.lastName')}
                            <div class="md:col-span-2">${renderInputField('Titre du poste', state.cvData.personal.title, 'cvData.personal.title')}</div>
                            ${renderInputField('Email', state.cvData.personal.email, 'cvData.personal.email')}
                            ${renderInputField('Téléphone', state.cvData.personal.phone, 'cvData.personal.phone')}
                            <div class="md:col-span-2">${renderInputField('Adresse', state.cvData.personal.address, 'cvData.personal.address')}</div>
                            <div class="md:col-span-2">
                                ${renderTextareaField('Résumé', state.cvData.personal.summary, 'cvData.personal.summary')}
                            </div>
                        </div>
                    `, true, 'personalInfo')}
                    ${renderAccordion('Expériences', 'briefcase', `
                        ${state.cvData.experiences.map((exp, index) => `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4 first:border-t-0 first:mt-0 first:pt-0">
                                ${renderInputField(`Poste ${index+1}`, exp.position, `cvData.experiences.${index}.position`)}
                                ${renderInputField('Entreprise', exp.company, `cvData.experiences.${index}.company`)}
                                ${renderInputField('Date de début', exp.startDate, `cvData.experiences.${index}.startDate`)}
                                ${renderInputField('Date de fin', exp.endDate, `cvData.experiences.${index}.endDate`)}
                                <div class="md:col-span-2">${renderTextareaField('Description', exp.description, `cvData.experiences.${index}.description`)}</div>
                                <div class="md:col-span-2 flex justify-between items-center">
                                    <button class="toggle-item-visibility flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900" data-section="experiences" data-id="${exp.id}">
                                        <i data-lucide="${state.visibility.experiences[exp.id] ? 'eye' : 'eye-off'}" class="w-4 h-4"></i>
                                        <span>${state.visibility.experiences[exp.id] ? "Visible" : "Caché"}</span>
                                    </button>
                                    <button class="remove-list-item text-red-500 hover:text-red-700 text-sm flex items-center gap-1" data-section="experiences" data-id="${exp.id}"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Supprimer</button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-list-item mt-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-1" data-section="experiences"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter une expérience</button>
                    `, false, 'experiences')}
                    ${renderAccordion('Projets', 'projector', `
                        ${(state.cvData.projects || []).map((p, index) => `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4 first:border-t-0 first:mt-0 first:pt-0">
                                ${renderInputField(`Projet ${index+1}`, p.name, `cvData.projects.${index}.name`)}
                                ${renderInputField('URL', p.url, `cvData.projects.${index}.url`)}
                                <div class="md:col-span-2">${renderTextareaField('Description', p.description, `cvData.projects.${index}.description`)}</div>
                                <div class="md:col-span-2 flex justify-between items-center">
                                    <button class="toggle-item-visibility flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900" data-section="projects" data-id="${p.id}">
                                        <i data-lucide="${state.visibility.projects[p.id] ? 'eye' : 'eye-off'}" class="w-4 h-4"></i>
                                        <span>${state.visibility.projects[p.id] ? "Visible" : "Caché"}</span>
                                    </button>
                                    <button class="remove-list-item text-red-500 hover:text-red-700 text-sm flex items-center gap-1" data-section="projects" data-id="${p.id}"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Supprimer</button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-list-item mt-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-1" data-section="projects"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter un projet</button>
                    `, false, 'projects')}
                    ${renderAccordion('Formation', 'graduation-cap', `
                        ${state.cvData.education.map((edu, index) => `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4 first:border-t-0 first:mt-0 first:pt-0">
                                ${renderInputField(`Diplôme ${index+1}`, edu.degree, `cvData.education.${index}.degree`)}
                                ${renderInputField('Établissement', edu.institution, `cvData.education.${index}.institution`)}
                                ${renderInputField('Date de début', edu.startDate, `cvData.education.${index}.startDate`)}
                                ${renderInputField('Date de fin', edu.endDate, `cvData.education.${index}.endDate`)}
                                <div class="md:col-span-2">${renderTextareaField('Description', edu.description, `cvData.education.${index}.description`)}</div>
                                <div class="md:col-span-2 flex justify-between items-center">
                                    <button class="toggle-item-visibility flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900" data-section="education" data-id="${edu.id}">
                                        <i data-lucide="${state.visibility.education[edu.id] ? 'eye' : 'eye-off'}" class="w-4 h-4"></i>
                                        <span>${state.visibility.education[edu.id] ? "Visible" : "Caché"}</span>
                                    </button>
                                    <button class="remove-list-item text-red-500 hover:text-red-700 text-sm flex items-center gap-1" data-section="education" data-id="${edu.id}"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Supprimer</button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-list-item mt-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-1" data-section="education"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter une formation</button>
                    `, false, 'education')}
                    ${renderAccordion('Compétences', 'zap', `
                        ${state.cvData.skills.map((skill, index) => `
                            <div class="grid grid-cols-3 gap-4 items-center border-t pt-4 mt-4 first:border-t-0 first:mt-0 first:pt-0">
                                <div class="col-span-2">${renderInputField(`Compétence ${index+1}`, skill.name, `cvData.skills.${index}.name`)}</div>
                                <div class="flex items-center">
                                    <input type="range" min="1" max="5" value="${skill.level}" data-path="cvData.skills.${index}.level" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <button class="remove-list-item text-red-500 hover:text-red-700 ml-4" data-section="skills" data-id="${skill.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-list-item mt-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-1" data-section="skills"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter une compétence</button>
                    `, false, 'skills')}
                    ${renderAccordion('Langues', 'globe', `
                        ${state.cvData.languages.map((lang, index) => `
                            <div class="grid grid-cols-2 gap-4 items-center border-t pt-4 mt-4 first:border-t-0 first:mt-0 first:pt-0">
                                ${renderInputField(`Langue ${index+1}`, lang.name, `cvData.languages.${index}.name`)}
                                <div class="flex items-center">
                                    ${renderInputField('Niveau', lang.level, `cvData.languages.${index}.level`)}
                                    <button class="remove-list-item text-red-500 hover:text-red-700 ml-2" data-section="languages" data-id="${lang.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-list-item mt-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-1" data-section="languages"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter une langue</button>
                    `, false, 'languages')}
                    ${renderAccordion('Centres d\'intérêt', 'heart', `
                        ${state.cvData.hobbies.map((hobby, index) => `
                            <div class="grid grid-cols-2 gap-4 items-center border-t pt-4 mt-4 first:border-t-0 first:mt-0 first:pt-0">
                                ${renderInputField(`Hobby ${index+1}`, hobby.name, `cvData.hobbies.${index}.name`)}
                                <div class="flex items-center">
                                    <select data-path="cvData.hobbies.${index}.icon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                        ${hobbyIcons.map(icon => `<option value="${icon}" ${hobby.icon === icon ? 'selected' : ''}>${icon}</option>`).join('')}
                                    </select>
                                    <button class="remove-list-item text-red-500 hover:text-red-700 ml-2" data-section="hobbies" data-id="${hobby.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                        <button class="add-list-item mt-4 px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-1" data-section="hobbies"><i data-lucide="plus" class="w-4 h-4"></i> Ajouter un hobby</button>
                    `, false, 'hobbies')}
                `, true, 'content')}
                ${renderAccordion('Design & Mise en Page', 'palette', `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                        <div>
                            <h4 class="font-semibold mb-2 text-gray-700">Modèle</h4>
                            <div class="flex flex-col space-y-2">
                                ${Object.entries(templates).map(([key, t]) => `
                                    <button data-control="activeTemplate" data-value="${key}" class="p-2 rounded-lg border-2 text-sm transition-all ${state.activeTemplate === key ? 'border-indigo-500 bg-indigo-50 font-semibold' : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'}">${t.name}</button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 text-gray-700">Mise en page</h4>
                            <div class="flex flex-col space-y-2">
                                ${Object.entries(layouts).map(([key, l]) => `
                                    <button data-control="activeLayout" data-value="${key}" class="p-2 rounded-lg border-2 text-sm transition-all ${state.activeLayout === key ? 'border-indigo-500 bg-indigo-50 font-semibold' : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'}">${l.name}</button>
                                `).join('')}
                            </div>
                        </div>
                         <div class="md:col-span-2">
                            <h4 class="font-semibold mb-2 text-gray-700">Couleur d'accent</h4>
                            <div class="flex gap-3 flex-wrap">
                                ${Object.entries(colors).map(([key, c]) => `
                                    <div class="tooltip">
                                        <button data-control="activeColor" data-value="${key}" class="w-10 h-10 rounded-full border-4 transition-all ${state.activeColor === key ? 'border-indigo-500 scale-110' : 'border-transparent hover:border-gray-300'}" style="background-color: ${c.primary}"></button>
                                        <span class="tooltip-text">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <h4 class="font-semibold mb-2 text-gray-700">Police</h4>
                            <div class="grid grid-cols-3 gap-2">
                                ${Object.entries(fonts).map(([key, f]) => `
                                    <button data-control="activeFont" data-value="${key}" style="font-family: ${f.family}" class="p-2 rounded-lg border-2 text-sm transition-all ${state.activeFont === key ? 'border-indigo-500 bg-indigo-50 font-semibold' : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'}">${f.name}</button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-8">
                           <div>
                                <h4 class="font-semibold mb-2 text-gray-700">Photo de profil</h4>
                                <div class="flex items-center gap-2">
                                    <input type="file" id="photo-upload" class="hidden" accept="image/*">
                                    <label for="photo-upload" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 text-sm flex items-center gap-2 cursor-pointer"><i data-lucide="upload-cloud"></i> Charger</label>
                                    <button id="remove-photo" class="p-2 text-red-500 hover:bg-red-100 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2 text-gray-700">Forme de la photo</h4>
                                <div class="flex gap-2">
                                    <button data-control="photoShape" data-value="round" class="p-2 rounded-lg border-2 ${state.photoShape === 'round' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}"><i data-lucide="circle" class="w-5 h-5"></i></button>
                                    <button data-control="photoShape" data-value="square" class="p-2 rounded-lg border-2 ${state.photoShape === 'square' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}"><i data-lucide="square" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-semibold mb-2 text-gray-700">Style des titres</h4>
                                <div class="flex gap-2">
                                    <button data-control="sectionTitleStyle" data-value="border" class="p-2 rounded-lg border-2 ${state.sectionTitleStyle === 'border' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}">Bordure</button>
                                    <button data-control="sectionTitleStyle" data-value="background" class="p-2 rounded-lg border-2 ${state.sectionTitleStyle === 'background' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}">Fond</button>
                                    <button data-control="sectionTitleStyle" data-value="simple" class="p-2 rounded-lg border-2 ${state.sectionTitleStyle === 'simple' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}">Simple</button>
                                </div>
                            </div>
                             <div>
                                <h4 class="font-semibold mb-2 text-gray-700">Affichage compétences</h4>
                                <div class="flex gap-2">
                                    <button data-control="skillDisplayStyle" data-value="bars" class="p-2 rounded-lg border-2 ${state.skillDisplayStyle === 'bars' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}"><i data-lucide="bar-chart-horizontal" class="w-5 h-5"></i></button>
                                    <button data-control="skillDisplayStyle" data-value="stars" class="p-2 rounded-lg border-2 ${state.skillDisplayStyle === 'stars' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}"><i data-lucide="star" class="w-5 h-5"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-2 space-y-4">
                           <h4 class="font-semibold text-gray-700 -mb-2">Tailles & Espacements</h4>
                           ${renderSlider('Taille police (base)', state.baseFontSize, 'baseFontSize', 8, 14, 0.5)}
                           ${renderSlider('Taille du nom', state.nameFontSize, 'nameFontSize', 20, 40, 1)}
                           ${renderSlider('Taille titres sections', state.sectionTitleFontSize, 'sectionTitleFontSize', 10, 18, 0.5)}
                           ${renderSlider('Hauteur de ligne', state.lineHeight, 'lineHeight', 1.2, 2.0, 0.1)}
                           ${renderSlider('Marge de page (rem)', state.pagePadding, 'pagePadding', 0.5, 2.5, 0.1)}
                           ${renderSlider('Espace sections (rem)', state.sectionSpacing, 'sectionSpacing', 0.5, 2.5, 0.1)}
                           ${renderSlider('Espace items (rem)', state.itemSpacing, 'itemSpacing', 0.5, 2.0, 0.1)}
                        </div>
                    </div>
                `, true, 'design')}
                ${renderAccordion('Organisation & Options', 'settings', `
                    <h4 class="font-semibold mb-3">Organisation des sections</h4>
                    ${state.activeLayout === 'two' ? renderTwoColumnLayoutEditor() : renderSingleColumnLayoutEditor()}
                    <div class="mt-6">
                        <h4 class="font-semibold mb-2 text-gray-700">Options diverses</h4>
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <label for="show-vcard-qr" class="text-sm font-medium text-gray-800">Afficher le QR Code vCard</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" id="show-vcard-qr" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" ${state.showVCardQR ? 'checked' : ''}/>
                                <label for="show-vcard-qr" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                            <style>.toggle-checkbox:checked { right: 0; border-color: #4f46e5; } .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }</style>
                        </div>
                    </div>
                `, false, 'organization')}
            `;
        }
        
        function renderDraggableBlock(blockId, column) {
            const blockNames = {personal: 'Infos Personnelles', experiences: 'Expériences', projects: 'Projets', education: 'Formation', awards: 'Récompenses', skills: 'Compétences', languages: 'Langues', hobbies: 'Centres d\'intérêt'};
            return `
                <div draggable="true" data-block-id="${blockId}" class="draggable-block p-3 bg-gray-100 border border-gray-200 rounded-lg cursor-move hover:bg-indigo-50 hover:border-indigo-200 transition-colors flex items-center gap-2">
                    <i data-lucide="move" class="w-4 h-4 text-gray-500"></i>
                    <span class="font-medium text-sm flex-grow">${blockNames[blockId]}</span>
                    <div class="tooltip">
                        <button class="toggle-section-visibility p-1 hover:bg-gray-300 rounded-full" data-section="${blockId}">
                            <i data-lucide="${visibilityCheck(blockId) ? 'eye' : 'eye-off'}" class="w-4 h-4 ${visibilityCheck(blockId) ? 'text-gray-600' : 'text-gray-400'}"></i>
                        </button>
                        <span class="tooltip-text">${visibilityCheck(blockId) ? "Cacher" : "Afficher"}</span>
                    </div>
                </div>
            `;
        }

        function renderSingleColumnLayoutEditor() {
            return `
                <div class="space-y-2 drop-zone" data-column="main">
                    ${state.blockOrder.map(id => renderDraggableBlock(id, 'main')).join('')}
                </div>
            `;
        }

        function renderTwoColumnLayoutEditor() {
            return `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold mb-2 text-center text-gray-600">Colonne Gauche</h4>
                            <div class="p-2 space-y-2 bg-gray-50 rounded-lg min-h-[200px] border-2 border-dashed drop-zone" data-column="left">
                                ${state.columnAssignment.left.map(id => renderDraggableBlock(id, 'left')).join('')}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2 text-center text-gray-600">Colonne Droite</h4>
                            <div class="p-2 space-y-2 bg-gray-50 rounded-lg min-h-[200px] border-2 border-dashed drop-zone" data-column="right">
                                ${state.columnAssignment.right.map(id => renderDraggableBlock(id, 'right')).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 items-center">
                        <button id="invert-columns" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 flex items-center justify-center gap-2 transition-colors"><i data-lucide="arrow-left-right" class="w-4 h-4"></i> Inverser</button>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">Ratio des colonnes</label>
                             <select id="column-ratio" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <option value="large-right" ${state.columnRatio === 'large-right' ? 'selected' : ''}>Gauche fine / Droite large</option>
                                <option value="equal" ${state.columnRatio === 'equal' ? 'selected' : ''}>Égales</option>
                                <option value="large-left" ${state.columnRatio === 'large-left' ? 'selected' : ''}>Gauche large / Droite fine</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- EVENT HANDLERS & LOGIC ---
        
        function attachEventListeners() {
            // Header controls
            document.getElementById('randomize-design')?.addEventListener('click', handleRandomizeDesign);
            document.getElementById('toggle-anonymize')?.addEventListener('click', () => setState({ isAnonymized: !state.isAnonymized }));
            document.getElementById('toggle-preview-mode')?.addEventListener('click', () => setState({ previewMode: !state.previewMode }));
            document.getElementById('generate-pdf')?.addEventListener('click', generatePDF);

            // Preview controls
            document.getElementById('zoom-in')?.addEventListener('click', () => setState({ previewScale: Math.min(1.5, state.previewScale + 0.1) }));
            document.getElementById('zoom-out')?.addEventListener('click', () => setState({ previewScale: Math.max(0.3, state.previewScale - 0.1) }));
            document.getElementById('zoom-reset')?.addEventListener('click', () => setState({ previewScale: state.previewMode ? 1 : 0.8 }));
            document.getElementById('zoom-slider')?.addEventListener('input', (e) => setState({ previewScale: parseFloat(e.target.value) }));

            // Editor inputs
            document.querySelectorAll('input[data-path], textarea[data-path], select[data-path]').forEach(input => {
                input.addEventListener('input', handleInputChange);
            });
            document.getElementById('column-ratio')?.addEventListener('change', (e) => setState({ columnRatio: e.target.value }));
            document.getElementById('show-vcard-qr')?.addEventListener('change', (e) => setState({ showVCardQR: e.target.checked }));
            
            // Photo upload
            document.getElementById('photo-upload')?.addEventListener('change', handlePhotoChange);
            document.getElementById('remove-photo')?.addEventListener('click', () => setState({ photo: null }));

            // Editor buttons (add/remove items, etc.)
            document.querySelectorAll('.add-list-item').forEach(btn => btn.addEventListener('click', handleAddListItem));
            document.querySelectorAll('.remove-list-item').forEach(btn => btn.addEventListener('click', handleRemoveListItem));
            document.querySelectorAll('.toggle-item-visibility').forEach(btn => btn.addEventListener('click', handleToggleItemVisibility));
            document.querySelectorAll('.toggle-section-visibility').forEach(btn => btn.addEventListener('click', handleToggleSectionVisibility));
            
            // Design controls
            document.querySelectorAll('button[data-control]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const control = e.currentTarget.dataset.control;
                    const value = e.currentTarget.dataset.value;
                    setState({ [control]: value });
                });
            });

            // Accordions
            document.querySelectorAll('.accordion-toggle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.accordionId;
                    const newAccordionsState = { ...state.openAccordions, [id]: !state.openAccordions[id] };
                    setState({ openAccordions: newAccordionsState });
                });
            });
            
            // Drag and Drop
            attachDragDropListeners();
            
            // Invert columns
            document.getElementById('invert-columns')?.addEventListener('click', () => {
                setState({ columnAssignment: { left: state.columnAssignment.right, right: state.columnAssignment.left }});
            });
        }
        
        let draggedBlock = null;

        function attachDragDropListeners() {
            document.querySelectorAll('.draggable-block').forEach(item => {
                item.addEventListener('dragstart', e => {
                    draggedBlock = e.target.closest('.draggable-block').dataset.blockId;
                    e.target.closest('.draggable-block').classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                item.addEventListener('dragend', e => {
                    e.target.closest('.draggable-block').classList.remove('dragging');
                    draggedBlock = null;
                });
            });

            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                 zone.addEventListener('dragleave', e => {
                    zone.classList.remove('drag-over');
                });
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    if (!draggedBlock) return;

                    const targetBlockEl = e.target.closest('.draggable-block');
                    const targetBlockId = targetBlockEl ? targetBlockEl.dataset.blockId : null;
                    const targetColumn = zone.dataset.column;

                    if (state.activeLayout === 'two') {
                        const newAssignment = {
                            left: state.columnAssignment.left.filter(id => id !== draggedBlock),
                            right: state.columnAssignment.right.filter(id => id !== draggedBlock)
                        };
                        const targetList = newAssignment[targetColumn];
                        const dropIndex = targetBlockId ? targetList.indexOf(targetBlockId) : targetList.length;
                        targetList.splice(dropIndex, 0, draggedBlock);
                        setState({ columnAssignment: newAssignment });
                    } else {
                        const newOrder = [...state.blockOrder].filter(id => id !== draggedBlock);
                        const dropIndex = targetBlockId ? newOrder.indexOf(targetBlockId) : newOrder.length;
                        newOrder.splice(dropIndex, 0, draggedBlock);
                        setState({ blockOrder: newOrder });
                    }
                    draggedBlock = null;
                });
            });
        }

        function handleInputChange(e) {
            const path = e.target.dataset.path;
            const value = e.target.type === 'range' ? parseFloat(e.target.value) : e.target.value;
            const keys = path.split('.');
            
            let tempState = JSON.parse(JSON.stringify(state));
            let current = tempState;

            for (let i = 0; i < keys.length - 1; i++) {
                current = current[keys[i]];
            }
            current[keys[keys.length - 1]] = value;
            
            setState(tempState);
        }
        
        function handleAddListItem(e) {
            const section = e.currentTarget.dataset.section;
            const newItem = {
                id: Date.now(),
                ...(section === 'experiences' && { company: '', position: '', startDate: '', endDate: '', description: '' }),
                ...(section === 'projects' && { name: '', url: '', description: '' }),
                ...(section === 'education' && { institution: '', degree: '', startDate: '', endDate: '', description: '' }),
                ...(section === 'awards' && { name: '', issuer: '', date: '', description: '' }),
                ...(section === 'skills' && { name: '', level: 3 }),
                ...(section === 'languages' && { name: '', level: '' }),
                ...(section === 'hobbies' && { name: '', icon: 'heart' }),
            };

            const newCvData = { ...state.cvData, [section]: [...(state.cvData[section] || []), newItem] };
            
            if (['experiences', 'education', 'projects', 'awards'].includes(section)) {
                const newVisibility = { ...state.visibility, [section]: { ...(state.visibility[section] || {}), [newItem.id]: true } };
                setState({ cvData: newCvData, visibility: newVisibility });
            } else {
                setState({ cvData: newCvData });
            }
        }

        function handleRemoveListItem(e) {
            const section = e.currentTarget.dataset.section;
            const id = parseInt(e.currentTarget.dataset.id, 10);
            const newCvData = { ...state.cvData, [section]: state.cvData[section].filter(item => item.id !== id) };
            
            if (['experiences', 'education', 'projects', 'awards'].includes(section)) {
                const newSectionVisibility = { ...state.visibility[section] };
                delete newSectionVisibility[id];
                const newVisibility = { ...state.visibility, [section]: newSectionVisibility };
                setState({ cvData: newCvData, visibility: newVisibility });
            } else {
                setState({ cvData: newCvData });
            }
        }
        
        function handleToggleItemVisibility(e) {
            const section = e.currentTarget.dataset.section;
            const id = parseInt(e.currentTarget.dataset.id, 10);
            const newVisibility = { ...state.visibility };
            newVisibility[section][id] = !newVisibility[section][id];
            setState({ visibility: newVisibility });
        }
        
        function handleToggleSectionVisibility(e) {
            const section = e.currentTarget.dataset.section;
            const newVisibility = { ...state.visibility, [section]: !state.visibility[section] };
            setState({ visibility: newVisibility });
        }
        
        function visibilityCheck(section, id = null) {
            if (id !== null) {
                return state.visibility[section] && state.visibility[section][id];
            }
            return state.visibility[section];
        }
        
        function handlePhotoChange(e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    setState({ photo: event.target.result });
                }
                reader.readAsDataURL(e.target.files[0]);
            }
        }
        
        function handleRandomizeDesign() {
            const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
            
            const randomTemplate = randomChoice(Object.keys(templates));
            const randomColor = randomChoice(Object.keys(colors));
            const randomFont = randomChoice(Object.keys(fonts));
            const randomLayout = randomChoice(Object.keys(layouts));
            const randomTitleStyle = randomChoice(['border', 'background', 'simple']);
            const randomSkillStyle = randomChoice(['bars', 'stars']);
            
            setState({
                activeTemplate: randomTemplate,
                activeColor: randomColor,
                activeFont: randomFont,
                activeLayout: randomLayout,
                sectionTitleStyle: randomTitleStyle,
                skillDisplayStyle: randomSkillStyle,
            });
        }

        async function generatePDF() {
            const element = document.getElementById('cv-preview-container');
            if (!element || state.isDownloadingPdf) return;
            
            setState({ isDownloadingPdf: true }, false); // Don't re-render yet
            renderApp(); // Manually re-render to show disabled button

            const originalScale = element.style.transform;
            element.style.transform = 'scale(1)';

            try {
                const opt = {
                    margin: 0,
                    filename: state.isAnonymized ? 'cv_anonyme.pdf' : `CV_${state.cvData.personal.firstName}_${state.cvData.personal.lastName}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 3, useCORS: true, letterRendering: true, scrollY: -window.scrollY },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                if (window.html2pdf) {
                    await window.html2pdf().from(element).set(opt).save();
                } else {
                    throw new Error("PDF library not loaded.");
                }
            } catch (error) {
                console.error("PDF Generation Error:", error);
                alert("Erreur lors de la création du PDF.");
            } finally {
                element.style.transform = originalScale;
                setState({ isDownloadingPdf: false });
            }
        }
        
        function generateVCardQR() {
            const qrContainer = document.getElementById('vcard-qr-code');
            if (state.showVCardQR && !state.isAnonymized && window.qrcode && qrContainer) {
                try {
                    const { firstName, lastName, email, phone } = state.cvData.personal;
                    const vCardData = `BEGIN:VCARD\nVERSION:3.0\nN:${lastName};${firstName}\nFN:${firstName} ${lastName}\nEMAIL:${email}\nTEL:${phone}\nEND:VCARD`;
                    const qr = window.qrcode(0, 'M');
                    qr.addData(vCardData);
                    qr.make();
                    qrContainer.innerHTML = qr.createImgTag(4, 8);
                } catch (error) {
                    console.error("vCard QR Code generation failed:", error);
                    qrContainer.innerHTML = 'Error';
                }
            }
        }
        
        // --- INITIALIZATION ---
        function init() {
            const savedState = localStorage.getItem('cvState_v3');
            let cvData = initialCvData;
            let loadedState = {};
            if (savedState) {
                loadedState = JSON.parse(savedState);
                cvData = loadedState.cvData || initialCvData;
            }
            
            const initialVisibility = {
                personal: true,
                experiences: Object.keys(cvData.experiences.reduce((acc, exp) => ({ ...acc, [exp.id]: true }), {})).length > 0 ? cvData.experiences.reduce((acc, exp) => ({ ...acc, [exp.id]: true }), {}) : {},
                projects: Object.keys((cvData.projects || []).reduce((acc, p) => ({ ...acc, [p.id]: true }), {})).length > 0 ? (cvData.projects || []).reduce((acc, p) => ({ ...acc, [p.id]: true }), {}) : {},
                education: Object.keys(cvData.education.reduce((acc, edu) => ({ ...acc, [edu.id]: true }), {})).length > 0 ? cvData.education.reduce((acc, edu) => ({ ...acc, [edu.id]: true }), {}) : {},
                awards: Object.keys((cvData.awards || []).reduce((acc, a) => ({ ...acc, [a.id]: true }), {})).length > 0 ? (cvData.awards || []).reduce((acc, a) => ({ ...acc, [a.id]: true }), {}) : {},
                skills: true,
                languages: true,
                hobbies: true,
            };

            const defaultState = {
                cvData,
                activeTemplate: 'modern',
                activeColor: 'indigo',
                backgroundColor: '#ffffff',
                activeLayout: 'two',
                columnRatio: 'large-right',
                activeFont: 'sans',
                previewMode: false,
                isAnonymized: false,
                isDownloadingPdf: false,
                showVCardQR: false,
                photo: null,
                photoShape: 'round',
                sectionTitleStyle: 'border',
                previewScale: 0.7,
                baseFontSize: 10,
                nameFontSize: 28,
                sectionTitleFontSize: 14,
                lineHeight: 1.5,
                pagePadding: 1.5,
                sectionSpacing: 1.25,
                itemSpacing: 1,
                skillDisplayStyle: 'bars',
                visibility: initialVisibility,
                blockOrder: ['experiences', 'projects', 'education', 'awards', 'skills', 'languages', 'hobbies'],
                columnAssignment: {
                    left: ['personal', 'skills', 'languages', 'hobbies'],
                    right: ['experiences', 'projects', 'education', 'awards']
                },
                openAccordions: {
                    content: true,
                    personalInfo: true,
                    design: true
                }
            };
            
            state = { ...defaultState, ...loadedState, visibility: loadedState.visibility || initialVisibility };

            renderApp();
        }

        // Start the application
        init();

    </script>
</body>
</html>
