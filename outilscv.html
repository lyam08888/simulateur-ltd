import React, { useState, useRef, useEffect } from 'react';
import ReactDOM from 'react-dom';
import { motion, AnimatePresence } from 'framer-motion';
import { Chart, registerables } from 'chart.js';
import { Download, Eye, User, Briefcase, GraduationCap, Award, Phone, Mail, MapPin, Plus, Move, Palette, Globe, Heart, Sparkles, LoaderCircle, ShieldCheck, Zap, ArrowLeftRight, CheckCircle, Building, Text, Rows, Expand, EyeOff, Camera, QrCode, Trash2, FileText, Lightbulb, Image as ImageIcon, Square, Circle, Star, Code, BookOpen, Music, Plane, Dumbbell, Paintbrush, Projector, ChevronDown, ChevronsUpDown, BarChartHorizontal, ZoomIn, ZoomOut, RotateCw, Settings, Info, Edit3, RefreshCcw, AlertTriangle, Share2, Wand, Coffee, Feather, MessageCircle, MoreHorizontal, BarChart2, ChevronRight, Triangle, GitCommitVertical, List, Columns, Figma, TrendingUp, Link as LinkIcon, PlusSquare, Wrench, Search, DownloadCloud, UploadCloud, Upload, Github, Twitter, Layers, Euro, Calendar, Map, Copy } from 'lucide-react';

Chart.register(...registerables);

// --- DATA INITIALE & EXEMPLES ---

const emptyCvData = {
    personal: { firstName: '', lastName: '', title: '', email: '', phone: '', address: '', summary: '', onlineProfileUrl: '', availability: '', salaryExpectations: '', location: '' },
    experiences: [],
    projects: [],
    education: [],
    skills: [],
    awards: [],
    languages: [],
    hobbies: [],
    socials: [],
    customSections: []
};

const exampleData = {
    dev: { 
        personal: { firstName: 'Léa', lastName: 'Martin', title: 'Développeuse Full-Stack', email: 'lea.martin@email.dev', phone: '+33 7 11 22 33 44', address: 'Paris, France', summary: 'Développeuse passionnée avec 5 ans d\'expérience en React et Node.js. Adepte du code propre et des tests unitaires, je cherche à construire des applications performantes et scalables.', availability: 'Immédiate', salaryExpectations: '55-65k€', location: 'Paris ou télétravail' }, 
        experiences: [{ id: 1, company: 'Tech Startup', position: 'Développeuse Senior', startDate: '2020', endDate: 'Présent', description: 'Développement de nouvelles fonctionnalités, maintenance de l\'application principale et mentorat des développeurs juniors.' }, { id: 2, company: 'Web Agency', position: 'Développeuse Junior', startDate: '2018', endDate: '2020', description: 'Intégration de maquettes et développement de sites vitrines.' }],
        projects: [{ id: 1, name: 'Portfolio Interactif', url: 'lea-martin.dev', description: 'Création d\'un site personnel en Next.js avec des animations Three.js.' }],
        education: [{ id: 1, institution: 'École 42', degree: 'Architecte en Technologies du Numérique', startDate: '2017', endDate: '2020', description: 'Formation par projets en peer-learning.' }],
        skills: [{id: 1, category: 'Frontend', name: 'React', level: 5, icon: 'code'}, {id: 2, category: 'Backend', name: 'Node.js', level: 5, icon: 'code'}, {id: 3, category: 'Langages', name: 'TypeScript', level: 4, icon: 'code'}, {id: 4, category: 'API', name: 'GraphQL', level: 4, icon: 'code'}],
        awards: [],
        languages: [ { id: 1, name: 'Français', level: 'Natif' }, { id: 2, name: 'Anglais', level: 'Technique' } ],
        hobbies: [ { id: 1, name: 'Jeux de stratégie', icon: 'Star' }, { id: 2, name: 'Open Source', icon: 'Code' } ],
        socials: [{ id: 1, network: 'github', url: 'https://github.com/leamartin' }],
        customSections: []
    },
    manager: { 
        personal: { firstName: 'Julien', lastName: 'Petit', title: 'Product Manager', email: 'j.petit@email.pro', phone: '+33 6 55 66 77 88', address: 'Bordeaux, France', summary: 'Product Manager avec 10 ans d\'expérience dans la définition de stratégies produit et la gestion de roadmaps. Je fais le pont entre les équipes techniques, le design et le business pour livrer des produits qui ravissent les utilisateurs.', availability: 'Sous 1 mois', salaryExpectations: '70k€+', location: 'Bordeaux' }, 
        experiences: [{ id: 1, company: 'SaaS Company', position: 'Head of Product', startDate: '2018', endDate: 'Présent', description: 'Définition de la vision produit, gestion d\'une équipe de 5 Product Owners et analyse des KPIs pour orienter les décisions stratégiques.' }],
        projects: [],
        education: [{ id: 1, institution: 'Kedge Business School', degree: 'Master in Management', startDate: '2008', endDate: '2012', description: 'Spécialisation Marketing & Stratégie.' }],
        skills: [{id: 1, category: 'Stratégie', name: 'Product Strategy', level: 5, icon: 'lightbulb'}, {id: 2, category: 'Planning', name: 'Roadmap Planning', level: 5, icon: 'map'}, {id: 3, category: 'Recherche', name: 'User Research', level: 5, icon: 'users'}, {id: 4, category: 'Analyse', name: 'Data Analysis', level: 4, icon: 'bar-chart-2'}],
        awards: [],
        languages: [ { id: 1, name: 'Français', level: 'Natif' }, { id: 2, name: 'Anglais', level: 'Bilingue' } ],
        hobbies: [ { id: 1, name: 'Économie', icon: 'BookOpen' }, { id: 2, name: 'Voyages', icon: 'Plane' } ],
        socials: [{ id: 1, network: 'linkedin', url: 'https://linkedin.com/in/julienpetit' }],
        customSections: []
    },
};

const initialRecruiterData = { name: 'Lyes AMARA', title: 'Responsable Recrutement BTP', company: 'LTD Recrutement', phone: '01 56 02 12 25', mobile: '06 34 25 32 96', email: 'l.amara@ltd-international.com' };

// --- COMPOSANTS UTILITAIRES ---

const hobbyIcons = { Code, BookOpen, Camera, Music, Plane, Dumbbell, Paintbrush, Heart, Star, Lightbulb, Compass: Info };
const IconComponent = ({ name, ...props }) => { const Icon = hobbyIcons[name] || Heart; return <Icon {...props} />; };
const Tooltip = ({ text, children }) => ( <div className="relative group flex items-center"> {children} <div className="absolute bottom-full mb-2 w-max bg-gray-800 text-white text-xs rounded py-1 px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-30"> {text} </div> </div> );

const Accordion = ({ title, icon: Icon, children, defaultOpen = false }) => {
    const [isOpen, setIsOpen] = useState(defaultOpen);
    return (
        <motion.div layout className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200">
            <motion.header layout>
                <button onClick={() => setIsOpen(!isOpen)} className="w-full flex justify-between items-center p-4 font-bold text-gray-800 hover:bg-gray-50 transition-colors">
                    <div className="flex items-center"> {Icon && <Icon className="mr-3 text-indigo-600" size={20} />} <span className="text-md">{title}</span> </div>
                    <ChevronDown size={20} className={`transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`} />
                </button>
            </motion.header>
            <AnimatePresence> {isOpen && ( <motion.section key="content" initial={{ opacity: 0, height: 0 }} animate={{ opacity: 1, height: 'auto' }} exit={{ opacity: 0, height: 0 }} transition={{ duration: 0.3, ease: 'easeInOut' }} className="overflow-hidden"> <div className="p-5 border-t border-gray-200">{children}</div> </motion.section> )} </AnimatePresence>
        </motion.div>
    );
};

const InputField = ({ label, value, onChange, placeholder, Icon, type = 'text' }) => (
    <div>
        <label className="block text-sm font-medium text-gray-600 mb-1 flex items-center"> {Icon && <Icon size={14} className="mr-2" />} {label} </label>
        <input type={type} value={value} onChange={onChange} placeholder={placeholder} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
    </div>
);

const TextareaField = ({ label, value, onChange, placeholder, Icon, rows = 3, children }) => (
    <div>
        <div className="flex justify-between items-center mb-1">
            <label className="block text-sm font-medium text-gray-600 flex items-center"> {Icon && <Icon size={14} className="mr-2" />} {label} </label>
            <div className="flex items-center gap-2">{children}</div>
        </div>
        <textarea value={value} onChange={onChange} placeholder={placeholder} rows={rows} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
    </div>
);

// --- COMPOSANT PRINCIPAL ---

const CVGenerator = () => {
    // --- STATE MANAGEMENT ---
    const [cvData, setCvData] = useState(() => { try { const d = localStorage.getItem('cvData_v8'); return d ? JSON.parse(d) : emptyCvData; } catch (e) { return emptyCvData; } });
    const [recruiterData, setRecruiterData] = useState(() => { try { const d = localStorage.getItem('recruiterData_v8'); return d ? JSON.parse(d) : initialRecruiterData; } catch (e) { return initialRecruiterData; } });

    const [activeTemplate, setActiveTemplate] = useState('modern');
    const [activePalette, setActivePalette] = useState('indigo');
    const [activeLayout, setActiveLayout] = useState('two');
    const [columnRatio, setColumnRatio] = useState('large-right');
    const [activeFont, setActiveFont] = useState('sans');
    const [previewMode, setPreviewMode] = useState(false);
    const [isAnonymized, setIsAnonymized] = useState(false);
    const [isDownloadingPdf, setIsDownloadingPdf] = useState(false);
    const [isDownloadingWord, setIsDownloadingWord] = useState(false);
    const [showRecruiterBanner, setShowRecruiterBanner] = useState(true);
    const [showVCardQR, setShowVCardQR] = useState(false);
    const [photo, setPhoto] = useState(null);
    const [photoShape, setPhotoShape] = useState('round');
    const [sectionTitleStyle, setSectionTitleStyle] = useState('border');
    const [experienceStyle, setExperienceStyle] = useState('default');
    const [headerAlignment, setHeaderAlignment] = useState('center');
    const [previewScale, setPreviewScale] = useState(0.8);
    const [baseFontSize, setBaseFontSize] = useState(10);
    const [nameFontSize, setNameFontSize] = useState(28);
    const [sectionTitleFontSize, setSectionTitleFontSize] = useState(12);
    const [lineHeight, setLineHeight] = useState(1.5);
    const [pagePadding, setPagePadding] = useState(1.5);
    const [sectionSpacing, setSectionSpacing] = useState(1.25);
    const [itemSpacing, setItemSpacing] = useState(1);
    const [skillDisplayStyle, setSkillDisplayStyle] = useState('bars');
    const [draggedBlock, setDraggedBlock] = useState(null);
    const [aiInput, setAiInput] = useState('');
    const [isAiLoading, setIsAiLoading] = useState(false);
    const [isAiSynthesizing, setIsAiSynthesizing] = useState(false);
    const [aiError, setAiError] = useState('');
    const [isOverflowing, setIsOverflowing] = useState(false);
    const [isSimplified, setIsSimplified] = useState(false);
    const [salesEmail, setSalesEmail] = useState('');
    const [isGeneratingEmail, setIsGeneratingEmail] = useState(false);
    const [copied, setCopied] = useState(false);
    const [injectionNotes, setInjectionNotes] = useState('');
    const [isInjecting, setIsInjecting] = useState(false);
    const [activeEditorTab, setActiveEditorTab] = useState('ia');
    
    const cvPreviewRef = useRef();
    const cvContentRef = useRef();
    const vCardQrCodeRef = useRef();
    const chartRef = useRef(null);
    const skillChartCanvasRef = useRef(null);
    const [visibility, setVisibility] = useState({ personal: true, skills: true, languages: true, hobbies: true, experiences: {}, projects: {}, education: {}, awards: {}, socials: {} });

    const [blockOrder, setBlockOrder] = useState(['socials', 'experiences', 'projects', 'education', 'awards', 'skills', 'languages', 'hobbies']);
    const [columnAssignment, setColumnAssignment] = useState({ left: ['personal', 'skills', 'languages', 'hobbies'], right: ['socials', 'experiences', 'projects', 'education', 'awards'] });

    // --- CONFIGURATIONS ---
    const templates = { modern: { name: 'Moderne' }, classic: { name: 'Classique' }, creative: { name: 'Créatif' }, minimalist: { name: 'Minimaliste' }, tech: { name: 'Tech' } };
    const layouts = { single: { name: 'Une colonne' }, two: { name: 'Deux colonnes' } };
    const fonts = { sans: { name: 'Inter (Sans)', family: "'Inter', sans-serif" }, serif: { name: 'Lora (Serif)', family: "'Lora', serif" }, mono: { name: 'JetBrains Mono', family: "'JetBrains Mono', monospace" } };
    const palettes = {
        indigo: { name: 'Indigo', primary: '#4f46e5', secondary: '#eef2ff', accent: '#3730a3', textOnPrimary: '#ffffff' },
        ocean: { name: 'Océan', primary: '#0891b2', secondary: '#ecfeff', accent: '#164e63', textOnPrimary: '#ffffff' },
        forest: { name: 'Forêt', primary: '#166534', secondary: '#f0fdf4', accent: '#14532d', textOnPrimary: '#ffffff' },
        sunset: { name: 'Crépuscule', primary: '#ea580c', secondary: '#fff7ed', accent: '#c2410c', textOnPrimary: '#ffffff' },
        monochrome: { name: 'Monochrome', primary: '#1f2937', secondary: '#f9fafb', accent: '#111827', textOnPrimary: '#ffffff' }
    };
    const socialIcons = { linkedin: LinkIcon, github: Github, twitter: Twitter, globe: Globe, default: LinkIcon };
    const editorTabs = [
        { id: 'ia', label: 'Assistant IA', icon: Sparkles },
        { id: 'personalisation', label: 'Personnalisation IA', icon: Wand },
        { id: 'vente', label: 'Email de Vente IA', icon: Mail },
        { id: 'contenu', label: 'Contenu du CV', icon: Edit3 },
        { id: 'design', label: 'Design & Mise en Page', icon: Palette },
        { id: 'options', label: 'Options Avancées', icon: Settings },
    ];

    // --- EFFECTS ---
    useEffect(() => {
        const scripts = [
            { id: 'html2pdf-script', src: "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" },
            { id: 'qrcode-script', src: "https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js" },
            { id: 'docx-script', src: "https://unpkg.com/docx@8.5.0/build/index.js" },
            { id: 'filesaver-script', src: "https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" }
        ];
        scripts.forEach(s => { if (!document.getElementById(s.id)) { const script = document.createElement('script'); script.id = s.id; script.src = s.src; script.async = true; document.body.appendChild(script); } });
    }, []);
    useEffect(() => { try { localStorage.setItem('cvData_v8', JSON.stringify(cvData)); localStorage.setItem('recruiterData_v8', JSON.stringify(recruiterData)); } catch (e) { console.error("Could not save data:", e); } }, [cvData, recruiterData]);
    useEffect(() => {
        if (showVCardQR && window.qrcode) {
            try {
                const { firstName, lastName, email, phone } = cvData.personal;
                const vCardData = `BEGIN:VCARD\nVERSION:3.0\nN:${lastName};${firstName}\nFN:${firstName} ${lastName}\nEMAIL:${email}\nTEL:${phone}\nEND:VCARD`;
                const qr = window.qrcode(0, 'M'); qr.addData(vCardData); qr.make();
                if (vCardQrCodeRef.current) { vCardQrCodeRef.current.innerHTML = qr.createImgTag(4, 8); }
            } catch (e) { console.error("vCard QR Code generation failed:", e); }
        }
    }, [showVCardQR, cvData.personal]);

    // Sync visibility state with cvData
    useEffect(() => {
        setVisibility(prev => {
            const newVisibility = { ...prev };
            ['experiences', 'projects', 'education', 'awards', 'socials'].forEach(section => {
                const sectionVisibility = { ...(newVisibility[section] || {}) };
                (cvData[section] || []).forEach(item => {
                    if (sectionVisibility[item.id] === undefined) {
                        sectionVisibility[item.id] = true; // Default new items to visible
                    }
                });
                newVisibility[section] = sectionVisibility;
            });
            return newVisibility;
        });
    }, [cvData]);

    // Overflow check effect
    useEffect(() => {
        const checkOverflow = () => {
            const contentElement = cvContentRef.current;
            if (contentElement) {
                const a4HeightInPx = 297 * (96 / 25.4); 
                setIsOverflowing(contentElement.scrollHeight > a4HeightInPx + 5);
            }
        };
        const timeoutId = setTimeout(checkOverflow, 150);
        return () => clearTimeout(timeoutId);
    }, [cvData, activeLayout, columnRatio, activeFont, baseFontSize, nameFontSize, sectionTitleFontSize, lineHeight, pagePadding, sectionSpacing, itemSpacing, photo, showRecruiterBanner]);

    // Chart.js effect
    useEffect(() => {
        if (skillDisplayStyle === 'radar' && skillChartCanvasRef.current) {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
            const ctx = skillChartCanvasRef.current.getContext('2d');
            const currentPalette = palettes[activePalette] || {primary: '#4f46e5'};
            chartRef.current = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: cvData.skills.map(s => s.name),
                    datasets: [{
                        label: 'Niveau de Compétence',
                        data: cvData.skills.map(s => s.level),
                        backgroundColor: `${currentPalette.primary}33`,
                        borderColor: currentPalette.primary,
                        borderWidth: 2,
                    }]
                },
                options: { scales: { r: { beginAtZero: true, max: 5, stepSize: 1 } }, plugins: { legend: { display: false } } }
            });
        }
        return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
        };
    }, [skillDisplayStyle, cvData.skills, activePalette]);

    // --- HANDLERS ---
    const handleCvDataChange = (section, field, value) => setCvData(p => ({ ...p, [section]: { ...p[section], [field]: value } }));
    const handleRecruiterDataChange = (field, value) => setRecruiterData(p => ({ ...p, [field]: value }));
    const handleListItemChange = (section, id, field, value) => setCvData(p => ({ ...p, [section]: p[section].map(i => i.id === id ? { ...i, [field]: value } : i) }));
    
    const addListItem = (section) => {
        const newItem = { id: Date.now(), ...(section === 'experiences' && { company: '', position: '', startDate: '', endDate: '', description: '' }), ...(section === 'projects' && { name: '', url: '', description: '' }), ...(section === 'education' && { institution: '', degree: '', startDate: '', endDate: '', description: '' }), ...(section === 'awards' && { name: '', issuer: '', date: '', description: '' }), ...(section === 'skills' && { category: 'Nouvelle Catégorie', name: '', level: 3, icon: '' }), ...(section === 'languages' && { name: '', level: '' }), ...(section === 'hobbies' && { name: '', icon: 'heart' }), ...(section === 'socials' && { network: 'linkedin', url: '' }), ...(section === 'customSections' && { title: 'Nouvelle Section', content: '' }) };
        setCvData(prev => ({ ...prev, [section]: [...(prev[section] || []), newItem] }));
    };
    const removeListItem = (section, id) => {
        setCvData(prev => ({ ...prev, [section]: prev[section].filter(item => item.id !== id) }));
    };
    const handlePhotoChange = (e) => { if (e.target.files && e.target.files[0]) { setPhoto(URL.createObjectURL(e.target.files[0])); } };
    const toggleSectionVisibility = (section) => setVisibility(p => ({ ...p, [section]: !p[section] }));
    const toggleItemVisibility = (section, id) => setVisibility(p => ({ ...p, [section]: { ...p[section], [id]: !p[section][id] } }));
    const handleRandomizeDesign = () => {
        const randomChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];
        setActiveTemplate(randomChoice(Object.keys(templates)));
        setActivePalette(randomChoice(Object.keys(palettes)));
        setActiveFont(randomChoice(Object.keys(fonts)));
        setActiveLayout(randomChoice(Object.keys(layouts)));
        setSectionTitleStyle(randomChoice(['border', 'background', 'simple']));
        setSkillDisplayStyle(randomChoice(['bars', 'stars']));
        setExperienceStyle(randomChoice(['default', 'timeline']));
        setHeaderAlignment(randomChoice(['left', 'center']));
    };
    const handleSimplifyCv = () => {
        setIsSimplified(true);
    };
    const handleShowAllDetails = () => {
        setIsSimplified(false);
    };

    // --- DRAG & DROP ---
    const handleDragStart = (e, blockId) => { setDraggedBlock(blockId); e.dataTransfer.effectAllowed = 'move'; };
    const handleDragOver = (e) => e.preventDefault();
    const handleDrop = (e, targetBlockId, targetColumn) => {
        e.preventDefault(); if (!draggedBlock) return;
        if (activeLayout === 'two') {
            setColumnAssignment(prev => {
                const newA = { left: prev.left.filter(id => id !== draggedBlock), right: prev.right.filter(id => id !== draggedBlock) };
                const targetList = newA[targetColumn]; const dropIndex = targetBlockId ? targetList.indexOf(targetBlockId) : targetList.length;
                targetList.splice(dropIndex, 0, draggedBlock); return newA;
            });
        } else { setBlockOrder(prev => { const newO = prev.filter(id => id !== draggedBlock); const dropIndex = newO.indexOf(targetBlockId); newO.splice(dropIndex, 0, draggedBlock); return newO; }); }
        setDraggedBlock(null);
    };
    const handleDropOnColumn = (e, column) => { e.preventDefault(); if (!columnAssignment[column].length) { handleDrop(e, null, column); } };
    const invertColumns = () => setColumnAssignment(p => ({ left: p.right, right: p.left }));

    // --- AI & PDF & WORD ---
    const generatePDF = async (options = {}) => {
        const {
            save = true,
            filename = isAnonymized ? 'cv_anonyme.pdf' : `CV_${cvData.personal.firstName || 'CV'}_${cvData.personal.lastName || 'Pro'}.pdf`
        } = options;

        if (isDownloadingPdf || typeof window.html2pdf === 'undefined') {
            setAiError("Le générateur de PDF est déjà en cours d'exécution ou n'est pas chargé.");
            return null;
        }
        setIsDownloadingPdf(true);
        setAiError('');

        const printContainer = document.createElement('div');
        printContainer.style.position = 'absolute';
        printContainer.style.left = '-9999px';
        printContainer.style.top = '0px';
        document.body.appendChild(printContainer);

        try {
            await new Promise(resolve => {
                ReactDOM.render(renderCV(), printContainer, () => {
                    setTimeout(resolve, 500);
                });
            });

            const elementToPrint = printContainer.firstChild;
            if (!elementToPrint) throw new Error("Le conteneur d'impression est vide.");

            const opt = {
                margin: 0,
                filename,
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: {
                    scale: 4,
                    useCORS: true,
                    letterRendering: true,
                    allowTaint: true,
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            if (save) {
                 await window.html2pdf().from(elementToPrint).set(opt).save();
                 return null;
            } else {
                return await window.html2pdf().from(elementToPrint).set(opt).output('blob');
            }

        } catch (e) {
            console.error("Erreur de génération PDF:", e);
            setAiError("Une erreur est survenue lors de la création du PDF. Essayez de rafraîchir la page.");
            return null;
        } finally {
            ReactDOM.unmountComponentAtNode(printContainer);
            document.body.removeChild(printContainer);
            setIsDownloadingPdf(false);
        }
    };
    
    const generateWord = () => {
        if (typeof docx === 'undefined' || typeof saveAs === 'undefined') {
            alert("Les composants de téléchargement sont encore en cours de chargement. Veuillez réessayer dans un instant.");
            return;
        }
        setIsDownloadingWord(true);
        const { Packer, Document, Paragraph, TextRun, HeadingLevel } = docx;
        const { personal, experiences, education, skills } = cvData;

        try {
            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ text: `${personal.firstName} ${personal.lastName}`, heading: HeadingLevel.TITLE }),
                        new Paragraph({ text: personal.title, style: "IntenseQuote" }),
                        new Paragraph({ text: `Email: ${personal.email} | Tel: ${personal.phone} | Adresse: ${personal.address}` }),
                        new Paragraph({ text: "" }),
                        new Paragraph({ text: "Résumé", heading: HeadingLevel.HEADING_1 }),
                        new Paragraph(personal.summary),
                        new Paragraph({ text: "" }),
                        new Paragraph({ text: "Expérience Professionnelle", heading: HeadingLevel.HEADING_1 }),
                        ...experiences.flatMap(exp => [
                            new Paragraph({ children: [new TextRun({ text: exp.position, bold: true })] }),
                            new Paragraph(`${exp.company} | ${exp.startDate} - ${exp.endDate}`),
                            new Paragraph({ text: exp.description, bullet: { level: 0 } }),
                            new Paragraph(""),
                        ]),
                        new Paragraph({ text: "Formation", heading: HeadingLevel.HEADING_1 }),
                        ...education.flatMap(edu => [
                            new Paragraph({ children: [new TextRun({ text: edu.degree, bold: true })] }),
                            new Paragraph(`${edu.institution} | ${edu.startDate} - ${edu.endDate}`),
                            new Paragraph({ text: edu.description, bullet: { level: 0 } }),
                            new Paragraph(""),
                        ]),
                        new Paragraph({ text: "Compétences", heading: HeadingLevel.HEADING_1 }),
                        new Paragraph(skills.map(s => s.name).join(', ')),
                    ],
                }],
            });

            Packer.toBlob(doc).then(blob => {
                saveAs(blob, `CV_${personal.firstName}_${personal.lastName}.docx`);
            }).catch(err => {
                console.error("Error generating DOCX blob:", err);
                alert("Une erreur est survenue lors de la création du fichier Word.");
            }).finally(() => {
                setIsDownloadingWord(false);
            });
        } catch (e) {
            console.error("Error in generateWord:", e);
            alert("Une erreur inattendue est survenue lors de la génération du document Word.");
            setIsDownloadingWord(false);
        }
    };

    const jsonSchemaForAI = { type: "OBJECT", properties: { personal: { type: "OBJECT", properties: { firstName: { type: "STRING" }, lastName: { type: "STRING" }, title: { type: "STRING" }, email: { type: "STRING" }, phone: { type: "STRING" }, address: { type: "STRING" }, summary: { type: "STRING" }, availability: { type: "STRING" }, salaryExpectations: { type: "STRING" }, location: { type: "STRING" } } }, experiences: { type: "ARRAY", items: { type: "OBJECT", properties: { company: { type: "STRING" }, position: { type: "STRING" }, startDate: { type: "STRING" }, endDate: { type: "STRING" }, description: { type: "STRING" } } } }, education: { type: "ARRAY", items: { type: "OBJECT", properties: { institution: { type: "STRING" }, degree: { type: "STRING" }, startDate: { type: "STRING" }, endDate: { type: "STRING" }, description: { type: "STRING" } } } }, projects: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, url: { type: "STRING" }, description: { type: "STRING" } } } }, awards: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, issuer: { type: "STRING" }, date: { type: "STRING" }, description: { type: "STRING" } } } }, skills: { type: "ARRAY", items: { type: "STRING" } }, languages: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, level: { type: "STRING" } } } }, hobbies: { type: "ARRAY", items: { type: "STRING" } } } };
    
    const handleAiGenerate = async () => {
        if (!aiInput.trim()) { setAiError("Veuillez copier-coller le contenu de votre CV."); return; }
        setIsAiLoading(true); setAiError('');
        const prompt = `You are an expert CV parsing system. Your task is to meticulously analyze the following text and extract structured information to populate a CV. The user's text is: "${aiInput}". Please extract the following sections: Personal Information (first name, last name, job title, email, phone, address, summary, availability, salary expectations, location), Professional Experiences (for each job: company, position, dates, description), Projects (name, url, description), Education (for each degree: institution, degree name, dates, description), Awards (name, issuer, date, description), a list of Skills, a list of Languages with their levels, and a list of Hobbies. You must adhere to the provided JSON schema. If information is not present, leave the field as an empty string or array. Do not invent information. Return ONLY the raw JSON object, without any surrounding text or markdown.`;
        try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: jsonSchemaForAI } };
            const apiUrl = 'https://simulateur-ltd.onrender.com/api/gemini'; // MODIFIED: Point to the Render backend
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                const parsedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                setCvData(prev => ({ ...prev, personal: { ...prev.personal, ...parsedJson.personal }, experiences: (parsedJson.experiences || []).map((exp, i) => ({ id: Date.now() + i, ...exp })), projects: (parsedJson.projects || []).map((p, i) => ({ id: Date.now() + i, ...p })), education: (parsedJson.education || []).map((edu, i) => ({ id: Date.now() + i, ...edu })), awards: (parsedJson.awards || []).map((a, i) => ({ id: Date.now() + i, ...a })), skills: (parsedJson.skills || []).map((skill, i) => ({ id: Date.now() + i, name: skill, level: 3 })), languages: (parsedJson.languages || []).map((lang, i) => ({ id: Date.now() + i, ...lang })), hobbies: (parsedJson.hobbies || []).map((hobby, i) => ({ id: Date.now() + i, name: hobby, icon: 'Heart' })) }));
            } else { throw new Error("Invalid response structure from AI."); }
        } catch (e) { console.error("AI Generation Error:", e); setAiError("Le service IA est momentanément indisponible."); } finally { setIsAiLoading(false); }
    };

    const handleAiSynthesizeAll = async () => {
        setIsAiSynthesizing(true);
        setAiError('');
        const prompt = `En tant qu'expert en recrutement, votre tâche est de synthétiser les données de CV suivantes pour les rendre plus concises et percutantes. Conservez le sens principal mais utilisez moins de mots. Raccourcissez le résumé ("summary") et toutes les descriptions ("description") des expériences, projets, formations et récompenses. Ne modifiez pas les noms, les entreprises, les dates, les titres de poste ou les diplômes. Voici les données actuelles du CV : ${JSON.stringify(cvData)}. Veuillez renvoyer l'intégralité des données du CV, avec les textes synthétisés, en respectant exactement le même format JSON. Renvoyez UNIQUEMENT l'objet JSON.`;
        try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: jsonSchemaForAI } };
            const apiUrl = 'https://simulateur-ltd.onrender.com/api/gemini'; // MODIFIED: Point to the Render backend
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                const synthesizedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                setCvData(prev => {
                    const newData = { ...prev };
                    if (synthesizedJson.personal && synthesizedJson.personal.summary) { newData.personal.summary = synthesizedJson.personal.summary; }
                    ['experiences', 'projects', 'education', 'awards'].forEach(section => {
                        if (synthesizedJson[section]) {
                            newData[section] = prev[section].map((item, index) => {
                                if (synthesizedJson[section][index] && synthesizedJson[section][index].description) {
                                    return { ...item, description: synthesizedJson[section][index].description };
                                }
                                return item;
                            });
                        }
                    });
                    return newData;
                });
            } else { throw new Error("Invalid response from AI."); }
        } catch (e) { console.error("AI Synthesis Error:", e); setAiError("Erreur lors de la synthèse globale."); } finally { setIsAiSynthesizing(false); }
    };

    const handleAiInjection = async () => {
        if (!injectionNotes.trim()) {
            setAiError("Veuillez entrer des notes à injecter.");
            return;
        }
        setIsInjecting(true);
        setAiError('');
        const prompt = `En tant qu'expert en recrutement, analyse les données de CV existantes et les notes supplémentaires, puis fusionne-les intelligemment. Met à jour les champs existants (comme la disponibilité ou le salaire) ou ajoute de nouvelles entrées (comme une expérience manquante) si nécessaire. Voici les données actuelles du CV au format JSON : ${JSON.stringify(cvData)}. Voici les notes à injecter : "${injectionNotes}". Renvoie l'intégralité des données du CV mises à jour, en respectant exactement le même format JSON. Ne renvoie que l'objet JSON brut.`;

        try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: jsonSchemaForAI } };
            const apiUrl = 'https://simulateur-ltd.onrender.com/api/gemini'; // MODIFIED: Point to the Render backend
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                const updatedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                setCvData(updatedJson);
                // Automatically regenerate the sales email with the new data
                await handleGenerateSalesEmail(updatedJson);
            } else { throw new Error("Invalid response structure from AI."); }
        } catch (e) {
            console.error("AI Injection Error:", e);
            setAiError("Erreur lors de la mise à jour par l'IA.");
        } finally {
            setIsInjecting(false);
        }
    };
    
    const handleGenerateSalesEmail = async (currentCvData = cvData) => {
        setIsGeneratingEmail(true);
        setAiError('');
        const prompt = `En tant qu'expert en recrutement, rédige un email de vente concis et percutant pour présenter le profil suivant à un potentiel employeur. Mets en avant les points forts du candidat en te basant sur son résumé, sa dernière expérience, et ses compétences clés. L'email doit être professionnel et inclure un appel à l'action clair. Ne mentionne PAS le nom de famille du candidat. Ne termine PAS par une formule de politesse ou une signature (ex: "Cordialement,"). Voici les données du CV : ${JSON.stringify(currentCvData)}. Ne renvoie que le texte brut du corps de l'email, sans la ligne "Objet:" ou "Subject:".`;
        try {
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiUrl = 'https://simulateur-ltd.onrender.com/api/gemini'; // MODIFIED: Point to the Render backend
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates[0].content.parts[0].text) {
                setSalesEmail(result.candidates[0].content.parts[0].text);
            } else { throw new Error("Invalid response structure from AI."); }
        } catch (e) { console.error("AI Email Generation Error:", e); setAiError("Erreur lors de la génération de l'email."); } finally { setIsGeneratingEmail(false); }
    };
    
    const copyToClipboard = (text) => {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            setCopied(true);
            setTimeout(() => setCopied(false), 2000);
        } catch (err) {
            console.error('Failed to copy: ', err);
        }
        document.body.removeChild(textArea);
    };

    // --- RENDER FUNCTIONS ---
    const renderRecruiterBanner = () => ( <div className="flex justify-between items-center p-4 border-b-2" style={{ borderColor: (palettes[activePalette] || {primary: '#4f46e5'}).primary }}> <div className="text-2xl font-bold" style={{ color: (palettes[activePalette] || {accent: '#3730a3'}).accent }}>{recruiterData.company}</div> <div className="text-right text-xs"> <p className="font-bold">{recruiterData.name}</p> <p>{recruiterData.title}</p> <p>Fixe: {recruiterData.phone} / Mobile: {recruiterData.mobile}</p> <p>Mail: {recruiterData.email}</p> </div> </div> );
    const renderHeader = (personalData) => ( <div className={`cv-header ${activeTemplate} flex flex-col ${headerAlignment === 'center' ? 'items-center text-center' : 'items-start text-left'}`} style={{ marginBottom: `${sectionSpacing}rem` }}> {photo && !isAnonymized && ( <motion.img layout src={photo} alt="User" className={`mb-4 w-32 h-32 object-cover shadow-lg`} style={{ borderRadius: photoShape === 'round' ? '50%' : '0.75rem' }} /> )} <h1 className="font-bold mb-1 text-gray-900" style={{ fontSize: `${nameFontSize}pt` }}> {personalData.firstName} {personalData.lastName} </h1> <h2 className="text-xl mb-3 font-medium" style={{ color: (palettes[activePalette] || {primary: '#4f46e5'}).primary }}> {personalData.title} </h2> {!isAnonymized && ( <div className={`flex flex-wrap ${headerAlignment === 'center' ? 'justify-center' : ''} gap-x-6 gap-y-2 text-gray-600 mb-4 text-sm`}> <div className="flex items-center gap-2"><Mail size={14} />{personalData.email}</div> <div className="flex items-center gap-2"><Phone size={14} />{personalData.phone}</div> <div className="flex items-center gap-2"><MapPin size={14} />{personalData.address}</div> </div> )} <div className={`flex flex-wrap ${headerAlignment === 'center' ? 'justify-center' : ''} gap-x-6 gap-y-2 text-gray-600 mb-4 text-sm`}> {(personalData.availability) && <div className="flex items-center gap-2"><Calendar size={14} />{personalData.availability}</div>} {(personalData.location) && <div className="flex items-center gap-2"><Map size={14} />{personalData.location}</div>} {(personalData.salaryExpectations) && <div className="flex items-center gap-2"><Euro size={14} />{personalData.salaryExpectations}</div>} </div> {!isSimplified && <p className="text-gray-700 leading-relaxed max-w-3xl"> {personalData.summary} </p>} </div> );
    const renderSection = (title, blockId, content) => { const s = { border: `border-b-2 pb-1`, background: `p-2 rounded-md`, simple: `` }; const c = sectionTitleStyle === 'background' ? (palettes[activePalette] || {textOnPrimary: '#ffffff'}).textOnPrimary : (palettes[activePalette] || {primary: '#4f46e5'}).primary; const bg = sectionTitleStyle === 'background' ? (palettes[activePalette] || {primary: '#4f46e5'}).primary : 'transparent'; const Icon = socialIcons[blockId] || Star; return ( <div className="cv-section" style={{ marginBottom: `${sectionSpacing}rem` }}> <h3 className={`font-bold mb-3 tracking-wider flex items-center gap-2 ${s[sectionTitleStyle]}`} style={{ color: c, backgroundColor: bg, borderColor: (palettes[activePalette] || {primary: '#4f46e5'}).primary, fontSize: `${sectionTitleFontSize}pt`, textTransform: 'uppercase', letterSpacing: `0.5px` }}> <Icon size={16}/> <span>{title}</span> </h3> {content} </div> ); };
    const renderExperiences = () => renderSection('Expérience Professionnelle', 'experiences', <div className={`space-y-4 ${experienceStyle === 'timeline' ? 'timeline' : ''}`}> {cvData.experiences.filter(e => visibility.experiences[e.id]).map(e => ( <div key={e.id} className={`cv-item relative ${experienceStyle === 'timeline' ? 'timeline-item pb-4' : ''}`}> <div className="flex justify-between items-start mb-1"> <div> <h4 className="font-semibold text-base">{e.position}</h4> <p className="font-medium" style={{ color: (palettes[activePalette] || {accent: '#3730a3'}).accent }}>{e.company}</p> </div> <span className="font-mono whitespace-nowrap pl-4 text-sm text-gray-600">{e.startDate} - {e.endDate}</span> </div> {!isSimplified && <p className="text-gray-600">{e.description}</p>} </div> ))} </div> );
    const renderProjects = () => renderSection('Projets', 'projects', <div className="space-y-4"> {cvData.projects && cvData.projects.filter(p => visibility.projects[p.id]).map(p => ( <div key={p.id} className="cv-item"> <div className="flex justify-between items-start mb-1"> <h4 className="font-semibold text-base">{p.name}</h4> {p.url && <a href={`https://${p.url}`} target="_blank" rel="noopener noreferrer" className="font-mono text-sm" style={{color: (palettes[activePalette] || {primary: '#4f46e5'}).primary}}>Voir le projet</a>} </div> {!isSimplified && <p className="text-gray-600">{p.description}</p>} </div> ))} </div> );
    const renderEducation = () => renderSection('Formation', 'education', <div className={`space-y-4 ${experienceStyle === 'timeline' ? 'timeline' : ''}`}> {cvData.education.filter(e => visibility.education[e.id]).map(e => ( <div key={e.id} className={`cv-item relative ${experienceStyle === 'timeline' ? 'timeline-item pb-4' : ''}`}> <div className="flex justify-between items-start mb-1"> <div> <h4 className="font-semibold text-base">{e.degree}</h4> <p className="font-medium" style={{ color: (palettes[activePalette] || {accent: '#3730a3'}).accent }}>{e.institution}</p> </div> <span className="font-mono whitespace-nowrap pl-4 text-sm text-gray-600">{e.startDate} - {e.endDate}</span> </div> {!isSimplified && <p className="text-gray-600">{e.description}</p>} </div> ))} </div> );
    const renderAwards = () => renderSection('Récompenses', 'awards', <div className="space-y-4"> {cvData.awards && cvData.awards.filter(a => visibility.awards[a.id]).map(a => ( <div key={a.id} className="cv-item"> <div className="flex justify-between items-start mb-1"> <div> <h4 className="font-semibold text-base">{a.name}</h4> <p className="font-medium" style={{ color: (palettes[activePalette] || {accent: '#3730a3'}).accent }}>{a.issuer}</p> </div> <span className="font-mono whitespace-nowrap pl-4 text-sm text-gray-600">{a.date}</span> </div> {!isSimplified && <p className="text-gray-600">{a.description}</p>} </div> ))} </div> );
    const renderSkills = () => { if (skillDisplayStyle === 'radar') { return renderSection('Compétences', 'skills', <div className="w-full max-w-md mx-auto"><canvas ref={skillChartCanvasRef}></canvas></div>); } const groupedSkills = cvData.skills.reduce((acc, skill) => { const category = skill.category || 'Autres'; if (!acc[category]) { acc[category] = []; } acc[category].push(skill); return acc; }, {}); const content = <div> {Object.keys(groupedSkills).map(category => ( <div key={category} className="mb-3"> <h5 className="font-bold text-sm mb-2 text-gray-600">{category}</h5> <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6" style={{ gapY: `${itemSpacing / 2}rem` }}> {groupedSkills[category].map(skill => ( <div key={skill.id}> <div className="flex items-center gap-2"><span className="font-medium">{skill.name}</span></div> {skillDisplayStyle === 'stars' ? ( <div className="flex items-center mt-1">{[...Array(5)].map((_, i) => <Star key={i} size={16} className={i < skill.level ? 'fill-current' : ''} style={{ color: i < skill.level ? (palettes[activePalette] || {primary: '#4f46e5'}).primary : '#e0e0e0' }} />)}</div> ) : ( <div className="w-full bg-gray-200 rounded-full h-2 mt-1"><div className="h-2 rounded-full" style={{ width: `${skill.level * 20}%`, backgroundColor: (palettes[activePalette] || {primary: '#4f46e5'}).primary }}></div></div> )} </div> ))} </div> </div> ))} </div>; return renderSection('Compétences', 'skills', content); };
    const renderLanguages = () => renderSection('Langues', 'languages', <div className="space-y-1"> {cvData.languages.map((l) => ( <div key={l.id} className="flex justify-between py-1"> <span className="font-medium">{l.name}</span> <span className="text-gray-600">{l.level}</span> </div> ))} </div> );
    const renderHobbies = () => renderSection('Centres d\'intérêt', 'hobbies', <div className="flex flex-wrap" style={{gap: `${itemSpacing}rem`}}> {cvData.hobbies.map((h) => ( <div key={h.id} className="flex items-center p-2 bg-gray-100 rounded-lg"> <IconComponent name={h.icon} size={14} className="mr-2" style={{color: (palettes[activePalette] || {primary: '#4f46e5'}).primary}} /> <span>{h.name}</span> </div> ))} </div> );
    const renderSocials = () => renderSection('Réseaux & Liens', 'socials', <div className="flex flex-wrap gap-4">{cvData.socials.filter(s => visibility.socials[s.id]).map(social => { const SocialIcon = socialIcons[social.network] || socialIcons.default; return <a key={social.id} href={social.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-gray-700 hover:text-[var(--primary-color)] transition-colors"><SocialIcon size={16}/><span className="text-sm">{social.url.replace(/^(https?:\/\/)?(www\.)?/, '')}</span></a>})}</div>);
    const renderCustomSection = (section) => renderSection(section.title, `custom-${section.id}`, <p className="text-gray-600">{section.content}</p>);

    const renderCV = () => {
        const pData = isAnonymized ? { ...cvData.personal, lastName: `${cvData.personal.lastName.charAt(0)}.`, email: '', phone: '', address: '' } : cvData.personal;
        const getBlock = (id) => {
            switch(id) {
                case 'personal': return renderHeader(pData);
                case 'socials': return cvData.socials?.length > 0 && visibility.socials ? renderSocials() : null;
                case 'experiences': return cvData.experiences?.length > 0 && visibility.experiences ? renderExperiences() : null;
                case 'projects': return cvData.projects?.length > 0 && visibility.projects ? renderProjects() : null;
                case 'education': return cvData.education?.length > 0 && visibility.education ? renderEducation() : null;
                case 'awards': return cvData.awards?.length > 0 && visibility.awards ? renderAwards() : null;
                case 'skills': return cvData.skills?.length > 0 && visibility.skills ? renderSkills() : null;
                case 'languages': return cvData.languages?.length > 0 && visibility.languages ? renderLanguages() : null;
                case 'hobbies': return cvData.hobbies?.length > 0 && visibility.hobbies ? renderHobbies() : null;
                default:
                    if (id.startsWith('custom-')) {
                        const section = cvData.customSections.find(s => `custom-${s.id}` === id);
                        return section ? renderCustomSection(section) : null;
                    }
                    return null;
            }
        };
        const { left: leftCol, right: rightCol } = { 'large-right': { left: 'w-1/3', right: 'w-2/3' }, 'equal': { left: 'w-1/2', right: 'w-1/2' }, 'large-left': { left: 'w-2/3', right: 'w-1/3' } }[columnRatio];
        const content = activeLayout === 'two' ? ( <div className="flex h-full" style={{ gap: `${pagePadding}rem` }}> <div className={`${leftCol} flex flex-col`}>{columnAssignment.left.map(id => <React.Fragment key={id}>{getBlock(id)}</React.Fragment>)}</div> <div className={`${rightCol} flex flex-col`}>{columnAssignment.right.map(id => <React.Fragment key={id}>{getBlock(id)}</React.Fragment>)}</div> </div> ) : ( <> {getBlock('personal')} <div className="flex flex-col">{blockOrder.map(id => <React.Fragment key={id}>{getBlock(id)}</React.Fragment>)}</div> </> );
        return ( <div id="cv-preview-container" className="bg-white" style={{ width: '210mm', height: '297mm', boxSizing: 'border-box', overflow: 'hidden' }}> <div id="cv-preview" className={`text-gray-800 template-${activeTemplate}`} style={{ fontFamily: fonts[activeFont].family, backgroundColor: '#ffffff', boxSizing: 'border-box', width: '100%', height: '100%', '--primary-color': (palettes[activePalette] || {primary: '#4f46e5'}).primary }}> <div ref={cvContentRef} className="h-full w-full flex flex-col relative" style={{ fontSize: `${baseFontSize}pt`, lineHeight: lineHeight }}> {showRecruiterBanner && renderRecruiterBanner()} <div className="flex-grow" style={{padding: `${pagePadding}rem`}}>{content}</div> {showVCardQR && !isAnonymized && <div ref={vCardQrCodeRef} className="absolute bottom-4 right-4 bg-white p-2 rounded-md shadow-lg"></div>} </div> </div> </div> );
    };

    // --- EDITOR ---
    const isCvEmpty = !cvData.personal.firstName && !cvData.personal.lastName && cvData.experiences.length === 0;
    
    const renderDraggableBlock = (blockId, column) => (
        <motion.div layout key={blockId} draggable onDragStart={(e) => handleDragStart(e, blockId)} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, blockId, column)} className="p-3 bg-gray-100 border border-gray-200 rounded-lg cursor-move hover:bg-indigo-50 hover:border-indigo-200 transition-colors flex items-center gap-2">
            <Move size={16} className="text-gray-500" />
            <span className="font-medium text-sm flex-grow">{ {personal: 'Infos Personnelles', socials: 'Réseaux & Liens', experiences: 'Expériences', projects: 'Projets', education: 'Formation', awards: 'Récompenses', skills: 'Compétences', languages: 'Langues', hobbies: 'Centres d\'intérêt'}[blockId] || cvData.customSections.find(s => `custom-${s.id}` === blockId)?.title }</span>
            <Tooltip text={visibility[blockId] ? "Cacher" : "Afficher"}>
                <button onClick={() => toggleSectionVisibility(blockId)} className="p-1 hover:bg-gray-300 rounded-full">
                    {visibility[blockId] ? <Eye size={16} className="text-gray-600"/> : <EyeOff size={16} className="text-gray-400"/>}
                </button>
            </Tooltip>
        </motion.div>
    );

    const renderEditor = () => (
        <div className="bg-white rounded-xl shadow-sm">
            <div className="border-b border-gray-200">
                <nav className="-mb-px flex space-x-1 overflow-x-auto p-2" aria-label="Tabs">
                    {editorTabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveEditorTab(tab.id)}
                            className={`whitespace-nowrap flex items-center py-3 px-4 font-medium text-sm rounded-lg transition-colors ${
                                activeEditorTab === tab.id
                                    ? 'bg-indigo-100 text-indigo-700'
                                    : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                            }`}
                        >
                            <tab.icon className="mr-2 h-5 w-5" />
                            {tab.label}
                        </button>
                    ))}
                </nav>
            </div>

            <div className="p-6">
                <AnimatePresence mode="wait">
                    <motion.div
                        key={activeEditorTab}
                        initial={{ y: 10, opacity: 0 }}
                        animate={{ y: 0, opacity: 1 }}
                        exit={{ y: -10, opacity: 0 }}
                        transition={{ duration: 0.2 }}
                    >
                        {activeEditorTab === 'ia' && (
                            <div className="space-y-4">
                                <div className="p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-indigo-800 flex items-start gap-3">
                                    <Info size={20} className="mt-1 flex-shrink-0" />
                                    <div>
                                        <h4 className="font-bold">Comment ça marche ?</h4>
                                        <p className="text-sm">Ouvrez votre CV (PDF, Word...), copiez tout le texte et collez-le dans la zone ci-dessous. L'IA analysera tout et remplira le formulaire pour vous !</p>
                                    </div>
                                </div>
                                <TextareaField label="Copiez et collez le contenu de votre CV ici" value={aiInput} onChange={(e) => setAiInput(e.target.value)} placeholder={"Ex: Léa Martin\nDéveloppeuse Full-Stack\nParis, France\n\nExpérience\nTech Startup, Développeuse Senior..."} rows={6} />
                                <button onClick={handleAiGenerate} disabled={isAiLoading} className="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 transition-colors disabled:bg-indigo-300"> {isAiLoading ? <><LoaderCircle size={16} className="animate-spin" /> Analyse...</> : <><Sparkles size={16} /> Remplir le formulaire</>} </button>
                                {aiError && <p className="text-red-500 text-sm mt-2">{aiError}</p>}
                            </div>
                        )}

                        {activeEditorTab === 'personalisation' && (
                            <div className="space-y-4">
                                <p className="text-sm text-gray-600">Ajoutez des informations de dernière minute (disponibilité, salaire, expérience manquante...) et l'IA mettra à jour le CV et l'email de présentation.</p>
                                <TextareaField label="Notes à injecter dans le CV" value={injectionNotes} onChange={(e) => setInjectionNotes(e.target.value)} placeholder="Ex: Disponible immédiatement, prétention salariale 55k€..." rows={4} />
                                <button onClick={handleAiInjection} disabled={isInjecting} className="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2 transition-colors disabled:bg-purple-300">
                                    {isInjecting ? <><LoaderCircle size={16} className="animate-spin" /> Mise à jour...</> : <><Wand size={16} /> Mettre à jour le CV et l'email</>}
                                </button>
                            </div>
                        )}

                        {activeEditorTab === 'vente' && (
                             <div className="space-y-4">
                                 <p className="text-sm text-gray-600">Générez un email de présentation percutant basé sur les informations de votre CV pour contacter les recruteurs.</p>
                                 <button onClick={() => handleGenerateSalesEmail()} disabled={isGeneratingEmail} className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 transition-colors disabled:bg-blue-300">
                                     {isGeneratingEmail ? <><LoaderCircle size={16} className="animate-spin" /> Génération...</> : <><Sparkles size={16} /> (Re)Générer l'email de présentation</>}
                                 </button>
                                 <TextareaField label="Email de présentation généré" value={salesEmail} onChange={(e) => setSalesEmail(e.target.value)} placeholder="L'email généré par l'IA apparaîtra ici..." rows={10}>
                                     <button onClick={() => copyToClipboard(salesEmail)} className="px-3 py-1 text-sm bg-gray-200 rounded-md hover:bg-gray-300 flex items-center gap-2">
                                         {copied ? <CheckCircle size={14} className="text-green-600" /> : <Copy size={14} />}
                                         {copied ? 'Copié !' : 'Copier'}
                                     </button>
                                 </TextareaField>
                             </div>
                        )}

                        {activeEditorTab === 'contenu' && (
                            <div className="space-y-4">
                                <Accordion title="Informations Personnelles" icon={User} defaultOpen>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <InputField label="Prénom" value={cvData.personal.firstName} onChange={(e) => handleCvDataChange('personal', 'firstName', e.target.value)} placeholder="ex: Léa" Icon={User} />
                                        <InputField label="Nom" value={cvData.personal.lastName} onChange={(e) => handleCvDataChange('personal', 'lastName', e.target.value)} placeholder="ex: Martin" Icon={User} />
                                        <InputField label="Titre du poste" value={cvData.personal.title} onChange={(e) => handleCvDataChange('personal', 'title', e.target.value)} placeholder="ex: Développeuse Full-Stack" Icon={Briefcase} />
                                        <InputField label="Email" type="email" value={cvData.personal.email} onChange={(e) => handleCvDataChange('personal', 'email', e.target.value)} placeholder="ex: lea.martin@email.dev" Icon={Mail} />
                                        <InputField label="Téléphone" value={cvData.personal.phone} onChange={(e) => handleCvDataChange('personal', 'phone', e.target.value)} placeholder="ex: +33 7 11 22 33 44" Icon={Phone} />
                                        <InputField label="Adresse" value={cvData.personal.address} onChange={(e) => handleCvDataChange('personal', 'address', e.target.value)} placeholder="ex: Paris, France" Icon={MapPin} />
                                        <InputField label="Disponibilité" value={cvData.personal.availability} onChange={(e) => handleCvDataChange('personal', 'availability', e.target.value)} placeholder="ex: Immédiate" Icon={Calendar} />
                                        <InputField label="Prétention Salariale" value={cvData.personal.salaryExpectations} onChange={(e) => handleCvDataChange('personal', 'salaryExpectations', e.target.value)} placeholder="ex: 55-65k€" Icon={Euro} />
                                        <div className="md:col-span-2">
                                            <InputField label="Localisation souhaitée" value={cvData.personal.location} onChange={(e) => handleCvDataChange('personal', 'location', e.target.value)} placeholder="ex: Paris ou télétravail" Icon={Map} />
                                        </div>
                                        <div className="md:col-span-2">
                                            <TextareaField label="Résumé" value={cvData.personal.summary} onChange={(e) => handleCvDataChange('personal', 'summary', e.target.value)} placeholder="Décrivez en quelques phrases votre profil et vos objectifs..." Icon={Text} />
                                        </div>
                                    </div>
                                </Accordion>
                                <Accordion title="Expériences" icon={Briefcase}>
                                    <div className="space-y-4">
                                        {cvData.experiences.map((exp, index) => (
                                            <motion.div key={exp.id} layout initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="p-4 border rounded-lg bg-gray-50 space-y-3 relative">
                                                <div className="flex justify-between items-center">
                                                    <h4 className="font-semibold">Expérience #{index + 1}</h4>
                                                    <button onClick={() => removeListItem('experiences', exp.id)} className="p-1 text-red-500 hover:bg-red-100 rounded-full"><Trash2 size={16} /></button>
                                                </div>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <InputField label="Poste" value={exp.position} onChange={(e) => handleListItemChange('experiences', exp.id, 'position', e.target.value)} placeholder="Développeur Senior" />
                                                    <InputField label="Entreprise" value={exp.company} onChange={(e) => handleListItemChange('experiences', exp.id, 'company', e.target.value)} placeholder="Tech Startup" />
                                                    <InputField label="Date de début" value={exp.startDate} onChange={(e) => handleListItemChange('experiences', exp.id, 'startDate', e.target.value)} placeholder="2020" />
                                                    <InputField label="Date de fin" value={exp.endDate} onChange={(e) => handleListItemChange('experiences', exp.id, 'endDate', e.target.value)} placeholder="Présent" />
                                                </div>
                                                <TextareaField label="Description" value={exp.description} onChange={(e) => handleListItemChange('experiences', exp.id, 'description', e.target.value)} placeholder="Décrivez vos missions et réalisations..." />
                                            </motion.div>
                                        ))}
                                        <button onClick={() => addListItem('experiences')} className="w-full px-4 py-2 bg-gray-100 text-gray-800 rounded-lg hover:bg-gray-200 flex items-center justify-center gap-2 transition-colors">
                                            <Plus size={16} /> Ajouter une expérience
                                        </button>
                                    </div>
                                </Accordion>
                            </div>
                        )}

                        {activeEditorTab === 'design' && (
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                 <div> <h4 className="font-semibold mb-2">Modèle</h4> <div className="flex flex-col space-y-2"> {Object.entries(templates).map(([k, t]) => ( <button key={k} onClick={() => setActiveTemplate(k)} className={`p-2 rounded-lg border-2 text-sm ${activeTemplate === k ? 'border-indigo-500 bg-indigo-50 font-semibold' : 'border-gray-200 hover:border-gray-300'}`}>{t.name}</button> ))} </div> </div>
                                 <div> <h4 className="font-semibold mb-2">Mise en page</h4> <div className="flex flex-col space-y-2"> {Object.entries(layouts).map(([k, l]) => ( <button key={k} onClick={() => setActiveLayout(k)} className={`p-2 rounded-lg border-2 text-sm ${activeLayout === k ? 'border-indigo-500 bg-indigo-50 font-semibold' : 'border-gray-200 hover:border-gray-300'}`}>{l.name}</button> ))} </div> {activeLayout === 'two' && <div className="mt-4"><h4 className="font-semibold mb-2">Ratio</h4><div className="flex flex-col space-y-2"><button onClick={() => setColumnRatio('large-left')} className={`p-2 rounded-lg border-2 text-sm ${columnRatio === 'large-left' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}>Large/Étroit</button><button onClick={() => setColumnRatio('equal')} className={`p-2 rounded-lg border-2 text-sm ${columnRatio === 'equal' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}>Égal</button><button onClick={() => setColumnRatio('large-right')} className={`p-2 rounded-lg border-2 text-sm ${columnRatio === 'large-right' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`}>Étroit/Large</button></div></div>} </div>
                                 <div> <h4 className="font-semibold mb-2">Police</h4> <div className="flex flex-col space-y-2"> {Object.entries(fonts).map(([k, f]) => ( <button key={k} onClick={() => setActiveFont(k)} style={{fontFamily: f.family}} className={`p-2 rounded-lg border-2 text-sm ${activeFont === k ? 'border-indigo-500 bg-indigo-50 font-semibold' : 'border-gray-200 hover:border-gray-300'}`}>{f.name}</button> ))} </div> </div>
                                 <div className="lg:col-span-3"> <h4 className="font-semibold mb-2">Couleur d'accent</h4> <div className="flex gap-3 flex-wrap"> {Object.entries(palettes).map(([k, c]) => ( <Tooltip text={c.name} key={k}> <button onClick={() => setActivePalette(k)} className={`w-10 h-10 rounded-full border-4 transition-all ${activePalette === k ? 'border-indigo-500 scale-110' : 'border-transparent'}`} style={{backgroundColor: c.primary}}></button></Tooltip> ))} </div> </div>
                             </div>
                        )}
                        
                        {activeEditorTab === 'options' && (
                            <div className="space-y-6">
                                <div>
                                    <h4 className="font-semibold mb-3">Organisation des sections</h4>
                                    {activeLayout === 'two' ? ( <div className="space-y-4"> <button onClick={invertColumns} className="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 flex items-center justify-center gap-2 transition-colors"><ArrowLeftRight size={16} /> Inverser les colonnes</button> <div className="grid grid-cols-2 gap-4"> <div> <h4 className="font-semibold mb-2 text-center">Colonne Gauche</h4> <div onDragOver={handleDragOver} onDrop={(e) => handleDropOnColumn(e, 'left')} className="p-2 space-y-2 bg-gray-50 rounded-lg min-h-[200px] border-2 border-dashed"> {columnAssignment.left.map(id => renderDraggableBlock(id, 'left'))} </div> </div> <div> <h4 className="font-semibold mb-2 text-center">Colonne Droite</h4> <div onDragOver={handleDragOver} onDrop={(e) => handleDropOnColumn(e, 'right')} className="p-2 space-y-2 bg-gray-50 rounded-lg min-h-[200px] border-2 border-dashed"> {columnAssignment.right.map(id => renderDraggableBlock(id, 'right'))} </div> </div> </div> </div> ) : ( <div className="space-y-2">{blockOrder.map(id => renderDraggableBlock(id))}</div> )}
                                </div>
                                <div>
                                    <h4 className="font-semibold mb-3 mt-6">Infos Recruteur</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1"> <InputField label="Nom du recruteur" value={recruiterData.name} onChange={(e) => handleRecruiterDataChange('name', e.target.value)} /> <InputField label="Titre du recruteur" value={recruiterData.title} onChange={(e) => handleRecruiterDataChange('title', e.target.value)} /> <InputField label="Société" value={recruiterData.company} onChange={(e) => handleRecruiterDataChange('company', e.target.value)} /> <InputField label="Email" value={recruiterData.email} onChange={(e) => handleRecruiterDataChange('email', e.target.value)} /> <InputField label="Téléphone Fixe" value={recruiterData.phone} onChange={(e) => handleRecruiterDataChange('phone', e.target.value)} /> <InputField label="Téléphone Mobile" value={recruiterData.mobile} onChange={(e) => handleRecruiterDataChange('mobile', e.target.value)} /> </div>
                                </div>
                                <div>
                                    <h4 className="font-semibold mb-3 mt-6">Photo & Extras</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-center"> <div> <label htmlFor="photo-upload" className="w-full text-center px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 cursor-pointer flex items-center justify-center gap-2"> <Camera size={16}/> Changer de photo </label> <input id="photo-upload" type="file" accept="image/*" onChange={handlePhotoChange} className="hidden" /> </div> <div className="flex items-center gap-2"> <h4 className="font-semibold">Forme:</h4> <Tooltip text="Ronde"><button onClick={() => setPhotoShape('round')} className={`p-2 rounded-full border-2 ${photoShape === 'round' ? 'border-indigo-500 bg-indigo-50' : 'border-transparent hover:bg-gray-100'}`}><Circle/></button></Tooltip> <Tooltip text="Carrée"><button onClick={() => setPhotoShape('square')} className={`p-2 rounded-lg border-2 ${photoShape === 'square' ? 'border-indigo-500 bg-indigo-50' : 'border-transparent hover:bg-gray-100'}`}><Square/></button></Tooltip> </div> <div className="md:col-span-2 flex items-center gap-2"> <input type="checkbox" id="vcard-toggle" checked={showVCardQR} onChange={(e) => setShowVCardQR(e.target.checked)} className="h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500" /> <label htmlFor="vcard-toggle" className="font-semibold">Afficher QR Code Contact</label> </div> </div>
                                </div>
                                <div>
                                    <h4 className="font-semibold mb-3 mt-6">Données & Exemples</h4>
                                    <div className="flex gap-4"> 
                                        <button onClick={() => { setCvData(exampleData.dev); }} className="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Exemple Développeur</button> 
                                        <button onClick={() => { setCvData(exampleData.manager); }} className="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Exemple Manager</button> 
                                        <Tooltip text="Réinitialiser le formulaire"><button onClick={() => { setCvData(emptyCvData); setPhoto(null); }} className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200"><RefreshCcw size={16}/></button></Tooltip>
                                    </div>
                                </div>
                            </div>
                        )}
                    </motion.div>
                </AnimatePresence>
            </div>
        </div>
    );

    // --- RENDER PRINCIPAL ---
    return (
        <div className="min-h-screen bg-gray-50 p-2 md:p-6 font-sans">
            <style>{` @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono&family=Lora:ital,wght@0,400;0,700;1,400&display=swap'); .cv-section, .cv-item, .cv-header { page-break-inside: avoid; } .timeline { position: relative; padding-left: 25px; border-left: 2px solid #e5e7eb; } .timeline-item::before { content: ''; position: absolute; left: -34px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background-color: white; border: 2px solid var(--primary-color, #4f46e5); }`}</style>
            <div className="max-w-screen-2xl mx-auto">
                <header className="bg-white rounded-xl shadow-md p-4 mb-6 flex flex-wrap justify-between items-center gap-4 sticky top-4 z-20">
                    <h1 className="text-xl font-bold text-gray-800">Créateur de CV Pro</h1>
                    <div className="flex items-center flex-wrap gap-2">
                        <Tooltip text="Design Aléatoire"><button onClick={handleRandomizeDesign} className="p-2 rounded-lg transition-colors bg-purple-100 text-purple-700 hover:bg-purple-200"><Sparkles size={18} /></button></Tooltip>
                        <Tooltip text={isAnonymized ? "Désanonymiser" : "Anonymiser"}><button onClick={() => setIsAnonymized(!isAnonymized)} className={`p-2 rounded-lg transition-colors ${isAnonymized ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800'}`}><ShieldCheck size={18} /></button></Tooltip>
                        <button onClick={() => setPreviewMode(!previewMode)} className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center gap-2 transition-colors"> <Eye size={16} /> <span className="hidden sm:inline">{previewMode ? 'Éditer' : 'Plein écran'}</span> </button>
                        <button onClick={() => generatePDF()} disabled={isDownloadingPdf} className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 transition-colors disabled:bg-indigo-300 w-[180px]"> {isDownloadingPdf ? <><LoaderCircle size={16} className="animate-spin" /> Téléchargement...</> : <><Download size={16} /> Télécharger PDF</>} </button>
                        <button onClick={generateWord} disabled={isDownloadingWord} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 transition-colors disabled:bg-blue-300 w-[180px]"> {isDownloadingWord ? <><LoaderCircle size={16} className="animate-spin" /> Génération...</> : <><FileText size={16} /> Télécharger Word</>} </button>
                    </div>
                </header>
                <div className={`grid ${previewMode ? 'grid-cols-1' : 'grid-cols-1 xl:grid-cols-[1fr,1.5fr]'} gap-8 items-start`}>
                    <AnimatePresence> {!previewMode && ( <motion.div initial={{ opacity: 0, x: -50 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -50 }} className="space-y-6"> {renderEditor()} </motion.div> )} </AnimatePresence>
                    <div className="flex flex-col items-center sticky top-28">
                        <AnimatePresence>
                            {isOverflowing && !isCvEmpty && (
                                <motion.div initial={{opacity: 0, y: -20}} animate={{opacity: 1, y: 0}} exit={{opacity: 0, y: -20}} className="w-full flex items-center gap-3 bg-red-100 border border-red-400 text-red-800 px-4 py-2 rounded-lg mb-4">
                                    <AlertTriangle size={24} />
                                    <div>
                                        <h4 className="font-bold">Le contenu dépasse la page !</h4>
                                        <p className="text-sm">Votre CV est trop long pour une seule page A4. Pensez à réduire le texte ou à cacher des sections.</p>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                        <div className="w-full flex justify-center items-center gap-2 mb-4 bg-white p-2 rounded-lg shadow-sm">
                            <Tooltip text="Zoom arrière"><button onClick={() => setPreviewScale(s => Math.max(0.3, s - 0.1))} className="p-2 rounded-full hover:bg-gray-100"><ZoomOut size={18}/></button></Tooltip>
                            <input type="range" min="0.3" max="1.5" step="0.01" value={previewScale} onChange={e => setPreviewScale(parseFloat(e.target.value))} className="w-32" />
                            <Tooltip text="Zoom avant"><button onClick={() => setPreviewScale(s => Math.min(1.5, s + 0.1))} className="p-2 rounded-full hover:bg-gray-100"><ZoomIn size={18}/></button></Tooltip>
                            <Tooltip text="Réinitialiser le zoom"><button onClick={() => setPreviewScale(previewMode ? 1 : 0.8)} className="p-2 rounded-full hover:bg-gray-100"><RotateCw size={16}/></button></Tooltip>
                            <span className="text-sm font-mono text-gray-500">{Math.round(previewScale * 100)}%</span>
                        </div>
                        
                        {isCvEmpty ? (
                            <div className="flex flex-col items-center justify-center text-center text-gray-500 bg-gray-100 rounded-lg p-10 w-[210mm]" style={{transform: `scale(${previewScale})`, height: '297mm'}}>
                                <FileText size={48} className="mb-4" />
                                <h3 className="text-xl font-semibold text-gray-700">Votre CV est vide</h3>
                                <p className="mt-2 max-w-sm">Utilisez l'assistant IA pour coller votre CV existant ou remplissez les sections dans le panneau de gauche pour commencer.</p>
                            </div>
                        ) : (
                            <div 
                                ref={cvPreviewRef} 
                                className="origin-top shadow-2xl transition-transform duration-300"
                                style={{ transform: `scale(${previewScale})` }}
                            > 
                                {renderCV()} 
                            </div>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
};

export default CVGenerator;
