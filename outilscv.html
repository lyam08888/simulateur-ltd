<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Générateur de CV Professionnel IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        #cv-preview-wrapper {
            width: 210mm;
            min-height: 297mm;
            background-color: white;
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            margin: 2rem auto;
            transition: opacity 0.5s ease-in-out;
        }
        #cv-preview {
            /* No padding here, we control it with internal divs */
        }
        .hidden-initially {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-start px-4 py-10">

    <!-- Section de contrôle -->
    <div class="w-full max-w-3xl bg-white shadow-lg rounded-xl p-8 mb-8">
        <div class="flex items-center justify-center gap-3 mb-2">
             <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v5"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M4.268 12.157a2.5 2.5 0 0 0-2.45 2.691 2.5 2.5 0 0 0 2.45 2.691h.084a2.5 2.5 0 0 1 2.45 2.691 2.5 2.5 0 0 1-2.45 2.691h-.084a2.5 2.5 0 0 0-2.45 2.691 2.5 2.5 0 0 0 2.45 2.691"/><path d="m10 15-2 2 2 2"/><path d="m7 17h3"/></svg>
            <h1 class="text-3xl font-bold text-center text-gray-800">Générateur de CV Professionnel</h1>
        </div>
        <p class="text-center text-gray-500 mb-8">Créez un CV élégant et structuré, prêt à être téléchargé en PDF.</p>
        
        <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">
            Décrivez le CV que vous souhaitez :
        </label>
        <textarea id="prompt" placeholder="Exemple : Crée un CV pour un chef de projet marketing avec 5 ans d'expérience, spécialisé en SEO et campagnes digitales."
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 mb-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>

        <button id="generate-btn"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm hover:shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
            Générer le CV
        </button>

        <div id="notification" class="mt-4 text-center text-sm min-h-[20px]"></div>
    </div>

    <!-- Boutons d'action (initialement masqués) -->
    <div id="action-buttons" class="w-full max-w-3xl text-center mb-8 hidden-initially">
         <div class="flex justify-center gap-4 flex-wrap">
            <button id="copy-btn" class="bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-700 transition-all duration-300 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                Copier Texte Original
            </button>
            <button id="download-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center justify-center gap-2">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                 Télécharger en PDF
            </button>
        </div>
    </div>

    <!-- Prévisualisation du CV -->
    <div id="cv-container" class="hidden-initially">
        <div id="cv-preview-wrapper">
            <div id="cv-preview">
                <!-- Le contenu du CV structuré sera injecté ici -->
            </div>
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const copyBtn = document.getElementById('copy-btn');
        const actionButtons = document.getElementById('action-buttons');
        const promptInput = document.getElementById('prompt');
        const notificationDiv = document.getElementById('notification');
        const cvContainer = document.getElementById('cv-container');
        const cvPreview = document.getElementById('cv-preview');
        
        let cvFileName = 'cv.pdf';
        let originalRawText = '';

        function notify(message, type = 'info') {
            notificationDiv.innerHTML = '';
            const p = document.createElement('p');
            p.innerHTML = message;
            const colors = { error: 'text-red-500', success: 'text-green-600', info: 'text-gray-500' };
            p.className = `${colors[type]} font-medium transition-opacity duration-300`;
            notificationDiv.appendChild(p);
        }

        function setLoadingState(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="loader"></div><span class="ml-2">Génération en cours...</span>';
                cvContainer.style.display = 'none';
                actionButtons.style.display = 'none';
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>Générer le CV';
            }
        }

        function parseCvTextLocally(text) {
            const cvData = {
                name: '', title: '',
                contact: { email: '', phone: '', address: '', linkedin: '' },
                summary: '', experience: [], education: [], skills: [], languages: []
            };

            const lines = text.split('\n').filter(line => line.trim() !== '');

            if (lines.length > 0) cvData.name = lines.shift().replace(/[*#]/g, '').trim();
            if (lines.length > 0 && lines[0].length < 60 && !lines[0].includes(':')) {
                cvData.title = lines.shift().replace(/[*#]/g, '').trim();
            }

            const sectionKeywords = {
                summary: /Profil|Résumé|À propos/i,
                experience: /Expérience|Parcours Professionnel/i,
                education: /Formation|Éducation/i,
                skills: /Compétences/i,
                contact: /Contact|Coordonnées/i,
                languages: /Langues/i
            };

            let currentSection = 'contact'; // Assume contact info can be anywhere at the top
            let sections = { contact: '' };

            for (const line of lines) {
                let isNewSection = false;
                for (const key in sectionKeywords) {
                    if (sectionKeywords[key].test(line)) {
                        currentSection = key;
                        sections[currentSection] = '';
                        isNewSection = true;
                        break;
                    }
                }
                if (!isNewSection && currentSection) {
                    sections[currentSection] += line + '\n';
                }
            }
            
            // Populate data from parsed sections
            const contactText = sections.contact || text;
            cvData.contact.email = (contactText.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/) || [])[0] || '';
            cvData.contact.phone = (contactText.match(/(\+33|0)[1-9]([ .-]?[0-9]{2}){4}/) || [])[0] || '';
            cvData.contact.address = (contactText.match(/(?:\d{1,5}\s[\w\s]{1,50},?\s\d{5}\s[\w\s-]{1,50})/) || [])[0] || '';
            cvData.contact.linkedin = (contactText.match(/linkedin\.com\/in\/[a-zA-Z0-9-]+/) || [])[0] || '';

            if (sections.summary) cvData.summary = sections.summary.trim();
            if (sections.skills) cvData.skills = sections.skills.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            if (sections.languages) cvData.languages = sections.languages.split('\n').map(s => s.replace(/^[-*]\s*/, '').trim()).filter(Boolean);
            
            if (sections.experience) {
                const entries = sections.experience.trim().split(/\n\s*\n/); // Split by blank lines
                entries.forEach(entry => {
                    const lines = entry.split('\n');
                    const titleLine = lines.shift() || '';
                    const companyLine = lines.shift() || '';
                    const description = lines.slice(0).join('\n').replace(/^[-*]\s*/gm, '').trim();
                    const companyParts = companyLine.split('|').map(s => s.trim());
                    const company = companyParts[0] || '';
                    const dates = companyParts[1] || '';
                    cvData.experience.push({ title: titleLine.replace(/^[-*]\s*/, '').trim(), company, dates, description });
                });
            }
            if (sections.education) {
                 const entries = sections.education.trim().split(/\n\s*\n/);
                 entries.forEach(entry => {
                     const lines = entry.split('\n');
                     const degree = lines.shift() || '';
                     const schoolLine = lines.shift() || '';
                     const schoolParts = schoolLine.split('|').map(s => s.trim());
                     const school = schoolParts[0] || '';
                     const dates = schoolParts[1] || '';
                     cvData.education.push({ degree, school, dates });
                });
            }

            return cvData;
        }

        async function handleGenerateCV() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                notify("Veuillez décrire le CV que vous souhaitez générer.", 'error');
                return;
            }

            setLoadingState(true);
            notify("Génération de votre CV...", 'info');

            try {
                const response = await fetch("https://simulateur-ltd.onrender.com/api/gemini", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: userPrompt })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`Erreur de l'API: ${response.status}. ${errorBody}`);
                }

                const data = await response.json();
                
                if (!data.response) {
                    throw new Error(data.error || "La réponse de l'API est vide.");
                }

                originalRawText = data.response;

                try {
                    const cvData = parseCvTextLocally(originalRawText);
                    renderProfessionalCV(cvData);
                    notify("CV professionnel généré avec succès !", 'success');
                } catch (parseError) {
                    console.error("Erreur de l'analyse locale:", parseError);
                    notify("La mise en page pro a échoué. Affichage du texte brut.", 'error');
                    renderCVAsFallback(originalRawText);
                }

            } catch (err) {
                console.error("Erreur lors de la génération:", err);
                notify(`Une erreur est survenue: ${err.message}`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        function renderProfessionalCV(data) {
            cvFileName = `CV_${(data.name || 'Candidat').replace(/\s+/g, '_')}.pdf`;
            const { name, title, contact, summary, experience, education, skills, languages } = data;

            const sidebarSectionTitle = "text-sm font-semibold text-blue-300 uppercase tracking-wider mb-4";
            const mainSectionTitle = "text-xl font-bold text-slate-800 tracking-tight mb-4 border-b-2 border-slate-200 pb-2";
            
            const contactHTML = `
                <section class="mb-8">
                    <h2 class="${sidebarSectionTitle}">Contact</h2>
                    <div class="space-y-3 text-sm text-slate-300">
                        ${contact.email ? `<div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg><span class="break-all">${contact.email}</span></div>` : ''}
                        ${contact.phone ? `<div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg><span>${contact.phone}</span></div>` : ''}
                        ${contact.address ? `<div class="flex items-start gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mt-1 flex-shrink-0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><span>${contact.address}</span></div>` : ''}
                        ${contact.linkedin ? `<div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg><a href="https://www.${contact.linkedin}" class="hover:underline">linkedin.com/in/...</a></div>` : ''}
                    </div>
                </section>`;

            const skillsHTML = skills && skills.length > 0 ? `
                <section class="mb-8">
                    <h2 class="${sidebarSectionTitle}">Compétences</h2>
                    <div class="flex flex-wrap gap-2">
                        ${skills.map(skill => `<span class="bg-blue-200 text-blue-800 text-xs font-medium px-2.5 py-1 rounded">${skill}</span>`).join('')}
                    </div>
                </section>` : '';
            
            const languagesHTML = languages && languages.length > 0 ? `
                <section>
                    <h2 class="${sidebarSectionTitle}">Langues</h2>
                    <ul class="space-y-1 text-sm text-slate-300">
                        ${languages.map(lang => `<li>${lang}</li>`).join('')}
                    </ul>
                </section>` : '';

            const summaryHTML = summary ? `
                <section class="mb-8">
                    <h2 class="${mainSectionTitle}">Profil</h2>
                    <p class="text-sm text-slate-700 leading-relaxed">${summary}</p>
                </section>` : '';

            const experienceHTML = experience && experience.length > 0 ? `
                <section class="mb-8">
                    <h2 class="${mainSectionTitle}">Expérience Professionnelle</h2>
                    <div class="space-y-6">
                        ${experience.map(exp => `
                            <div class="text-sm">
                                <h3 class="font-semibold text-base text-slate-800">${exp.title}</h3>
                                <p class="font-medium text-slate-600">${exp.company || ''} <span class="text-slate-500 font-normal italic ml-2">${exp.dates || ''}</span></p>
                                <div class="mt-2 text-slate-700 whitespace-pre-wrap">${exp.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </section>` : '';

            const educationHTML = education && education.length > 0 ? `
                <section>
                    <h2 class="${mainSectionTitle}">Formation</h2>
                    <div class="space-y-4">
                        ${education.map(edu => `
                             <div class="text-sm">
                                <h3 class="font-semibold text-base text-slate-800">${edu.degree}</h3>
                                <p class="font-medium text-slate-600">${edu.school || ''} <span class="text-slate-500 font-normal italic ml-2">${edu.dates || ''}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </section>` : '';

            cvPreview.innerHTML = `
                <div class="flex min-h-[277mm]">
                    <!-- Colonne de gauche (Sidebar) -->
                    <aside class="w-1/3 bg-slate-800 text-white p-8">
                        <div class="text-center mb-10">
                            <h1 class="text-3xl font-bold text-white tracking-tight">${name || 'Nom Candidat'}</h1>
                            <p class="text-lg font-light text-blue-300 mt-1">${title || 'Titre du Poste'}</p>
                        </div>
                        ${contactHTML}
                        ${skillsHTML}
                        ${languagesHTML}
                    </aside>

                    <!-- Colonne de droite (Contenu principal) -->
                    <main class="w-2/3 p-8">
                        ${summaryHTML}
                        ${experienceHTML}
                        ${educationHTML}
                    </main>
                </div>
            `;
            showCvContainer();
        }
        
        function renderCVAsFallback(textContent) {
            cvPreview.innerHTML = `<div class="p-12 text-slate-800 text-sm leading-relaxed whitespace-pre-wrap">${textContent}</div>`;
            showCvContainer();
        }
        
        function showCvContainer() {
            cvContainer.style.display = 'block';
            actionButtons.style.display = 'block';
            setTimeout(() => {
                cvContainer.style.opacity = 1;
                actionButtons.style.opacity = 1;
            }, 10);
        }

        function handleDownloadPDF() {
            notify('Préparation du PDF...', 'info');
            const element = document.getElementById('cv-preview-wrapper');
            const opt = {
              margin: 0,
              filename: cvFileName,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 4, letterRendering: true, useCORS: true },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().from(element).set(opt).save().then(() => {
                notify('PDF téléchargé avec succès !', 'success');
            }).catch(err => notify('Erreur lors du téléchargement.', 'error'));
        }

        function handleCopyText() {
            if (!originalRawText) {
                notify('Rien à copier.', 'error');
                return;
            }
            const textArea = document.createElement('textarea');
            textArea.value = originalRawText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                notify('Texte original copié dans le presse-papiers !', 'success');
            } catch (err) {
                notify('La copie a échoué.', 'error');
            }
            document.body.removeChild(textArea);
        }

        generateBtn.addEventListener('click', handleGenerateCV);
        downloadBtn.addEventListener('click', handleDownloadPDF);
        copyBtn.addEventListener('click', handleCopyText);

    </script>
</body>
</html>
