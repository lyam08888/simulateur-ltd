<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Générateur de CV IA (A4 PDF)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librairie pour générer le PDF depuis le HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style pour le conteneur du CV au format A4 */
        #cv-preview {
            width: 210mm;
            min-height: 297mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.15);
            margin: 2rem auto;
            transition: opacity 0.5s ease-in-out;
        }
        /* Masquer le CV et le bouton de téléchargement par défaut */
        .hidden-initially {
            display: none;
            opacity: 0;
        }
        /* Animation pour le chargement */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start px-4 py-8">

    <!-- Section de contrôle -->
    <div class="w-full max-w-3xl bg-white shadow-xl rounded-xl p-8 mb-8">
        <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">Générateur de CV IA</h1>
        <p class="text-center text-gray-500 mb-6">Créez un CV professionnel au format PDF en quelques secondes.</p>
        
        <label for="prompt" class="block text-lg font-medium text-gray-700 mb-2">
            Décrivez le CV que vous souhaitez :
        </label>
        <textarea id="prompt" placeholder="Exemple : Crée un CV pour un développeur web full-stack avec 3 ans d'expérience, spécialisé en React et Node.js. Inclure des projets et des compétences techniques."
                  class="w-full h-32 border border-gray-300 rounded-lg p-4 mb-4 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"></textarea>

        <button id="generate-btn"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition-all duration-300 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
            Générer le CV
        </button>

        <!-- Zone de notification -->
        <div id="notification" class="mt-4 text-center text-sm"></div>
    </div>

    <!-- Bouton de téléchargement (initialement masqué) -->
    <div id="download-container" class="w-full max-w-3xl text-center mb-8 hidden-initially">
         <button id="download-btn"
                class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center justify-center gap-2 mx-auto">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
             Télécharger en PDF
         </button>
    </div>

    <!-- Prévisualisation du CV (initialement masqué) -->
    <div id="cv-container" class="hidden-initially">
        <div id="cv-preview" class="bg-white p-12 text-gray-800">
            <!-- Le contenu du CV sera injecté ici -->
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generate-btn');
        const downloadBtn = document.getElementById('download-btn');
        const downloadContainer = document.getElementById('download-container');
        const promptInput = document.getElementById('prompt');
        const notificationDiv = document.getElementById('notification');
        const cvContainer = document.getElementById('cv-container');
        const cvPreview = document.getElementById('cv-preview');
        let cvFileName = 'cv.pdf';

        /**
         * Affiche une notification à l'utilisateur.
         * @param {string} message - Le message à afficher.
         * @param {string} type - 'info', 'success', ou 'error'.
         */
        function notify(message, type = 'info') {
            notificationDiv.innerHTML = ''; // Clear previous
            const p = document.createElement('p');
            p.innerHTML = message;
            if (type === 'error') {
                p.className = 'text-red-500 font-medium';
            } else if (type === 'success') {
                p.className = 'text-green-500 font-medium';
            } else {
                p.className = 'text-gray-500';
            }
            notificationDiv.appendChild(p);
        }

        /**
         * Gère l'état de chargement de l'interface.
         * @param {boolean} isLoading - Vrai si le chargement est en cours.
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="loader"></div><span class="ml-2">Génération en cours...</span>';
                cvContainer.style.display = 'none';
                cvContainer.style.opacity = 0;
                downloadContainer.style.display = 'none';
                downloadContainer.style.opacity = 0;
            } else {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>Générer le CV';
            }
        }

        /**
         * Appelle l'API Gemini pour générer le contenu du CV.
         */
        async function generateCV() {
            const userPrompt = promptInput.value.trim();
            if (!userPrompt) {
                notify("Veuillez décrire le CV que vous souhaitez générer.", 'error');
                return;
            }

            setLoadingState(true);
            notify("L'IA rédige votre CV, veuillez patienter...");

            // Instruction pour l'IA : demander une sortie JSON structurée.
            const fullPrompt = `
                Génère un CV complet et professionnel basé sur la description suivante : "${userPrompt}".
                La réponse DOIT être un objet JSON valide, et rien d'autre. Ne pas inclure de texte avant ou après le JSON.
                Le JSON doit avoir la structure suivante :
                {
                  "name": "string",
                  "title": "string",
                  "contact": {
                    "email": "string",
                    "phone": "string",
                    "address": "string",
                    "linkedin": "string (URL complète, optionnel)"
                  },
                  "summary": "string (un paragraphe de 3-4 phrases)",
                  "experience": [
                    {
                      "title": "string",
                      "company": "string",
                      "dates": "string (ex: 'Janvier 2020 - Présent')",
                      "description": "string (liste de 3-4 points commençant par un verbe d'action)"
                    }
                  ],
                  "education": [
                    {
                      "degree": "string",
                      "school": "string",
                      "dates": "string (ex: '2015 - 2018')"
                    }
                  ],
                  "skills": {
                    "technical": ["string"],
                    "soft": ["string"]
                  }
                }
            `;
            
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: fullPrompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // Laisser vide, sera géré par l'environnement
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erreur API: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    // Nettoyer la réponse pour extraire uniquement le JSON
                    let jsonString = result.candidates[0].content.parts[0].text;
                    jsonString = jsonString.replace(/```json/g, '').replace(/```/g, '').trim();

                    const cvData = JSON.parse(jsonString);
                    renderCV(cvData);
                    notify("CV généré avec succès !", 'success');

                } else {
                    console.error("Réponse inattendue de l'API:", result);
                    throw new Error("La réponse de l'API est vide ou malformée.");
                }

            } catch (err) {
                console.error("Erreur lors de la génération :", err);
                notify(`Une erreur est survenue. Vérifiez la console pour plus de détails. (${err.message})`, 'error');
            } finally {
                setLoadingState(false);
            }
        }

        /**
         * Affiche les données du CV dans le template HTML.
         * @param {object} data - Les données du CV au format JSON.
         */
        function renderCV(data) {
            cvFileName = `CV_${data.name.replace(/\s+/g, '_')}.pdf`;
            let html = `
                <header class="text-center mb-10 border-b-2 pb-6 border-gray-200">
                    <h1 class="text-5xl font-bold text-gray-800">${data.name || ''}</h1>
                    <h2 class="text-2xl font-semibold text-blue-600 mt-2">${data.title || ''}</h2>
                </header>

                <div class="grid grid-cols-3 gap-12">
                    <aside class="col-span-1">
                        <section class="mb-8">
                            <h3 class="text-xl font-bold border-b border-gray-300 pb-2 mb-3 text-gray-700">CONTACT</h3>
                            <ul class="text-sm space-y-2">
                                ${data.contact.phone ? `<li><strong>Tél :</strong> ${data.contact.phone}</li>` : ''}
                                ${data.contact.email ? `<li><strong>Email :</strong> ${data.contact.email}</li>` : ''}
                                ${data.contact.address ? `<li><strong>Adresse :</strong> ${data.contact.address}</li>` : ''}
                                ${data.contact.linkedin ? `<li><strong>LinkedIn :</strong> <a href="${data.contact.linkedin}" class="text-blue-500 hover:underline">Profil</a></li>` : ''}
                            </ul>
                        </section>
                        <section class="mb-8">
                            <h3 class="text-xl font-bold border-b border-gray-300 pb-2 mb-3 text-gray-700">COMPÉTENCES TECHNIQUES</h3>
                            <ul class="text-sm list-disc list-inside space-y-1">
                                ${data.skills.technical.map(skill => `<li>${skill}</li>`).join('')}
                            </ul>
                        </section>
                        <section>
                            <h3 class="text-xl font-bold border-b border-gray-300 pb-2 mb-3 text-gray-700">QUALITÉS</h3>
                            <ul class="text-sm list-disc list-inside space-y-1">
                                ${data.skills.soft.map(skill => `<li>${skill}</li>`).join('')}
                            </ul>
                        </section>
                    </aside>

                    <main class="col-span-2">
                        <section class="mb-8">
                            <h3 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-4">PROFIL</h3>
                            <p class="text-base text-gray-700 leading-relaxed">${data.summary || ''}</p>
                        </section>
                        <section class="mb-8">
                            <h3 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-4">EXPÉRIENCE PROFESSIONNELLE</h3>
                            <div class="space-y-6">
                                ${data.experience.map(exp => `
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-800">${exp.title}</h4>
                                        <p class="text-md font-medium text-gray-600">${exp.company} | ${exp.dates}</p>
                                        <ul class="mt-2 text-sm list-disc list-inside text-gray-600 space-y-1">
                                            ${exp.description.split('\n').map(line => `<li>${line.replace(/^- /, '')}</li>`).join('')}
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                        <section>
                            <h3 class="text-2xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-4">FORMATION</h3>
                             <div class="space-y-4">
                                ${data.education.map(edu => `
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-800">${edu.degree}</h4>
                                        <p class="text-md font-medium text-gray-600">${edu.school} | ${edu.dates}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </section>
                    </main>
                </div>
            `;
            cvPreview.innerHTML = html;
            cvContainer.style.display = 'block';
            downloadContainer.style.display = 'block';
            // Utiliser un timeout pour l'animation d'apparition
            setTimeout(() => {
                cvContainer.style.opacity = 1;
                downloadContainer.style.opacity = 1;
            }, 10);
        }

        /**
         * Génère et télécharge le PDF à partir de l'élément cv-preview.
         */
        function downloadPDF() {
            const element = document.getElementById('cv-preview');
            const opt = {
              margin:       0,
              filename:     cvFileName,
              image:        { type: 'jpeg', quality: 0.98 },
              html2canvas:  { scale: 4, letterRendering: true, useCORS: true }, // Augmenter la scale pour une meilleure qualité
              jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // Utiliser html2pdf pour générer le PDF
            html2pdf().from(element).set(opt).save();
        }

        // Ajout des écouteurs d'événements
        generateBtn.addEventListener('click', generateCV);
        downloadBtn.addEventListener('click', downloadPDF);

    </script>
</body>
</html>
