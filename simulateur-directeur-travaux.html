<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager Simulator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Import Inter font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a202c, #2d3748); /* Dark gradient background */
            color: #e2e8f0; /* Light gray text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Hide overflow for transitions */
        }
        .card {
            background-color: #2d3748; /* Slightly lighter dark background for cards */
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            backdrop-filter: blur(10px); /* Glassmorphism effect */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border */
            transition: all 0.3s ease-in-out; /* Smooth transition for cards */
        }
        .btn {
            background-color: #4299e1; /* Blue button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(66, 153, 225, 0.3);
        }
        .btn:hover {
            background-color: #3182ce; /* Darker blue on hover */
            transform: translateY(-2px) scale(1.02); /* Added scale on hover */
            box-shadow: 0 6px 15px rgba(66, 153, 225, 0.4);
        }
        .metric-value {
            transition: color 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .metric-change-indicator {
            position: absolute;
            font-weight: bold;
            opacity: 0;
            transform: translateY(0);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            pointer-events: none;
            z-index: 10;
        }
        .metric-change-indicator.show {
            opacity: 1;
            transform: translateY(-10px);
            animation: bounce-fade 1s forwards; /* New bounce-fade animation */
        }
        @keyframes bounce-fade {
            0% { opacity: 0; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-25px); }
        }
        .positive-change {
            color: #48bb78; /* Green for positive */
        }
        .negative-change {
            color: #ef4444; /* Red for negative */
        }
        .highlight-choice {
            border-color: #fcd34d !important; /* Yellow border for highlighted choice */
            box-shadow: 0 0 15px rgba(252, 211, 77, 0.5) !important;
        }
        .critical-time {
            animation: pulse-red 1s infinite alternate;
        }
        @keyframes pulse-red {
            from {
                transform: scale(1);
                opacity: 1;
            }
            to {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }
        /* Screen transition classes */
        .screen-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            z-index: -10;
        }
        .screen-visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            z-index: 20; /* Ensure game screen is above start/result */
        }
        /* Modal transition classes */
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content-hidden {
            transform: scale(0.95);
        }
        .modal-content-visible {
            transform: scale(1);
        }

        /* Enhanced Power-up Buttons */
        .btn-power-up {
            background: linear-gradient(145deg, #6b46c1, #805ad5); /* Purple gradient */
            color: white;
            box-shadow: 0 5px 15px rgba(107, 70, 193, 0.4);
            border: none;
            position: relative;
            overflow: hidden;
            width: 80px; /* Smaller size for bubble */
            height: 80px; /* Smaller size for bubble */
            border-radius: 50%; /* Circular shape */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem; /* Smaller font for text */
            line-height: 1;
            text-align: center;
            padding: 0.5rem;
        }
        .btn-power-up:hover {
            background: linear-gradient(145deg, #805ad5, #9f7aea);
            transform: translateY(-3px) scale(1.05); /* Added scale on hover */
            box-shadow: 0 8px 20px rgba(107, 70, 193, 0.6);
        }
        .btn-power-up:disabled {
            background: #4a5568;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        .btn-power-up::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1;
            border-radius: 50%; /* Ensure overlay is also circular */
        }
        .btn-power-up:hover::before {
            opacity: 1;
        }
        .btn-power-up > * {
            position: relative;
            z-index: 2;
        }
        .btn-power-up .text-4xl { /* Adjust icon size within bubble */
            font-size: 2rem; /* Smaller icon */
            margin-bottom: 0.25rem;
        }
        .btn-power-up .font-semibold {
            font-size: 0.875rem; /* Smaller text */
        }
        .btn-power-up .text-sm {
            font-size: 0.65rem; /* Even smaller text for count */
        }
        .btn-power-up .text-xs {
            display: none; /* Hide description in bubble for brevity */
        }


        /* Share button styling */
        .btn-share {
            background-color: #38b2ac; /* Teal */
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.3);
        }
        .btn-share:hover {
            background-color: #319795; /* Darker teal */
            transform: translateY(-2px) scale(1.02); /* Added scale on hover */
            box-shadow: 0 6px 15px rgba(56, 178, 172, 0.4);
        }

        /* Back to main menu button */
        .btn-back-to-menu {
            background-color: #a0aec0; /* Gray */
            color: #2d3748;
            box-shadow: 0 4px 10px rgba(160, 174, 192, 0.3);
        }
        .btn-back-to-menu:hover {
            background-color: #718096; /* Darker gray */
            transform: translateY(-2px) scale(1.02); /* Added scale on hover */
            box-shadow: 0 6px 15px rgba(160, 174, 192, 0.4);
        }

        /* Quick Event Modal specific styling */
        #quick-event-modal {
            background: linear-gradient(160deg, #4a5568, #2d3748); /* Darker gradient for quick event */
            border: 2px solid #ef4444; /* Red border for urgency */
            box-shadow: 0 15px 30px rgba(239, 68, 68, 0.4); /* Red glow effect */
        }
        #quick-event-timer-display {
            animation: pulse-red 0.8s infinite alternate; /* More intense pulse for quick event timer */
        }

        /* Catastrophe Modal Styling */
        #catastrophe-modal-overlay {
            background: rgba(0, 0, 0, 0.9); /* Even darker, more opaque background */
        }
        #catastrophe-modal {
            background: linear-gradient(160deg, #330000, #660000); /* Deep red gradient */
            border: 3px solid #ff0000; /* Bright red border */
            box-shadow: 0 20px 40px rgba(255, 0, 0, 0.6); /* Intense red glow */
            animation: shake 0.5s infinite alternate; /* Shaking effect for urgency */
        }
        @keyframes shake {
            0% { transform: translateX(0) scale(0.95); }
            25% { transform: translateX(-5px) scale(0.95); }
            50% { transform: translateX(0) scale(0.95); }
            75% { transform: translateX(5px) scale(0.95); }
            100% { transform: translateX(0) scale(0.95); }
        }
        #catastrophe-modal.modal-content-visible {
            animation: shake 0.5s infinite alternate, pop-in 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        #catastrophe-timer-display {
            animation: pulse-red 0.5s infinite alternate; /* Very fast pulse for catastrophe timer */
            color: #ffdd00; /* Yellow for high contrast */
        }

        /* Market Event Modal Styling */
        #market-event-modal-overlay {
            background: rgba(0, 0, 0, 0.8);
        }
        #market-event-modal {
            background: linear-gradient(160deg, #3a3a3a, #1a1a1a); /* Dark grey gradient */
            border: 2px solid #63b3ed; /* Light blue border */
            box-shadow: 0 15px 30px rgba(99, 179, 237, 0.4); /* Blue glow */
        }
        #market-event-timer-display {
            animation: pulse-blue 1s infinite alternate;
            color: #63b3ed;
        }
        @keyframes pulse-blue {
            from {
                transform: scale(1);
                opacity: 1;
            }
            to {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        /* Email Event Modal Styling */
        #email-event-modal-overlay {
            background: rgba(0, 0, 0, 0.7);
        }
        #email-event-modal {
            background: linear-gradient(160deg, #2a3a4a, #1a2a3a); /* Dark blue-grey gradient */
            border: 2px solid #a78bfa; /* Light purple border */
            box-shadow: 0 15px 30px rgba(167, 139, 250, 0.4); /* Purple glow */
        }

        /* Call Event Modal Styling */
        #call-event-modal-overlay {
            background: rgba(0, 0, 0, 0.85);
        }
        #call-event-modal {
            background: linear-gradient(160deg, #5a2a2a, #3a1a1a); /* Dark red gradient for urgency */
            border: 2px solid #f87171; /* Light red border */
            box-shadow: 0 15px 30px rgba(248, 113, 113, 0.5); /* Red glow */
        }
        #call-event-timer-display {
            animation: pulse-red 0.8s infinite alternate;
            color: #f87171;
        }


        /* Floating Power-ups Container */
        #floating-power-ups {
            position: absolute;
            right: 1rem; /* 16px from the right */
            top: 50%;
            transform: translateY(-50%);
            z-index: 15; /* Above game content, below modals */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Space between bubbles */
            padding: 1rem;
            background-color: rgba(45, 55, 72, 0.7); /* Semi-transparent background */
            border-radius: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        @media (max-width: 768px) { /* Adjust for smaller screens */
            #floating-power-ups {
                position: fixed; /* Fixed position for mobile */
                bottom: 1rem;
                top: auto;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                flex-direction: row; /* Row for mobile */
                width: auto;
                padding: 0.75rem;
            }
            .btn-power-up {
                width: 60px;
                height: 60px;
            }
            .btn-power-up .text-4xl {
                font-size: 1.5rem;
            }
            .btn-power-up .font-semibold, .btn-power-up .text-sm {
                display: none; /* Hide text on mobile for bubbles */
            }
        }

        /* Character and Speech Bubble Styling */
        #character-container {
            position: absolute; /* Changed from fixed to absolute for relative positioning to parent */
            bottom: 4rem; /* 4rem from the bottom */
            right: 4rem; /* 4rem from the right */
            left: auto; /* Ensure left is not set */
            z-index: 30;
            display: flex;
            flex-direction: column;
            align-items: center; /* Center items horizontally */
            transition: transform 0.3s ease-out;
        }
        #character-avatar {
            font-size: 6rem; /* Large emoji */
            line-height: 1;
            animation: float 3s ease-in-out infinite alternate; /* Subtle floating animation */
            transition: transform 0.3s ease-out, font-size 0.3s ease-out; /* Smooth transition for emoji changes */
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        #speech-bubble {
            background-color: #4a5568; /* Darker grey for bubble */
            color: #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
            position: relative;
            margin-bottom: 1rem; /* Space between bubble and character */
            opacity: 0;
            transform: translateY(10px) scale(0.9);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            min-width: 150px;
            max-width: 250px;
            text-align: center; /* Center text within the bubble */
        }
        #speech-bubble.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            animation: pop-in 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; /* Pop-in animation */
        }
        @keyframes pop-in {
            0% { opacity: 0; transform: translateY(10px) scale(0.5); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        #speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px; /* Position the pointer */
            right: 50%; /* Pointer from the right side */
            transform: translateX(50%) rotate(-45deg); /* Adjust rotation and translation for right side */
            width: 20px;
            height: 20px;
            background-color: #4a5568; /* Match bubble background */
            border-radius: 3px;
            z-index: -1; /* Behind the bubble content */
        }

        /* Scenario icon animation */
        .scenario-icon-animate {
            animation: bounce-in 0.8s ease-out;
        }
        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* News Feed Styling */
        #news-feed-display {
            background-color: #1a202c; /* Darker background for news feed */
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1.5rem;
            height: 200px; /* Fixed height for scrolling */
            overflow-y: auto; /* Enable scrolling */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2); /* Inner shadow */
        }
        .news-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.9rem;
            color: #cbd5e0;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(10px);
            animation: slide-in 0.5s forwards;
        }
        .news-item:last-child {
            border-bottom: none;
        }
        .news-item.positive { color: #48bb78; }
        .news-item.negative { color: #ef4444; }
        .news-item.neutral { color: #cbd5e0; }
        .news-item.info { color: #63b3ed; } /* For power-up usage, etc. */

        @keyframes slide-in {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Timeline specific styling */
        #timeline-display {
            border-left: 2px solid #6b46c1; /* Purple line */
            padding-left: 1rem;
            max-height: 300px; /* Limit height for scrolling */
            overflow-y: auto;
            position: relative;
            margin-top: 1.5rem; /* Space from metrics */
        }
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
            font-size: 0.9rem;
            color: #cbd5e0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -0.5rem; /* Position the dot on the line */
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            background-color: #6b46c1; /* Purple dot */
            border-radius: 50%;
            border: 2px solid #2d3748; /* Border to match card background */
            z-index: 1;
        }
        .timeline-item .timeline-day {
            font-weight: bold;
            color: #a78bfa; /* Lighter purple for day */
            margin-bottom: 0.25rem;
            display: block;
        }
        .timeline-item .timeline-description {
            color: #e2e8f0;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Start Screen -->
    <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 bg-opacity-90 z-10 transition-all duration-500 ease-in-out screen-visible">
        <div class="card p-8 text-center max-w-lg w-full">
            <h1 class="text-5xl font-extrabold text-white mb-6">Simulateur de Gestion de Projet</h1>
            <p class="text-lg text-slate-300 mb-8">
                Devenez Directeur des Travaux et g√©rez la construction du Canal Seine-Nord Europe.
                Chaque d√©cision compte !
            </p>
            <h2 class="text-3xl font-bold text-amber-400 mb-4">Choisissez votre Difficult√© :</h2>
            <div id="difficulty-selection" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <!-- Difficulty buttons will be rendered here by JS -->
            </div>
            <p class="text-lg text-slate-300">Meilleur Score : <span id="high-score-display" class="text-amber-400 font-bold">0</span></p>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="relative w-full max-w-6xl h-[90vh] grid grid-rows-[auto_1fr] md:grid-rows-1 md:grid-cols-[1fr_2fr] gap-6 p-6 bg-slate-800/80 rounded-3xl shadow-2xl transition-all duration-500 ease-in-out screen-hidden">
        
        <!-- Left Panel: Metrics and Timeline -->
        <div class="flex flex-col space-y-6 overflow-y-auto pr-2">
            <div class="card p-6 flex-grow">
                <h2 class="text-2xl font-bold mb-4 text-amber-400">Statistiques du Projet</h2>
                <div id="metrics-display" class="space-y-3" role="status" aria-live="polite">
                    <!-- Metrics will be rendered here by JS -->
                </div>
            </div>
            <!-- New Timeline Section -->
            <div class="card p-6 flex-grow">
                <h2 class="text-2xl font-bold mb-4 text-purple-400">Chronologie du Projet</h2>
                <div id="timeline-display" class="relative pl-4">
                    <!-- Timeline events will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Right Panel: Scenario, Choices, News Feed and Back to Main Menu -->
        <div class="flex flex-col space-y-6 overflow-y-auto"> <!-- Added overflow-y-auto here -->
            <div class="card p-6 flex items-center justify-between">
                <div class="text-xl font-semibold">
                    Sc√©nario <span id="current-scenario-display">1</span> / <span id="total-scenarios-display">15</span>
                </div>
                <div class="w-1/2 bg-slate-700 rounded-full h-3">
                    <div id="progress-bar" class="bg-green-500 h-full rounded-full transition-all duration-300 ease-out"></div>
                </div>
                <div id="timer-display" class="text-2xl font-bold text-amber-400">‚è±Ô∏è 0:60</div>
            </div>

            <div class="card p-6 flex-grow flex flex-col justify-between">
                <div>
                    <h2 class="text-4xl font-extrabold mb-4 text-white flex items-center">
                        <span id="scenario-icon" class="mr-3 text-5xl"></span>
                        <span id="scenario-title">Titre du Sc√©nario</span>
                    </h2>
                    <p id="scenario-text" class="text-lg text-slate-300 mb-6">
                        Description du sc√©nario.
                    </p>
                </div>
                <div id="choices-container" class="grid grid-cols-1 gap-4">
                    <!-- Choices will be rendered here by JS -->
                </div>
            </div>

            <!-- News Feed moved here -->
            <div class="card p-6 mt-6">
                <h2 class="text-2xl font-bold mb-4 text-cyan-400">Fil d'Actualit√©s</h2>
                <div id="news-feed-display" class="space-y-2">
                    <!-- News items will be rendered here by JS -->
                </div>
            </div>

            <!-- Back to Main Menu button moved here -->
            <button id="back-to-main-menu-game-btn" class="btn btn-back-to-menu mt-4">Retour au Menu Principal</button>
        </div>

        <!-- Character and Speech Bubble Container -->
        <div id="character-container" class="absolute bottom-4 right-4 z-30 flex flex-col items-center">
            <div id="speech-bubble" class="speech-bubble card p-4 mb-2 text-sm max-w-xs relative opacity-0 transform -translate-y-2"></div>
            <div id="character-avatar" class="text-6xl">üë®‚Äçüíº</div> <!-- Project Manager Emoji -->
        </div>
    </div>

    <!-- Floating Power-Ups Container -->
    <div id="floating-power-ups" class="screen-hidden">
        <h2 class="text-lg font-bold text-purple-300 mb-2 text-center hidden md:block">Bonus</h2>
        <div id="power-ups-display" class="grid grid-cols-3 gap-2 md:grid-cols-1 md:gap-4">
            <!-- Power-ups will be rendered here by JS -->
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40 transition-opacity duration-300 modal-hidden">
        <div id="feedback-modal" class="card p-8 max-w-xl w-full text-center transform scale-95 transition-transform duration-300 modal-content-hidden">
            <h2 id="feedback-title" class="text-3xl font-bold mb-4 text-white">Cons√©quences de la d√©cision</h2>
            <p id="feedback-text" class="text-lg text-slate-300 mb-6"></p>
            <div id="impact-list" class="space-y-3 mb-8 text-left" role="status" aria-live="polite">
                <!-- Impacts will be rendered here -->
            </div>
            <button id="modal-continue-btn" class="btn">Continuer</button>
        </div>
    </div>

    <!-- Quick Event Modal -->
    <div id="quick-event-modal-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300 modal-hidden">
        <div id="quick-event-modal" class="card p-8 max-w-xl w-full text-center transform scale-95 transition-transform duration-300 modal-content-hidden">
            <h2 class="text-4xl font-extrabold mb-4 text-red-400 flex items-center justify-center">
                <span id="quick-event-icon" class="mr-3 text-5xl"></span>
                <span id="quick-event-title">√âv√©nement Rapide !</span>
            </h2>
            <p id="quick-event-text" class="text-lg text-slate-300 mb-6"></p>
            <div id="quick-event-choices-container" class="grid grid-cols-1 gap-4 mb-6">
                <!-- Quick event choices will be rendered here -->
            </div>
            <div id="quick-event-timer-display" class="text-3xl font-bold text-red-500">‚è±Ô∏è 0:15</div>
        </div>
    </div>

    <!-- Catastrophe Modal -->
    <div id="catastrophe-modal-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-300 modal-hidden">
        <div id="catastrophe-modal" class="card p-8 max-w-xl w-full text-center transform scale-95 transition-transform duration-300 modal-content-hidden">
            <h2 class="text-5xl font-extrabold mb-4 text-red-600 flex items-center justify-center">
                <span id="catastrophe-icon" class="mr-4 text-6xl"></span>
                <span id="catastrophe-title">CATASTROPHE MAJEURE !</span>
            </h2>
            <p id="catastrophe-text" class="text-xl text-red-200 mb-6">Une crise sans pr√©c√©dent menace le projet !</p>
            <div id="catastrophe-choices-container" class="grid grid-cols-1 gap-4 mb-6">
                <!-- Catastrophe choices will be rendered here -->
            </div>
            <div id="catastrophe-timer-display" class="text-4xl font-bold text-yellow-400">‚è±Ô∏è 0:05</div>
        </div>
    </div>

    <!-- Market Event Modal (New) -->
    <div id="market-event-modal-overlay" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300 modal-hidden">
        <div id="market-event-modal" class="card p-8 max-w-xl w-full text-center transform scale-95 transition-transform duration-300 modal-content-hidden">
            <h2 class="text-4xl font-extrabold mb-4 text-blue-400 flex items-center justify-center">
                <span id="market-event-icon" class="mr-3 text-5xl"></span>
                <span id="market-event-title">Fluctuation du March√© !</span>
            </h2>
            <p id="market-event-text" class="text-lg text-slate-300 mb-6"></p>
            <div id="market-impact-list" class="space-y-3 mb-8 text-left" role="status" aria-live="polite">
                <!-- Market impacts will be rendered here -->
            </div>
            <!-- Added a dedicated container for choices in the market event modal -->
            <div id="market-event-choices-container" class="grid grid-cols-1 gap-4 mb-6">
                <!-- Market event choices will be rendered here -->
            </div>
            <div id="market-event-timer-display" class="text-3xl font-bold text-blue-500">‚è±Ô∏è 0:05</div>
        </div>
    </div>

    <!-- Email Event Modal (New) -->
    <div id="email-event-modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300 modal-hidden">
        <div id="email-event-modal" class="card p-8 max-w-xl w-full text-center transform scale-95 transition-transform duration-300 modal-content-hidden">
            <h2 class="text-3xl font-bold mb-4 text-purple-400 flex items-center justify-center">
                <span class="mr-3 text-4xl">‚úâÔ∏è</span>
                <span id="email-event-title">Nouvel E-mail !</span>
            </h2>
            <p class="text-sm text-slate-400 mb-2 text-left">De: <span id="email-sender" class="font-semibold"></span></p>
            <p class="text-sm text-slate-400 mb-4 text-left">Objet: <span id="email-subject" class="font-semibold"></span></p>
            <p id="email-body" class="text-lg text-slate-300 mb-6 text-left"></p>
            <div id="email-choices-container" class="grid grid-cols-1 gap-4 mb-6">
                <!-- Email choices will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Call Event Modal (New) -->
    <div id="call-event-modal-overlay" class="fixed inset-0 bg-black bg-opacity-85 flex items-center justify-center z-50 transition-opacity duration-300 modal-hidden">
        <div id="call-event-modal" class="card p-8 max-w-xl w-full text-center transform scale-95 transition-transform duration-300 modal-content-hidden">
            <h2 class="text-4xl font-extrabold mb-4 text-red-400 flex items-center justify-center">
                <span class="mr-3 text-5xl">üìû</span>
                <span id="call-event-title">Appel Urgent !</span>
            </h2>
            <p class="text-lg text-slate-300 mb-2">De: <span id="call-caller" class="font-semibold text-red-300"></span></p>
            <p id="call-message" class="text-xl text-slate-300 mb-6"></p>
            <div id="call-choices-container" class="grid grid-cols-1 gap-4 mb-6">
                <!-- Call choices will be rendered here -->
            </div>
            <div id="call-event-timer-display" class="text-3xl font-bold text-red-500">‚è±Ô∏è 0:10</div>
        </div>
    </div>


    <!-- Result Screen -->
    <div id="result-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 bg-opacity-90 z-10 transition-all duration-500 ease-in-out screen-visible">
        <div class="card p-8 text-center max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h1 class="text-5xl font-extrabold text-white mb-6">Simulation Termin√©e !</h1>
            <p class="text-lg text-slate-300 mb-4">Votre score final : <span id="final-score" class="text-amber-400 text-4xl font-bold">0</span></p>
            <p class="text-lg text-slate-300 mb-4">Meilleur Score : <span id="final-high-score" class="text-yellow-300 text-3xl font-bold">0</span></p>
            <h2 id="result-category" class="text-3xl font-bold text-green-400 mb-4"></h2>
            <p id="result-description" class="text-md text-slate-300 mb-8"></p>
            
            <div class="text-left mb-8">
                <h3 class="text-2xl font-bold text-cyan-400 mb-4">Analyse des Indicateurs Cl√©s :</h3>
                <div id="metric-analysis-results" class="space-y-2">
                    <!-- Metric analysis will be rendered here -->
                </div>
            </div>

            <div id="contact-message" class="text-md text-slate-300 mb-8"></div>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button id="restart-game-btn" class="btn text-xl px-8 py-4">Rejouer</button>
                <button id="share-results-btn" class="btn btn-share text-xl px-8 py-4">Copier les R√©sultats</button>
                <button id="back-to-main-menu-result-btn" class="btn btn-back-to-menu text-xl px-8 py-4">Retour au Menu Principal</button>
            </div>
        </div>
    </div>

    <script>
        // Wrap the entire script in an IIFE to create a new scope
        (function() {
            // Global state and configuration
            let state = {};
            let mainTimerInterval = null;
            let quickEventTimerInterval = null;
            let catastropheTimerInterval = null; // New timer for catastrophes
            let marketEventTimerInterval = null; // New timer for market events
            let emailEventInterval = null; // For email events (no timer, but needs to be cleared)
            let callEventTimerInterval = null; // New timer for call events
            let currentScenarioIndex = 0;
            let timerCountdown = 0;
            let isQuickEventActive = false;
            let isCatastropheActive = false; // New flag for catastrophes
            let isMarketEventActive = false; // New flag for market events
            let isEmailEventActive = false; // New flag for email events
            let isCallEventActive = false; // New flag for call events
            let activePowerUp = null; // To track which power-up is active
            let timelineEvents = []; // Array to store timeline events

            // Tone.js Synths for sound effects
            const clickSound = new Tone.Synth().toDestination();
            const positiveSound = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "triangle" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.5 },
                volume: -10
            }).toDestination();
            const negativeSound = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.4 },
                volume: -10
            }).toDestination();
            const scenarioStartSound = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 8,
                envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.8 },
                volume: -15
            }).toDestination();
            const gameOverWinSound = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.1, decay: 0.5, sustain: 0.3, release: 1 },
                volume: -5
            }).toDestination();
            const gameOverLoseSound = new Tone.Synth({
                oscillator: { type: "square" },
                envelope: { attack: 0.1, decay: 0.5, sustain: 0.1, release: 1 },
                volume: -5
            }).toDestination();
            const timerWarningSound = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "square" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 },
                volume: -15
            }).toDestination();


            // Game Data (Scenarios, Difficulties, Power-ups)
            const difficulties = [
                {
                    id: 'easy',
                    name: 'Facile',
                    multiplier: 1.2,
                    initialMetrics: {
                        currentCash: 750000000, // Increased
                        revenue: 0,
                        totalCosts: 0,
                        reputation: 100,
                        quality: 100,
                        morale: 100,
                        clientSatisfaction: 100,
                        deadlineAdherence: 100,
                        siteSafety: 100
                    },
                    totalProjectDays: 2555, // 7 years * 365 days/year
                    timer: 150 // Scenario timer increased
                },
                {
                    id: 'normal',
                    name: 'Normal',
                    multiplier: 1.0,
                    initialMetrics: {
                        currentCash: 500000000, // Increased
                        revenue: 0,
                        totalCosts: 0,
                        reputation: 90,
                        quality: 90,
                        morale: 90,
                        clientSatisfaction: 90,
                        deadlineAdherence: 100,
                        siteSafety: 90
                    },
                    totalProjectDays: 2555,
                    timer: 120 // Scenario timer increased
                },
                {
                    id: 'hard',
                    name: 'Difficile',
                    multiplier: 0.8,
                    initialMetrics: {
                        currentCash: 70000000,
                        revenue: 0,
                        totalCosts: 0,
                        reputation: 60,
                        quality: 60,
                        morale: 60,
                        clientSatisfaction: 65,
                        deadlineAdherence: 100,
                        siteSafety: 70
                    },
                    totalProjectDays: 2555,
                    timer: 60 // Scenario timer increased
                }
            ];

            const powerUps = [
                { id: 'time_boost', name: 'Acc√©l√©rateur Temporel', description: '+250 Jours', icon: '‚ö°', cost: 2000000, effect: { time: -250 }, count: 5, type: 'instant' }, // Increased effect, reduced cost
                { id: 'money_boost', name: 'Injection de Fonds', description: '+100M ‚Ç¨', icon: 'üí∞', cost: 3000000, effect: { cashChange: 100000000 }, count: 5, type: 'instant' }, // Increased effect, reduced cost
                { id: 'reputation_boost', name: 'Relations Publiques', description: '+40 R√©putation', icon: 'üåü', cost: 500000, effect: { reputation: 40 }, count: 5, type: 'instant' }, // Reduced cost
                { id: 'quality_boost', name: 'Contr√¥le Qualit√©', description: '+35 Qualit√©', icon: '‚úÖ', cost: 1000000, effect: { quality: 35 }, count: 5, type: 'instant' }, // Reduced cost
                { id: 'morale_boost', name: 'Motivation √âquipe', description: '+35 Moral', icon: 'üòä', cost: 500000, effect: { morale: 35 }, count: 5, type: 'instant' }, // Reduced cost
                { id: 'crisis_management', name: 'Gestion de Crise', description: 'Annule 1 Catastrophe', icon: 'üõ°Ô∏è', cost: 6000000, effect: {}, count: 2, type: 'pre_event' }, // Reduced cost
                { id: 'market_insight', name: 'Analyse March√©', description: 'R√©v√®le impact March√©', icon: 'üìà', cost: 3000000, effect: {}, count: 2, type: 'pre_event' }, // Reduced cost
                { id: 'expert_consultation', name: 'Consultation Expert', description: 'R√©v√®le meilleure option', icon: 'üß†', cost: 4000000, effect: {}, count: 2, type: 'pre_event' } // Reduced cost
            ];

            const scenarios = [
                {
                    title: "Lancement du Projet",
                    text: "Le projet du Canal Seine-Nord Europe est officiellement lanc√©. Vous devez choisir l'approche initiale pour les √©tudes de terrain.",
                    icon: "üó∫Ô∏è",
                    choices: [
                        { text: "√âtudes approfondies (co√ªteux, long, mais fiable)", impact: { cashChange: -500000, time: 10, quality: +15, reputation: +10, clientSatisfaction: +10, siteSafety: +5 }, feedback: "Les √©tudes approfondies ont r√©v√©l√© des informations cruciales, √©vitant des probl√®mes futurs. La qualit√© est assur√©e, mais le budget et le temps sont impact√©s." },
                        { text: "√âtudes rapides (√©conomique, rapide, mais risqu√©)", impact: { cashChange: 7000000, time: -5, quality: -1, reputation: 0, clientSatisfaction: 0, siteSafety: 0 }, feedback: "Les √©tudes rapides ont permis de gagner du temps et de l'argent, mais des incertitudes subsistent. La qualit√© pourrait en p√¢tir √† long terme." }
                    ]
                },
                {
                    title: "Acquisition des Terrains",
                    text: "Vous rencontrez des difficult√©s dans l'acquisition de certains terrains. Des propri√©taires refusent de vendre.",
                    icon: "üè°",
                    choices: [
                        { text: "N√©gocier fermement (risque de r√©putation, gain de temps)", impact: { cashChange: 3000000, time: -3, reputation: -2, morale: -1, clientSatisfaction: -1 }, feedback: "La n√©gociation a √©t√© difficile, mais vous avez obtenu les terrains √† un bon prix. Cependant, l'image du projet en a souffert." },
                        { text: "Offrir un prix plus √©lev√© (co√ªteux, rapide)", impact: { cashChange: -200000, time: 5, morale: +5, clientSatisfaction: +12 }, feedback: "Vous avez pay√© plus cher, mais les acquisitions sont boucl√©es rapidement. La satisfaction des propri√©taires est bonne." },
                        { text: "Recourir √† l'expropriation (tr√®s n√©gatif pour la r√©putation, rapide)", impact: { cashChange: 0, time: 10, reputation: -5, morale: -2, clientSatisfaction: -2 }, feedback: "L'expropriation a √©t√© rapide mais a provoqu√© un toll√© m√©diatique. Votre r√©putation est au plus bas." }
                    ]
                },
                {
                    title: "Choix des Fournisseurs",
                    text: "Vous devez s√©lectionner les fournisseurs pour les mat√©riaux principaux (b√©ton, acier).",
                    icon: "üèóÔ∏è",
                    choices: [
                        { text: "Fournisseur local (plus cher, mais soutient l'√©conomie locale, bonne qualit√©)", impact: { cashChange: -1000000, quality: +15, reputation: +12, clientSatisfaction: +5 }, feedback: "Le choix d'un fournisseur local renforce les liens avec la communaut√© et assure une excellente qualit√©." },
                        { text: "Fournisseur international (moins cher, mais d√©lais potentiels, qualit√© variable)", impact: { cashChange: 8000000, time: -5, quality: -1, morale: 0, clientSatisfaction: 0 }, feedback: "Un fournisseur international offre des prix comp√©titifs, mais les d√©lais et la qualit√© sont moins garantis." }
                    ]
                },
                {
                    title: "Gestion des D√©chets",
                    text: "Le chantier produit une grande quantit√© de d√©chets. Comment les g√©rer ?",
                    icon: "üóëÔ∏è",
                    choices: [
                        { text: "Recyclage et valorisation (co√ªteux, bonne r√©putation)", impact: { cashChange: -300000, reputation: +15, quality: +4, clientSatisfaction: +3, siteSafety: +3 }, feedback: "Une gestion √©cologique des d√©chets am√©liore votre image, mais a un co√ªt." },
                        { text: "Mise en d√©charge classique (√©conomique, mauvaise r√©putation)", impact: { cashChange: 3000000, reputation: -3, morale: 0, clientSatisfaction: -1, siteSafety: 0 }, feedback: "La m√©thode la moins ch√®re, mais les critiques environnementales fusent." }
                    ]
                },
                {
                    title: "Conditions M√©t√©orologiques",
                    text: "Des pluies intenses et prolong√©es menacent de retarder les travaux.",
                    icon: "üåßÔ∏è",
                    choices: [
                        { text: "Travailler en horaires prolong√©s (co√ªteux, impact moral)", impact: { cashChange: -700000, time: -10, morale: -3, quality: 0, siteSafety: -1 }, feedback: "Les √©quipes sont √©puis√©es, mais le retard est limit√©. La qualit√© peut en souffrir." },
                        { text: "Accepter le retard (impact temps, pas de co√ªt additionnel)", impact: { time: 10, morale: +8, clientSatisfaction: -1 }, feedback: "Le chantier prend du retard, mais les √©quipes sont au repos et la qualit√© n'est pas compromise." }
                    ]
                },
                {
                    title: "Accident sur le Chantier",
                    text: "Un incident mineur s'est produit, un ouvrier est l√©g√®rement bless√©. Que faites-vous ?",
                    icon: "üö®",
                    choices: [
                        { text: "Enqu√™te approfondie et mesures correctives (co√ªteux, long, mais renforce la s√©curit√©)", impact: { cashChange: -200000, time: 3, morale: +15, reputation: +10, quality: +10, siteSafety: +15, clientSatisfaction: +10 }, feedback: "Vous montrez votre engagement envers la s√©curit√©, ce qui renforce le moral et la r√©putation." },
                        { text: "G√©rer rapidement l'incident, minimiser l'impact (rapide, risque de r√©putation)", impact: { cashChange: 0, time: -3, morale: -1, reputation: -3, siteSafety: -1, clientSatisfaction: -1 }, feedback: "L'incident est vite oubli√©, mais la perception de la s√©curit√© sur le chantier se d√©grade." }
                    ]
                },
                {
                    title: "Pression Politique",
                    text: "Des √©lus locaux vous pressent d'acc√©l√©rer le projet pour des raisons √©lectorales.",
                    icon: "üèõÔ∏è",
                    choices: [
                        { text: "C√©der √† la pression (risque qualit√©, r√©putation si √©chec)", impact: { time: -5, quality: -3, reputation: -1, clientSatisfaction: -1, morale: -1 }, feedback: "Vous acc√©l√©rez, mais la qualit√© du travail est compromise. Si des probl√®mes surviennent, votre r√©putation en p√¢tira." },
                        { text: "Maintenir le cap (risque de friction politique, maintient qualit√©)", impact: { reputation: +10, morale: +5, clientSatisfaction: +5 }, feedback: "Vous tenez bon sur le calendrier initial, ce qui peut irriter certains √©lus, mais assure la qualit√©." }
                    ]
                },
                {
                    title: "D√©couverte Arch√©ologique",
                    text: "Des vestiges arch√©ologiques inattendus ont √©t√© d√©couverts sur le trac√© du canal.",
                    icon: "üè∫",
                    choices: [
                        { text: "Arr√™ter les travaux pour fouilles (tr√®s long, co√ªteux, bonne r√©putation)", impact: { cashChange: -1500000, time: 20, reputation: +20, clientSatisfaction: -2 }, feedback: "Une d√©cision co√ªteuse en temps et en argent, mais salu√©e par les historiens et le public." },
                        { text: "Minimiser l'impact, d√©vier l√©g√®rement (compromis, risque r√©putation)", impact: { cashChange: 0, time: 5, reputation: -1, quality: 0, clientSatisfaction: 0 }, feedback: "Vous trouvez un compromis, mais certains puristes critiquent votre approche." }
                    ]
                },
                {
                    title: "Gr√®ve des Ouvriers",
                    text: "Une partie des ouvriers se met en gr√®ve pour de meilleures conditions de travail.",
                    icon: "‚úä",
                    choices: [
                        { text: "N√©gocier et accorder des augmentations (co√ªteux, r√©sout la gr√®ve)", impact: { cashChange: -500000, time: 3, morale: +20, clientSatisfaction: 0 }, feedback: "La gr√®ve est lev√©e, le moral est bon, mais le budget est impact√©." },
                        { text: "Maintenir la position (long, impact moral, r√©putation)", impact: { time: 5, morale: -4, reputation: -2, clientSatisfaction: -1 }, feedback: "La gr√®ve s'√©ternise, le chantier est √† l'arr√™t et la tension monte." }
                    ]
                },
                {
                    title: "Innovation Technologique",
                    text: "Une nouvelle technologie de forage pourrait acc√©l√©rer les travaux, mais est tr√®s ch√®re.",
                    icon: "üí°",
                    choices: [
                        { text: "Investir dans la nouvelle technologie (tr√®s co√ªteux, gain de temps, risque)", impact: { cashChange: -2000000, time: -60, quality: +10, clientSatisfaction: +10 }, feedback: "Un pari risqu√© mais potentiellement tr√®s payant. Le temps gagn√© est consid√©rable." },
                        { text: "Continuer avec les m√©thodes actuelles (pas de co√ªt, pas de gain)", impact: { quality: +4 }, feedback: "La prudence est de mise, le projet avance √† son rythme habituel." }
                    ]
                },
                {
                    title: "Probl√®me G√©otechnique",
                    text: "Des analyses r√©v√®lent une instabilit√© inattendue du sol sur un tron√ßon cl√©.",
                    icon: "‚õ∞Ô∏è",
                    choices: [
                        { text: "Renforcer massivement la zone (tr√®s co√ªteux, long, mais s√©curis√©)", impact: { cashChange: -1800000, time: 15, quality: +15, siteSafety: +15, clientSatisfaction: +10 }, feedback: "Une solution robuste mais on√©reuse et chronophage. La s√©curit√© est maximale." },
                        { text: "Adapter les fondations (co√ªteux, moins long, risque r√©siduel)", impact: { cashChange: -500000, time: 8, quality: -1, siteSafety: -1, clientSatisfaction: 0 }, feedback: "Un compromis qui permet de gagner du temps, mais avec une l√©g√®re incertitude sur la qualit√© √† long terme." }
                    ]
                },
                {
                    title: "Relations Publiques",
                    text: "L'image du projet est en baisse. Que faites-vous pour regagner la confiance du public ?",
                    icon: "üì¢",
                    choices: [
                        { text: "Lancer une campagne de communication positive (co√ªteux, gain r√©putation)", impact: { cashChange: -150000, reputation: +15, clientSatisfaction: +4 }, feedback: "Une campagne bien men√©e am√©liore la perception du public." },
                        { text: "Organiser des journ√©es portes ouvertes sur le chantier (moins co√ªteux, gain r√©putation, temps)", impact: { cashChange: -50000, time: 1, reputation: +12, morale: +6, clientSatisfaction: +10 }, feedback: "La transparence paie, le public appr√©cie de voir l'avancement du projet." }
                    ]
                },
                {
                    title: "Surco√ªt Impr√©vu",
                    text: "Un fournisseur majeur augmente subitement ses prix en raison d'une p√©nurie mondiale.",
                    icon: "üí∏",
                    choices: [
                        { text: "Accepter l'augmentation (impact budget, pas de retard)", impact: { cashChange: -1000000 }, feedback: "Le budget est fortement impact√©, mais le chantier continue sans interruption." },
                        { text: "Chercher un nouveau fournisseur (long, risque qualit√©, gain budget)", impact: { cashChange: 5000000, time: 10, quality: -1, clientSatisfaction: -1 }, feedback: "Vous √©conomisez de l'argent, mais le temps est perdu et la qualit√© du nouveau fournisseur est incertaine." }
                    ]
                },
                {
                    title: "Probl√®me Environnemental",
                    text: "Une esp√®ce prot√©g√©e est d√©couverte √† proximit√© du trac√©, n√©cessitant des ajustements.",
                    icon: "üå≥",
                    choices: [
                        { text: "Modifier le trac√© (tr√®s co√ªteux, long, excellente r√©putation)", impact: { cashChange: -1500000, time: 15, reputation: +20, clientSatisfaction: -1 }, feedback: "Une d√©cision exemplaire pour l'environnement, salu√©e par tous, mais avec des cons√©quences importantes sur le projet." },
                        { text: "Mettre en place des mesures de protection strictes (co√ªteux, moins long, bonne r√©putation)", impact: { cashChange: -500000, time: 5, reputation: +12, quality: +4, clientSatisfaction: +5 }, feedback: "Un bon compromis qui prot√®ge l'esp√®ce sans trop impacter le projet." }
                    ]
                },
                {
                    title: "Ach√®vement du Projet",
                    text: "Le projet du Canal Seine-Nord Europe est achev√© ! Le succ√®s d√©pend de vos indicateurs finaux.",
                    icon: "üèÜ",
                    choices: [
                        { text: "Voir les r√©sultats", impact: {}, feedback: "Le moment de v√©rit√© est arriv√© !" }
                    ]
                }
            ];

            const quickEvents = [
                {
                    title: "Panne de Mat√©riel !",
                    text: "Une excavatrice essentielle est tomb√©e en panne. R√©parer co√ªte cher mais est rapide, attendre est gratuit mais lent.",
                    icon: "üõ†Ô∏è",
                    choices: [
                        { text: "R√©parer imm√©diatement (-‚Ç¨50k, +1 Jour)", impact: { cashChange: -50000, time: 1 }, feedback: "La r√©paration rapide a √©vit√© un long retard, mais a co√ªt√© cher." },
                        { text: "Attendre une pi√®ce de rechange (Gratuit, +5 Jours)", impact: { time: 5, morale: 0, clientSatisfaction: 0 }, feedback: "L'attente a √©t√© longue, mais vous avez √©conomis√© de l'argent." }
                    ],
                    timer: 40 // seconds increased
                },
                {
                    title: "P√©nurie de Main-d'≈ìuvre !",
                    text: "Un virus saisonnier a mis une partie de votre √©quipe hors service. Recruter des int√©rimaires co√ªte cher, ou accepter le retard.",
                    icon: "üò∑",
                    choices: [
                        { text: "Recruter des int√©rimaires (-‚Ç¨150k, +1 Jour)", impact: { cashChange: -150000, time: 1, morale: +4 }, feedback: "Les int√©rimaires ont combl√© le manque, mais le budget a souffert." },
                        { text: "Accepter le manque (Gratuit, +3 Jours, -1 Moral)", impact: { time: 3, morale: -1, clientSatisfaction: 0 }, feedback: "Le chantier tourne au ralenti, et le moral des troupes baisse." }
                    ],
                    timer: 45 // increased
                },
                {
                    title: "Inspection Surprise !",
                    text: "Les autorit√©s viennent faire une inspection inopin√©e de la s√©curit√©. √ätes-vous pr√™t ?",
                    icon: "üîç",
                    choices: [
                        { text: "Tout est en ordre (Qualit√© +10, R√©putation +10)", impact: { quality: +10, reputation: +10, siteSafety: +10, clientSatisfaction: +10 }, feedback: "L'inspection s'est d√©roul√©e sans accroc, votre rigueur est salu√©e." },
                        { text: "Quelques lacunes (Qualit√© -1, R√©putation -1, -‚Ç¨0k)", impact: { quality: -1, reputation: -1, cashChange: 0, siteSafety: -2, clientSatisfaction: -1 }, feedback: "Des manquements ont √©t√© relev√©s, entra√Ænant des p√©nalit√©s et une mauvaise presse." }
                    ],
                    timer: 35 // increased
                }
            ];

            const catastrophes = [
                {
                    title: "Inondation Majeure !",
                    text: "Des pluies diluviennes ont provoqu√© une inondation catastrophique sur une section du chantier, causant des d√©g√¢ts majeurs et un arr√™t des travaux.",
                    icon: "üåä",
                    choices: [
                        { text: "Mobiliser toutes les ressources pour r√©parer (-‚Ç¨2M, -15 Jours, +15 Moral)", impact: { cashChange: -2000000, time: 15, morale: +15, quality: -1, siteSafety: -3, clientSatisfaction: -3 }, feedback: "Un effort colossal est d√©ploy√© pour remettre le chantier en √©tat. C'est co√ªteux et long, mais l'√©quipe est soud√©e." },
                        { text: "D√©clarer force majeure, demander aide publique (-‚Ç¨0k, -25 Jours, -5 R√©putation)", impact: { cashChange: 0, time: 25, reputation: -5, quality: -3, siteSafety: -5, clientSatisfaction: -5 }, feedback: "Vous minimisez les co√ªts directs, mais le projet subit un retard √©norme et l'image est ternie par la d√©pendance √† l'aide ext√©rieure." }
                    ],
                    timer: 20 // seconds increased
                },
                {
                    title: "Effondrement Partiel !",
                    text: "Une section r√©cemment construite s'est partiellement effondr√©e en raison d'un d√©faut structurel. Enqu√™te et reconstruction in√©vitables.",
                    icon: "üí•",
                    choices: [
                        { text: "Reconstruire en urgence, renforcer les contr√¥les (-‚Ç¨3M, -15 Jours, +30 Qualit√©)", impact: { cashChange: -3000000, time: 15, quality: +30, siteSafety: +15, clientSatisfaction: +15 }, feedback: "Une reconstruction co√ªteuse but qui garantit une qualit√© irr√©prochable et renforce la confiance." },
                        { text: "Reconstruire √† moindre co√ªt, cacher les causes (-‚Ç¨1.5M, -8 Jours, -10 R√©putation, -3 Qualit√©)", impact: { cashChange: -1500000, time: 8, reputation: -10, quality: -3, siteSafety: -5, clientSatisfaction: -5 }, feedback: "Une solution rapide et moins ch√®re, mais le secret est difficile √† garder et la qualit√© est compromise. Le scandale menace." }
                    ],
                    timer: 25 // increased
                },
                {
                    title: "Scandale M√©diatique !",
                    text: "Une fuite d'informations r√©v√®le des pratiques douteuses d'un sous-traitant majeur, √©claboussant l'ensemble du projet. La r√©putation est en jeu.",
                    icon: "üì∞",
                    choices: [
                        { text: "Rompre le contrat, lancer audit interne (-‚Ç¨1M, -6 Jours, +20 R√©putation)", impact: { cashChange: -1000000, time: 6, reputation: +20, clientSatisfaction: +10 }, feedback: "Une action forte qui montre votre int√©grit√©, mais qui a un co√ªt financier et temporel." },
                        { text: "D√©fendre le sous-traitant, minimiser l'affaire (Risque √©norme de R√©putation, +3 Jours)", impact: { reputation: -12, time: -3, clientSatisfaction: -8 }, feedback: "Vous prenez un risque √©norme pour la r√©putation du projet en d√©fendant l'ind√©fendable. Le public est furieux." }
                    ],
                    timer: 20 // increased
                }
            ];

            const marketEvents = [
                {
                    title: "Flamb√©e des Prix de l'Acier !",
                    text: "Le prix mondial de l'acier a soudainement augment√© de 30% en raison de tensions g√©opolitiques.",
                    icon: "üìà",
                    impact: { cashChange: -500000 }, // Base impact reduced
                    choices: [
                        { text: "Acheter imm√©diatement malgr√© le prix (√âvite retard, impact budget)", impact: { cashChange: -300000, time: -1 }, feedback: "Vous assurez l'approvisionnement, mais le surco√ªt est significatif." },
                        { text: "Attendre une baisse (Risque de retard, potentiel gain budget)", impact: { cashChange: 2000000, time: 8 }, feedback: "Vous pariez sur une future baisse, mais le chantier risque de prendre un retard important." }
                    ],
                    timer: 30 // increased
                },
                {
                    title: "Crise √ânerg√©tique !",
                    text: "Les prix de l'√©nergie (carburant, √©lectricit√©) s'envolent, impactant lourdement les co√ªts op√©rationnels du chantier.",
                    icon: "üí°",
                    impact: { cashChange: -400000 }, // Base impact reduced
                    choices: [
                        { text: "Optimiser la consommation, investir dans l'efficacit√© (-‚Ç¨200k, Qualit√© +10)", impact: { cashChange: -200000, quality: +10, clientSatisfaction: +5 }, feedback: "Un investissement initial qui r√©duit les co√ªts √† long terme et am√©liore l'efficacit√©." },
                        { text: "R√©duire l'activit√© pour √©conomiser (Temps +5, Moral -1)", impact: { time: 5, morale: -1, clientSatisfaction: 0 }, feedback: "Vous r√©duisez la cadence pour limiter les d√©penses, but cela impacte le calendrier et le moral des √©quipes." }
                    ],
                    timer: 30 // increased
                }
            ];

            const emailEvents = [
                {
                    sender: "Jean Dupont, Syndicat des Travailleurs",
                    subject: "Conditions de s√©curit√© inacceptables",
                    body: "Cher Directeur, je vous √©cris pour exprimer la vive inqui√©tude de nos membres concernant les conditions de s√©curit√© sur le site. Plusieurs incidents mineurs ont √©t√© signal√©s et nous craignons un accident majeur si rien n'est fait. Nous attendons des mesures concr√®tes et rapides.",
                    choices: [
                        { text: "R√©pondre imm√©diatement, promettre une enqu√™te et des actions (R√©putation +15, Moral +10, Co√ªt -‚Ç¨50k)", impact: { reputation: +15, morale: +10, cashChange: -50000, siteSafety: +10, clientSatisfaction: +5 }, feedback: "Votre r√©activit√© et votre engagement rassurent le syndicat et les ouvriers. Des fonds sont allou√©s pour am√©liorer la s√©curit√©." },
                        { text: "Accuser le syndicat d'exag√©rer, ignorer (R√©putation -6, Moral -3)", impact: { reputation: -6, morale: -3, siteSafety: -2, clientSatisfaction: -2 }, feedback: "Votre r√©ponse agressive a enflamm√© la situation. Le moral est au bas et la r√©putation du projet est gravement entach√©e." },
                        { text: "Transf√©rer √† la direction de la s√©curit√© (Neutre, pas d'impact imm√©diat)", impact: {}, feedback: "Vous d√©l√©guez le probl√®me. L'impact d√©pendra de la r√©action de la direction de la s√©curit√©." }
                    ]
                },
                {
                    sender: "Marie Curie, Association Environnementale",
                    subject: "Impact du chantier sur la faune locale",
                    body: "Madame, Monsieur, nous avons observ√© une augmentation de la mortalit√© des oiseaux et une perturbation des habitats naturels autour de votre chantier. Nous vous demandons de revoir vos m√©thodes et de mettre en place des mesures de protection de la biodiversit√©.",
                    choices: [
                        { text: "Collaborer avec l'association, financer des √©tudes d'impact (-‚Ç¨150k, R√©putation +15, Temps -1)", impact: { cashChange: -150000, reputation: +15, time: 1, clientSatisfaction: +10 }, feedback: "Votre collaboration est salu√©e par les √©cologistes, renfor√ßant l'image verte du projet, mais cela a un co√ªt et un l√©ger impact sur le temps." },
                        { text: "Ignorer l'e-mail (R√©putation -4)", impact: { reputation: -4, clientSatisfaction: -2 }, feedback: "L'association lance une campagne m√©diatique contre le projet, ternissant votre r√©putation." }
                    ]
                }
            ];

            const callEvents = [
                {
                    caller: "Pr√©fet de R√©gion",
                    message: "Directeur, j'ai des remont√©es tr√®s n√©gatives des riverains concernant le bruit et la poussi√®re. Des manifestations sont pr√©vues si la situation ne s'am√©liore pas rapidement. Que comptez-vous faire ?",
                    choices: [
                        { text: "Mettre en place des mesures anti-bruit et anti-poussi√®re urgentes (-‚Ç¨300k, Moral +10)", impact: { cashChange: -300000, morale: +10, reputation: +10, clientSatisfaction: +10 }, feedback: "Les mesures sont co√ªteuses but apaisent les tensions avec les riverains et am√©liorent le moral des √©quipes." },
                        { text: "Ignorer les plaintes, continuer comme avant (R√©putation -6, Temps -1)", impact: { reputation: -6, time: 1, clientSatisfaction: -3 }, feedback: "Les manifestations bloquent le chantier, la r√©putation est catastrophique." }
                    ],
                    timer: 30 // increased
                },
                {
                    caller: "Directeur Financier",
                    message: "Nous avons un probl√®me de tr√©sorerie inattendu. Un paiement important d'un partenaire est retard√©. Nous devons trouver une solution rapidement pour √©viter une crise.",
                    choices: [
                        { text: "Demander un pr√™t d'urgence (-‚Ç¨100k, Temps -2)", impact: { cashChange: -100000, time: -2, clientSatisfaction: 0 }, feedback: "Le pr√™t r√©sout le probl√®me de tr√©sorerie, mais ajoute une dette et un l√©ger retard." },
                        { text: "Retarder des paiements aux fournisseurs (R√©putation -4, Qualit√© -1)", impact: { reputation: -4, quality: -1, clientSatisfaction: -2 }, feedback: "Vous gagnez du temps sur la tr√©sorerie, but les relations avec les fournisseurs se d√©gradent et la qualit√© des livraisons pourrait en p√¢tir." }
                    ],
                    timer: 30 // increased
                }
            ];


            // DOM Elements
            const startScreen = document.getElementById('start-screen');
            const gameScreen = document.getElementById('game-screen');
            const resultScreen = document.getElementById('result-screen');
            const difficultySelection = document.getElementById('difficulty-selection');
            const highScoreDisplay = document.getElementById('high-score-display');
            const metricsDisplay = document.getElementById('metrics-display');
            const currentScenarioDisplay = document.getElementById('current-scenario-display');
            const totalScenariosDisplay = document.getElementById('total-scenarios-display');
            const progressBar = document.getElementById('progress-bar');
            const timerDisplay = document.getElementById('timer-display');
            const scenarioIcon = document.getElementById('scenario-icon');
            const scenarioTitle = document.getElementById('scenario-title');
            const scenarioText = document.getElementById('scenario-text');
            const choicesContainer = document.getElementById('choices-container');
            const modalOverlay = document.getElementById('modal-overlay');
            const feedbackModal = document.getElementById('feedback-modal');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackText = document.getElementById('feedback-text');
            const impactList = document.getElementById('impact-list');
            const modalContinueBtn = document.getElementById('modal-continue-btn');
            const finalScoreDisplay = document.getElementById('final-score');
            const finalHighScoreDisplay = document.getElementById('final-high-score');
            const resultCategory = document.getElementById('result-category');
            const resultDescription = document.getElementById('result-description');
            const metricAnalysisResults = document.getElementById('metric-analysis-results');
            const restartGameBtn = document.getElementById('restart-game-btn');
            const shareResultsBtn = document.getElementById('share-results-btn');
            const backToMainMenuGameBtn = document.getElementById('back-to-main-menu-game-btn');
            const backToMainMenuResultBtn = document.getElementById('back-to-main-menu-result-btn');
            const powerUpsDisplay = document.getElementById('power-ups-display');
            const floatingPowerUps = document.getElementById('floating-power-ups');
            const characterContainer = document.getElementById('character-container');
            const speechBubble = document.getElementById('speech-bubble');
            const characterAvatar = document.getElementById('character-avatar');
            const newsFeedDisplay = document.getElementById('news-feed-display');
            const contactMessage = document.getElementById('contact-message');

            // Quick Event Modal elements
            const quickEventModalOverlay = document.getElementById('quick-event-modal-overlay');
            const quickEventModal = document.getElementById('quick-event-modal');
            const quickEventIcon = document.getElementById('quick-event-icon');
            const quickEventTitle = document.getElementById('quick-event-title');
            const quickEventText = document.getElementById('quick-event-text');
            const quickEventChoicesContainer = document.getElementById('quick-event-choices-container');
            const quickEventTimerDisplay = document.getElementById('quick-event-timer-display');

            // Catastrophe Modal elements
            const catastropheModalOverlay = document.getElementById('catastrophe-modal-overlay');
            const catastropheModal = document.getElementById('catastrophe-modal');
            const catastropheIcon = document.getElementById('catastrophe-icon');
            const catastropheTitle = document.getElementById('catastrophe-title');
            const catastropheText = document.getElementById('catastrophe-text');
            const catastropheChoicesContainer = document.getElementById('catastrophe-choices-container');
            const catastropheTimerDisplay = document.getElementById('catastrophe-timer-display');

            // Market Event Modal elements
            const marketEventModalOverlay = document.getElementById('market-event-modal-overlay');
            const marketEventModal = document.getElementById('market-event-modal');
            const marketEventIcon = document.getElementById('market-event-icon');
            const marketEventTitle = document.getElementById('market-event-title');
            const marketEventText = document.getElementById('market-event-text');
            const marketImpactList = document.getElementById('market-impact-list');
            const marketEventTimerDisplay = document.getElementById('market-event-timer-display');
            // New element for market event choices
            const marketEventChoicesContainer = document.getElementById('market-event-choices-container');
            console.log('marketEventChoicesContainer on load:', marketEventChoicesContainer); // Debug log

            // Email Event Modal elements
            const emailEventModalOverlay = document.getElementById('email-event-modal-overlay');
            const emailEventModal = document.getElementById('email-event-modal');
            const emailSender = document.getElementById('email-sender');
            const emailSubject = document.getElementById('email-subject');
            const emailBody = document.getElementById('email-body');
            const emailChoicesContainer = document.getElementById('email-choices-container');

            // Call Event Modal elements
            const callEventModalOverlay = document.getElementById('call-event-modal-overlay');
            const callEventModal = document.getElementById('call-event-modal');
            const callCaller = document.getElementById('call-caller');
            const callMessage = document.getElementById('call-message');
            const callChoicesContainer = document.getElementById('call-choices-container');
            const callEventTimerDisplay = document.getElementById('call-event-timer-display');

            // Timeline display element
            const timelineDisplay = document.getElementById('timeline-display');


            // Utility Functions
            function formatNumber(num) {
                return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num);
            }

            function updateMetricDisplay(metric, value, oldValue = null) {
                const metricElement = document.getElementById(`${metric}-value`);
                if (metricElement) {
                    let displayValue = value;
                    if (metric === 'currentCash' || metric === 'revenue' || metric === 'totalCosts') {
                        displayValue = formatNumber(value);
                    } else if (metric === 'netMargin' || metric === 'deadlineAdherence' || metric === 'reputation' || metric === 'quality' || metric === 'morale' || metric === 'clientSatisfaction' || metric === 'siteSafety') {
                        displayValue = `${value.toFixed(0)}%`;
                    }

                    metricElement.textContent = displayValue;

                    if (oldValue !== null) {
                        const change = value - oldValue;
                        const indicator = document.createElement('span');
                        indicator.className = `metric-change-indicator absolute ${change > 0 ? 'positive-change' : 'negative-change'}`;
                        
                        let changeText = '';
                        if (metric === 'currentCash' || metric === 'revenue' || metric === 'totalCosts') {
                            changeText = formatNumber(Math.abs(change));
                        } else if (metric === 'netMargin' || metric === 'deadlineAdherence' || metric === 'reputation' || metric === 'quality' || metric === 'morale' || metric === 'clientSatisfaction' || metric === 'siteSafety') {
                            changeText = `${Math.abs(change).toFixed(0)}%`;
                        } else {
                            changeText = Math.abs(change);
                        }
                        
                        indicator.textContent = (change > 0 ? '+' : '-') + changeText;
                        metricElement.parentNode.style.position = 'relative'; // Ensure parent is positioned for absolute indicator
                        metricElement.parentNode.appendChild(indicator);

                        // Trigger reflow to restart animation
                        void indicator.offsetWidth;
                        indicator.classList.add('show');

                        indicator.addEventListener('animationend', () => {
                            indicator.remove();
                        });
                    }
                }
            }

            function showModal(overlay, content) {
                overlay.classList.remove('modal-hidden');
                overlay.classList.add('modal-visible');
                content.classList.remove('modal-content-hidden');
                content.classList.add('modal-content-visible');
            }

            function hideModal(overlay, content) {
                overlay.classList.remove('modal-visible');
                overlay.classList.add('modal-hidden');
                content.classList.remove('modal-content-visible');
                content.classList.add('modal-content-hidden');
            }

            function addNewsItem(message, type = 'neutral') {
                const itemDiv = document.createElement('div');
                itemDiv.className = `news-item ${type}`;
                itemDiv.textContent = `Jour ${state.elapsedDays}: ${message}`;
                newsFeedDisplay.prepend(itemDiv); // Add to the top
                // Keep only the last 10 items
                while (newsFeedDisplay.children.length > 10) {
                    newsFeedDisplay.removeChild(newsFeedDisplay.lastChild);
                }
            }

            function playSound(type) {
                Tone.start(); // Ensure audio context is started
                if (type === 'click') {
                    clickSound.triggerAttackRelease("C4", "8n");
                } else if (type === 'positive') {
                    positiveSound.triggerAttackRelease(["C5", "E5", "G5"], "8n");
                } else if (type === 'negative') {
                    negativeSound.triggerAttackRelease(["C3", "F#3"], "8n");
                } else if (type === 'scenario') {
                    scenarioStartSound.triggerAttackRelease("C2", "2n");
                } else if (type === 'win') {
                    gameOverWinSound.triggerAttackRelease("C5", "1s");
                } else if (type === 'lose') {
                    gameOverLoseSound.triggerAttackRelease("C3", "1s");
                } else if (type === 'timerWarning') {
                    timerWarningSound.triggerAttackRelease("C4", "16n");
                }
            }

            function setCharacterMood(mood) {
                let emoji = 'üë®‚Äçüíº'; // Default: neutral
                switch (mood) {
                    case 'happy': emoji = 'üòÅ'; break;
                    case 'sad': emoji = 'üòü'; break;
                    case 'angry': emoji = 'üò†'; break;
                    case 'stressed': emoji = 'üò∞'; break;
                    case 'thoughtful': emoji = 'ü§î'; break;
                    case 'surprised': emoji = 'üòÆ'; break;
                    case 'confident': emoji = 'üòé'; break;
                    case 'worried': emoji = 'üò¨'; break;
                }
                characterAvatar.textContent = emoji;
            }

            function showSpeechBubble(message, duration = 3000) {
                speechBubble.textContent = message;
                speechBubble.classList.add('show');
                clearTimeout(speechBubble.hideTimer);
                speechBubble.hideTimer = setTimeout(() => {
                    speechBubble.classList.remove('show');
                }, duration);
            }

            // Timeline Functions
            function renderTimeline() {
                timelineDisplay.innerHTML = ''; // Clear existing events

                timelineEvents.forEach(event => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'timeline-item';
                    itemDiv.innerHTML = `
                        <span class="timeline-day">Jour ${event.day}</span>
                        <span class="timeline-description">${event.description}</span>
                    `;
                    timelineDisplay.appendChild(itemDiv);
                });

                // Scroll to the latest event
                timelineDisplay.scrollTop = timelineDisplay.scrollHeight;
            }


            // Game Logic
            function initializeGame(difficultyId) {
                console.log('initializeGame called with difficulty:', difficultyId);
                const difficulty = difficulties.find(d => d.id === difficultyId);
                let initialPowerUps = JSON.parse(JSON.stringify(powerUps));
                
                // Adjust initial power-up counts based on difficulty
                if (difficultyId === 'easy') {
                    initialPowerUps.find(pu => pu.id === 'crisis_management').count = 2;
                    initialPowerUps.find(pu => pu.id === 'market_insight').count = 2;
                    initialPowerUps.find(pu => pu.id === 'expert_consultation').count = 2;
                    initialPowerUps.forEach(pu => {
                        if (pu.type === 'instant') pu.count = 5; // Give 5 of each instant power-up
                    });
                } else if (difficultyId === 'normal') {
                    initialPowerUps.find(pu => pu.id === 'crisis_management').count = 1; // Normal starts with 1 crisis management
                    initialPowerUps.find(pu => pu.id === 'market_insight').count = 1;
                    initialPowerUps.find(pu => pu.id === 'expert_consultation').count = 1;
                    initialPowerUps.forEach(pu => {
                        if (pu.type === 'instant') pu.count = 3; // Give 3 of each instant power-up
                    });
                } else { // Hard
                    initialPowerUps.find(pu => pu.id === 'crisis_management').count = 0;
                    initialPowerUps.find(pu => pu.id === 'market_insight').count = 0;
                    initialPowerUps.find(pu => pu.id === 'expert_consultation').count = 0;
                    initialPowerUps.forEach(pu => {
                        if (pu.type === 'instant') pu.count = 0; // Hard starts with 0 instant power-ups
                    });
                }


                state = {
                    metrics: { ...difficulty.initialMetrics },
                    difficulty: difficulty,
                    powerUps: initialPowerUps, // Use adjusted power-ups
                    score: 0,
                    highScore: parseInt(localStorage.getItem('highScore') || '0'),
                    timerDuration: difficulty.timer,
                    currentQuickEvent: null,
                    currentCatastrophe: null,
                    currentMarketEvent: null,
                    currentEmailEvent: null,
                    currentCallEvent: null,
                    lastMetricValues: { ...difficulty.initialMetrics },
                    totalProjectDays: difficulty.totalProjectDays, // Store total project days
                    elapsedDays: 0, // New: track elapsed days
                    daysOverdue: 0
                };
                currentScenarioIndex = 0;
                timelineEvents = [{ day: 0, description: "Lancement du projet Canal Seine-Nord Europe." }]; // Initial timeline event
                renderTimeline(); // Render initial timeline

                updateHighScoreDisplay();
                renderMetrics();
                renderPowerUps();
                addNewsItem("Le simulateur de gestion de projet est pr√™t ! Bonne chance !", "info");
                setCharacterMood('confident');
                showSpeechBubble("Bienvenue ! G√©rez ce projet avec succ√®s !");
                console.log('Initial state after initializeGame:', JSON.parse(JSON.stringify(state)));
            }

            function updateHighScoreDisplay() {
                highScoreDisplay.textContent = state.highScore;
                finalHighScoreDisplay.textContent = state.highScore;
            }

            function renderMetrics() {
                const netMarginValue = state.metrics.revenue > 0 ? ((state.metrics.revenue - state.metrics.totalCosts) / state.metrics.revenue * 100) : 0;
                const daysLeft = Math.max(0, state.totalProjectDays - state.elapsedDays);
                const daysOverdueDisplay = state.daysOverdue > 0 ? ` (+${state.daysOverdue} jours de retard)` : '';

                metricsDisplay.innerHTML = `
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Argent Disponible: <span id="currentCash-value" class="metric-value text-green-400">${formatNumber(state.metrics.currentCash)}</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Chiffre d'Affaires: <span id="revenue-value" class="metric-value text-blue-400">${formatNumber(state.metrics.revenue)}</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Co√ªts Totaux: <span id="totalCosts-value" class="metric-value text-red-400">${formatNumber(state.metrics.totalCosts)}</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Marge Nette: <span id="netMargin-value" class="metric-value ${netMarginValue >= 5 ? 'text-green-400' : (netMarginValue >= 0 ? 'text-yellow-400' : 'text-red-400')}">${netMarginValue.toFixed(1)}%</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Jours Restants: <span id="daysRemaining-value" class="metric-value text-blue-400">${daysLeft}</span>${daysOverdueDisplay}
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Respect des D√©lais: <span id="deadlineAdherence-value" class="metric-value ${state.metrics.deadlineAdherence >= 80 ? 'text-green-400' : (state.metrics.deadlineAdherence >= 50 ? 'text-yellow-400' : 'text-red-400')}">${state.metrics.deadlineAdherence.toFixed(0)}%</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            R√©putation: <span id="reputation-value" class="metric-value text-purple-400">${state.metrics.reputation}%</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Qualit√© de l'Ouvrage: <span id="quality-value" class="metric-value text-yellow-400">${state.metrics.quality}%</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Moral de l'√âquipe: <span id="morale-value" class="metric-value text-pink-400">${state.metrics.morale}%</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            Satisfaction Ma√Ætre d'Ouvrage: <span id="clientSatisfaction-value" class="metric-value text-cyan-400">${state.metrics.clientSatisfaction}%</span>
                        </p>
                    </div>
                    <div class="relative">
                        <p class="text-lg font-semibold text-white">
                            S√©curit√© du Chantier: <span id="siteSafety-value" class="metric-value text-orange-400">${state.metrics.siteSafety}%</span>
                        </p>
                    </div>
                `;
            }

            function renderPowerUps() {
                powerUpsDisplay.innerHTML = '';
                state.powerUps.forEach(pu => {
                    const button = document.createElement('button');
                    button.id = `power-up-${pu.id}`;
                    button.className = `btn btn-power-up flex flex-col items-center justify-center relative ${pu.count === 0 ? 'opacity-50 cursor-not-allowed' : ''}`;
                    button.disabled = pu.count === 0;
                    button.innerHTML = `
                        <span class="text-4xl">${pu.icon}</span>
                        <span class="font-semibold">${pu.name}</span>
                        <span class="text-sm">${pu.description}</span>
                        <span class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold -mt-2 -mr-2">${pu.count}</span>
                    `;
                    button.onclick = () => usePowerUp(pu.id);
                    powerUpsDisplay.appendChild(button);
                });
            }

            function usePowerUp(powerUpId) {
                playSound('click');
                const powerUp = state.powerUps.find(pu => pu.id === powerUpId);

                if (!powerUp || powerUp.count <= 0) {
                    showSpeechBubble("Vous n'avez plus de ce bonus !", 2000);
                    return;
                }

                if (state.metrics.currentCash < powerUp.cost) {
                    showSpeechBubble("Pas assez d'argent pour ce bonus !", 2000);
                    return;
                }

                if (powerUp.type === 'pre_event') {
                    activePowerUp = powerUp.id;
                    showSpeechBubble(`Bonus "${powerUp.name}" activ√© ! Il s'appliquera au prochain √©v√©nement pertinent.`);
                    addNewsItem(`Bonus "${powerUp.name}" activ√©.`, "info");
                    // Do not deduct cost or count yet for pre-event power-ups
                } else { // Instant power-ups
                    state.metrics.currentCash -= powerUp.cost;
                    state.metrics.totalCosts += powerUp.cost; // Power-up cost contributes to total costs
                    powerUp.count--;
                    applyImpact(powerUp.effect);
                    addNewsItem(`Bonus "${powerUp.name}" utilis√©. ${powerUp.description}`, "info");
                    showSpeechBubble(`Bonus "${powerUp.name}" appliqu√© !`);
                }

                renderPowerUps();
                renderMetrics(); // Update money display
            }

            function applyImpact(impact, isReversed = false) {
                const oldMetrics = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue }; // Capture all relevant state for comparison

                for (const metric in impact) {
                    if (impact.hasOwnProperty(metric)) {
                        let value = impact[metric];
                        if (isReversed) value = -value; // Reverse impact for market event choice

                        if (metric === 'cashChange') { // Handle the new 'cashChange' property
                            state.metrics.currentCash += value;
                            if (value > 0) {
                                state.metrics.revenue += value;
                            } else {
                                state.metrics.totalCosts += Math.abs(value);
                            }
                        } else if (metric === 'time') { // This is now days to ADD/SUBTRACT from elapsedDays
                            // Positive 'time' in impact means project takes MORE days (delay)
                            // Negative 'time' in impact means project takes FEWER days (gain time)
                            state.elapsedDays += value; // If value is positive, elapsedDays increase (lose time)
                                                       // If value is negative, elapsedDays decrease (gain time)
                            
                            // Ensure elapsedDays doesn't go below 0
                            state.elapsedDays = Math.max(0, state.elapsedDays);

                            // Recalculate daysOverdue
                            if (state.elapsedDays > state.totalProjectDays) {
                                state.daysOverdue = state.elapsedDays - state.totalProjectDays;
                            } else {
                                state.daysOverdue = 0;
                            }
                            // Recalculate deadlineAdherence
                            state.metrics.deadlineAdherence = Math.max(0, 100 - (state.daysOverdue / state.totalProjectDays) * 100);

                        } else {
                            // For other metrics (reputation, quality, morale, clientSatisfaction, siteSafety)
                            state.metrics[metric] = Math.min(100, Math.max(0, state.metrics[metric] + value));
                        }
                    }
                }
                // Update display with change indicators for all relevant metrics
                for (const metric in state.metrics) {
                    updateMetricDisplay(metric, state.metrics[metric], oldMetrics[metric]);
                }
                // Special update for netMargin as it's derived
                const newNetMargin = state.metrics.revenue > 0 ? ((state.metrics.revenue - state.metrics.totalCosts) / state.metrics.revenue * 100) : 0;
                const oldNetMargin = oldMetrics.revenue > 0 ? ((oldMetrics.revenue - oldMetrics.totalCosts) / oldMetrics.revenue * 100) : 0;
                updateMetricDisplay('netMargin', newNetMargin, oldNetMargin);

                // Update days remaining display (which is derived from elapsedDays)
                updateMetricDisplay('daysRemaining', Math.max(0, state.totalProjectDays - state.elapsedDays), Math.max(0, state.totalProjectDays - oldMetrics.elapsedDays));
            }

            function checkGameEnd() {
                const netMarginValue = state.metrics.revenue > 0 ? ((state.metrics.revenue - state.metrics.totalCosts) / state.metrics.revenue * 100) : 0;
                
                console.log('checkGameEnd called. Current metrics:', JSON.parse(JSON.stringify(state.metrics)));
                console.log('netMarginValue:', netMarginValue);
                console.log('currentScenarioIndex:', currentScenarioIndex, 'scenarios.length:', scenarios.length);

                // Adjusted loss thresholds (even more lenient)
                const isCashLow = state.metrics.currentCash <= -100000000; // Can go significantly negative
                const isReputationLow = state.metrics.reputation <= 0; // Must hit 0
                const isQualityLow = state.metrics.quality <= 0; // Must hit 0
                const isMoraleLow = state.metrics.morale <= 0; // Must hit 0
                const isClientSatisfactionLow = state.metrics.clientSatisfaction <= 0; // Must hit 0
                const isSiteSafetyLow = state.metrics.siteSafety <= 0; // Must hit 0
                const isNetMarginTooLow = netMarginValue < -75; // Even more lenient
                const isScenarioComplete = currentScenarioIndex >= scenarios.length;

                console.log({
                    isCashLow, isReputationLow, isQualityLow, isMoraleLow,
                    isClientSatisfactionLow, isSiteSafetyLow, isNetMarginTooLow,
                    isScenarioComplete
                });

                if (isCashLow || isReputationLow || isQualityLow || isMoraleLow || isClientSatisfactionLow || isSiteSafetyLow || isNetMarginTooLow) {
                    console.log('Game ending: Loss condition met.');
                    endGame(false); // Game Over (Loss)
                    return true;
                }
                if (isScenarioComplete) {
                    console.log('Game ending: All scenarios completed (Win).');
                    endGame(true); // Game Over (Win)
                    return true;
                }
                console.log('Game continues.');
                return false;
            }

            function startGame(difficultyId) {
                console.log('startGame called with difficulty:', difficultyId);
                initializeGame(difficultyId);
                showScreen('game');
                startMainTimer();
                loadScenario();
                console.log('startGame finished.');
            }

            function startMainTimer() {
                clearInterval(mainTimerInterval);
                timerCountdown = state.timerDuration;
                timerDisplay.textContent = `‚è±Ô∏è 0:${String(timerCountdown).padStart(2, '0')}`;
                timerDisplay.classList.remove('critical-time');

                mainTimerInterval = setInterval(() => {
                    timerCountdown--;
                    timerDisplay.textContent = `‚è±Ô∏è 0:${String(timerCountdown).padStart(2, '0')}`;

                    if (timerCountdown <= 10 && timerCountdown > 0) {
                        timerDisplay.classList.add('critical-time');
                        playSound('timerWarning');
                    } else if (timerCountdown <= 0) {
                        clearInterval(mainTimerInterval);
                        timerDisplay.classList.remove('critical-time');
                        addNewsItem("Temps √©coul√© pour le sc√©nario ! Une d√©cision al√©atoire a √©t√© prise.", "negative");
                        showSpeechBubble("Le temps est √©coul√© ! Une d√©cision al√©atoire a √©t√© prise.", 3000);
                        applyRandomChoice();
                    }
                }, 1000);
            }

            function stopAllTimers() {
                clearInterval(mainTimerInterval);
                clearInterval(quickEventTimerInterval);
                clearInterval(catastropheTimerInterval);
                clearInterval(marketEventTimerInterval);
                clearInterval(emailEventInterval);
                clearInterval(callEventTimerInterval);
            }

            function loadScenario() {
                console.log('loadScenario called. currentScenarioIndex:', currentScenarioIndex);
                if (checkGameEnd()) {
                    console.log('checkGameEnd returned true in loadScenario. Returning.');
                    return;
                }

                // Reset timers and flags for all modals
                stopAllTimers();
                isQuickEventActive = false;
                isCatastropheActive = false;
                isMarketEventActive = false;
                isEmailEventActive = false;
                isCallEventActive = false;

                // Hide all modals
                hideModal(modalOverlay, feedbackModal);
                hideModal(quickEventModalOverlay, quickEventModal);
                hideModal(catastropheModalOverlay, catastropheModal);
                hideModal(marketEventModalOverlay, marketEventModal);
                hideModal(emailEventModalOverlay, emailEventModal);
                hideModal(callEventModalOverlay, callEventModal);

                // Advance time for previous scenario (only if not the first scenario)
                if (currentScenarioIndex > 0) {
                    const daysAdvancedPerScenario = Math.round(state.totalProjectDays / scenarios.length); // Distribute days evenly across scenarios
                    const oldElapsedDays = state.elapsedDays; // Capture for comparison
                    state.elapsedDays += daysAdvancedPerScenario;

                    // Add passive revenue gain per scenario
                    const passiveRevenueGain = 20000000; // 20M‚Ç¨ per scenario
                    state.metrics.currentCash += passiveRevenueGain;
                    state.metrics.revenue += passiveRevenueGain;
                    addNewsItem(`Financement du projet re√ßu : ${formatNumber(passiveRevenueGain)}.`, "positive");

                    // Apply penalty for going overdue
                    if (state.elapsedDays > state.totalProjectDays && oldElapsedDays <= state.totalProjectDays) {
                        // Just crossed the deadline
                        const initialOverdueDays = state.elapsedDays - state.totalProjectDays;
                        state.daysOverdue = initialOverdueDays;
                        const penaltyCost = initialOverdueDays * 500; // Reduced penalty
                        const penaltyReputation = Math.floor(initialOverdueDays / 200); // Reduced penalty
                        state.metrics.currentCash -= penaltyCost;
                        state.metrics.totalCosts += penaltyCost;
                        state.metrics.reputation = Math.max(0, state.metrics.reputation - penaltyReputation);
                        addNewsItem(`Le projet a d√©pass√© le d√©lai initial de ${initialOverdueDays} jours ! P√©nalit√©s appliqu√©es.`, "negative");
                        showSpeechBubble(`D√©lai d√©pass√© ! P√©nalit√©s appliqu√©es.`, 3000);
                    } else if (state.elapsedDays > state.totalProjectDays && oldElapsedDays > state.totalProjectDays) {
                        // Already overdue, just accumulating more overdue days
                        const newDaysOverdue = state.elapsedDays - state.totalProjectDays;
                        const additionalOverdueDays = newDaysOverdue - state.daysOverdue;
                        state.daysOverdue = newDaysOverdue;
                        if (additionalOverdueDays > 0) {
                            const penaltyCost = additionalOverdueDays * 500;
                            const penaltyReputation = Math.floor(additionalOverdueDays / 200);
                            state.metrics.currentCash -= penaltyCost;
                            state.metrics.totalCosts += penaltyCost;
                            state.metrics.reputation = Math.max(0, state.metrics.reputation - penaltyReputation);
                            addNewsItem(`Le projet accumule ${additionalOverdueDays} jours de retard suppl√©mentaires !`, "negative");
                            showSpeechBubble(`Retard accru !`, 3000);
                        }
                    }
                    
                    // Update deadlineAdherence
                    state.metrics.deadlineAdherence = Math.max(0, 100 - (state.daysOverdue / state.totalProjectDays) * 100);

                    addNewsItem(`${daysAdvancedPerScenario} jours se sont √©coul√©s sur le chantier.`, "neutral");
                    renderMetrics(); // Update metrics display after time advance and potential penalties
                }

                // Check for random events only if it's not the last scenario
                if (currentScenarioIndex < scenarios.length - 1) {
                    triggerRandomEvent();
                } else {
                    // If it's the last scenario (completion), just load it
                    displayCurrentScenario();
                }

                // Restart main timer if no special event is active
                if (!isQuickEventActive && !isCatastropheActive && !isMarketEventActive && !isEmailEventActive && !isCallEventActive) {
                    startMainTimer();
                }

                // Update scenario progress
                currentScenarioDisplay.textContent = currentScenarioIndex + 1;
                totalScenariosDisplay.textContent = scenarios.length;
                progressBar.style.width = `${((currentScenarioIndex + 1) / scenarios.length) * 100}%`;

                // Check game end conditions after all updates
                checkGameEnd(); // Call checkGameEnd again after all scenario loading logic
            }

            function displayCurrentScenario() {
                const scenario = scenarios[currentScenarioIndex];
                scenarioIcon.textContent = scenario.icon;
                scenarioIcon.classList.add('scenario-icon-animate'); // Add animation class
                scenarioIcon.addEventListener('animationend', () => {
                    scenarioIcon.classList.remove('scenario-icon-animate'); // Remove after animation
                }, { once: true });
                scenarioTitle.textContent = scenario.title;
                scenarioText.textContent = scenario.text;
                renderChoices(scenario.choices, choicesContainer, applyChoice);
                playSound('scenario');
                setCharacterMood('thoughtful');
                showSpeechBubble(scenario.text.substring(0, 50) + "...", 4000); // Show first 50 chars of scenario text
            }

            function renderChoices(choices, container, applyFunction) {
                if (!container) {
                    console.error("Erreur: Le conteneur cible pour les choix est null.", container);
                    return; // Emp√™che d'autres erreurs
                }
                container.innerHTML = '';
                choices.forEach((choice, index) => {
                    const button = document.createElement('button');
                    button.className = 'btn w-full text-left p-4 rounded-xl shadow-lg hover:bg-blue-600 transition-all duration-200';
                    button.textContent = choice.text;
                    button.onclick = () => {
                        playSound('click');
                        applyFunction(choice);
                    };
                    container.appendChild(button);
                });
            }

            function applyChoice(choice) {
                stopAllTimers(); // Stop main timer and any active event timers
                const oldMetrics = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue }; // Capture metrics before applying impact

                // Apply power-up effect if active and relevant
                if (activePowerUp) {
                    const pu = state.powerUps.find(p => p.id === activePowerUp);
                    if (pu && pu.type === 'pre_event') {
                        if (activePowerUp === 'expert_consultation') {
                            // Find the best choice for the current scenario
                            const currentScenario = scenarios[currentScenarioIndex];
                            let bestChoice = null;
                            let maxPositiveImpact = -Infinity;

                            currentScenario.choices.forEach(c => {
                                let totalImpact = 0;
                                // Simplified impact calculation for expert consultation
                                if (c.impact.cashChange) totalImpact += c.impact.cashChange / 1000000; // Convert to M‚Ç¨ for comparison
                                if (c.impact.time) totalImpact -= c.impact.time; // Negative time is good (less elapsed days)
                                if (c.impact.reputation) totalImpact += c.impact.reputation;
                                if (c.impact.quality) totalImpact += c.impact.quality;
                                if (c.impact.morale) totalImpact += c.impact.morale;
                                if (c.impact.clientSatisfaction) totalImpact += c.impact.clientSatisfaction;
                                if (c.impact.siteSafety) totalImpact += c.impact.siteSafety;
                                
                                if (totalImpact > maxPositiveImpact) {
                                    maxPositiveImpact = totalImpact;
                                    bestChoice = c;
                                }
                            });

                            if (bestChoice) {
                                // Highlight the best choice
                                Array.from(choicesContainer.children).forEach(btn => {
                                    if (btn.textContent === bestChoice.text) {
                                        btn.classList.add('highlight-choice');
                                        showSpeechBubble("L'expert sugg√®re cette option !", 3000);
                                    }
                                });
                            }
                        }
                        // Deduct cost and count for pre-event power-ups after they are "used"
                        state.metrics.currentCash -= pu.cost;
                        state.metrics.totalCosts += pu.cost; // Power-up cost contributes to total costs
                        pu.count--;
                        activePowerUp = null; // Reset active power-up
                        renderPowerUps();
                        updateMetricDisplay('currentCash', state.metrics.currentCash, oldMetrics.currentCash); // Update money display immediately
                    }
                }

                applyImpact(choice.impact);

                // Update news feed with scenario outcome
                let newsType = 'neutral';
                if (choice.impact.cashChange > 0 || choice.impact.reputation > 0 || choice.impact.quality > 0 || choice.impact.morale > 0 || choice.impact.clientSatisfaction > 0 || choice.impact.siteSafety > 0) {
                    newsType = 'positive';
                } else if (choice.impact.cashChange < 0 || choice.impact.reputation < 0 || choice.impact.quality < 0 || choice.impact.morale < 0 || choice.impact.clientSatisfaction < 0 || choice.impact.siteSafety < 0) {
                    newsType = 'negative';
                }
                addNewsItem(`D√©cision prise pour "${scenarios[currentScenarioIndex].title}". ${choice.feedback}`, newsType);

                showFeedbackModal(choice.feedback, choice.impact, oldMetrics);
                currentScenarioIndex++;

                // Add scenario to timeline
                const eventDescription = `D√©cision: "${scenarios[currentScenarioIndex - 1].title}"`;
                timelineEvents.push({ day: state.elapsedDays, description: eventDescription }); // Use elapsedDays for timeline
                renderTimeline();
            }

            function applyRandomChoice() {
                const scenario = scenarios[currentScenarioIndex];
                const randomIndex = Math.floor(Math.random() * scenario.choices.length);
                const randomChoice = scenario.choices[randomIndex];
                applyChoice(randomChoice);
            }

            function showFeedbackModal(feedback, impact, oldMetrics) {
                feedbackTitle.textContent = "Cons√©quences de votre d√©cision";
                feedbackText.textContent = feedback;
                impactList.innerHTML = ''; // Clear previous impacts

                let hasPositiveImpact = false;
                let hasNegativeImpact = false;

                for (const metric in impact) {
                    if (impact.hasOwnProperty(metric)) {
                        const change = impact[metric];
                        const li = document.createElement('li');
                        
                        let displayChange = '';
                        let metricName = '';
                        let isPercentage = false;

                        switch (metric) {
                            case 'cashChange':
                                metricName = 'Argent';
                                displayChange = formatNumber(Math.abs(change));
                                break;
                            case 'time':
                                metricName = 'Jours';
                                displayChange = Math.abs(change);
                                break;
                            case 'revenue':
                                metricName = 'Chiffre d\'Affaires';
                                displayChange = formatNumber(Math.abs(change));
                                break;
                            case 'totalCosts':
                                metricName = 'Co√ªts Totaux';
                                displayChange = formatNumber(Math.abs(change));
                                break;
                            case 'netMargin': // This won't be in direct impacts, but for completeness
                                metricName = 'Marge Nette';
                                displayChange = `${Math.abs(change).toFixed(1)}%`;
                                isPercentage = true;
                                break;
                            case 'reputation':
                                metricName = 'R√©putation';
                                displayChange = `${Math.abs(change)}%`;
                                isPercentage = true;
                                break;
                            case 'quality':
                                metricName = 'Qualit√©';
                                displayChange = `${Math.abs(change)}%`;
                                isPercentage = true;
                                break;
                            case 'morale':
                                metricName = 'Moral √âquipe';
                                displayChange = `${Math.abs(change)}%`;
                                isPercentage = true;
                                break;
                            case 'clientSatisfaction':
                                metricName = 'Satisfaction Ma√Ætre d\'Ouvrage';
                                displayChange = `${Math.abs(change)}%`;
                                isPercentage = true;
                                break;
                            case 'deadlineAdherence': // This won't be in direct impacts, but for completeness
                                metricName = 'Respect des D√©lais';
                                displayChange = `${Math.abs(change).toFixed(0)}%`;
                                isPercentage = true;
                                break;
                            case 'siteSafety':
                                metricName = 'S√©curit√© du Chantier';
                                displayChange = `${Math.abs(change)}%`;
                                isPercentage = true;
                                break;
                            default:
                                metricName = metric;
                                displayChange = Math.abs(change);
                        }

                        li.className = `flex items-center ${change > 0 ? 'text-green-400' : 'text-red-400'}`;
                        const icon = change > 0 ? '<i class="fas fa-arrow-up mr-2"></i>' : '<i class="fas fa-arrow-down mr-2"></i>';
                        li.innerHTML = `${icon} ${metricName}: ${change > 0 ? '+' : '-'}${displayChange}`;
                        impactList.appendChild(li);

                        if (change > 0) hasPositiveImpact = true;
                        if (change < 0) hasNegativeImpact = true;
                    }
                }

                if (hasPositiveImpact && !hasNegativeImpact) {
                    playSound('positive');
                    setCharacterMood('happy');
                    showSpeechBubble("Excellente d√©cision !", 3000);
                } else if (!hasPositiveImpact && hasNegativeImpact) {
                    playSound('negative');
                    setCharacterMood('stressed');
                    showSpeechBubble("Oups, √ßa ne s'annonce pas bien...", 3000);
                } else if (hasPositiveImpact && hasNegativeImpact) {
                    setCharacterMood('thoughtful');
                    showSpeechBubble("Une d√©cision aux cons√©quences mitig√©es.", 3000);
                } else {
                    setCharacterMood('neutral');
                    showSpeechBubble("Pas de changement majeur.", 3000);
                }

                // Update metrics display with the new values and old values for comparison
                for (const metric in state.metrics) {
                    updateMetricDisplay(metric, state.metrics[metric], oldMetrics[metric]);
                }

                showModal(modalOverlay, feedbackModal);
            }

            modalContinueBtn.onclick = () => {
                playSound('click');
                hideModal(modalOverlay, feedbackModal);
                loadScenario();
            };

            function endGame(isWin) {
                console.log('endGame called. isWin:', isWin);
                stopAllTimers();
                showScreen('result');
                calculateScore();
                displayResults(isWin);
                if (isWin) {
                    playSound('win');
                    setCharacterMood('confident');
                    showSpeechBubble("Mission accomplie ! Vous √™tes un excellent chef de projet !", 5000);
                } else {
                    playSound('lose');
                    setCharacterMood('sad');
                    showSpeechBubble("Le projet a √©chou√©... Mieux la prochaine fois !", 5000);
                }
            }

            function calculateScore() {
                // Score calculation logic
                // Include all new metrics in score calculation
                const netMarginValue = state.metrics.revenue > 0 ? ((state.metrics.revenue - state.metrics.totalCosts) / state.metrics.revenue * 100) : 0;
                
                state.score = (state.metrics.currentCash / 1000000) + // Cash in millions
                              (state.metrics.reputation * 10) +
                              (state.metrics.quality * 10) +
                              (state.metrics.morale * 10) +
                              (state.metrics.clientSatisfaction * 10) +
                              (state.metrics.siteSafety * 10) +
                              (netMarginValue * 5) + // Net margin contributes significantly
                              (state.metrics.deadlineAdherence * 5); // Deadline adherence also contributes

                // Penalize heavily for overdue days
                state.score -= state.daysOverdue * 500; // Further reduced penalty per day overdue

                state.score = Math.round(state.score * state.difficulty.multiplier);
                state.score = Math.max(0, state.score); // Score cannot be negative

                if (state.score > state.highScore) {
                    state.highScore = state.score;
                    localStorage.setItem('highScore', state.highScore);
                }
            }

            function displayResults(isWin) {
                finalScoreDisplay.textContent = state.score;
                finalHighScoreDisplay.textContent = state.highScore;

                if (isWin) {
                    resultCategory.textContent = "Victoire ! Le Canal est achev√© !";
                    resultCategory.classList.remove('text-red-400');
                    resultCategory.classList.add('text-green-400');
                    resultDescription.textContent = "F√©licitations ! Vous avez men√© le projet du Canal Seine-Nord Europe √† son terme avec succ√®s. Votre gestion exemplaire a permis de surmonter tous les d√©fis.";
                    contactMessage.innerHTML = "Pour plus d'informations sur le Canal Seine-Nord Europe, visitez le site officiel : <a href='https://www.canal-seine-nord-europe.fr/' target='_blank' class='text-blue-400 hover:underline'>canal-seine-nord-europe.fr</a>";
                } else {
                    resultCategory.textContent = "D√©faite ! Le projet a √©chou√©.";
                    resultCategory.classList.remove('text-green-400');
                    resultCategory.classList.add('text-red-400');
                    resultDescription.textContent = "Malheureusement, le projet du Canal Seine-Nord Europe n'a pas pu √™tre men√© √† bien. Vos indicateurs cl√©s sont tomb√©s trop bas. Analysez vos erreurs et r√©essayez !";
                    contactMessage.innerHTML = ""; // No contact message for loss
                }

                // Metric analysis
                metricAnalysisResults.innerHTML = '';
                const thresholds = {
                    currentCash: { good: 50000000, bad: -50000000 }, // Adjusted bad threshold
                    revenue: { good: 150000000, bad: 5000000 }, // Adjusted bad threshold
                    totalCosts: { good: 100000000, bad: 150000000 }, // Lower is better for costs
                    netMargin: { good: 8, bad: -50 }, // Adjusted bad threshold
                    reputation: { good: 70, bad: 10 },
                    quality: { good: 70, bad: 10 },
                    morale: { good: 70, bad: 10 },
                    clientSatisfaction: { good: 70, bad: 10 },
                    deadlineAdherence: { good: 90, bad: 40 },
                    siteSafety: { good: 80, bad: 30 }
                };

                for (const metric in state.metrics) {
                    const value = state.metrics[metric];
                    let statusText = '';
                    let statusColor = 'text-slate-300';
                    let icon = '';
                    let displayValue = value;
                    let metricLabel = '';

                    switch (metric) {
                        case 'currentCash':
                            metricLabel = 'Argent Disponible';
                            displayValue = formatNumber(value);
                            if (value >= thresholds.currentCash.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.currentCash.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'revenue':
                            metricLabel = 'Chiffre d\'Affaires';
                            displayValue = formatNumber(value);
                            if (value >= thresholds.revenue.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.revenue.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'totalCosts':
                            metricLabel = 'Co√ªts Totaux';
                            displayValue = formatNumber(value);
                            // For costs, lower is better
                            if (value <= thresholds.totalCosts.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value >= thresholds.totalCosts.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'netMargin':
                            metricLabel = 'Marge Nette';
                            displayValue = `${value.toFixed(1)}%`;
                            if (value >= thresholds.netMargin.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.netMargin.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'reputation':
                            metricLabel = 'R√©putation';
                            displayValue = `${value}%`;
                            if (value >= thresholds.reputation.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.reputation.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'quality':
                            metricLabel = 'Qualit√© de l\'Ouvrage';
                            displayValue = `${value}%`;
                            if (value >= thresholds.quality.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.quality.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'morale':
                            metricLabel = 'Moral de l\'√âquipe';
                            displayValue = `${value}%`;
                            if (value >= thresholds.morale.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.morale.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'clientSatisfaction':
                            metricLabel = 'Satisfaction Ma√Ætre d\'Ouvrage';
                            displayValue = `${value}%`;
                            if (value >= thresholds.clientSatisfaction.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.clientSatisfaction.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'deadlineAdherence':
                            metricLabel = 'Respect des D√©lais';
                            displayValue = `${value.toFixed(0)}%`;
                            if (value >= thresholds.deadlineAdherence.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.deadlineAdherence.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            // Add days overdue info
                            if (state.daysOverdue > 0) {
                                displayValue += ` (${state.daysOverdue} jours de retard)`;
                            }
                            break;
                        case 'siteSafety':
                            metricLabel = 'S√©curit√© du Chantier';
                            displayValue = `${value}%`;
                            if (value >= thresholds.siteSafety.good) { statusText = 'Excellent'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            else if (value <= thresholds.siteSafety.bad) { statusText = 'Critique'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else { statusText = 'Moyen'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            break;
                        case 'daysRemaining': // This is a derived display, not a core metric in state.metrics
                            metricLabel = 'Jours Restants';
                            displayValue = value;
                            if (value <= 0) { statusText = 'Termin√© (avec retard)'; statusColor = 'text-red-400'; icon = 'üî¥'; }
                            else if (value < 100) { statusText = 'Proche de la fin'; statusColor = 'text-yellow-400'; icon = 'üü°'; }
                            else { statusText = 'En cours'; statusColor = 'text-green-400'; icon = 'üü¢'; }
                            break;
                        default:
                            continue; // Skip metrics not meant for final display or analysis
                    }
                    metricAnalysisResults.innerHTML += `<p class="${statusColor}">${icon} ${metricLabel}: ${displayValue} (${statusText})</p>`;
                }
            }

            function showScreen(screen) {
                startScreen.classList.remove('screen-visible', 'screen-hidden');
                gameScreen.classList.remove('screen-visible', 'screen-hidden');
                resultScreen.classList.remove('screen-visible', 'screen-hidden');
                floatingPowerUps.classList.remove('screen-visible', 'screen-hidden');

                if (screen === 'start') {
                    startScreen.classList.add('screen-visible');
                    gameScreen.classList.add('screen-hidden');
                    resultScreen.classList.add('screen-hidden');
                    floatingPowerUps.classList.add('screen-hidden');
                } else if (screen === 'game') {
                    startScreen.classList.add('screen-hidden');
                    gameScreen.classList.add('screen-visible');
                    resultScreen.classList.add('screen-hidden');
                    floatingPowerUps.classList.add('screen-visible');
                } else if (screen === 'result') {
                    startScreen.classList.add('screen-hidden');
                    gameScreen.classList.add('screen-hidden');
                    resultScreen.classList.add('screen-visible');
                    floatingPowerUps.classList.add('screen-hidden');
                }
            }

            function triggerRandomEvent() {
                const eventTypeRoll = Math.random(); // 0 to 1

                // Probabilities (can be adjusted)
                const quickEventChance = 0.25; // 25% chance (increased)
                const catastropheChance = 0.03; // 3% chance (reduced)
                const marketEventChance = 0.08; // 8% chance (reduced)
                const emailEventChance = 0.18; // 18% chance (increased)
                const callEventChance = 0.18; // 18% chance (increased)

                // Ensure only one special event can be active at a time
                console.log('Checking for active events before triggering random event:', { isQuickEventActive, isCatastropheActive, isMarketEventActive, isEmailEventActive, isCallEventActive });
                if (isQuickEventActive || isCatastropheActive || isMarketEventActive || isEmailEventActive || isCallEventActive) {
                    console.log('An event is already active, displaying current scenario.');
                    displayCurrentScenario(); // If an event is already active, just load next scenario
                    return;
                }

                console.log('Event type roll:', eventTypeRoll);

                if (eventTypeRoll < catastropheChance && catastrophes.length > 0) {
                    console.log('Attempting to trigger Catastrophe.');
                    // Check for Crisis Management power-up
                    const crisisManagementPU = state.powerUps.find(pu => pu.id === 'crisis_management');
                    if (crisisManagementPU && crisisManagementPU.count > 0 && activePowerUp === 'crisis_management') {
                        addNewsItem("Une catastrophe a √©t√© √©vit√©e gr√¢ce √† la Gestion de Crise !", "info");
                        showSpeechBubble("Catastrophe √©vit√©e !", 3000);
                        crisisManagementPU.count--; // Deduct power-up count
                        state.metrics.currentCash -= crisisManagementPU.cost; // Deduct cost
                        state.metrics.totalCosts += crisisManagementPU.cost; // Cost contributes to total costs
                        activePowerUp = null; // Reset active power-up
                        renderPowerUps();
                        renderMetrics(); // Update money display
                        displayCurrentScenario(); // Continue to next scenario normally
                        return;
                    }
                    triggerCatastrophe();
                } else if (eventTypeRoll < catastropheChance + marketEventChance && marketEvents.length > 0) {
                    console.log('Attempting to trigger Market Event.');
                    triggerMarketEvent();
                } else if (eventTypeRoll < catastropheChance + marketEventChance + emailEventChance && emailEvents.length > 0) {
                    console.log('Attempting to trigger Email Event.');
                    triggerEmailEvent();
                } else if (eventTypeRoll < catastropheChance + marketEventChance + emailEventChance + callEventChance && callEvents.length > 0) {
                    console.log('Attempting to trigger Call Event.');
                    triggerCallEvent();
                } else if (eventTypeRoll < catastropheChance + marketEventChance + emailEventChance + callEventChance + quickEventChance && quickEvents.length > 0) {
                    console.log('Attempting to trigger Quick Event.');
                    triggerQuickEvent();
                } else {
                    console.log('No special event triggered, displaying current scenario.');
                    displayCurrentScenario(); // No special event, proceed to next regular scenario
                }
            }

            function triggerQuickEvent() {
                isQuickEventActive = true;
                const event = quickEvents[Math.floor(Math.random() * quickEvents.length)];
                state.currentQuickEvent = event;

                quickEventIcon.textContent = event.icon;
                quickEventTitle.textContent = event.title;
                quickEventText.textContent = event.text;
                renderChoices(event.choices, quickEventChoicesContainer, applyQuickEventChoice);
                quickEventTimerDisplay.textContent = `‚è±Ô∏è 0:${String(event.timer).padStart(2, '0')}`;

                showModal(quickEventModalOverlay, quickEventModal);
                setCharacterMood('surprised');
                showSpeechBubble("√âv√©nement rapide ! D√©cidez vite !", 3000);
                addNewsItem(`√âv√©nement rapide: "${event.title}"`, "negative");

                let countdown = event.timer;
                quickEventTimerInterval = setInterval(() => {
                    countdown--;
                    quickEventTimerDisplay.textContent = `‚è±Ô∏è 0:${String(countdown).padStart(2, '0')}`;
                    if (countdown <= 5 && countdown > 0) {
                        playSound('timerWarning');
                    }
                    if (countdown <= 0) {
                        clearInterval(quickEventTimerInterval);
                        addNewsItem("Temps √©coul√© pour l'√©v√©nement rapide ! Une d√©cision al√©atoire a √©t√© prise.", "negative");
                        showSpeechBubble("Temps √©coul√© !", 2000);
                        applyQuickEventChoice(event.choices[Math.floor(Math.random() * event.choices.length)]);
                    }
                }, 1000);
            }

            function applyQuickEventChoice(choice) {
                clearInterval(quickEventTimerInterval);
                isQuickEventActive = false;
                hideModal(quickEventModalOverlay, quickEventModal);
                const oldMetrics = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue };
                applyImpact(choice.impact);
                addNewsItem(`D√©cision prise pour l'√©v√©nement rapide: "${state.currentQuickEvent.title}". ${choice.feedback}`, 'info');
                showFeedbackModal(choice.feedback, choice.impact, oldMetrics); // Reuse feedback modal
                state.currentQuickEvent = null;
            }

            function triggerCatastrophe() {
                isCatastropheActive = true;
                const event = catastrophes[Math.floor(Math.random() * catastrophes.length)];
                state.currentCatastrophe = event;

                catastropheIcon.textContent = event.icon;
                catastropheTitle.textContent = event.title;
                catastropheText.textContent = event.text;
                renderChoices(event.choices, catastropheChoicesContainer, applyCatastropheChoice);
                catastropheTimerDisplay.textContent = `‚è±Ô∏è 0:${String(event.timer).padStart(2, '0')}`;

                showModal(catastropheModalOverlay, catastropheModal);
                setCharacterMood('angry');
                showSpeechBubble("Catastrophe ! Agissez vite ou tout est perdu !", 4000);
                addNewsItem(`CATASTROPHE: "${event.title}"`, "negative");

                let countdown = event.timer;
                catastropheTimerInterval = setInterval(() => {
                    countdown--;
                    catastropheTimerDisplay.textContent = `‚è±Ô∏è 0:${String(countdown).padStart(2, '0')}`;
                    if (countdown <= 3 && countdown > 0) {
                        playSound('timerWarning');
                    }
                    if (countdown <= 0) {
                        clearInterval(catastropheTimerInterval);
                        addNewsItem("Temps √©coul√© pour la catastrophe ! Une d√©cision al√©atoire a √©t√© prise.", "negative");
                        showSpeechBubble("Temps √©coul√© ! Cons√©quences d√©sastreuses...", 3000);
                        applyCatastropheChoice(event.choices[Math.floor(Math.random() * event.choices.length)]);
                    }
                }, 1000);
            }

            function applyCatastropheChoice(choice) {
                clearInterval(catastropheTimerInterval);
                isCatastropheActive = false;
                hideModal(catastropheModalOverlay, catastropheModal);
                const oldMetrics = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue };
                applyImpact(choice.impact);
                addNewsItem(`D√©cision prise pour la catastrophe: "${state.currentCatastrophe.title}". ${choice.feedback}`, 'negative');
                showFeedbackModal(choice.feedback, choice.impact, oldMetrics);
                state.currentCatastrophe = null;
            }

            function triggerMarketEvent() {
                isMarketEventActive = true;
                const event = marketEvents[Math.floor(Math.random() * marketEvents.length)];
                state.currentMarketEvent = event;

                marketEventIcon.textContent = event.icon;
                marketEventTitle.textContent = event.title;
                marketEventText.textContent = event.text;
                marketEventTimerDisplay.textContent = `‚è±Ô∏è 0:${String(event.timer).padStart(2, '0')}`;

                // Apply base impact immediately for market events
                const oldMetricsBeforeMarketImpact = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue };
                applyImpact(event.impact); // Apply the base market impact
                addNewsItem(`March√©: "${event.title}" impact initial.`, "negative");

                // Display impacts in the modal
                marketImpactList.innerHTML = '';
                for (const metric in event.impact) {
                    if (event.impact.hasOwnProperty(metric)) {
                        const change = event.impact[metric];
                        const li = document.createElement('li');
                        li.className = `flex items-center ${change > 0 ? 'text-green-400' : 'text-red-400'}`;
                        const icon = change > 0 ? '<i class="fas fa-arrow-up mr-2"></i>' : '<i class="fas fa-arrow-down mr-2"></i>';
                        
                        let displayChange = '';
                        let metricName = '';

                        switch (metric) {
                            case 'cashChange':
                                metricName = 'Argent';
                                displayChange = formatNumber(Math.abs(change));
                                break;
                            case 'time':
                                metricName = 'Jours';
                                displayChange = Math.abs(change);
                                break;
                            case 'revenue':
                                metricName = 'Chiffre d\'Affaires';
                                displayChange = formatNumber(Math.abs(change));
                                break;
                            case 'totalCosts':
                                metricName = 'Co√ªts Totaux';
                                displayChange = formatNumber(Math.abs(change));
                                break;
                            case 'reputation':
                                metricName = 'R√©putation';
                                displayChange = `${Math.abs(change)}%`;
                                break;
                            case 'quality':
                                metricName = 'Qualit√©';
                                displayChange = `${Math.abs(change)}%`;
                                break;
                            case 'morale':
                                metricName = 'Moral √âquipe';
                                displayChange = `${Math.abs(change)}%`;
                                break;
                            case 'clientSatisfaction':
                                metricName = 'Satisfaction Ma√Ætre d\'Ouvrage';
                                displayChange = `${Math.abs(change)}%`;
                                break;
                            case 'siteSafety':
                                metricName = 'S√©curit√© du Chantier';
                                displayChange = `${Math.abs(change)}%`;
                                break;
                            default:
                                metricName = metric;
                                displayChange = Math.abs(change);
                        }

                        li.innerHTML = `${icon} ${metricName}: ${change > 0 ? '+' : '-'}${displayChange}`;
                        marketImpactList.appendChild(li);
                    }
                }

                // Check for Market Insight power-up
                const marketInsightPU = state.powerUps.find(pu => pu.id === 'market_insight');
                if (marketInsightPU && marketInsightPU.count > 0 && activePowerUp === 'market_insight') {
                    showSpeechBubble("Analyse du march√© activ√©e ! Vous avez une meilleure vision des options.", 3000);
                    // No special rendering for market insight, just allows player to make informed choice
                    state.metrics.currentCash -= marketInsightPU.cost;
                    state.metrics.totalCosts += marketInsightPU.cost; // Cost contributes to total costs
                    marketInsightPU.count--;
                    activePowerUp = null;
                    renderPowerUps();
                    renderMetrics(); // Update money display
                } else {
                    showSpeechBubble("Fluctuation du march√© ! Agissez vite !", 3000);
                }

                // Pass the correct choices container
                renderChoices(event.choices, marketEventChoicesContainer, (choice) => applyMarketEventChoice(choice, event.impact));

                showModal(marketEventModalOverlay, marketEventModal);
                setCharacterMood('worried');


                let countdown = event.timer;
                marketEventTimerInterval = setInterval(() => {
                    countdown--;
                    marketEventTimerDisplay.textContent = `‚è±Ô∏è 0:${String(countdown).padStart(2, '0')}`;
                    if (countdown <= 3 && countdown > 0) {
                        playSound('timerWarning');
                    }
                    if (countdown <= 0) {
                        clearInterval(marketEventTimerInterval);
                        addNewsItem("Temps √©coul√© pour l'√©v√©nement de march√© ! Pas de d√©cision prise.", "negative");
                        showSpeechBubble("Temps √©coul√© ! Le march√© n'attend pas...", 3000);
                        // If no choice is made, the initial impact remains and no further choice impact is applied.
                        isMarketEventActive = false;
                        hideModal(marketEventModalOverlay, marketEventModal);
                        loadScenario();
                    }
                }, 1000);
            }

            function applyMarketEventChoice(choice, baseImpact) {
                clearInterval(marketEventTimerInterval);
                isMarketEventActive = false;
                hideModal(marketEventModalOverlay, marketEventModal);

                const oldMetrics = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue };

                // Revert the base impact first, then apply the choice's impact
                applyImpact(baseImpact, true); // Reverse the base impact
                applyImpact(choice.impact); // Apply the choice's specific impact

                addNewsItem(`D√©cision prise pour l'√©v√©nement de march√©: "${state.currentMarketEvent.title}". ${choice.feedback}`, 'info');
                showFeedbackModal(choice.feedback, choice.impact, oldMetrics); // Reuse feedback modal
                state.currentMarketEvent = null;
            }

            function triggerEmailEvent() {
                isEmailEventActive = true;
                const event = emailEvents[Math.floor(Math.random() * emailEvents.length)];
                state.currentEmailEvent = event;

                emailSender.textContent = event.sender;
                emailSubject.textContent = event.subject;
                emailBody.textContent = event.body;
                renderChoices(event.choices, emailChoicesContainer, applyEmailEventChoice);

                showModal(emailEventModalOverlay, emailEventModal);
                setCharacterMood('thoughtful');
                showSpeechBubble("Nouvel e-mail ! Lisez attentivement.", 3000);
                addNewsItem(`Nouvel e-mail de: "${event.sender}"`, "info");
            }

            function applyEmailEventChoice(choice) {
                isEmailEventActive = false;
                hideModal(emailEventModalOverlay, emailEventModal);
                const oldMetrics = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue };
                applyImpact(choice.impact);
                addNewsItem(`R√©ponse envoy√©e √† l'e-mail de "${state.currentEmailEvent.sender}". ${choice.feedback}`, 'info');
                showFeedbackModal(choice.feedback, choice.impact, oldMetrics);
                state.currentEmailEvent = null;
            }

            function triggerCallEvent() {
                isCallEventActive = true;
                const event = callEvents[Math.floor(Math.random() * callEvents.length)];
                state.currentCallEvent = event;

                callCaller.textContent = event.caller;
                callMessage.textContent = event.message;
                renderChoices(event.choices, callChoicesContainer, applyCallEventChoice);
                callEventTimerDisplay.textContent = `‚è±Ô∏è 0:${String(event.timer).padStart(2, '0')}`;

                showModal(callEventModalOverlay, callEventModal);
                setCharacterMood('stressed');
                showSpeechBubble("Appel urgent ! R√©pondez sans tarder !", 3000);
                addNewsItem(`Appel urgent de: "${event.caller}"`, "negative");

                let countdown = event.timer;
                callEventTimerInterval = setInterval(() => {
                    countdown--;
                    callEventTimerDisplay.textContent = `‚è±Ô∏è 0:${String(countdown).padStart(2, '0')}`;
                    if (countdown <= 3 && countdown > 0) {
                        playSound('timerWarning');
                    }
                    if (countdown <= 0) {
                        clearInterval(callEventTimerInterval);
                        addNewsItem("Appel manqu√© ! Une d√©cision al√©atoire a √©t√© prise.", "negative");
                        showSpeechBubble("Appel manqu√© ! Cons√©quences...", 3000);
                        applyCallEventChoice(event.choices[Math.floor(Math.random() * event.choices.length)]);
                    }
                }, 1000);
            }

            function applyCallEventChoice(choice) {
                clearInterval(callEventTimerInterval);
                isCallEventActive = false;
                hideModal(callEventModalOverlay, callEventModal);
                const oldMetrics = { ...state.metrics, elapsedDays: state.elapsedDays, daysOverdue: state.daysOverdue };
                applyImpact(choice.impact);
                addNewsItem(`D√©cision prise suite √† l'appel de "${state.currentCallEvent.caller}". ${choice.feedback}`, 'info');
                showFeedbackModal(choice.feedback, choice.impact, oldMetrics);
                state.currentCallEvent = null;
            }


            // Event Listeners
            function setupEventListeners() {
                // Difficulty selection
                difficulties.forEach(d => {
                    const button = document.createElement('button');
                    button.className = 'btn w-full text-xl py-3 rounded-xl shadow-lg hover:bg-blue-600 transition-all duration-200';
                    button.textContent = d.name;
                    button.onclick = () => {
                        playSound('click');
                        startGame(d.id);
                    };
                    difficultySelection.appendChild(button);
                });

                restartGameBtn.onclick = () => {
                    playSound('click');
                    showScreen('start');
                    updateHighScoreDisplay(); // Update high score on start screen
                };

                shareResultsBtn.onclick = () => {
                    playSound('click');
                    const resultsText = `J'ai termin√© le simulateur de gestion de projet Canal Seine-Nord Europe avec un score de ${state.score} ! Mon meilleur score est ${state.highScore}.`;
                    navigator.clipboard.writeText(resultsText).then(() => {
                        showSpeechBubble("R√©sultats copi√©s !", 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        showSpeechBubble("Erreur lors de la copie des r√©sultats.", 2000);
                    });
                };

                backToMainMenuGameBtn.onclick = () => {
                    playSound('click');
                    stopAllTimers();
                    showScreen('start');
                    updateHighScoreDisplay();
                };

                backToMainMenuResultBtn.onclick = () => {
                    playSound('click');
                    showScreen('start');
                    updateHighScoreDisplay();
                };
            }

            // Initial setup
            document.addEventListener('DOMContentLoaded', () => {
                console.log('DOMContentLoaded fired.');
                setupEventListeners();
                updateHighScoreDisplay(); // Load high score on initial page load
                showScreen('start'); // Show start screen initially
                console.log('DOMContentLoaded finished.');
            });
        })();
    </script>
</body>
</html>
