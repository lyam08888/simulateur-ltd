<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTD Recrutement - Simulateur Directeur de Projet Travaux</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js library for graphs -->

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animated-gradient {
            background-size: 200% 200%;
            animation: gradient-animation 20s ease-in-out infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .screen { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; }
        @keyframes pulse-timer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .critical-time { animation: pulse-timer 1.5s infinite; }
        @keyframes metric-change-anim {
            from { opacity: 1; transform: translateY(0) scale(1.1); }
            to { opacity: 0; transform: translateY(-25px) scale(0.9); }
        }
        .metric-change { animation: metric-change-anim 1.5s ease-out forwards; }
        @keyframes highlight-pulse {
            from { box-shadow: 0 0 15px #f59e0b; }
            to { box-shadow: 0 0 30px #facc15, 0 0 45px #f59e0b; }
        }
        .highlight-choice { animation: highlight-pulse 1.5s infinite alternate; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-900 text-white overflow-x-hidden">

    <div id="app-container" class="relative min-h-screen w-full flex items-center justify-center p-2 sm:p-4">

        <!-- Start Screen -->
        <div id="startScreen" class="screen absolute inset-0 flex flex-col items-center justify-center text-center p-6 bg-gradient-to-br from-slate-900 to-slate-800 animated-gradient z-30 opacity-100 scale-100">
            <h1 class="text-5xl md:text-6xl font-extrabold text-blue-400 mb-4">LTD Recrutement</h1>
            <h2 class="text-2xl md:text-3xl font-semibold text-slate-300 mb-6">
                <span class="text-4xl">üèóÔ∏è</span> Simulateur Directeur de Projet Travaux
            </h2>
            <p class="max-w-2xl text-lg text-slate-400 mb-10 leading-relaxed">
                La marge de man≈ìuvre est r√©duite. G√©rez un budget de 150M‚Ç¨ o√π chaque d√©cision impacte directement votre rentabilit√©, la satisfaction client et la s√©curit√©.
            </p>
            <button onclick="startGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-xl text-xl shadow-lg shadow-blue-600/30 transform hover:scale-105 transition-all duration-300">
                Relever le D√©fi
            </button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen absolute inset-0 flex flex-col w-full max-w-7xl mx-auto p-2 sm:p-4 opacity-0 -z-10 transform scale-95">
            <header class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 mb-4 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-xl font-bold text-blue-300">Simulation Directeur de Projet Travaux</div>
                <div class="flex items-center gap-4 md:gap-6">
                    <div class="flex items-center gap-3">
                        <div class="w-40 h-3 bg-slate-700 rounded-full overflow-hidden">
                            <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <div class="text-sm font-medium text-slate-300">Sc√©nario <span id="currentScenario">1</span>/<span id="totalScenarios">10</span></div>
                    </div>
                    <div id="timerDisplay" class="text-lg font-bold text-amber-400">‚è±Ô∏è 0:00</div>
                </div>
            </header>

            <main class="flex-grow bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 sm:p-6 md:p-8 shadow-lg mb-4">
                <div class="flex items-start gap-4 mb-4">
                    <div id="scenarioIcon" class="text-4xl">üéØ</div>
                    <h2 id="scenarioTitle" class="text-2xl md:text-3xl font-bold text-slate-100"></h2>
                </div>
                <p id="scenarioText" class="text-slate-300 text-lg leading-relaxed mb-8"></p>
                <div id="choicesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                
                <!-- Project Health Chart -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-slate-100 mb-4 text-center">√âtat de Sant√© du Projet</h3>
                    <div class="bg-slate-700/50 rounded-xl p-4">
                        <canvas id="projectHealthChart"></canvas>
                    </div>
                </div>
            </main>

            <footer id="metricsContainer" class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 shadow-lg grid grid-cols-2 sm:grid-cols-4 gap-3"></footer>

            <div class="power-ups fixed bottom-4 right-4 flex flex-col gap-3 z-20"></div>
            <div id="hintMessage" class="fixed bottom-24 right-4 bg-slate-900/80 backdrop-blur-md text-white px-4 py-2 rounded-lg text-sm shadow-xl opacity-0 transform translate-y-4 transition-all duration-300 z-20"></div>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen absolute inset-0 flex flex-col items-center justify-center text-center p-6 bg-gradient-to-br from-slate-900 to-slate-800 animated-gradient opacity-0 -z-10 transform scale-95">
             <h1 class="text-5xl md:text-6xl font-extrabold text-blue-400 mb-4">LTD Recrutement</h1>
            <h2 class="text-3xl font-semibold text-slate-300 mb-4">üèÜ Bilan de Mission üèÜ</h2>
            <div id="finalScore" class="text-8xl font-bold my-4 bg-clip-text text-transparent bg-gradient-to-r from-amber-400 to-yellow-300">0</div>
            <h3 id="resultCategory" class="text-2xl font-semibold text-slate-100 mb-2"></h3>
            <p id="resultDescription" class="max-w-2xl text-lg text-slate-400 mb-8 leading-relaxed"></p>
            <div id="scoreBreakdown" class="w-full max-w-lg bg-slate-800/50 rounded-xl p-6 mb-8 text-left"></div>
            <button onclick="restartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl text-lg shadow-lg shadow-blue-600/30 transform hover:scale-105 transition-all duration-300">
                Nouvelle Simulation
            </button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="modal" class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 transform scale-95 transition-all duration-300">
            <h3 id="feedbackTitle" class="text-2xl font-bold text-center mb-4"></h3>
            <p id="feedbackText" class="text-slate-300 text-center mb-6"></p>
            <div id="impactList" class="space-y-2 mb-6 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
            <button id="modalContinueBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg text-lg transform hover:scale-105 transition-all duration-300">
                Continuer
            </button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const DOMElements = {
            startScreen: document.getElementById('startScreen'),
            gameScreen: document.getElementById('gameScreen'),
            resultScreen: document.getElementById('resultScreen'),
            progressBar: document.getElementById('progressBar'),
            currentScenarioDisplay: document.getElementById('currentScenario'),
            totalScenariosDisplay: document.getElementById('totalScenarios'),
            timerDisplay: document.getElementById('timerDisplay'),
            scenarioIcon: document.getElementById('scenarioIcon'),
            scenarioTitle: document.getElementById('scenarioTitle'),
            scenarioText: document.getElementById('scenarioText'),
            choicesContainer: document.getElementById('choicesContainer'),
            metricsContainer: document.getElementById('metricsContainer'),
            powerUpContainer: document.querySelector('.power-ups'),
            hintMessage: document.getElementById('hintMessage'),
            finalScore: document.getElementById('finalScore'),
            resultCategory: document.getElementById('resultCategory'),
            resultDescription: document.getElementById('resultDescription'),
            scoreBreakdown: document.getElementById('scoreBreakdown'),
            modalOverlay: document.getElementById('modalOverlay'),
            modal: document.getElementById('modal'),
            feedbackTitle: document.getElementById('feedbackTitle'),
            feedbackText: document.getElementById('feedbackText'),
            impactList: document.getElementById('impactList'),
            modalContinueBtn: document.getElementById('modalContinueBtn'),
            projectHealthChartCanvas: document.getElementById('projectHealthChart'),
        };

        // --- Game Configuration ---
        const CONFIG = {
            initialMetrics: {
                chiffreAffaires: { name: "Chiffre d'Affaires", icon: "üìà", value: 150000000, isCurrency: true },
                couts: { name: "Co√ªts", icon: "üìâ", value: 135000000, isCurrency: true },
                marge: { name: "Marge", icon: "üìä", value: 10, isPercentage: true },
                delais: { name: "D√©lais", icon: "‚è±Ô∏è", value: 80 },
                qualite: { name: "Qualit√©", icon: "‚≠ê", value: 80 },
                securite: { name: "S√©curit√©", icon: "üõ°Ô∏è", value: 80 },
                client: { name: "Client", icon: "ü§ù", value: 80 },
                equipe: { name: "√âquipe", icon: "üë•", value: 80 },
            },
            initialPowerUps: {
                audit: { name: "Audit Financier", icon: "ÔøΩ", count: 1, description: "R√©v√®le les impacts financiers exacts de chaque choix." },
                negociation: { name: "N√©gociation", icon: "üó£Ô∏è", count: 1, description: "Permet de r√©duire un impact n√©gatif majeur." },
                xray: { name: "Analyse Risques", icon: "üîç", count: 1, description: "Surligne le choix le moins dommageable pour le projet." },
            },
            timeBonusThreshold: 20,
            timeBonusPoints: 50,
        };

        // --- Game State ---
        let state = {};
        let projectHealthChart; // Chart.js instance

        // --- Scenarios Data (Expert Mode) ---
        const scenarios = [
            {
                title: "D√©faillance Fournisseur Critique", icon: "üè≠", timeLimit: 45,
                text: "Votre fournisseur principal de b√©ton pr√©fabriqu√©, crucial pour la phase actuelle, vient de d√©poser le bilan. Le chantier risque d'√™tre √† l'arr√™t complet d'ici 48h.",
                choices: [
                    { text: "Signer avec un fournisseur local plus cher en urgence", impacts: { couts: 2500000, delais: -15, qualite: -15, client: 5, marge: -1.5 }, feedback: "Vous sauvez les d√©lais mais le surco√ªt est important et la qualit√© de ce fournisseur est moins r√©put√©e. Le client appr√©cie votre r√©activit√©, mais la marge est fortement impact√©e." },
                    { text: "Lancer un appel d'offres acc√©l√©r√© (1 semaine)", impacts: { couts: 800000, delais: -35, equipe: -30, client: -25, marge: -0.5 }, feedback: "Solution financi√®rement prudente, mais une semaine d'arr√™t p√®se lourdement sur les d√©lais et le moral de l'√©quipe, et le client est tr√®s m√©content." },
                    { text: "Utiliser une technologie alternative (b√©ton coul√© sur place)", impacts: { couts: 4000000, securite: -30, qualite: 0, delais: -25, marge: -2.5 }, feedback: "Innovant mais extr√™mement co√ªteux et techniquement risqu√©. La qualit√© pourrait √™tre similaire, si tout se passe bien, mais la s√©curit√© est une pr√©occupation majeure et la marge est d√©vast√©e." },
                    { text: "Tenter de racheter le stock du fournisseur d√©faillant via l'administrateur judiciaire", impacts: { couts: -300000, delais: -30, client: -40, securite: -25, marge: 0.2 }, feedback: "Un pari audacieux. Si √ßa marche, vous faites une bonne affaire. Si √ßa √©choue, vous perdez un temps pr√©cieux, la relation client se d√©grade fortement et la s√©curit√© est compromise. C'est un risque juridique et de s√©curit√© √©lev√©." }
                ]
            },
            {
                title: "Conflit Social sur le Chantier", icon: "üî•", timeLimit: 60,
                text: "Une gr√®ve surprise √©clate sur le chantier suite √† un d√©saccord sur les conditions de travail. Le piquet de gr√®ve bloque l'acc√®s au site. La presse locale est d√©j√† l√†.",
                choices: [
                    { text: "N√©gocier imm√©diatement avec les syndicats, quitte √† c√©der sur des primes", impacts: { couts: 1800000, equipe: 10, delais: 15, client: -15, marge: -1.0 }, feedback: "Le conflit est r√©solu rapidement, l'√©quipe est satisfaite, mais cela cr√©e un pr√©c√©dent co√ªteux pour l'avenir et le client est tr√®s agac√© par les retards et les surco√ªts." },
                    { text: "Faire appel √† un huissier pour constater le blocage et menacer d'actions l√©gales", impacts: { equipe: -50, delais: -40, client: -35, securite: -20, marge: -0.8 }, feedback: "La ligne dure. Vous envenimez gravement les relations sociales, risquez un arr√™t prolong√©, des accidents et des poursuites. L'image du projet en p√¢tit gravement." },
                    { text: "Organiser une table ronde avec la direction, les syndicats et un m√©diateur", impacts: { delais: -15, equipe: 5, couts: 200000, marge: -0.2 }, feedback: "Approche diplomatique mais lente. Montre votre volont√© de dialogue, mais chaque jour de n√©gociation est un jour de retard co√ªteux et la marge est l√©g√®rement impact√©e." },
                    { text: "Ignorer le piquet et tenter de faire entrer des non-gr√©vistes par une autre entr√©e", impacts: { securite: -70, equipe: -60, delais: -60, qualite: -50, marge: -5.0 }, feedback: "Extr√™mement dangereux et irresponsable. Vous risquez l'escalade violente, des accidents graves, des d√©fauts de qualit√© catastrophiques, des poursuites judiciaires et la ruine de votre carri√®re. Une d√©cision d√©sastreuse et impardonnable." }
                ]
            },
            {
                title: "Modification Majeure du Client", icon: "‚úçÔ∏è", timeLimit: 50,
                text: "√Ä mi-projet, le client demande une modification de conception majeure qui impacte la structure porteuse. Il souhaite que cela soit inclus dans le budget initial.",
                choices: [
                    { text: "Refuser cat√©goriquement en citant le contrat", impacts: { client: -60, equipe: 5, marge: 0.0 }, feedback: "Vous √™tes dans votre droit, mais la relation client est durablement et gravement endommag√©e. Cela pourrait compromettre la r√©ception du chantier, les projets futurs et votre r√©putation. Pas de marge de man≈ìuvre." },
                    { text: "Accepter, en esp√©rant vous rattraper sur d'autres postes", impacts: { couts: 5000000, client: 25, qualite: -30, equipe: -30, marge: -3.0 }, feedback: "Geste commercial tr√®s appr√©ci√© mais qui an√©antit votre marge, d√©grade la qualit√© du projet et d√©motive l'√©quipe. Une d√©cision financi√®rement suicidaire." },
                    { text: "Chiffrer un avenant d√©taill√© (co√ªts + marge) et le d√©fendre fermement", impacts: { chiffreAffaires: 3500000, couts: 2800000, client: 10, delais: -15, marge: 0.5 }, feedback: "La seule approche professionnelle. La n√©gociation sera tr√®s tendue mais vous pr√©servez votre marge et la rigueur du projet, bien qu'avec un retard significatif." },
                    { text: "Proposer une alternative moins ch√®re qui r√©pond partiellement au besoin", impacts: { client: -25, qualite: -25, couts: 1500000, marge: -1.0 }, feedback: "Un compromis qui ne satisfait personne. Le client se sent flou√©, la solution technique est sous-optimale et la qualit√© est fortement d√©grad√©e. Co√ªts √©lev√©s pour un r√©sultat m√©diocre." }
                ]
            },
            {
                title: "Probl√®me G√©otechnique Impr√©vu", icon: "‚õ∞Ô∏è", timeLimit: 40,
                text: "Les fondations r√©v√®lent une poche d'argile non d√©tect√©e par les √©tudes de sol initiales. La stabilit√© d'une aile du b√¢timent est compromise.",
                choices: [
                    { text: "Mettre en place des fondations sp√©ciales (micropieux)", impacts: { couts: 6000000, delais: -35, securite: 40, marge: -4.0 }, feedback: "La solution la plus s√ªre et la plus p√©renne, mais son co√ªt est exorbitant et impacte lourdement les d√©lais. La s√©curit√© est assur√©e, mais la rentabilit√© est gravement compromise." },
                    { text: "R√©aliser une injection de r√©sine pour stabiliser le sol", impacts: { couts: 2500000, delais: -20, securite: 15, qualite: -15, marge: -1.5 }, feedback: "Une solution technique plus rapide et moins ch√®re, mais dont la durabilit√© √† long terme est sujette √† d√©bat. Un risque calcul√© sur la qualit√© et la s√©curit√©." },
                    { text: "All√©ger la structure du b√¢timent concern√© pour r√©duire la charge", impacts: { qualite: -50, client: -30, couts: 1000000, securite: -30, marge: -0.8 }, feedback: "Vous traitez le sympt√¥me, pas la cause. Le client n'appr√©cie pas la r√©duction de la qualit√©, la s√©curit√© reste une pr√©occupation majeure et les co√ªts augmentent. Une d√©cision dangereuse." },
                    { text: "Mettre en cause le bureau d'√©tudes g√©otechniques pour prise en charge", impacts: { delais: -60, client: -40, couts: 500000, marge: -0.5 }, feedback: "Vous lancez une bataille juridique qui paralysera le projet pendant des mois avec des co√ªts importants. Les chances de succ√®s sont incertaines et le client est furieux. Le projet est √† l'arr√™t." }
                ]
            },
            {
                title: "P√©nurie de Main-d'≈ìuvre Qualifi√©e", icon: "üë∑", timeLimit: 55,
                text: "Une p√©nurie inattendue de main-d'≈ìuvre qualifi√©e (soudeurs certifi√©s) menace l'avancement des travaux structurels. Les d√©lais sont d√©j√† serr√©s.",
                choices: [
                    { text: "Recruter des int√©rimaires √† prix d'or", impacts: { couts: 2800000, delais: 15, qualite: -20, equipe: -15, marge: -1.8 }, feedback: "Solution rapide mais extr√™mement co√ªteuse, et la qualit√© peut √™tre fortement impact√©e par le manque de familiarit√© avec le projet et la d√©motivation de l'√©quipe. La marge est s√©v√®rement touch√©e." },
                    { text: "Mettre en place un programme de formation acc√©l√©r√©e pour l'√©quipe existante", impacts: { couts: 1000000, delais: -30, equipe: 25, qualite: 10, marge: -0.7 }, feedback: "Investissement √† long terme pour l'√©quipe, mais cela retarde significativement le projet √† court terme. La qualit√© s'am√©liore √† terme, mais le co√ªt est √©lev√© et les d√©lais sont critiques." },
                    { text: "Sous-traiter la t√¢che √† une entreprise externe avec des √©quipes disponibles", impacts: { couts: 2000000, delais: 0, qualite: -10, client: -15, marge: -1.2 }, feedback: "Permet de maintenir les d√©lais, but la coordination est plus complexe, la qualit√© peut √™tre l√©g√®rement inf√©rieure et le client peut percevoir un manque de contr√¥le. Co√ªts √©lev√©s." },
                    { text: "N√©gocier avec le client un ajustement des d√©lais en expliquant la situation", impacts: { client: -30, delais: -25, couts: -200000, marge: 0.1 }, feedback: "Honn√™te mais risque de m√©contenter fortement le client. Vous √©vitez des co√ªts suppl√©mentaires mais perdez en r√©putation et en confiance. Les d√©lais sont tr√®s impact√©s." }
                ]
            },
            {
                title: "D√©couverte Arch√©ologique", icon: "üè∫", timeLimit: 70,
                text: "Lors des terrassements, des vestiges arch√©ologiques importants sont d√©couverts. Le site est imm√©diatement gel√© par les autorit√©s culturelles.",
                choices: [
                    { text: "Financer des fouilles acc√©l√©r√©es pour minimiser l'arr√™t", impacts: { couts: 5000000, delais: -40, client: 10, securite: 0, marge: -3.0 }, feedback: "Solution co√ªteuse mais proactive. Vous montrez votre engagement et minimisez l'impact sur le client, mais les d√©lais sont fortement impact√©s et la marge est en chute libre." },
                    { text: "Tenter de d√©vier le projet pour contourner la zone", impacts: { couts: 7000000, delais: -70, qualite: -30, client: -40, marge: -5.0 }, feedback: "Extr√™mement co√ªteux et complexe, cela peut compromettre gravement la conception initiale, la qualit√© et la satisfaction client. Retards massifs et marge an√©antie." },
                    { text: "N√©gocier avec les autorit√©s pour une intervention minimale", impacts: { delais: -30, securite: -15, client: -25, couts: 800000, marge: -0.8 }, feedback: "Vous essayez de limiter les d√©g√¢ts, mais cela peut entra√Æner des compromis sur la conservation, des retards persistants et des co√ªts additionnels importants." },
                    { text: "Mettre le chantier en pause ind√©finie en attendant une d√©cision officielle", impacts: { couts: 3500000, delais: -90, equipe: -40, client: -50, marge: -2.5 }, feedback: "La pire des solutions. Co√ªts d'immobilisation √©normes, moral de l'√©quipe au plus bas, client furieux et projet potentiellement abandonn√©. Une catastrophe totale." }
                ]
            },
            {
                title: "Accident sur le Chantier", icon: "üöë", timeLimit: 30,
                text: "Un accident grave vient de se produire sur le chantier, impliquant un ouvrier. Les secours sont en route. L'inspection du travail sera l√† sous peu.",
                choices: [
                    { text: "Assurer la prise en charge m√©dicale et la s√©curit√© du site, puis communiquer avec transparence", impacts: { securite: 40, equipe: 20, client: 15, couts: 300000, marge: -0.2 }, feedback: "Priorit√© √† l'humain et √† la transparence. Cela renforce la confiance mais a un co√ªt financier et d'image initial. La s√©curit√© est primordiale." },
                    { text: "Tenter de minimiser les faits et de cacher certaines informations", impacts: { securite: -80, equipe: -70, client: -60, couts: 2000000, marge: -4.0 }, feedback: "Extr√™mement risqu√© et irresponsable. Cela peut mener √† des poursuites judiciaires lourdes, d√©truire la r√©putation de l'entreprise, causer des pertes humaines et des scandales m√©diatiques. Une d√©cision catastrophique et criminelle." },
                    { text: "Mettre en place imm√©diatement un audit de s√©curit√© complet", impacts: { securite: 35, equipe: 15, delais: -15, couts: 600000, marge: -0.5 }, feedback: "Action forte pour la s√©curit√©, mais cela peut entra√Æner un ralentissement temporaire du chantier et des co√ªts importants. L'√©quipe est rassur√©e." },
                    { text: "Bl√¢mer l'ouvrier pour n√©gligence sans investigation", impacts: { equipe: -70, securite: -30, client: -40, couts: -150000, marge: 0.1 }, feedback: "Injuste et d√©moralisant pour l'√©quipe. Cela cr√©e un climat de peur, n'am√©liore pas la s√©curit√© et peut entra√Æner des d√©missions massives et des conflits sociaux. Gain financier minime pour un d√©sastre humain." }
                ]
            },
            {
                title: "Fluctuation des Prix des Mati√®res Premi√®res", icon: "üí∞", timeLimit: 45,
                text: "Le prix de l'acier, un composant majeur de votre projet, a subitement augment√© de 25%. Votre budget est sous pression.",
                choices: [
                    { text: "Acheter en grande quantit√© maintenant pour bloquer le prix", impacts: { couts: 2500000, delais: 15, qualite: 0, client: 0, marge: -1.5 }, feedback: "Bonne strat√©gie pour limiter la hausse, mais cela immobilise beaucoup de capital et augmente les co√ªts de stockage et de d√©lais. La marge est fortement impact√©e." },
                    { text: "Revoir les sp√©cifications techniques pour utiliser moins d'acier ou un substitut", impacts: { qualite: -30, couts: -1000000, client: -30, delais: -20, marge: 0.5 }, feedback: "Solution √©conomique mais qui peut compromettre gravement la qualit√© et la satisfaction client. N√©cessite l'accord du client et entra√Æne des retards significatifs." },
                    { text: "N√©gocier des conditions de paiement plus favorables avec le fournisseur", impacts: { couts: 300000, client: 0, delais: 0, chiffreAffaires: 0, marge: -0.1 }, feedback: "Peut all√©ger la tr√©sorerie √† court terme, mais ne r√©sout pas le probl√®me du co√ªt total et n'a qu'un impact mineur sur la marge." },
                    { text: "Demander un avenant au client pour couvrir la hausse des co√ªts", impacts: { client: -40, couts: 0, chiffreAffaires: 2500000, marge: 1.0 }, feedback: "La solution la plus directe pour votre marge, mais risque de tendre fortement la relation client et de compromettre les futurs contrats. Le client sera tr√®s m√©content." }
                ]
            },
            {
                title: "Probl√®me de Permis de Construire", icon: "üìÑ", timeLimit: 60,
                text: "Un recours de derni√®re minute contre le permis de construire est d√©pos√© par une association de quartier. Le chantier est menac√© d'un arr√™t administratif.",
                choices: [
                    { text: "Engager un avocat sp√©cialis√© et d√©fendre le permis en urgence", impacts: { couts: 1500000, delais: -30, client: 10, securite: 0, marge: -1.0 }, feedback: "La meilleure approche l√©gale, mais co√ªteuse et le d√©lai de r√©solution est incertain. Le client appr√©cie votre proactivit√©, mais les d√©lais sont tr√®s impact√©s." },
                    { text: "Tenter de n√©gocier directement avec l'association pour trouver un compromis", impacts: { couts: 400000, delais: -15, client: 0, equipe: 0, marge: -0.2 }, feedback: "Approche diplomatique qui peut √©viter un long conflit, mais n√©cessite des concessions co√ªteuses et des retards. Le r√©sultat est incertain." },
                    { text: "Ignorer le recours et continuer les travaux (risque p√©nal)", impacts: { securite: -60, delais: -70, client: -60, couts: 4000000, marge: -6.0 }, feedback: "Extr√™mement risqu√©. Vous vous exposez √† de lourdes amendes, √† l'arr√™t d√©finitif du chantier, √† des poursuites p√©nales, √† la ruine de votre r√©putation et √† des pertes financi√®res colossales. Une d√©cision ill√©gale et d√©sastreuse." },
                    { text: "Revoir le projet pour int√©grer les demandes de l'association", impacts: { couts: 2500000, delais: -40, client: 25, qualite: -15, marge: -1.8 }, feedback: "Co√ªteux et long, mais peut d√©samorcer le conflit et am√©liorer l'image du projet. La qualit√© peut √™tre compromise et les d√©lais sont tr√®s importants." }
                ]
            },
            {
                title: "Innovation Technologique Impos√©e", icon: "üí°", timeLimit: 50,
                text: "Le client souhaite int√©grer une nouvelle technologie de gestion des b√¢timents (BIM avanc√©) qui n'√©tait pas pr√©vue initialement et demande une adaptation rapide.",
                choices: [
                    { text: "Investir dans la formation de l'√©quipe et l'achat de logiciels", impacts: { couts: 2000000, equipe: 25, qualite: 20, delais: -15, marge: -1.2 }, feedback: "Co√ªteux √† court terme, mais un investissement majeur pour l'avenir de l'entreprise et la satisfaction client. Entra√Æne des retards initiaux significatifs." },
                    { text: "Sous-traiter la partie BIM √† une entreprise sp√©cialis√©e", impacts: { couts: 1200000, delais: 0, qualite: 10, client: 0, marge: -0.8 }, feedback: "Solution rapide pour r√©pondre au besoin, mais vous perdez en comp√©tence interne et le co√ªt est √©lev√©, impactant la marge." },
                    { text: "Refuser l'int√©gration en expliquant les contraintes de d√©lai et budget", impacts: { client: -40, qualite: -20, equipe: -10, couts: 0, marge: 0.0 }, feedback: "Vous prot√©gez votre budget, mais le client sera tr√®s d√©√ßu, le projet moins moderne et l'√©quipe peut se sentir d√©valoris√©e. La qualit√© per√ßue diminue." },
                    { text: "Proposer une int√©gration partielle ou progressive de la technologie", impacts: { client: 15, qualite: 15, couts: 600000, delais: -8, marge: -0.3 }, feedback: "Un compromis qui satisfait partiellement le client et limite les co√ªts et d√©lais. Une approche pragmatique avec un impact positif sur la qualit√©." }
                ]
            }
        ];

        // --- Game Logic ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(value);
        }

        function initializeGame() {
            state = {
                currentScenarioIndex: 0,
                score: 0,
                metrics: JSON.parse(JSON.stringify(CONFIG.initialMetrics)),
                powerUps: JSON.parse(JSON.stringify(CONFIG.initialPowerUps)),
                timerInterval: null,
                timeLeft: 0,
                isModalOpen: false,
                auditActive: false,
            };
            recalculateMargin();
            initProjectHealthChart(); // Initialize the chart
        }
        
        function recalculateMargin() {
            const ca = state.metrics.chiffreAffaires.value;
            const costs = state.metrics.couts.value;
            if (ca > 0) {
                state.metrics.marge.value = ((ca - costs) / ca) * 100;
            } else {
                state.metrics.marge.value = 0;
            }
        }

        function startGame() {
            initializeGame();
            
            // Fade out start screen
            DOMElements.startScreen.classList.remove('opacity-100', 'scale-100');
            DOMElements.startScreen.classList.add('opacity-0', 'scale-95');
            // After transition, move it to the back
            setTimeout(() => {
                DOMElements.startScreen.classList.remove('z-30');
                DOMElements.startScreen.classList.add('-z-10');
            }, 500); // Match CSS transition duration

            // Fade in game screen
            DOMElements.gameScreen.classList.remove('opacity-0', '-z-10', 'scale-95');
            DOMElements.gameScreen.classList.add('opacity-100', 'z-10', 'scale-100');

            DOMElements.totalScenariosDisplay.textContent = scenarios.length;
            renderAll();
            loadScenario(state.currentScenarioIndex);
            updateProjectHealthChart(); // Initial chart render
        }

        function restartGame() {
            // Fade out result screen
            DOMElements.resultScreen.classList.remove('opacity-100', 'scale-100');
            DOMElements.resultScreen.classList.add('opacity-0', 'scale-95');
             // After transition, move it to the back
            setTimeout(() => {
                DOMElements.resultScreen.classList.remove('z-10');
                DOMElements.resultScreen.classList.add('-z-10');
            }, 500);

            // Fade in start screen
            DOMElements.startScreen.classList.remove('opacity-0', '-z-10', 'scale-95');
            DOMElements.startScreen.classList.add('opacity-100', 'z-30', 'scale-100');
        }

        function loadScenario(index) {
            state.auditActive = false; // Reset audit on new scenario
            if (index >= scenarios.length) {
                endGame();
                return;
            }
            state.currentScenarioIndex = index;
            const scenario = scenarios[index];
            DOMElements.choicesContainer.querySelectorAll('.highlight-choice').forEach(el => el.classList.remove('highlight-choice'));
            DOMElements.hintMessage.classList.remove('opacity-100', 'translate-y-0');
            DOMElements.currentScenarioDisplay.textContent = index + 1;
            DOMElements.progressBar.style.width = `${((index + 1) / scenarios.length) * 100}%`;
            DOMElements.scenarioIcon.textContent = scenario.icon;
            DOMElements.scenarioTitle.textContent = scenario.title;
            DOMElements.scenarioText.textContent = scenario.text;
            renderChoices(scenario.choices);
            startTimer(scenario.timeLimit);
        }

        function handleChoice(choiceIndex) {
            if (state.isModalOpen) return;
            clearInterval(state.timerInterval);

            const scenario = scenarios[state.currentScenarioIndex];
            const choice = scenario.choices[choiceIndex];
            const impacts = choice.impacts;
            
            for (const key in impacts) {
                updateMetric(key, impacts[key]);
            }
            recalculateMargin();

            if (state.timeLeft >= CONFIG.timeBonusThreshold) {
                state.score += CONFIG.timeBonusPoints;
            }
            
            showFeedbackModal(choice, impacts);
        }

        function updateMetric(key, change) {
            const metric = state.metrics[key];
            if (!metric) return;
            
            if (metric.isCurrency) {
                 metric.value += change;
            } else if (metric.isPercentage) {
                metric.value += change; // Direct change for percentage
            } else {
                metric.value = Math.max(0, Math.min(100, metric.value + change));
            }

            renderMetric(key);
            showMetricChangeIndicator(key, change, metric.isCurrency);
        }

        function startTimer(duration) {
            state.timeLeft = duration;
            clearInterval(state.timerInterval);
            const update = () => {
                DOMElements.timerDisplay.textContent = `‚è±Ô∏è 0:${state.timeLeft.toString().padStart(2, '0')}`;
                DOMElements.timerDisplay.classList.toggle('text-red-500', state.timeLeft <= 10);
                DOMElements.timerDisplay.classList.toggle('critical-time', state.timeLeft <= 10);
                DOMElements.timerDisplay.classList.toggle('text-amber-400', state.timeLeft > 10);
                if (state.timeLeft <= 0) {
                    clearInterval(state.timerInterval);
                    // If time runs out, choose a random option
                    handleChoice(Math.floor(Math.random() * scenarios[state.currentScenarioIndex].choices.length));
                }
                state.timeLeft--;
            };
            update();
            state.timerInterval = setInterval(update, 1000);
        }

        function usePowerUp(type) {
            if (state.powerUps[type].count <= 0 || state.isModalOpen) return;
            state.powerUps[type].count--;

            switch (type) {
                case 'audit':
                    state.auditActive = true;
                    renderChoices(scenarios[state.currentScenarioIndex].choices);
                    DOMElements.hintMessage.textContent = "Audit activ√© : Impacts financiers r√©v√©l√©s.";
                    DOMElements.hintMessage.classList.add('opacity-100', 'translate-y-0');
                    break;
                case 'negociation':
                    // This would require a more complex UI to select which impact to reduce.
                    // For now, let's just boost the 'client' metric as a negotiation success.
                    updateMetric('client', 15);
                    DOMElements.hintMessage.textContent = "N√©gociation r√©ussie ! La satisfaction client augmente.";
                    DOMElements.hintMessage.classList.add('opacity-100', 'translate-y-0');
                    break;
                case 'xray':
                    const bestChoiceElement = document.getElementById(`choice-${findBestChoice().index}`);
                    if (bestChoiceElement) {
                        bestChoiceElement.classList.add('highlight-choice');
                    }
                    DOMElements.hintMessage.textContent = "Analyse Risques : Le choix le plus avantageux est mis en √©vidence.";
                    DOMElements.hintMessage.classList.add('opacity-100', 'translate-y-0');
                    break;
            }
            setTimeout(() => { DOMElements.hintMessage.classList.remove('opacity-100', 'translate-y-0'); }, 4000);
            renderPowerUps();
        }

        function findBestChoice() {
            const choices = scenarios[state.currentScenarioIndex].choices;
            let bestScore = -Infinity;
            let bestIndex = -1;
            choices.forEach((choice, index) => {
                // Calculate a score based on the sum of impacts, giving more weight to positive impacts
                // and considering financial impacts appropriately.
                let currentScore = 0;
                for (const key in choice.impacts) {
                    const change = choice.impacts[key];
                    const metric = CONFIG.initialMetrics[key];
                    if (metric.isCurrency) {
                        // For currency, positive change in CA is good, positive change in costs is bad.
                        currentScore += (key === 'chiffreAffaires' ? change : -change) / 100000; // Normalize large currency values
                    } else if (metric.isPercentage) {
                        currentScore += change * 2; // Percentage changes are often significant
                    } else {
                        currentScore += change;
                    }
                }

                // Add a small bonus for positive overall impact to break ties or favor generally good choices
                if (currentScore > 0) {
                    currentScore += 1;
                }

                if (currentScore > bestScore) {
                    bestScore = currentScore;
                    bestIndex = index;
                }
            });
            return { ...choices[bestIndex], index: bestIndex };
        }

        function showFeedbackModal(choice, impacts) {
            state.isModalOpen = true;
            DOMElements.feedbackTitle.textContent = choice.text ? `Cons√©quences de la d√©cision` : "Rapport de situation";
            DOMElements.feedbackText.textContent = choice.feedback;
            
            let impactHTML = '';
            for (const key in impacts) {
                const change = impacts[key];
                const metric = CONFIG.initialMetrics[key];
                const isFinancial = metric.isCurrency || key === 'marge';
                const colorClass = change > 0 ? (key === 'couts' ? 'text-red-400' : 'text-green-400') : (key === 'couts' ? 'text-green-400' : 'text-red-400');
                const sign = change > 0 ? '+' : '';
                const value = isFinancial ? formatCurrency(change) : `${sign}${change}`;

                impactHTML += `
                    <div class="flex justify-between items-center bg-slate-700/50 p-3 rounded-lg">
                        <span class="font-medium">${metric.icon} ${metric.name}</span>
                        <span class="font-bold ${colorClass}">${value}</span>
                    </div>
                `;
            }
            DOMElements.impactList.innerHTML = impactHTML;

            DOMElements.modalOverlay.classList.remove('pointer-events-none', 'opacity-0');
            DOMElements.modal.classList.remove('scale-95');
            
            DOMElements.modalContinueBtn.onclick = () => {
                closeFeedbackModal();
                loadScenario(state.currentScenarioIndex + 1);
                updateProjectHealthChart(); // Update chart after each scenario
            };
        }

        function closeFeedbackModal() {
            state.isModalOpen = false;
            DOMElements.modalOverlay.classList.add('pointer-events-none', 'opacity-0');
            DOMElements.modal.classList.add('scale-95');
        }

        function endGame() {
            // Fade out game screen
            DOMElements.gameScreen.classList.remove('opacity-100', 'scale-100');
            DOMElements.gameScreen.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                DOMElements.gameScreen.classList.remove('z-10');
                DOMElements.gameScreen.classList.add('-z-10');
            }, 500);

            // Fade in result screen
            DOMElements.resultScreen.classList.remove('opacity-0', '-z-10', 'scale-95');
            DOMElements.resultScreen.classList.add('opacity-100', 'z-10', 'scale-100');

            const finalMargin = state.metrics.marge.value;
            // Calculate total score based on margin, client satisfaction, and quality
            // Adjusted scoring to make it harder to get high scores with bad decisions
            const totalScore = Math.round(
                (finalMargin * 100) + // Margin is now more impactful
                (state.metrics.client.value * 20) + // Client satisfaction contribution
                (state.metrics.qualite.value * 20) + // Quality contribution
                (state.metrics.securite.value * 10) + // Safety contribution
                (state.metrics.equipe.value * 5) // Team morale contribution
            );
            DOMElements.finalScore.textContent = totalScore;

            let category, description;
            let contactMessage = '';

            if (totalScore >= 15000) {
                category = "L√©gende de la Gestion de Projet ! üöÄ";
                description = "Votre performance est absolument exceptionnelle, digne des plus grands. Une ma√Ætrise parfaite de tous les aspects. Postulez sans h√©siter !";
                contactMessage = `<p class="mt-4 text-lg text-amber-300 font-bold">Votre score est incroyable ! Nous vous encourageons vivement √† postuler chez LTD Recrutement.</p><p class="text-md text-amber-300">Envoyez votre candidature √† <a href="mailto:l.amara@ltd-international.com" class="underline text-blue-400 hover:text-blue-300">l.amara@ltd-international.com</a></p>`;
            } else if (totalScore >= 10000) {
                category = "Ma√Ætre d'≈íuvre d'Exception ! üèÜ";
                description = "Rentabilit√© exceptionnelle, projet men√© de main de ma√Ætre. Votre gestion financi√®re et strat√©gique est un cas d'√©cole. Bravo !";
                contactMessage = `<p class="mt-4 text-lg text-amber-300 font-bold">Votre score est excellent ! Nous serions ravis d'√©tudier votre profil chez LTD Recrutement.</p><p class="text-md text-amber-300">Envoyez votre candidature √† <a href="mailto:l.amara@ltd-international.com" class="underline text-blue-400 hover:text-blue-300">l.amara@ltd-international.com</a></p>`;
            } else if (totalScore >= 7500) {
                category = "Directeur de Projet √âlite ! ‚ú®";
                description = "Une performance sup√©rieure √† la moyenne, d√©montrant une grande expertise et une capacit√© √† g√©rer des d√©fis complexes avec succ√®s.";
            } else if (totalScore >= 5000) {
                category = "Directeur de Projet Confirm√©";
                description = "Vous avez su pr√©server la rentabilit√© face √† l'adversit√©. Une performance solide qui d√©montre une bonne exp√©rience.";
            } else if (totalScore >= 2500) {
                category = "Gestionnaire Prudent";
                description = "Le projet est rentable, c'est l'essentiel. Des optimisations sont possibles, mais vous avez √©vit√© la catastrophe. Mission accomplie.";
            } else if (totalScore >= 0) {
                category = "Projet en Difficult√©";
                description = "La rentabilit√© est faible ou nulle. Cette simulation difficile est riche d'enseignements pour affiner votre gestion des risques et √©viter les pertes.";
            } else {
                category = "Catastrophe de Projet ! üö®";
                description = "Le projet a subi des pertes importantes. Une analyse approfondie des d√©cisions est n√©cessaire pour √©viter de telles situations √† l'avenir.";
            }

            DOMElements.resultCategory.textContent = category;
            DOMElements.resultDescription.innerHTML = description + contactMessage; // Use innerHTML to allow HTML tags for the contact message

            let breakdownHTML = `<h4 class="text-lg font-bold text-center text-blue-300 mb-4">Bilan Financier & Op√©rationnel</h4>`;
            for (const key in state.metrics) {
                const metric = state.metrics[key];
                const value = metric.isCurrency ? formatCurrency(metric.value) : metric.isPercentage ? `${metric.value.toFixed(2)}%` : `${metric.value}/100`;
                let colorClass = 'text-white';
                if(key === 'marge') colorClass = metric.value > 10 ? 'text-green-400' : metric.value > 0 ? 'text-amber-400' : 'text-red-400';
                else if (!metric.isCurrency) { // For non-currency, non-percentage metrics (like quality, safety)
                    colorClass = metric.value > 70 ? 'text-green-400' : metric.value > 40 ? 'text-amber-400' : 'text-red-400';
                }
                
                breakdownHTML += `
                    <div class="flex justify-between items-center py-2 border-b border-slate-700 last:border-b-0">
                        <span class="font-semibold text-slate-300">${metric.icon} ${CONFIG.initialMetrics[key].name}</span>
                        <span class="font-bold text-lg ${colorClass}">${value}</span>
                    </div>
                `;
            }
            DOMElements.scoreBreakdown.innerHTML = breakdownHTML;
        }

        // --- Chart.js Functions ---
        function initProjectHealthChart() {
            // Destroy existing chart instance if it exists
            if (projectHealthChart) {
                projectHealthChart.destroy();
            }

            const ctx = DOMElements.projectHealthChartCanvas.getContext('2d');
            projectHealthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Marge (%)', 'Qualit√©', 'S√©curit√©', 'Client', '√âquipe', 'D√©lais'],
                    datasets: [{
                        label: 'Niveau Actuel',
                        data: [], // This will be populated by updateProjectHealthChart
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)', // Marge
                            'rgba(153, 102, 255, 0.6)', // Qualit√©
                            'rgba(255, 159, 64, 0.6)', // S√©curit√©
                            'rgba(54, 162, 235, 0.6)', // Client
                            'rgba(255, 99, 132, 0.6)', // √âquipe
                            'rgba(201, 203, 207, 0.6)'  // D√©lais
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(201, 203, 207, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100, // Max value for all metrics (marge can exceed, but for visual consistency)
                            ticks: {
                                color: '#cbd5e1' // Light gray for ticks
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)' // Light grid lines
                            }
                        },
                        x: {
                            ticks: {
                                color: '#cbd5e1' // Light gray for labels
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)' // Light grid lines
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // No need for legend with single dataset
                        },
                        title: {
                            display: false,
                            text: '√âtat de Sant√© du Projet',
                            color: '#e2e8f0'
                        }
                    }
                }
            });
        }

        function updateProjectHealthChart() {
            if (!projectHealthChart) return;

            const data = [
                state.metrics.marge.value,
                state.metrics.qualite.value,
                state.metrics.securite.value,
                state.metrics.client.value,
                state.metrics.equipe.value,
                state.metrics.delais.value // Higher is better for delays (on-time performance)
            ];

            // Adjust colors dynamically based on value (for non-marge metrics out of 100)
            const backgroundColors = data.map((value, index) => {
                if (index === 0) { // Marge
                    if (value > 10) return 'rgba(75, 192, 192, 0.6)'; // Greenish for good margin
                    if (value > 0) return 'rgba(255, 159, 64, 0.6)'; // Orange for positive but low margin
                    return 'rgba(255, 99, 132, 0.6)'; // Red for negative margin
                } else { // Other metrics (Qualit√©, S√©curit√©, Client, √âquipe, D√©lais)
                    if (value > 70) return 'rgba(75, 192, 192, 0.6)';
                    if (value > 40) return 'rgba(255, 159, 64, 0.6)';
                    return 'rgba(255, 99, 132, 0.6)';
                }
            });

            const borderColors = backgroundColors.map(color => color.replace('0.6', '1')); // Make border opaque

            projectHealthChart.data.datasets[0].data = data;
            projectHealthChart.data.datasets[0].backgroundColor = backgroundColors;
            projectHealthChart.data.datasets[0].borderColor = borderColors;
            projectHealthChart.update();
        }

        // --- Rendering Functions ---
        function renderAll() {
            renderMetrics();
            renderPowerUps();
        }

        function renderChoices(choices) {
            DOMElements.choicesContainer.innerHTML = choices.map((choice, index) => {
                let financialPreview = '';
                if (state.auditActive) {
                    const costImpact = choice.impacts.couts || 0;
                    const caImpact = choice.impacts.chiffreAffaires || 0;
                    financialPreview = `
                        <div class="text-xs mt-2">
                            <span class="text-red-400">Co√ªt: ${formatCurrency(costImpact)}</span> | 
                            <span class="text-green-400">C.A.: ${formatCurrency(caImpact)}</span>
                        </div>
                    `;
                }
                return `
                    <div id="choice-${index}" onclick="handleChoice(${index})" class="group bg-slate-700/50 hover:bg-slate-700 border-2 border-transparent hover:border-blue-500 rounded-xl p-5 cursor-pointer transition-all duration-300 transform hover:-translate-y-1 shadow-md hover:shadow-blue-500/20">
                        <p class="text-slate-100 font-semibold text-lg">${choice.text}</p>
                        ${financialPreview}
                    </div>
                `;
            }).join('');
        }

        function renderMetrics() {
            DOMElements.metricsContainer.innerHTML = Object.keys(state.metrics).map(key => createMetricHTML(key)).join('');
        }

        function renderMetric(key) {
            const metricElement = document.getElementById(`metric-${key}`);
            if (metricElement) metricElement.outerHTML = createMetricHTML(key);
            else renderMetrics(); // Fallback if element not found (e.g., initial render)
        }

        function createMetricHTML(key) {
            const metric = state.metrics[key];
            let valueDisplay, barDisplay = '';
            
            if (metric.isCurrency) {
                valueDisplay = formatCurrency(metric.value);
            } else if (metric.isPercentage) {
                valueDisplay = `${metric.value.toFixed(2)}%`;
                const barColor = metric.value > 75 ? 'bg-green-500' : metric.value > 40 ? 'bg-amber-500' : 'bg-red-500';
                barDisplay = `
                    <div class="w-full h-2 bg-slate-600 rounded-full mt-1">
                        <div class="h-full ${barColor} rounded-full" style="width: ${Math.max(0, Math.min(100, metric.value))}%;"></div>
                    </div>
                `;
            } else {
                valueDisplay = `${metric.value}/100`;
                const barColor = metric.value > 75 ? 'bg-green-500' : metric.value > 40 ? 'bg-amber-500' : 'bg-red-500';
                barDisplay = `
                    <div class="w-full h-2 bg-slate-600 rounded-full mt-1">
                        <div class="h-full ${barColor} rounded-full" style="width: ${Math.max(0, Math.min(100, metric.value))}%;"></div>
                    </div>
                `;
            }

            let valueColorClass = 'text-slate-200';
            if (key === 'marge') {
                valueColorClass = metric.value > 10 ? 'text-green-400' : metric.value > 0 ? 'text-amber-400' : 'text-red-400';
            } else if (!metric.isCurrency) { // For non-currency, non-percentage metrics
                valueColorClass = metric.value > 70 ? 'text-green-400' : metric.value > 40 ? 'text-amber-400' : 'text-red-400';
            } else if (key === 'couts') { // For costs, lower is better
                valueColorClass = metric.value < CONFIG.initialMetrics.couts.value * 0.9 ? 'text-green-400' : metric.value > CONFIG.initialMetrics.couts.value * 1.1 ? 'text-red-400' : 'text-amber-400';
            } else if (key === 'chiffreAffaires') { // For revenue, higher is better
                valueColorClass = metric.value > CONFIG.initialMetrics.chiffreAffaires.value * 1.1 ? 'text-green-400' : metric.value < CONFIG.initialMetrics.chiffreAffaires.value * 0.9 ? 'text-red-400' : 'text-amber-400';
            }

            return `
                <div id="metric-${key}" class="bg-slate-700/50 rounded-lg p-3 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-2xl mb-1">${metric.icon}</span>
                    <span class="text-sm text-slate-400 font-medium">${metric.name}</span>
                    <span class="text-lg font-bold ${valueColorClass}">${valueDisplay}</span>
                    ${barDisplay}
                </div>
            `;
        }

        function showMetricChangeIndicator(key, change, isCurrency) {
            const metricElement = document.getElementById(`metric-${key}`);
            if (!metricElement) return;

            const indicator = document.createElement('div');
            indicator.className = `absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold metric-change ${change > 0 ? (key === 'couts' ? 'text-red-400' : 'text-green-400') : (key === 'couts' ? 'text-green-400' : 'text-red-400')}`;
            indicator.textContent = `${change > 0 ? '+' : ''}${isCurrency ? formatCurrency(change) : change}`;
            metricElement.appendChild(indicator);

            indicator.addEventListener('animationend', () => {
                indicator.remove();
            });
        }

        function renderPowerUps() {
            DOMElements.powerUpContainer.innerHTML = Object.keys(state.powerUps).map(type => {
                const powerUp = state.powerUps[type];
                const isDisabled = powerUp.count <= 0 ? 'opacity-50 cursor-not-allowed' : 'hover:scale-110 cursor-pointer';
                return `
                    <button onclick="usePowerUp('${type}')" class="bg-blue-700 text-white rounded-full p-3 shadow-lg flex items-center justify-center transition-all duration-200 ${isDisabled}" title="${powerUp.description}" ${powerUp.count <= 0 ? 'disabled' : ''}>
                        <span class="text-2xl">${powerUp.icon}</span>
                        <span class="absolute top-0 right-0 -mt-1 -mr-1 bg-amber-500 text-slate-900 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${powerUp.count}</span>
                    </button>
                `;
            }).join('');
        }

        // Initial setup
        initializeGame();
    </script>
</body>
</html>
ÔøΩ
