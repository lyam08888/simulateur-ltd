<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTD Recrutement - Simulateur Directeur de Projet Travaux</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animated-gradient {
            background-size: 200% 200%;
            animation: gradient-animation 20s ease-in-out infinite;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .screen { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; }
        @keyframes pulse-timer {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .critical-time { animation: pulse-timer 1.5s infinite; }
        @keyframes metric-change-anim {
            from { opacity: 1; transform: translateY(0) scale(1.1); }
            to { opacity: 0; transform: translateY(-25px) scale(0.9); }
        }
        .metric-change { animation: metric-change-anim 1.5s ease-out forwards; }
        @keyframes highlight-pulse {
            from { box-shadow: 0 0 15px #f59e0b; }
            to { box-shadow: 0 0 30px #facc15, 0 0 45px #f59e0b; }
        }
        .highlight-choice { animation: highlight-pulse 1.5s infinite alternate; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-900 text-white overflow-x-hidden">

    <div id="app-container" class="relative min-h-screen w-full flex items-center justify-center p-2 sm:p-4">

        <!-- Start Screen -->
        <div id="startScreen" class="screen absolute inset-0 flex flex-col items-center justify-center text-center p-6 bg-gradient-to-br from-slate-900 to-slate-800 animated-gradient z-30 opacity-100 scale-100">
            <h1 class="text-5xl md:text-6xl font-extrabold text-blue-400 mb-4">LTD Recrutement</h1>
            <h2 class="text-2xl md:text-3xl font-semibold text-slate-300 mb-6">
                <span class="text-4xl">üèóÔ∏è</span> Simulateur Directeur de Projet Travaux
            </h2>
            <p class="max-w-2xl text-lg text-slate-400 mb-10 leading-relaxed">
                La marge de man≈ìuvre est r√©duite. G√©rez un budget de 150M‚Ç¨ o√π chaque d√©cision impacte directement votre rentabilit√©, la satisfaction client et la s√©curit√©.
            </p>
            <button onclick="startGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-xl text-xl shadow-lg shadow-blue-600/30 transform hover:scale-105 transition-all duration-300">
                Relever le D√©fi
            </button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen absolute inset-0 flex flex-col w-full max-w-7xl mx-auto p-2 sm:p-4 opacity-0 -z-10 transform scale-95">
            <header class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 mb-4 shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="text-xl font-bold text-blue-300">Simulation Directeur de Projet Travaux</div>
                <div class="flex items-center gap-4 md:gap-6">
                    <div class="flex items-center gap-3">
                        <div class="w-40 h-3 bg-slate-700 rounded-full overflow-hidden">
                            <div id="progressBar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <div class="text-sm font-medium text-slate-300">Sc√©nario <span id="currentScenario">1</span>/<span id="totalScenarios">10</span></div>
                    </div>
                    <div id="timerDisplay" class="text-lg font-bold text-amber-400">‚è±Ô∏è 0:00</div>
                </div>
            </header>

            <main class="flex-grow bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 sm:p-6 md:p-8 shadow-lg mb-4">
                <div class="flex items-start gap-4 mb-4">
                    <div id="scenarioIcon" class="text-4xl">üéØ</div>
                    <h2 id="scenarioTitle" class="text-2xl md:text-3xl font-bold text-slate-100"></h2>
                </div>
                <p id="scenarioText" class="text-slate-300 text-lg leading-relaxed mb-8"></p>
                <div id="choicesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </main>

            <footer id="metricsContainer" class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 shadow-lg grid grid-cols-2 sm:grid-cols-4 gap-3"></footer>

            <div class="power-ups fixed bottom-4 right-4 flex flex-col gap-3 z-20"></div>
            <div id="hintMessage" class="fixed bottom-24 right-4 bg-slate-900/80 backdrop-blur-md text-white px-4 py-2 rounded-lg text-sm shadow-xl opacity-0 transform translate-y-4 transition-all duration-300 z-20"></div>
        </div>

        <!-- Result Screen -->
        <div id="resultScreen" class="screen absolute inset-0 flex flex-col items-center justify-center text-center p-6 bg-gradient-to-br from-slate-900 to-slate-800 animated-gradient opacity-0 -z-10 transform scale-95">
             <h1 class="text-5xl md:text-6xl font-extrabold text-blue-400 mb-4">LTD Recrutement</h1>
            <h2 class="text-3xl font-semibold text-slate-300 mb-4">üèÜ Bilan de Mission üèÜ</h2>
            <div id="finalScore" class="text-8xl font-bold my-4 bg-clip-text text-transparent bg-gradient-to-r from-amber-400 to-yellow-300">0</div>
            <h3 id="resultCategory" class="text-2xl font-semibold text-slate-100 mb-2"></h3>
            <p id="resultDescription" class="max-w-2xl text-lg text-slate-400 mb-8 leading-relaxed"></p>
            <div id="scoreBreakdown" class="w-full max-w-lg bg-slate-800/50 rounded-xl p-6 mb-8 text-left"></div>
            <button onclick="restartGame()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl text-lg shadow-lg shadow-blue-600/30 transform hover:scale-105 transition-all duration-300">
                Nouvelle Simulation
            </button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="modalOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="modal" class="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg p-6 transform scale-95 transition-all duration-300">
            <h3 id="feedbackTitle" class="text-2xl font-bold text-center mb-4"></h3>
            <p id="feedbackText" class="text-slate-300 text-center mb-6"></p>
            <div id="impactList" class="space-y-2 mb-6 max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
            <button id="modalContinueBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg text-lg transform hover:scale-105 transition-all duration-300">
                Continuer
            </button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const DOMElements = {
            startScreen: document.getElementById('startScreen'),
            gameScreen: document.getElementById('gameScreen'),
            resultScreen: document.getElementById('resultScreen'),
            progressBar: document.getElementById('progressBar'),
            currentScenarioDisplay: document.getElementById('currentScenario'),
            totalScenariosDisplay: document.getElementById('totalScenarios'),
            timerDisplay: document.getElementById('timerDisplay'),
            scenarioIcon: document.getElementById('scenarioIcon'),
            scenarioTitle: document.getElementById('scenarioTitle'),
            scenarioText: document.getElementById('scenarioText'),
            choicesContainer: document.getElementById('choicesContainer'),
            metricsContainer: document.getElementById('metricsContainer'),
            powerUpContainer: document.querySelector('.power-ups'),
            hintMessage: document.getElementById('hintMessage'),
            finalScore: document.getElementById('finalScore'),
            resultCategory: document.getElementById('resultCategory'),
            resultDescription: document.getElementById('resultDescription'),
            scoreBreakdown: document.getElementById('scoreBreakdown'),
            modalOverlay: document.getElementById('modalOverlay'),
            modal: document.getElementById('modal'),
            feedbackTitle: document.getElementById('feedbackTitle'),
            feedbackText: document.getElementById('feedbackText'),
            impactList: document.getElementById('impactList'),
            modalContinueBtn: document.getElementById('modalContinueBtn'),
        };

        // --- Game Configuration ---
        const CONFIG = {
            initialMetrics: {
                chiffreAffaires: { name: "Chiffre d'Affaires", icon: "ÔøΩ", value: 150000000, isCurrency: true },
                couts: { name: "Co√ªts", icon: "üìâ", value: 135000000, isCurrency: true },
                marge: { name: "Marge", icon: "üìä", value: 10, isPercentage: true },
                delais: { name: "D√©lais", icon: "‚è±Ô∏è", value: 80 },
                qualite: { name: "Qualit√©", icon: "‚≠ê", value: 80 },
                securite: { name: "S√©curit√©", icon: "üõ°Ô∏è", value: 80 },
                client: { name: "Client", icon: "ü§ù", value: 80 },
                equipe: { name: "√âquipe", icon: "üë•", value: 80 },
            },
            initialPowerUps: {
                audit: { name: "Audit Financier", icon: "üí∏", count: 1, description: "R√©v√®le les impacts financiers exacts de chaque choix." },
                negociation: { name: "N√©gociation", icon: "üó£Ô∏è", count: 1, description: "Permet de r√©duire un impact n√©gatif majeur." },
                xray: { name: "Analyse Risques", icon: "üîç", count: 1, description: "Surligne le choix le moins dommageable pour le projet." },
            },
            timeBonusThreshold: 20,
            timeBonusPoints: 50,
        };

        // --- Game State ---
        let state = {};

        // --- Scenarios Data (Expert Mode) ---
        const scenarios = [
            {
                title: "D√©faillance Fournisseur Critique", icon: "üè≠", timeLimit: 45,
                text: "Votre fournisseur principal de b√©ton pr√©fabriqu√©, crucial pour la phase actuelle, vient de d√©poser le bilan. Le chantier risque d'√™tre √† l'arr√™t complet d'ici 48h.",
                choices: [
                    { text: "Signer avec un fournisseur local plus cher en urgence", impacts: { couts: 750000, delais: 5, qualite: -5, client: 10 }, feedback: "Vous sauvez les d√©lais mais le surco√ªt est important et la qualit√© de ce fournisseur est moins r√©put√©e. Le client appr√©cie votre r√©activit√©." },
                    { text: "Lancer un appel d'offres acc√©l√©r√© (1 semaine)", impacts: { couts: 250000, delais: -15, equipe: -10, client: -5 }, feedback: "Solution financi√®rement prudente, mais une semaine d'arr√™t p√®se sur les d√©lais et le moral de l'√©quipe." },
                    { text: "Utiliser une technologie alternative (b√©ton coul√© sur place)", impacts: { couts: 1200000, securite: -10, qualite: 10, delais: -5 }, feedback: "Innovant mais tr√®s co√ªteux et techniquement risqu√©. La qualit√© pourrait √™tre sup√©rieure, si tout se passe bien." },
                    { text: "Tenter de racheter le stock du fournisseur d√©faillant via l'administrateur judiciaire", impacts: { couts: -100000, delais: -10, client: -10, securite: -5 }, feedback: "Un pari audacieux. Si √ßa marche, vous faites une bonne affaire. Si √ßa √©choue, vous perdez un temps pr√©cieux. C'est un risque juridique." }
                ]
            },
            {
                title: "Conflit Social sur le Chantier", icon: "üî•", timeLimit: 60,
                text: "Une gr√®ve surprise √©clate sur le chantier suite √† un d√©saccord sur les conditions de travail. Le piquet de gr√®ve bloque l'acc√®s au site. La presse locale est d√©j√† l√†.",
                choices: [
                    { text: "N√©gocier imm√©diatement avec les syndicats, quitte √† c√©der sur des primes", impacts: { couts: 500000, equipe: 15, delais: 5, client: -5 }, feedback: "Le conflit est r√©solu rapidement, l'√©quipe est satisfaite, mais cela cr√©e un pr√©c√©dent co√ªteux pour l'avenir." },
                    { text: "Faire appel √† un huissier pour constater le blocage et menacer d'actions l√©gales", impacts: { equipe: -25, delais: -15, client: -10, securite: -5 }, feedback: "La ligne dure. Vous envenimez les relations sociales et risquez un arr√™t prolong√©. L'image du projet en p√¢tit." },
                    { text: "Organiser une table ronde avec la direction, les syndicats et un m√©diateur", impacts: { delais: -5, equipe: 5, couts: 50000 }, feedback: "Approche diplomatique mais lente. Montre votre volont√© de dialogue, mais chaque jour de n√©gociation est un jour de retard." },
                    { text: "Ignorer le piquet et tenter de faire entrer des non-gr√©vistes par une autre entr√©e", impacts: { securite: -30, equipe: -20, delais: -20, qualite: -15 }, feedback: "Extr√™mement dangereux. Vous risquez l'escalade, des accidents et des d√©fauts de qualit√© catastrophiques. Une tr√®s mauvaise d√©cision." }
                ]
            },
            {
                title: "Modification Majeure du Client", icon: "‚úçÔ∏è", timeLimit: 50,
                text: "√Ä mi-projet, le client demande une modification de conception majeure qui impacte la structure porteuse. Il souhaite que cela soit inclus dans le budget initial.",
                choices: [
                    { text: "Refuser cat√©goriquement en citant le contrat", impacts: { client: -25, equipe: 5 }, feedback: "Vous √™tes dans votre droit, mais la relation client est durablement endommag√©e. Cela pourrait compliquer la r√©ception du chantier." },
                    { text: "Accepter, en esp√©rant vous rattraper sur d'autres postes", impacts: { couts: 1500000, client: 15, qualite: -10, equipe: -10 }, feedback: "Geste commercial tr√®s appr√©ci√© mais qui an√©antit votre marge. L'√©quipe est d√©motiv√©e par ce travail 'gratuit'." },
                    { text: "Chiffrer un avenant d√©taill√© (co√ªts + marge) et le d√©fendre fermement", impacts: { chiffreAffaires: 1800000, couts: 1500000, client: 5, delais: -5 }, feedback: "La seule approche professionnelle. La n√©gociation sera tendue mais vous pr√©servez votre marge et la rigueur du projet." },
                    { text: "Proposer une alternative moins ch√®re qui r√©pond partiellement au besoin", impacts: { client: -5, qualite: -5, couts: 400000 }, feedback: "Un compromis qui ne satisfait personne. Le client se sent flou√© et la solution technique est sous-optimale." }
                ]
            },
            {
                title: "Probl√®me G√©otechnique Impr√©vu", icon: "‚õ∞Ô∏è", timeLimit: 40,
                text: "Les fondations r√©v√®lent une poche d'argile non d√©tect√©e par les √©tudes de sol initiales. La stabilit√© d'une aile du b√¢timent est compromise.",
                choices: [
                    { text: "Mettre en place des fondations sp√©ciales (micropieux)", impacts: { couts: 2000000, delais: -15, securite: 20 }, feedback: "La solution la plus s√ªre et la plus p√©renne, mais son co√ªt est exorbitant et impacte lourdement les d√©lais." },
                    { text: "R√©aliser une injection de r√©sine pour stabiliser le sol", impacts: { couts: 800000, delais: -5, securite: 5, qualite: -5 }, feedback: "Une solution technique plus rapide et moins ch√®re, mais dont la durabilit√© √† long terme est sujette √† d√©bat. Un risque calcul√©." },
                    { text: "All√©ger la structure du b√¢timent concern√© pour r√©duire la charge", impacts: { qualite: -15, client: -10, couts: 250000 }, feedback: "Vous traitez le sympt√¥me, pas la cause. Le client n'appr√©cie pas la r√©duction de la qualit√© et la s√©curit√© reste une pr√©occupation." },
                    { text: "Mettre en cause le bureau d'√©tudes g√©otechniques pour prise en charge", impacts: { delais: -25, client: -15, couts: 100000 }, feedback: "Vous lancez une bataille juridique qui paralysera le projet pendant des mois. Les chances de succ√®s sont incertaines." }
                ]
            },
            {
                title: "P√©nurie de Main-d'≈ìuvre Qualifi√©e", icon: "üë∑", timeLimit: 55,
                text: "Une p√©nurie inattendue de main-d'≈ìuvre qualifi√©e (soudeurs certifi√©s) menace l'avancement des travaux structurels. Les d√©lais sont d√©j√† serr√©s.",
                choices: [
                    { text: "Recruter des int√©rimaires √† prix d'or", impacts: { couts: 900000, delais: 5, qualite: -5, equipe: -5 }, feedback: "Solution rapide mais co√ªteuse, et la qualit√© peut √™tre impact√©e par le manque de familiarit√© avec le projet." },
                    { text: "Mettre en place un programme de formation acc√©l√©r√©e pour l'√©quipe existante", impacts: { couts: 300000, delais: -10, equipe: 15, qualite: 5 }, feedback: "Investissement √† long terme pour l'√©quipe, mais cela retarde le projet √† court terme. La qualit√© s'am√©liore √† terme." },
                    { text: "Sous-traiter la t√¢che √† une entreprise externe avec des √©quipes disponibles", impacts: { couts: 700000, delais: 0, qualite: 0, client: -5 }, feedback: "Permet de maintenir les d√©lais, mais la coordination est plus complexe et le client peut percevoir un manque de contr√¥le." },
                    { text: "N√©gocier avec le client un ajustement des d√©lais en expliquant la situation", impacts: { client: -10, delais: -5, couts: -50000 }, feedback: "Honn√™te but risque de m√©contenter le client. Vous √©vitez des co√ªts suppl√©mentaires mais perdez en r√©putation." }
                ]
            },
            {
                title: "D√©couverte Arch√©ologique", icon: "üè∫", timeLimit: 70,
                text: "Lors des terrassements, des vestiges arch√©ologiques importants sont d√©couverts. Le site est imm√©diatement gel√© par les autorit√©s culturelles.",
                choices: [
                    { text: "Financer des fouilles acc√©l√©r√©es pour minimiser l'arr√™t", impacts: { couts: 1500000, delais: -20, client: 5, securite: 0 }, feedback: "Solution co√ªteuse mais proactive. Vous montrez votre engagement et minimisez l'impact sur le client." },
                    { text: "Tenter de d√©vier le projet pour contourner la zone", impacts: { couts: 2000000, delais: -30, qualite: -10, client: -15 }, feedback: "Extr√™mement co√ªteux et complexe, cela peut compromettre la conception initiale et la satisfaction client." },
                    { text: "N√©gocier avec les autorit√©s pour une intervention minimale", impacts: { delais: -10, securite: -5, client: -5, couts: 200000 }, feedback: "Vous essayez de limiter les d√©g√¢ts, mais cela peut entra√Æner des compromis sur la conservation et des retards persistants." },
                    { text: "Mettre le chantier en pause ind√©finie en attendant une d√©cision officielle", impacts: { couts: 1000000, delais: -50, equipe: -20, client: -20 }, feedback: "La pire des solutions. Co√ªts d'immobilisation √©normes, moral de l'√©quipe au plus bas et client furieux." }
                ]
            },
            {
                title: "Accident sur le Chantier", icon: "üöë", timeLimit: 30,
                text: "Un accident grave vient de se produire sur le chantier, impliquant un ouvrier. Les secours sont en route. L'inspection du travail sera l√† sous peu.",
                choices: [
                    { text: "Assurer la prise en charge m√©dicale et la s√©curit√© du site, puis communiquer avec transparence", impacts: { securite: 20, equipe: 10, client: 5, couts: 100000 }, feedback: "Priorit√© √† l'humain et √† la transparence. Cela renforce la confiance mais a un co√ªt financier et d'image initial." },
                    { text: "Tenter de minimiser les faits et de cacher certaines informations", impacts: { securite: -30, equipe: -25, client: -20, couts: 500000 }, feedback: "Extr√™mement risqu√© et irresponsable. Cela peut mener √† des poursuites judiciaires et d√©truire la r√©putation de l'entreprise." },
                    { text: "Mettre en place imm√©diatement un audit de s√©curit√© complet", impacts: { securite: 15, equipe: 5, delais: -5, couts: 200000 }, feedback: "Action forte pour la s√©curit√©, mais cela peut entra√Æner un ralentissement temporaire du chantier." },
                    { text: "Bl√¢mer l'ouvrier pour n√©gligence sans investigation", impacts: { equipe: -30, securite: -10, client: -10, couts: -50000 }, feedback: "Injuste et d√©moralisant pour l'√©quipe. Cela cr√©e un climat de peur et n'am√©liore pas la s√©curit√©." }
                ]
            },
            {
                title: "Fluctuation des Prix des Mati√®res Premi√®res", icon: "üí∞", timeLimit: 45,
                text: "Le prix de l'acier, un composant majeur de votre projet, a subitement augment√© de 25%. Votre budget est sous pression.",
                choices: [
                    { text: "Acheter en grande quantit√© maintenant pour bloquer le prix", impacts: { couts: 700000, delais: 5, qualite: 0, client: 0 }, feedback: "Bonne strat√©gie pour limiter la hausse, mais cela immobilise du capital et augmente les co√ªts de stockage." },
                    { text: "Revoir les sp√©cifications techniques pour utiliser moins d'acier ou un substitut", impacts: { qualite: -10, couts: -300000, client: -10, delais: -5 }, feedback: "Solution √©conomique mais qui peut compromettre la qualit√© et la satisfaction client. N√©cessite l'accord du client." },
                    { text: "N√©gocier des conditions de paiement plus favorables avec le fournisseur", impacts: { couts: 100000, client: 0, delais: 0, chiffreAffaires: 0 }, feedback: "Peut all√©ger la tr√©sorerie √† court terme, mais ne r√©sout pas le probl√®me du co√ªt total." },
                    { text: "Demander un avenant au client pour couvrir la hausse des co√ªts", impacts: { client: -15, couts: 0, chiffreAffaires: 700000 }, feedback: "La solution la plus directe pour votre marge, mais risque de tendre la relation client." }
                ]
            },
            {
                title: "Probl√®me de Permis de Construire", icon: "üìÑ", timeLimit: 60,
                text: "Un recours de derni√®re minute contre le permis de construire est d√©pos√© par une association de quartier. Le chantier est menac√© d'un arr√™t administratif.",
                choices: [
                    { text: "Engager un avocat sp√©cialis√© et d√©fendre le permis en urgence", impacts: { couts: 400000, delais: -10, client: 5, securite: 0 }, feedback: "La meilleure approche l√©gale, mais co√ªteuse et le d√©lai de r√©solution est incertain." },
                    { text: "Tenter de n√©gocier directement avec l'association pour trouver un compromis", impacts: { couts: 100000, delais: -5, client: 0, equipe: 0 }, feedback: "Approche diplomatique qui peut √©viter un long conflit, mais n√©cessite des concessions." },
                    { text: "Ignorer le recours et continuer les travaux (risque p√©nal)", impacts: { securite: -20, delais: -30, client: -20, couts: 1000000 }, feedback: "Extr√™mement risqu√©. Vous vous exposez √† de lourdes amendes et √† l'arr√™t d√©finitif du chantier." },
                    { text: "Revoir le projet pour int√©grer les demandes de l'association", impacts: { couts: 800000, delais: -15, client: 10, qualite: -5 }, feedback: "Co√ªteux et long, mais peut d√©samorcer le conflit et am√©liorer l'image du projet. La qualit√© peut √™tre compromise." }
                ]
            },
            {
                title: "Innovation Technologique Impos√©e", icon: "üí°", timeLimit: 50,
                text: "Le client souhaite int√©grer une nouvelle technologie de gestion des b√¢timents (BIM avanc√©) qui n'√©tait pas pr√©vue initialement et demande une adaptation rapide.",
                choices: [
                    { text: "Investir dans la formation de l'√©quipe et l'achat de logiciels", impacts: { couts: 600000, equipe: 15, qualite: 10, delais: -5 }, feedback: "Co√ªteux √† court terme, mais un investissement pour l'avenir de l'entreprise et la satisfaction client." },
                    { text: "Sous-traiter la partie BIM √† une entreprise sp√©cialis√©e", impacts: { couts: 400000, delais: 0, qualite: 5, client: 0 }, feedback: "Solution rapide pour r√©pondre au besoin, mais vous perdez en comp√©tence interne." },
                    { text: "Refuser l'int√©gration en expliquant les contraintes de d√©lai et budget", impacts: { client: -15, qualite: -5, equipe: 0, couts: 0 }, feedback: "Vous prot√©gez votre budget, mais le client sera d√©√ßu et le projet moins moderne." },
                    { text: "Proposer une int√©gration partielle ou progressive de la technologie", impacts: { client: 5, qualite: 5, couts: 200000, delais: -2 }, feedback: "Un compromis qui satisfait partiellement le client et limite les co√ªts et d√©lais. Une approche pragmatique." }
                ]
            }
        ];

        // --- Game Logic ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(value);
        }

        function initializeGame() {
            state = {
                currentScenarioIndex: 0,
                score: 0,
                metrics: JSON.parse(JSON.stringify(CONFIG.initialMetrics)),
                powerUps: JSON.parse(JSON.stringify(CONFIG.initialPowerUps)),
                timerInterval: null,
                timeLeft: 0,
                isModalOpen: false,
                auditActive: false,
            };
            recalculateMargin();
        }
        
        function recalculateMargin() {
            const ca = state.metrics.chiffreAffaires.value;
            const costs = state.metrics.couts.value;
            if (ca > 0) {
                state.metrics.marge.value = ((ca - costs) / ca) * 100;
            } else {
                state.metrics.marge.value = 0;
            }
        }

        function startGame() {
            initializeGame();
            
            // Fade out start screen
            DOMElements.startScreen.classList.remove('opacity-100', 'scale-100');
            DOMElements.startScreen.classList.add('opacity-0', 'scale-95');
            // After transition, move it to the back
            setTimeout(() => {
                DOMElements.startScreen.classList.remove('z-30');
                DOMElements.startScreen.classList.add('-z-10');
            }, 500); // Match CSS transition duration

            // Fade in game screen
            DOMElements.gameScreen.classList.remove('opacity-0', '-z-10', 'scale-95');
            DOMElements.gameScreen.classList.add('opacity-100', 'z-10', 'scale-100');

            DOMElements.totalScenariosDisplay.textContent = scenarios.length;
            renderAll();
            loadScenario(state.currentScenarioIndex);
        }

        function restartGame() {
            // Fade out result screen
            DOMElements.resultScreen.classList.remove('opacity-100', 'scale-100');
            DOMElements.resultScreen.classList.add('opacity-0', 'scale-95');
             // After transition, move it to the back
            setTimeout(() => {
                DOMElements.resultScreen.classList.remove('z-10');
                DOMElements.resultScreen.classList.add('-z-10');
            }, 500);

            // Fade in start screen
            DOMElements.startScreen.classList.remove('opacity-0', '-z-10', 'scale-95');
            DOMElements.startScreen.classList.add('opacity-100', 'z-30', 'scale-100');
        }

        function loadScenario(index) {
            state.auditActive = false; // Reset audit on new scenario
            if (index >= scenarios.length) {
                endGame();
                return;
            }
            state.currentScenarioIndex = index;
            const scenario = scenarios[index];
            DOMElements.choicesContainer.querySelectorAll('.highlight-choice').forEach(el => el.classList.remove('highlight-choice'));
            DOMElements.hintMessage.classList.remove('opacity-100', 'translate-y-0');
            DOMElements.currentScenarioDisplay.textContent = index + 1;
            DOMElements.progressBar.style.width = `${((index + 1) / scenarios.length) * 100}%`;
            DOMElements.scenarioIcon.textContent = scenario.icon;
            DOMElements.scenarioTitle.textContent = scenario.title;
            DOMElements.scenarioText.textContent = scenario.text;
            renderChoices(scenario.choices);
            startTimer(scenario.timeLimit);
        }

        function handleChoice(choiceIndex) {
            if (state.isModalOpen) return;
            clearInterval(state.timerInterval);

            const scenario = scenarios[state.currentScenarioIndex];
            const choice = scenario.choices[choiceIndex];
            const impacts = choice.impacts;
            
            for (const key in impacts) {
                updateMetric(key, impacts[key]);
            }
            recalculateMargin();

            if (state.timeLeft >= CONFIG.timeBonusThreshold) {
                state.score += CONFIG.timeBonusPoints;
            }
            
            showFeedbackModal(choice, impacts);
        }

        function updateMetric(key, change) {
            const metric = state.metrics[key];
            if (!metric) return;
            
            if (metric.isCurrency || metric.isPercentage) {
                 metric.value += change;
            } else {
                metric.value = Math.max(0, Math.min(100, metric.value + change));
            }

            renderMetric(key);
            showMetricChangeIndicator(key, change, metric.isCurrency);
        }

        function startTimer(duration) {
            state.timeLeft = duration;
            clearInterval(state.timerInterval);
            const update = () => {
                DOMElements.timerDisplay.textContent = `‚è±Ô∏è 0:${state.timeLeft.toString().padStart(2, '0')}`;
                DOMElements.timerDisplay.classList.toggle('text-red-500', state.timeLeft <= 10);
                DOMElements.timerDisplay.classList.toggle('critical-time', state.timeLeft <= 10);
                DOMElements.timerDisplay.classList.toggle('text-amber-400', state.timeLeft > 10);
                if (state.timeLeft <= 0) {
                    clearInterval(state.timerInterval);
                    // If time runs out, choose a random option
                    handleChoice(Math.floor(Math.random() * scenarios[state.currentScenarioIndex].choices.length));
                }
                state.timeLeft--;
            };
            update();
            state.timerInterval = setInterval(update, 1000);
        }

        function usePowerUp(type) {
            if (state.powerUps[type].count <= 0 || state.isModalOpen) return;
            state.powerUps[type].count--;

            switch (type) {
                case 'audit':
                    state.auditActive = true;
                    renderChoices(scenarios[state.currentScenarioIndex].choices);
                    DOMElements.hintMessage.textContent = "Audit activ√© : Impacts financiers r√©v√©l√©s.";
                    DOMElements.hintMessage.classList.add('opacity-100', 'translate-y-0');
                    break;
                case 'negociation':
                    // This would require a more complex UI to select which impact to reduce.
                    // For now, let's just boost the 'client' metric as a negotiation success.
                    updateMetric('client', 15);
                    DOMElements.hintMessage.textContent = "N√©gociation r√©ussie ! La satisfaction client augmente.";
                    DOMElements.hintMessage.classList.add('opacity-100', 'translate-y-0');
                    break;
                case 'xray':
                    const bestChoiceElement = document.getElementById(`choice-${findBestChoice().index}`);
                    if (bestChoiceElement) {
                        bestChoiceElement.classList.add('highlight-choice');
                    }
                    DOMElements.hintMessage.textContent = "Analyse Risques : Le choix le plus avantageux est mis en √©vidence.";
                    DOMElements.hintMessage.classList.add('opacity-100', 'translate-y-0');
                    break;
            }
            setTimeout(() => { DOMElements.hintMessage.classList.remove('opacity-100', 'translate-y-0'); }, 4000);
            renderPowerUps();
        }

        function findBestChoice() {
            const choices = scenarios[state.currentScenarioIndex].choices;
            let bestScore = -Infinity;
            let bestIndex = -1;
            choices.forEach((choice, index) => {
                // Calculate a score based on the sum of impacts, giving more weight to positive impacts
                // and considering financial impacts appropriately.
                let currentScore = 0;
                for (const key in choice.impacts) {
                    const change = choice.impacts[key];
                    const metric = CONFIG.initialMetrics[key];
                    if (metric.isCurrency) {
                        // For currency, positive change in CA is good, positive change in costs is bad.
                        currentScore += (key === 'chiffreAffaires' ? change : -change) / 100000; // Normalize large currency values
                    } else if (metric.isPercentage) {
                        currentScore += change * 2; // Percentage changes are often significant
                    } else {
                        currentScore += change;
                    }
                }

                // Add a small bonus for positive overall impact to break ties or favor generally good choices
                if (currentScore > 0) {
                    currentScore += 1;
                }

                if (currentScore > bestScore) {
                    bestScore = currentScore;
                    bestIndex = index;
                }
            });
            return { ...choices[bestIndex], index: bestIndex };
        }

        function showFeedbackModal(choice, impacts) {
            state.isModalOpen = true;
            DOMElements.feedbackTitle.textContent = choice.text ? `Cons√©quences de la d√©cision` : "Rapport de situation";
            DOMElements.feedbackText.textContent = choice.feedback; // Corrected typo here
            
            let impactHTML = '';
            for (const key in impacts) {
                const change = impacts[key];
                const metric = CONFIG.initialMetrics[key];
                const isFinancial = metric.isCurrency || key === 'marge';
                const colorClass = change > 0 ? (key === 'couts' ? 'text-red-400' : 'text-green-400') : (key === 'couts' ? 'text-green-400' : 'text-red-400');
                const sign = change > 0 ? '+' : '';
                const value = isFinancial ? formatCurrency(change) : `${sign}${change}`;

                impactHTML += `
                    <div class="flex justify-between items-center bg-slate-700/50 p-3 rounded-lg">
                        <span class="font-medium">${metric.icon} ${metric.name}</span>
                        <span class="font-bold ${colorClass}">${value}</span>
                    </div>
                `;
            }
            DOMElements.impactList.innerHTML = impactHTML;

            DOMElements.modalOverlay.classList.remove('pointer-events-none', 'opacity-0');
            DOMElements.modal.classList.remove('scale-95');
            
            DOMElements.modalContinueBtn.onclick = () => {
                closeFeedbackModal();
                loadScenario(state.currentScenarioIndex + 1);
            };
        }

        function closeFeedbackModal() {
            state.isModalOpen = false;
            DOMElements.modalOverlay.classList.add('pointer-events-none', 'opacity-0');
            DOMElements.modal.classList.add('scale-95');
        }

        function endGame() {
            // Fade out game screen
            DOMElements.gameScreen.classList.remove('opacity-100', 'scale-100');
            DOMElements.gameScreen.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                DOMElements.gameScreen.classList.remove('z-10');
                DOMElements.gameScreen.classList.add('-z-10');
            }, 500);

            // Fade in result screen
            DOMElements.resultScreen.classList.remove('opacity-0', '-z-10', 'scale-95');
            DOMElements.resultScreen.classList.add('opacity-100', 'z-10', 'scale-100');

            const finalMargin = state.metrics.marge.value;
            // Calculate total score based on margin, client satisfaction, and quality
            const totalScore = Math.round(finalMargin * 1000 + state.metrics.client.value * 50 + state.metrics.qualite.value * 50);
            DOMElements.finalScore.textContent = totalScore;

            let category, description;
            if (finalMargin >= 10) {
                category = "Ma√Ætre d'≈íuvre d'Exception";
                description = "Rentabilit√© exceptionnelle, projet men√© de main de ma√Ætre. Votre gestion financi√®re et strat√©gique est un cas d'√©cole. Bravo !";
            } else if (finalMargin >= 5) {
                category = "Directeur de Projet chevronn√©";
                description = "Vous avez su pr√©server la rentabilit√© face √† l'adversit√©. Une performance solide qui d√©montre une grande exp√©rience.";
            } else if (finalMargin > 0) {
                category = "Gestionnaire Prudent";
                description = "Le projet est rentable, c'est l'essentiel. Des optimisations sont possibles, mais vous avez √©vit√© la catastrophe. Mission accomplie.";
            } else {
                category = "Projet en Difficult√©";
                description = "La rentabilit√© n'est pas au rendez-vous. Cette simulation difficile est riche d'enseignements pour affiner votre gestion des risques.";
            }
            DOMElements.resultCategory.textContent = category;
            DOMElements.resultDescription.textContent = description;

            let breakdownHTML = `<h4 class="text-lg font-bold text-center text-blue-300 mb-4">Bilan Financier & Op√©rationnel</h4>`;
            for (const key in state.metrics) {
                const metric = state.metrics[key];
                const value = metric.isCurrency ? formatCurrency(metric.value) : metric.isPercentage ? `${metric.value.toFixed(2)}%` : `${metric.value}/100`;
                let colorClass = 'text-white';
                if(key === 'marge') colorClass = metric.value > 10 ? 'text-green-400' : metric.value > 0 ? 'text-amber-400' : 'text-red-400';
                else if (!metric.isCurrency) { // For non-currency, non-percentage metrics (like quality, safety)
                    colorClass = metric.value > 70 ? 'text-green-400' : metric.value > 40 ? 'text-amber-400' : 'text-red-400';
                }
                
                breakdownHTML += `
                    <div class="flex justify-between items-center py-2 border-b border-slate-700 last:border-b-0">
                        <span class="font-semibold text-slate-300">${metric.icon} ${CONFIG.initialMetrics[key].name}</span>
                        <span class="font-bold text-lg ${colorClass}">${value}</span>
                    </div>
                `;
            }
            DOMElements.scoreBreakdown.innerHTML = breakdownHTML;
        }

        // --- Rendering Functions ---
        function renderAll() {
            renderMetrics();
            renderPowerUps();
        }

        function renderChoices(choices) {
            DOMElements.choicesContainer.innerHTML = choices.map((choice, index) => {
                let financialPreview = '';
                if (state.auditActive) {
                    const costImpact = choice.impacts.couts || 0;
                    const caImpact = choice.impacts.chiffreAffaires || 0;
                    financialPreview = `
                        <div class="text-xs mt-2">
                            <span class="text-red-400">Co√ªt: ${formatCurrency(costImpact)}</span> | 
                            <span class="text-green-400">C.A.: ${formatCurrency(caImpact)}</span>
                        </div>
                    `;
                }
                return `
                    <div id="choice-${index}" onclick="handleChoice(${index})" class="group bg-slate-700/50 hover:bg-slate-700 border-2 border-transparent hover:border-blue-500 rounded-xl p-5 cursor-pointer transition-all duration-300 transform hover:-translate-y-1 shadow-md hover:shadow-blue-500/20">
                        <p class="text-slate-100 font-semibold text-lg">${choice.text}</p>
                        ${financialPreview}
                    </div>
                `;
            }).join('');
        }

        function renderMetrics() {
            DOMElements.metricsContainer.innerHTML = Object.keys(state.metrics).map(key => createMetricHTML(key)).join('');
        }

        function renderMetric(key) {
            const metricElement = document.getElementById(`metric-${key}`);
            if (metricElement) metricElement.outerHTML = createMetricHTML(key);
            else renderMetrics(); // Fallback if element not found (e.g., initial render)
        }

        function createMetricHTML(key) {
            const metric = state.metrics[key];
            let valueDisplay, barDisplay = '';
            
            if (metric.isCurrency) {
                valueDisplay = formatCurrency(metric.value);
            } else if (metric.isPercentage) {
                valueDisplay = `${metric.value.toFixed(2)}%`;
                const barColor = metric.value > 75 ? 'bg-green-500' : metric.value > 40 ? 'bg-amber-500' : 'bg-red-500';
                barDisplay = `
                    <div class="w-full h-2 bg-slate-600 rounded-full mt-1">
                        <div class="h-full ${barColor} rounded-full" style="width: ${Math.max(0, Math.min(100, metric.value))}%;"></div>
                    </div>
                `;
            } else {
                valueDisplay = `${metric.value}/100`;
                const barColor = metric.value > 75 ? 'bg-green-500' : metric.value > 40 ? 'bg-amber-500' : 'bg-red-500';
                barDisplay = `
                    <div class="w-full h-2 bg-slate-600 rounded-full mt-1">
                        <div class="h-full ${barColor} rounded-full" style="width: ${Math.max(0, Math.min(100, metric.value))}%;"></div>
                    </div>
                `;
            }

            let valueColorClass = 'text-slate-200';
            if (key === 'marge') {
                valueColorClass = metric.value > 10 ? 'text-green-400' : metric.value > 0 ? 'text-amber-400' : 'text-red-400';
            } else if (!metric.isCurrency && !metric.isPercentage) { // For other non-currency, non-percentage metrics
                valueColorClass = metric.value > 70 ? 'text-green-400' : metric.value > 40 ? 'text-amber-400' : 'text-red-400';
            } else if (key === 'couts') { // For costs, lower is better
                valueColorClass = metric.value < CONFIG.initialMetrics.couts.value * 0.9 ? 'text-green-400' : metric.value > CONFIG.initialMetrics.couts.value * 1.1 ? 'text-red-400' : 'text-amber-400';
            } else if (key === 'chiffreAffaires') { // For revenue, higher is better
                valueColorClass = metric.value > CONFIG.initialMetrics.chiffreAffaires.value * 1.1 ? 'text-green-400' : metric.value < CONFIG.initialMetrics.chiffreAffaires.value * 0.9 ? 'text-red-400' : 'text-amber-400';
            }

            return `
                <div id="metric-${key}" class="bg-slate-700/50 rounded-lg p-3 flex flex-col items-center justify-center relative overflow-hidden">
                    <span class="text-2xl mb-1">${metric.icon}</span>
                    <span class="text-sm text-slate-400 font-medium">${metric.name}</span>
                    <span class="text-lg font-bold ${valueColorClass}">${valueDisplay}</span>
                    ${barDisplay}
                </div>
            `;
        }

        function showMetricChangeIndicator(key, change, isCurrency) {
            const metricElement = document.getElementById(`metric-${key}`);
            if (!metricElement) return;

            const indicator = document.createElement('div');
            indicator.className = `absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold metric-change ${change > 0 ? (key === 'couts' ? 'text-red-400' : 'text-green-400') : (key === 'couts' ? 'text-green-400' : 'text-red-400')}`;
            indicator.textContent = `${change > 0 ? '+' : ''}${isCurrency ? formatCurrency(change) : change}`;
            metricElement.appendChild(indicator);

            indicator.addEventListener('animationend', () => {
                indicator.remove();
            });
        }

        function renderPowerUps() {
            DOMElements.powerUpContainer.innerHTML = Object.keys(state.powerUps).map(type => {
                const powerUp = state.powerUps[type];
                const isDisabled = powerUp.count <= 0 ? 'opacity-50 cursor-not-allowed' : 'hover:scale-110 cursor-pointer';
                return `
                    <button onclick="usePowerUp('${type}')" class="bg-blue-700 text-white rounded-full p-3 shadow-lg flex items-center justify-center transition-all duration-200 ${isDisabled}" title="${powerUp.description}" ${powerUp.count <= 0 ? 'disabled' : ''}>
                        <span class="text-2xl">${powerUp.icon}</span>
                        <span class="absolute top-0 right-0 -mt-1 -mr-1 bg-amber-500 text-slate-900 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${powerUp.count}</span>
                    </button>
                `;
            }).join('');
        }

        // Initial setup
        initializeGame();
    </script>
</body>
</html>
ÔøΩ
